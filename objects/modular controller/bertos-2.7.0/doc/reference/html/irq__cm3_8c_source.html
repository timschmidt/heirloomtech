

<!-- Generated by Doxygen 1.7.4 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="dir_9fd71c1ac00056e7d855336b2291c56c.html">bertos</a>      </li>
      <li class="navelem"><a class="el" href="dir_a5de7543e32a5f073daa04f8834eb5fd.html">cpu</a>      </li>
      <li class="navelem"><a class="el" href="dir_b85b1b77342b0233aa6bdb4655adc5e9.html">cortex-m3</a>      </li>
      <li class="navelem"><a class="el" href="dir_67d33e4ffe4ff938d746541f95b62a0f.html">drv</a>      </li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">irq_cm3.c</div>  </div>
</div>
<div class="contents">
<a href="irq__cm3_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 
<a name="l00038"></a>00038 <span class="preprocessor">#include &quot;<a class="code" href="irq__cm3_8h.html" title="IRQ management for the Cortex-M3 processor.">irq_cm3.h</a>&quot;</span>
<a name="l00039"></a>00039 
<a name="l00040"></a>00040 <span class="preprocessor">#include &lt;<a class="code" href="debug_8h.html">cfg/debug.h</a>&gt;</span> <span class="comment">/* ASSERT() */</span>
<a name="l00041"></a>00041 <span class="preprocessor">#include &lt;<a class="code" href="log_8h.html">cfg/log.h</a>&gt;</span> <span class="comment">/* LOG_ERR() */</span>
<a name="l00042"></a>00042 <span class="preprocessor">#include &lt;<a class="code" href="cpu_2irq_8h.html" title="CPU-specific IRQ definitions.">cpu/irq.h</a>&gt;</span>
<a name="l00043"></a>00043 
<a name="l00044"></a>00044 
<a name="l00045"></a>00045 <span class="preprocessor">#ifdef __IAR_SYSTEMS_ICC__</span>
<a name="l00046"></a>00046 <span class="preprocessor"></span><span class="preprocessor">#pragma data_alignment=0x400</span>
<a name="l00047"></a>00047 <span class="preprocessor"></span><span class="keyword">static</span> void (*irq_table[<a class="code" href="lm3s__ints_8h.html#a8b9ae71d2ea53a231841b41414acf1ec" title="The following are defines for the total number of interrupts.">NUM_INTERRUPTS</a>])(void);
<a name="l00048"></a>00048 <span class="preprocessor">#else</span>
<a name="l00049"></a>00049 <span class="preprocessor"></span><span class="keyword">static</span> void (*irq_table[<a class="code" href="lm3s__ints_8h.html#a8b9ae71d2ea53a231841b41414acf1ec" title="The following are defines for the total number of interrupts.">NUM_INTERRUPTS</a>])(void)
<a name="l00050"></a>00050             __attribute__((section(<span class="stringliteral">&quot;vtable&quot;</span>)));
<a name="l00051"></a>00051 <span class="preprocessor">#endif</span>
<a name="l00052"></a>00052 <span class="preprocessor"></span>
<a name="l00053"></a>00053 <span class="comment">/* Priority register / IRQ number table */</span>
<a name="l00054"></a>00054 <span class="keyword">static</span> <span class="keyword">const</span> uint32_t nvic_prio_reg[] =
<a name="l00055"></a>00055 {
<a name="l00056"></a>00056     <span class="comment">/* System exception registers */</span>
<a name="l00057"></a>00057     0, <a class="code" href="lm3s__nvic_8h.html#aaca44d8032156f85991ffc303f1baddf" title="Sys. Handlers 4 to 7 Priority.">NVIC_SYS_PRI1</a>, <a class="code" href="lm3s__nvic_8h.html#a618b94c9eb37d0fa3ce8a015000af87e" title="Sys. Handlers 8 to 11 Priority.">NVIC_SYS_PRI2</a>, <a class="code" href="lm3s__nvic_8h.html#a11a289b2016fdb8e0f1d9bd27dc355ed" title="Sys. Handlers 12 to 15 Priority.">NVIC_SYS_PRI3</a>,
<a name="l00058"></a>00058 
<a name="l00059"></a>00059     <span class="comment">/* External interrupts registers */</span>
<a name="l00060"></a>00060     <a class="code" href="lm3s__nvic_8h.html#a18cea92c71bd04c864eb6d2ed7438885" title="IRQ 0 to 3 Priority Register.">NVIC_PRI0</a>, <a class="code" href="lm3s__nvic_8h.html#a1a9e2a8df93a2504c1a55aa95962a73a" title="IRQ 4 to 7 Priority Register.">NVIC_PRI1</a>, <a class="code" href="lm3s__nvic_8h.html#a8c7e668b3262773a397fc25c4d0cdbcb" title="IRQ 8 to 11 Priority Register.">NVIC_PRI2</a>, <a class="code" href="lm3s__nvic_8h.html#a94acb841e721388468ac76b29f44ab06" title="IRQ 12 to 15 Priority Register.">NVIC_PRI3</a>,
<a name="l00061"></a>00061     <a class="code" href="lm3s__nvic_8h.html#af966c67de90708e2137c37fba54e91bc" title="IRQ 16 to 19 Priority Register.">NVIC_PRI4</a>, <a class="code" href="lm3s__nvic_8h.html#a3d0ccbe9b6733e7f3003a356b9ec998c" title="IRQ 20 to 23 Priority Register.">NVIC_PRI5</a>, <a class="code" href="lm3s__nvic_8h.html#a517055d422a98ee117e548da8bab6cd2" title="IRQ 24 to 27 Priority Register.">NVIC_PRI6</a>, <a class="code" href="lm3s__nvic_8h.html#acb5880381bb3ccc41a43769cbb7d0380" title="IRQ 28 to 31 Priority Register.">NVIC_PRI7</a>,
<a name="l00062"></a>00062     <a class="code" href="lm3s__nvic_8h.html#a3a4b85819dabf11849c195cd486e9998" title="IRQ 32 to 35 Priority Register.">NVIC_PRI8</a>, <a class="code" href="lm3s__nvic_8h.html#a8078d70d80da47831a9747b799dd9edb" title="IRQ 36 to 39 Priority Register.">NVIC_PRI9</a>, <a class="code" href="lm3s__nvic_8h.html#a11d56252a7d015637eba9501f52633b6" title="IRQ 40 to 43 Priority Register.">NVIC_PRI10</a>, <a class="code" href="lm3s__nvic_8h.html#a0c59a490d0dd67147dcae93b45c0f109" title="IRQ 44 to 47 Priority Register.">NVIC_PRI11</a>,
<a name="l00063"></a>00063     <a class="code" href="lm3s__nvic_8h.html#a155fb32059321478ae7fbad99d384f2f" title="IRQ 48 to 51 Priority Register.">NVIC_PRI12</a>, <a class="code" href="lm3s__nvic_8h.html#ad1d93011f649138c55405a816a6d9800" title="IRQ 52 to 55 Priority Register.">NVIC_PRI13</a>
<a name="l00064"></a>00064 };
<a name="l00065"></a>00065 
<a name="l00066"></a>00066 <span class="comment">/* Unhandled IRQ */</span>
<a name="l00067"></a>00067 <span class="keyword">static</span> NAKED NORETURN <span class="keywordtype">void</span> unhandled_isr(<span class="keywordtype">void</span>)
<a name="l00068"></a>00068 {
<a name="l00069"></a>00069     <span class="keyword">register</span> uint32_t reg;
<a name="l00070"></a>00070 
<a name="l00071"></a>00071 <span class="preprocessor">#ifdef __IAR_SYSTEMS_ICC__</span>
<a name="l00072"></a>00072 <span class="preprocessor"></span>    reg = CPU_READ_IPSR();
<a name="l00073"></a>00073 <span class="preprocessor">#else</span>
<a name="l00074"></a>00074 <span class="preprocessor"></span>    <span class="keyword">asm</span> <span class="keyword">volatile</span> (<span class="stringliteral">&quot;mrs %0, ipsr&quot;</span> : <span class="stringliteral">&quot;=r&quot;</span>(reg));
<a name="l00075"></a>00075 <span class="preprocessor">#endif</span>
<a name="l00076"></a>00076 <span class="preprocessor"></span>    <a class="code" href="group__logging.html#ga19c97c740010c52ce6801d46a5346644" title="Output an error message.">LOG_ERR</a>(<span class="stringliteral">&quot;unhandled IRQ %lu\n&quot;</span>, reg);
<a name="l00077"></a>00077     <span class="keywordflow">while</span> (1)
<a name="l00078"></a>00078         <a class="code" href="attr_8h.html#a5666ac5930c9f903698073ab1fa694f7" title="Generic PAUSE implementation.">PAUSE</a>;
<a name="l00079"></a>00079 }
<a name="l00080"></a>00080 
<a name="l00081"></a>00081 <span class="keywordtype">void</span> sysirq_setPriority(<a class="code" href="sysirq__at91_8h.html#a4c3f180f298a68eafe5b5cc39ea6ec20" title="System IRQ ID list.">sysirq_t</a> irq, <span class="keywordtype">int</span> prio)
<a name="l00082"></a>00082 {
<a name="l00083"></a>00083     uint32_t pos = (irq &amp; 3) * 8;
<a name="l00084"></a>00084     reg32_t reg = nvic_prio_reg[irq &gt;&gt; 2];
<a name="l00085"></a>00085     uint32_t val;
<a name="l00086"></a>00086 
<a name="l00087"></a>00087     val = <a class="code" href="types_8h.html#ac9660181819fceac0b5abcd67d76ca6e" title="Macros for hardware access, both direct and via the bit-band region.">HWREG</a>(reg);
<a name="l00088"></a>00088     val &amp;= ~(0xff &lt;&lt; pos);
<a name="l00089"></a>00089     val |= prio &lt;&lt; pos;
<a name="l00090"></a>00090     <a class="code" href="types_8h.html#ac9660181819fceac0b5abcd67d76ca6e" title="Macros for hardware access, both direct and via the bit-band region.">HWREG</a>(reg) = val;
<a name="l00091"></a>00091 }
<a name="l00092"></a>00092 
<a name="l00093"></a>00093 <span class="keyword">static</span> <span class="keywordtype">void</span> sysirq_enable(<a class="code" href="sysirq__at91_8h.html#a4c3f180f298a68eafe5b5cc39ea6ec20" title="System IRQ ID list.">sysirq_t</a> irq)
<a name="l00094"></a>00094 {
<a name="l00095"></a>00095     <span class="comment">/* Enable the IRQ line (only for generic IRQs) */</span>
<a name="l00096"></a>00096     <span class="keywordflow">if</span> (irq &gt;= 16 &amp;&amp; irq &lt; 48)
<a name="l00097"></a>00097         <a class="code" href="lm3s__com_8h.html#a116f514784f648ad8b4634731406bd4c" title="NVIC registers (NVIC)">NVIC_EN0_R</a> = 1 &lt;&lt; (irq - 16);
<a name="l00098"></a>00098     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (irq &gt;= 48)
<a name="l00099"></a>00099         <a class="code" href="lm3s__com_8h.html#a2579967f4c45e4eaca0f61838ee3687b" title="NVIC registers (NVIC)">NVIC_EN1_R</a> = 1 &lt;&lt; (irq - 48);
<a name="l00100"></a>00100 }
<a name="l00101"></a>00101 
<a name="l00102"></a><a class="code" href="irq__cm3_8c.html#ac306e48b7f835d555d57502b277961f8">00102</a> <span class="keywordtype">void</span> <a class="code" href="sysirq__at91_8c.html#ac306e48b7f835d555d57502b277961f8" title="Helper function used to set handler for system IRQ irq.">sysirq_setHandler</a>(<a class="code" href="sysirq__at91_8h.html#a4c3f180f298a68eafe5b5cc39ea6ec20" title="System IRQ ID list.">sysirq_t</a> irq, <a class="code" href="sysirq__at91_8h.html#a5d841605d626b85c8672c05cc47034d8" title="Type for system irq handler.">sysirq_handler_t</a> handler)
<a name="l00103"></a>00103 {
<a name="l00104"></a>00104     cpu_flags_t flags;
<a name="l00105"></a>00105 
<a name="l00106"></a>00106     <a class="code" href="group__debug.html#gaca68c0d4ac8df0838e209fb5300f7be3" title="Assert a pre-condition on code.">ASSERT</a>(irq &lt; <a class="code" href="lm3s__ints_8h.html#a8b9ae71d2ea53a231841b41414acf1ec" title="The following are defines for the total number of interrupts.">NUM_INTERRUPTS</a>);
<a name="l00107"></a>00107 
<a name="l00108"></a>00108     IRQ_SAVE_DISABLE(flags);
<a name="l00109"></a>00109     irq_table[irq] = handler;
<a name="l00110"></a>00110     sysirq_setPriority(irq, IRQ_PRIO);
<a name="l00111"></a>00111     sysirq_enable(irq);
<a name="l00112"></a>00112     IRQ_RESTORE(flags);
<a name="l00113"></a>00113 }
<a name="l00114"></a>00114 
<a name="l00115"></a>00115 <span class="keywordtype">void</span> sysirq_freeHandler(<a class="code" href="sysirq__at91_8h.html#a4c3f180f298a68eafe5b5cc39ea6ec20" title="System IRQ ID list.">sysirq_t</a> irq)
<a name="l00116"></a>00116 {
<a name="l00117"></a>00117     cpu_flags_t flags;
<a name="l00118"></a>00118 
<a name="l00119"></a>00119     <a class="code" href="group__debug.html#gaca68c0d4ac8df0838e209fb5300f7be3" title="Assert a pre-condition on code.">ASSERT</a>(irq &lt; <a class="code" href="lm3s__ints_8h.html#a8b9ae71d2ea53a231841b41414acf1ec" title="The following are defines for the total number of interrupts.">NUM_INTERRUPTS</a>);
<a name="l00120"></a>00120 
<a name="l00121"></a>00121     IRQ_SAVE_DISABLE(flags);
<a name="l00122"></a>00122     irq_table[irq] = unhandled_isr;
<a name="l00123"></a>00123     IRQ_RESTORE(flags);
<a name="l00124"></a>00124 }
<a name="l00125"></a>00125 
<a name="l00126"></a><a class="code" href="irq__cm3_8c.html#a4246172c39d164cff750f38fca61e378">00126</a> <span class="keywordtype">void</span> <a class="code" href="sysirq__at91_8c.html#a4246172c39d164cff750f38fca61e378" title="Init system IRQ handling.">sysirq_init</a>(<span class="keywordtype">void</span>)
<a name="l00127"></a>00127 {
<a name="l00128"></a>00128     cpu_flags_t flags;
<a name="l00129"></a>00129     <span class="keywordtype">int</span> i;
<a name="l00130"></a>00130 
<a name="l00131"></a>00131     IRQ_SAVE_DISABLE(flags);
<a name="l00132"></a>00132     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="lm3s__ints_8h.html#a8b9ae71d2ea53a231841b41414acf1ec" title="The following are defines for the total number of interrupts.">NUM_INTERRUPTS</a>; i++)
<a name="l00133"></a>00133         irq_table[i] = unhandled_isr;
<a name="l00134"></a>00134 
<a name="l00135"></a>00135     <span class="comment">/* Update NVIC to point to the new vector table */</span>
<a name="l00136"></a>00136     <a class="code" href="lm3s__com_8h.html#a32315c8fcc675d189d48a2b2f5097606" title="NVIC registers (NVIC)">NVIC_VTABLE_R</a> = (size_t)irq_table;
<a name="l00137"></a>00137     IRQ_RESTORE(flags);
<a name="l00138"></a>00138 }
</pre></div></div>
</div>


