

<!-- Generated by Doxygen 1.7.4 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="dir_9fd71c1ac00056e7d855336b2291c56c.html">bertos</a>      </li>
      <li class="navelem"><a class="el" href="dir_a5de7543e32a5f073daa04f8834eb5fd.html">cpu</a>      </li>
      <li class="navelem"><a class="el" href="dir_3ade2df878d06c00b7da75ebdc1e74f5.html">arm</a>      </li>
      <li class="navelem"><a class="el" href="dir_88b011769bd68bcbdcfc8a5f3d937253.html">drv</a>      </li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">i2s_at91.c</div>  </div>
</div>
<div class="contents">
<a href="i2s__at91_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 
<a name="l00038"></a>00038 <span class="comment">/*</span>
<a name="l00039"></a>00039 <span class="comment"> * TODO: Revise the public api of this module to be more generic. Evalutate to</span>
<a name="l00040"></a>00040 <span class="comment"> * implement the more generic layer to be common to all I2S BeRTOS drivers.</span>
<a name="l00041"></a>00041 <span class="comment"> */</span>
<a name="l00042"></a>00042 <span class="preprocessor">#include &quot;<a class="code" href="i2s__at91_8h.html" title="I2S driver functions.">i2s_at91.h</a>&quot;</span>
<a name="l00043"></a>00043 <span class="preprocessor">#include &quot;<a class="code" href="cfg__i2s_8h.html" title="Configuration file for I2S module.">cfg/cfg_i2s.h</a>&quot;</span>
<a name="l00044"></a>00044 
<a name="l00045"></a>00045 <span class="comment">// Define log settings for cfg/log.h.</span>
<a name="l00046"></a>00046 <span class="preprocessor">#define LOG_LEVEL         I2S_LOG_LEVEL</span>
<a name="l00047"></a>00047 <span class="preprocessor"></span><span class="preprocessor">#define LOG_FORMAT        I2S_LOG_FORMAT</span>
<a name="l00048"></a>00048 <span class="preprocessor"></span><span class="preprocessor">#include &lt;<a class="code" href="log_8h.html">cfg/log.h</a>&gt;</span>
<a name="l00049"></a>00049 
<a name="l00050"></a>00050 <span class="preprocessor">#include &lt;<a class="code" href="timer_8h.html">drv/timer.h</a>&gt;</span>
<a name="l00051"></a>00051 <span class="preprocessor">#include &lt;<a class="code" href="arm_8h.html">io/arm.h</a>&gt;</span>
<a name="l00052"></a>00052 
<a name="l00053"></a>00053 <span class="preprocessor">#define DATALEN (15 &amp; SSC_DATLEN_MASK)</span>
<a name="l00054"></a>00054 <span class="preprocessor"></span><span class="comment">// FIXME: this is not correct for 16 &lt;= DATALEN &lt; 24</span>
<a name="l00055"></a>00055 <span class="preprocessor">#define PDC_DIV ((DATALEN / 8) + 1)</span>
<a name="l00056"></a>00056 <span class="preprocessor"></span><span class="comment">/*</span>
<a name="l00057"></a>00057 <span class="comment"> * PDC_DIV must be 1, 2 or 4, which are the bytes that are transferred</span>
<a name="l00058"></a>00058 <span class="comment"> * each time the PDC reads from memory.</span>
<a name="l00059"></a>00059 <span class="comment"> */</span>
<a name="l00060"></a>00060 <a class="code" href="compiler_8h.html#a695e64485eb9535f5ddcfec01167bddc" title="Issue a compilation error if the condition is false.">STATIC_ASSERT</a>(PDC_DIV % 2 == 0);
<a name="l00061"></a>00061 <span class="preprocessor">#define PDC_COUNT (CONFIG_PLAY_BUF_LEN / PDC_DIV)</span>
<a name="l00062"></a>00062 <span class="preprocessor"></span>
<a name="l00063"></a>00063 <span class="keyword">static</span> uint8_t play_buf1[<a class="code" href="cfg__i2s_8h.html#a6c7e2eee3c239b0c0af46746323293e4" title="Length of each play buffer.">CONFIG_PLAY_BUF_LEN</a>];
<a name="l00064"></a>00064 <span class="keyword">static</span> uint8_t play_buf2[<a class="code" href="cfg__i2s_8h.html#a6c7e2eee3c239b0c0af46746323293e4" title="Length of each play buffer.">CONFIG_PLAY_BUF_LEN</a>];
<a name="l00065"></a>00065 
<a name="l00066"></a>00066 <span class="comment">// the buffer in PDC next is play_buf2</span>
<a name="l00067"></a>00067 <span class="keyword">volatile</span> <span class="keywordtype">bool</span> is_second_buf_next;
<a name="l00068"></a>00068 
<a name="l00069"></a><a class="code" href="i2s__at91_8h.html#a8b2854c8c9206514a69bd3a7630b16f4">00069</a> uint8_t *<a class="code" href="i2s__at91_8c.html#a8b2854c8c9206514a69bd3a7630b16f4" title="Returns one of the two buffers or NULL if none is available.">i2s_getBuffer</a>(<span class="keywordtype">unsigned</span> buf_num)
<a name="l00070"></a>00070 {
<a name="l00071"></a>00071     <a class="code" href="group__logging.html#gaa5595314cc54c304a127c75cfcec4017" title="Output an informative message.">LOG_INFO</a>(<span class="stringliteral">&quot;getBuffer start\n&quot;</span>);
<a name="l00072"></a>00072 
<a name="l00073"></a>00073     <span class="keywordflow">if</span> (i2s_isPlaying())
<a name="l00074"></a>00074     {
<a name="l00075"></a>00075         <a class="code" href="group__debug.html#gaca68c0d4ac8df0838e209fb5300f7be3" title="Assert a pre-condition on code.">ASSERT</a>(0);
<a name="l00076"></a>00076         <span class="keywordflow">return</span> 0;
<a name="l00077"></a>00077     }
<a name="l00078"></a>00078 
<a name="l00079"></a>00079     <span class="keywordflow">if</span> (buf_num == <a class="code" href="i2s__at91_8h.html#a1f5f00dea7116b6131bbe6b0eeb968a5" title="Second buffer.">I2S_SECOND_BUF</a>)
<a name="l00080"></a>00080         <span class="keywordflow">return</span> play_buf2;
<a name="l00081"></a>00081     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (buf_num == <a class="code" href="i2s__at91_8h.html#a5d0d92ae11c048d00e678bea47a7a069" title="First buffer.">I2S_FIRST_BUF</a>)
<a name="l00082"></a>00082         <span class="keywordflow">return</span> play_buf1;
<a name="l00083"></a>00083     <span class="keywordflow">else</span>
<a name="l00084"></a>00084         <span class="keywordflow">return</span> 0;
<a name="l00085"></a>00085 }
<a name="l00086"></a>00086 
<a name="l00087"></a><a class="code" href="i2s__at91_8h.html#a37b630b8053a633ad5c2028519a15d5f">00087</a> uint8_t *<a class="code" href="i2s__at91_8c.html#a37b630b8053a633ad5c2028519a15d5f" title="Returns a buffer that will be played after the current one.">i2s_getFreeBuffer</a>(<span class="keywordtype">void</span>)
<a name="l00088"></a>00088 {
<a name="l00089"></a>00089     <span class="keywordflow">if</span> (!i2s_isPlaying())
<a name="l00090"></a>00090     {
<a name="l00091"></a>00091         <a class="code" href="group__debug.html#gaca68c0d4ac8df0838e209fb5300f7be3" title="Assert a pre-condition on code.">ASSERT</a>(0);
<a name="l00092"></a>00092         <span class="keywordflow">return</span> 0;
<a name="l00093"></a>00093     }
<a name="l00094"></a>00094 
<a name="l00095"></a>00095     <span class="comment">// wait PDC transmission end</span>
<a name="l00096"></a>00096     <span class="keywordflow">if</span> (!(<a class="code" href="sam3__ssc_8h.html#a90a127c193bd864152a396f6b71218ae" title="Status register address.">SSC_SR</a> &amp; <a class="code" href="group__macros.html#ga663d8c125655d41622b1e6bc96e5d63d" title="Convert a bit value to a binary flag.">BV</a>(<a class="code" href="at91__ssc_8h.html#a009be0cb90377d74c0ff17bb918396f6" title="End of transmission.">SSC_ENDTX</a>)))
<a name="l00097"></a>00097         <span class="keywordflow">return</span> 0;
<a name="l00098"></a>00098 
<a name="l00099"></a>00099     uint8_t *ret_buf = 0;
<a name="l00100"></a>00100     <span class="comment">// the last time we got called, the second buffer was in PDC next</span>
<a name="l00101"></a>00101     <span class="keywordflow">if</span> (is_second_buf_next)
<a name="l00102"></a>00102     {
<a name="l00103"></a>00103         is_second_buf_next = <span class="keyword">false</span>;
<a name="l00104"></a>00104         ret_buf = play_buf1;
<a name="l00105"></a>00105     }
<a name="l00106"></a>00106     <span class="comment">// the last time the first buffer was in PDC next</span>
<a name="l00107"></a>00107     <span class="keywordflow">else</span>
<a name="l00108"></a>00108     {
<a name="l00109"></a>00109         is_second_buf_next = <span class="keyword">true</span>;
<a name="l00110"></a>00110         ret_buf = play_buf2;
<a name="l00111"></a>00111     }
<a name="l00112"></a>00112 
<a name="l00113"></a>00113     <span class="keywordflow">if</span> (ret_buf)
<a name="l00114"></a>00114     {
<a name="l00115"></a>00115         <a class="code" href="sam3__ssc_8h.html#adb2b8483e2a43e20f1922899e3456e03" title="Transmit next pointer register address.">SSC_TNPR</a> = (reg32_t) ret_buf;
<a name="l00116"></a>00116         <a class="code" href="sam3__ssc_8h.html#ac95b3208d26eea6e6deb2d04b1151311" title="Transmit next counter register address.">SSC_TNCR</a> = PDC_COUNT;
<a name="l00117"></a>00117     }
<a name="l00118"></a>00118     <span class="keywordflow">return</span> ret_buf;
<a name="l00119"></a>00119 }
<a name="l00120"></a>00120 
<a name="l00121"></a><a class="code" href="i2s__at91_8h.html#a9c2b2161a0f64d2e53f9210290b11731">00121</a> <span class="keywordtype">bool</span> <a class="code" href="i2s__at91_8c.html#a9c2b2161a0f64d2e53f9210290b11731" title="Starts playing from I2S_FIRST_BUFFER.">i2s_start</a>(<span class="keywordtype">void</span>)
<a name="l00122"></a>00122 {
<a name="l00123"></a>00123     <span class="comment">/* Some time must pass between disabling and enabling again the transmission</span>
<a name="l00124"></a>00124 <span class="comment">     * on SSC. A good empirical value seems &gt;15 us. We try to avoid putting an</span>
<a name="l00125"></a>00125 <span class="comment">     * explicit delay, instead we disable the transmitter when a sound finishes</span>
<a name="l00126"></a>00126 <span class="comment">     * and hope that the delay has passed before we enter here again.</span>
<a name="l00127"></a>00127 <span class="comment">     */</span>
<a name="l00128"></a>00128     <a class="code" href="sam3__ssc_8h.html#a8333a0d563246b070743867d7ee973be" title="Control register address.">SSC_CR</a> = <a class="code" href="group__macros.html#ga663d8c125655d41622b1e6bc96e5d63d" title="Convert a bit value to a binary flag.">BV</a>(<a class="code" href="at91__ssc_8h.html#a9a8d978d3ed119f0ccd8961a1b6266dd" title="Transmit disable.">SSC_TXDIS</a>);
<a name="l00129"></a>00129     <a class="code" href="group__drv__timers.html#gace6fb3d382bd740f9cee1b139e12f7a6" title="Wait some time [ms].">timer_delay</a>(10);
<a name="l00130"></a>00130 
<a name="l00131"></a>00131     <a class="code" href="sam3__ssc_8h.html#a70d36d980f37d82af6c279119076ca73" title="Transfer control register address.">SSC_PTCR</a> = <a class="code" href="group__macros.html#ga663d8c125655d41622b1e6bc96e5d63d" title="Convert a bit value to a binary flag.">BV</a>(PDC_TXTDIS);
<a name="l00132"></a>00132     <a class="code" href="sam3__ssc_8h.html#a4681441f3dca8575f8d989cc4b34154d" title="Transmit pointer register address.">SSC_TPR</a> = (reg32_t)play_buf1;
<a name="l00133"></a>00133     <a class="code" href="sam3__ssc_8h.html#a368b0ef7321235e9316078e4b725fa63" title="Transmit counter register address.">SSC_TCR</a> = PDC_COUNT;
<a name="l00134"></a>00134     <a class="code" href="sam3__ssc_8h.html#adb2b8483e2a43e20f1922899e3456e03" title="Transmit next pointer register address.">SSC_TNPR</a> = (reg32_t)play_buf2;
<a name="l00135"></a>00135     <a class="code" href="sam3__ssc_8h.html#ac95b3208d26eea6e6deb2d04b1151311" title="Transmit next counter register address.">SSC_TNCR</a> = PDC_COUNT;
<a name="l00136"></a>00136     is_second_buf_next = <span class="keyword">true</span>;
<a name="l00137"></a>00137 
<a name="l00138"></a>00138     <a class="code" href="sam3__ssc_8h.html#a70d36d980f37d82af6c279119076ca73" title="Transfer control register address.">SSC_PTCR</a> = <a class="code" href="group__macros.html#ga663d8c125655d41622b1e6bc96e5d63d" title="Convert a bit value to a binary flag.">BV</a>(PDC_TXTEN);
<a name="l00139"></a>00139 
<a name="l00140"></a>00140     <span class="comment">/* enable output */</span>
<a name="l00141"></a>00141     <a class="code" href="sam3__ssc_8h.html#a8333a0d563246b070743867d7ee973be" title="Control register address.">SSC_CR</a> = <a class="code" href="group__macros.html#ga663d8c125655d41622b1e6bc96e5d63d" title="Convert a bit value to a binary flag.">BV</a>(<a class="code" href="at91__ssc_8h.html#a52971a900b884e14ec1b05b9db293a9e" title="Transmit enable.">SSC_TXEN</a>);
<a name="l00142"></a>00142 
<a name="l00143"></a>00143     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00144"></a>00144 }
<a name="l00145"></a>00145 
<a name="l00146"></a>00146 <span class="preprocessor">#define BITS_PER_CHANNEL 16</span>
<a name="l00147"></a>00147 <span class="preprocessor"></span><span class="preprocessor">#define N_OF_CHANNEL 2</span>
<a name="l00148"></a>00148 <span class="preprocessor"></span><span class="comment">// TODO: check the computed value?</span>
<a name="l00149"></a>00149 <span class="comment">/* The last parameter (2) is due to the hadware on at91sam7s. */</span>
<a name="l00150"></a>00150 <span class="preprocessor">#define MCK_DIV (CPU_FREQ / CONFIG_SAMPLE_FREQ / BITS_PER_CHANNEL / N_OF_CHANNEL / 2)</span>
<a name="l00151"></a>00151 <span class="preprocessor"></span>
<a name="l00152"></a>00152 <span class="preprocessor">#define CONFIG_DELAY 1</span>
<a name="l00153"></a>00153 <span class="preprocessor"></span><span class="preprocessor">#define CONFIG_PERIOD 15</span>
<a name="l00154"></a>00154 <span class="preprocessor"></span><span class="preprocessor">#define CONFIG_DATNB  1</span>
<a name="l00155"></a>00155 <span class="preprocessor"></span><span class="preprocessor">#define CONFIG_FSLEN 15</span>
<a name="l00156"></a>00156 <span class="preprocessor"></span>
<a name="l00157"></a>00157 <span class="preprocessor">#define DELAY ((CONFIG_DELAY &lt;&lt; SSC_STTDLY_SHIFT) &amp; SSC_STTDLY_MASK)</span>
<a name="l00158"></a>00158 <span class="preprocessor"></span><span class="preprocessor">#define PERIOD ((CONFIG_PERIOD &lt;&lt; (SSC_PERIOD_SHIFT)) &amp; SSC_PERIOD_MASK)</span>
<a name="l00159"></a>00159 <span class="preprocessor"></span><span class="preprocessor">#define DATNB ((CONFIG_DATNB &lt;&lt; SSC_DATNB_SHIFT) &amp; SSC_DATNB_MASK)</span>
<a name="l00160"></a>00160 <span class="preprocessor"></span><span class="preprocessor">#define FSLEN ((CONFIG_FSLEN &lt;&lt; SSC_FSLEN_SHIFT) &amp; SSC_FSLEN_MASK)</span>
<a name="l00161"></a>00161 <span class="preprocessor"></span>
<a name="l00162"></a>00162 <span class="preprocessor">#define SSC_DMA_IRQ_PRIORITY 5</span>
<a name="l00163"></a>00163 <span class="preprocessor"></span>
<a name="l00164"></a><a class="code" href="i2s__at91_8h.html#a73ce4945fabc9a4bb717a57ea4bdfd17">00164</a> <span class="keywordtype">void</span> <a class="code" href="i2s__at91_8c.html#a73ce4945fabc9a4bb717a57ea4bdfd17" title="Initializes the module and sets current buffer to I2S_FIRST_BUF.">i2s_init</a>(<span class="keywordtype">void</span>)
<a name="l00165"></a>00165 {
<a name="l00166"></a>00166     <a class="code" href="sam3__pio_8h.html#a5f995a869c97e633de77b4a8576c7ab4" title="PIO disable register address.">PIOA_PDR</a> = <a class="code" href="group__macros.html#ga663d8c125655d41622b1e6bc96e5d63d" title="Convert a bit value to a binary flag.">BV</a>(SSC_TK) | <a class="code" href="group__macros.html#ga663d8c125655d41622b1e6bc96e5d63d" title="Convert a bit value to a binary flag.">BV</a>(SSC_TF) | <a class="code" href="group__macros.html#ga663d8c125655d41622b1e6bc96e5d63d" title="Convert a bit value to a binary flag.">BV</a>(SSC_TD);
<a name="l00167"></a>00167     <span class="comment">/* reset device */</span>
<a name="l00168"></a>00168     <a class="code" href="sam3__ssc_8h.html#a8333a0d563246b070743867d7ee973be" title="Control register address.">SSC_CR</a> = <a class="code" href="group__macros.html#ga663d8c125655d41622b1e6bc96e5d63d" title="Convert a bit value to a binary flag.">BV</a>(<a class="code" href="at91__ssc_8h.html#aa73f76a4cffadbedc4a637a34aa14b26" title="Software reset.">SSC_SWRST</a>);
<a name="l00169"></a>00169 
<a name="l00170"></a>00170     <a class="code" href="sam3__ssc_8h.html#ad3108df745eed38dbacdf7af537e1e8b" title="Clock mode register address.">SSC_CMR</a> = MCK_DIV &amp; <a class="code" href="at91__ssc_8h.html#acbba0dd0eb079a5a6bde1c225d38dfd8" title="Clock divider.">SSC_DIV_MASK</a>;
<a name="l00171"></a>00171     <a class="code" href="sam3__ssc_8h.html#a3ee6649e3943ba66a740c5210e81c40a" title="Transmit clock mode register address.">SSC_TCMR</a> = <a class="code" href="at91__ssc_8h.html#a5e4731a2181099d48e440e5289eac33b" title="Divided clock.">SSC_CKS_DIV</a> | <a class="code" href="at91__ssc_8h.html#aed78a72d80324bbf3284b858e0955ba3" title="Continous receive clock.">SSC_CKO_CONT</a> | <a class="code" href="at91__ssc_8h.html#a75a7d42e7e9cf9f932ec86f428d21723" title="None, continous clock.">SSC_CKG_NONE</a> | DELAY | PERIOD | <a class="code" href="at91__ssc_8h.html#a7dca4e9790c2a1caeb5029aa5e1ced23" title="Receive start on falling edge RF.">SSC_START_FALL_F</a>;
<a name="l00172"></a>00172     <a class="code" href="sam3__ssc_8h.html#aa862d4063504db595007b721590dd8a2" title="Transmit frame mode register address.">SSC_TFMR</a> = DATALEN | DATNB | FSLEN | <a class="code" href="group__macros.html#ga663d8c125655d41622b1e6bc96e5d63d" title="Convert a bit value to a binary flag.">BV</a>(<a class="code" href="at91__ssc_8h.html#a4b1513ef77f139e9ca9550c1180e54e5" title="Most significant bit first.">SSC_MSBF</a>) | <a class="code" href="at91__ssc_8h.html#a9b3f2bc75d759f4779adaa67b6893bbf" title="Negative pulse.">SSC_FSOS_NEGATIVE</a>;
<a name="l00173"></a>00173 
<a name="l00174"></a>00174     <span class="comment">/* Disable all irqs */</span>
<a name="l00175"></a>00175     <a class="code" href="sam3__ssc_8h.html#a808b994115af005bf8529aae4cc4b3fd" title="Interrupt disable register address.">SSC_IDR</a> = 0xFFFFFFFF;
<a name="l00176"></a>00176 
<a name="l00177"></a>00177     <span class="comment">/* Enable the SSC IRQ */</span>
<a name="l00178"></a>00178     <a class="code" href="at91__aic_8h.html#a45352b181aa207c667ae1a30c878044f" title="Interrupt enable command register address.">AIC_IECR</a> = <a class="code" href="group__macros.html#ga663d8c125655d41622b1e6bc96e5d63d" title="Convert a bit value to a binary flag.">BV</a>(SSC_ID);
<a name="l00179"></a>00179 
<a name="l00180"></a>00180     <span class="comment">/* enable i2s */</span>
<a name="l00181"></a>00181     <a class="code" href="at91__pmc_8h.html#a17654b41c5f9f88c153bad07eaaf9afc" title="Peripheral clock enable register address.">PMC_PCER</a> = <a class="code" href="group__macros.html#ga663d8c125655d41622b1e6bc96e5d63d" title="Convert a bit value to a binary flag.">BV</a>(SSC_ID);
<a name="l00182"></a>00182 
<a name="l00183"></a>00183     <span class="comment">/* Enable SSC */</span>
<a name="l00184"></a>00184     <a class="code" href="sam3__ssc_8h.html#a8333a0d563246b070743867d7ee973be" title="Control register address.">SSC_CR</a> = <a class="code" href="group__macros.html#ga663d8c125655d41622b1e6bc96e5d63d" title="Convert a bit value to a binary flag.">BV</a>(<a class="code" href="at91__ssc_8h.html#a52971a900b884e14ec1b05b9db293a9e" title="Transmit enable.">SSC_TXEN</a>);
<a name="l00185"></a>00185 }
</pre></div></div>
</div>


