

<!-- Generated by Doxygen 1.7.4 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="dir_9fd71c1ac00056e7d855336b2291c56c.html">bertos</a>      </li>
      <li class="navelem"><a class="el" href="dir_e91c80130e425b11d52da5b92a7aa933.html">net</a>      </li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="summary">
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle">
<div class="title">pocketcmd.c File Reference</div>  </div>
</div>
<div class="contents">

<p>pocketBus protocol Command layer implementation.  
<a href="#details">More...</a></p>
<div class="textblock"><code>#include &quot;<a class="el" href="pocketcmd_8h_source.html">pocketcmd.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="pocketbus_8h_source.html">pocketbus.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="cfg__pocketbus_8h_source.html">cfg/cfg_pocketbus.h</a>&quot;</code><br/>
<code>#include &lt;<a class="el" href="log_8h_source.html">cfg/log.h</a>&gt;</code><br/>
<code>#include &lt;<a class="el" href="debug_8h_source.html">cfg/debug.h</a>&gt;</code><br/>
<code>#include &lt;<a class="el" href="macros_8h_source.html">cfg/macros.h</a>&gt;</code><br/>
<code>#include &lt;<a class="el" href="module_8h_source.html">cfg/module.h</a>&gt;</code><br/>
<code>#include &lt;<a class="el" href="timer_8h_source.html">drv/timer.h</a>&gt;</code><br/>
<code>#include &lt;<a class="el" href="cpu_2byteorder_8h_source.html">cpu/byteorder.h</a>&gt;</code><br/>
<code>#include &lt;<a class="el" href="detect_8h_source.html">cpu/detect.h</a>&gt;</code><br/>
<code>#include &lt;string.h&gt;</code><br/>
</div>
<p><a href="pocketcmd_8c_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr><td colspan="2"><h2><a name="func-members"></a>
Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="pocketcmd_8c.html#a03d8be6ba197eafbd3cf7985eb6a92d5">pocketcmd_poll</a> (struct <a class="el" href="structPocketCmdCtx.html">PocketCmdCtx</a> *ctx)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">pocketBus Command poll function.  <a href="#a03d8be6ba197eafbd3cf7985eb6a92d5"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="pocketcmd_8c.html#a23fc67283834014609b06cd4b318fc9e">pocketcmd_recv</a> (struct <a class="el" href="structPocketCmdCtx.html">PocketCmdCtx</a> *ctx, <a class="el" href="structPocketCmdMsg.html">PocketCmdMsg</a> *recv_msg)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">pocketBus Command recv function.  <a href="#a23fc67283834014609b06cd4b318fc9e"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="pocketcmd_8c.html#a42cde2e81868cb68d11bc4b2ae50d354">pocketcmd_send</a> (struct <a class="el" href="structPocketCmdCtx.html">PocketCmdCtx</a> *ctx, <a class="el" href="pocketcmd_8h.html#affe678a12b9a8f6f3238b24e8eb4a9d7">pocketcmd_t</a> cmd, const void *buf, size_t len, bool wait_reply)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Send command <em>cmd</em> to/from slave adding <em>len</em> arguments in <em>buf</em>.  <a href="#a42cde2e81868cb68d11bc4b2ae50d354"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="pocketcmd_8c.html#a4d1eb2686d1093319c9165f8e82804ce">pocketcmd_init</a> (struct <a class="el" href="structPocketCmdCtx.html">PocketCmdCtx</a> *ctx, struct <a class="el" href="structPocketBusCtx.html">PocketBusCtx</a> *bus_ctx, <a class="el" href="pocketbus_8h.html#af63b5ecec3f1a8ffaf7d711181392dec">pocketbus_addr_t</a> addr, <a class="el" href="pocketcmd_8h.html#af46331528972d3b475ed35e3fc006617">pocketcmd_lookup_t</a> search)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Init pocketBus command layer.  <a href="#a4d1eb2686d1093319c9165f8e82804ce"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="ab19c58e94373dffa1aaad2922db4ac16"></a><!-- doxytag: member="pocketcmd.c::pocketcmd_replyAck" ref="ab19c58e94373dffa1aaad2922db4ac16" args="(struct PocketCmdMsg *msg)" -->
void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="pocketcmd_8c.html#ab19c58e94373dffa1aaad2922db4ac16">pocketcmd_replyAck</a> (struct <a class="el" href="structPocketCmdMsg.html">PocketCmdMsg</a> *msg)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Helper function used to reply to master with an ACK. <br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a5060e7ace57fad7f8fb9debf50faff41"></a><!-- doxytag: member="pocketcmd.c::pocketcmd_replyNak" ref="a5060e7ace57fad7f8fb9debf50faff41" args="(struct PocketCmdMsg *msg)" -->
void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="pocketcmd_8c.html#a5060e7ace57fad7f8fb9debf50faff41">pocketcmd_replyNak</a> (struct <a class="el" href="structPocketCmdMsg.html">PocketCmdMsg</a> *msg)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Helper function used to reply to master with a NAK. <br/></td></tr>
</table>
<hr/><a name="details" id="details"></a><h2>Detailed Description</h2>
<div class="textblock"><p>pocketBus protocol Command layer implementation. </p>
<p>This module implements command layer over pocketBus protocol. Payload packets received by pocketBus are first checked for address matching. If a packet is addressed to us we look for a suitable callback function to call.</p>
<p>The received payload format is as follows: </p>
<pre>
 +----------------------------------------+
 |  CMD |            DATA                 |
 +----------------------------------------+
 |      |                                 |
 +  2B  +           0..N Byte             +
 </pre><p>The CMD ID used is the same supplied by the master when the command was sent.</p>
<dl class="author"><dt><b>Author:</b></dt><dd>Francesco Sacchi &lt;<a href="mailto:batt@develer.com">batt@develer.com</a>&gt; </dd></dl>

<p>Definition in file <a class="el" href="pocketcmd_8c_source.html">pocketcmd.c</a>.</p>
</div><hr/><h2>Function Documentation</h2>
<a class="anchor" id="a4d1eb2686d1093319c9165f8e82804ce"></a><!-- doxytag: member="pocketcmd.c::pocketcmd_init" ref="a4d1eb2686d1093319c9165f8e82804ce" args="(struct PocketCmdCtx *ctx, struct PocketBusCtx *bus_ctx, pocketbus_addr_t addr, pocketcmd_lookup_t search)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void pocketcmd_init </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structPocketCmdCtx.html">PocketCmdCtx</a> *&#160;</td>
          <td class="paramname"><em>ctx</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structPocketBusCtx.html">PocketBusCtx</a> *&#160;</td>
          <td class="paramname"><em>bus_ctx</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="pocketbus_8h.html#af63b5ecec3f1a8ffaf7d711181392dec">pocketbus_addr_t</a>&#160;</td>
          <td class="paramname"><em>addr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="pocketcmd_8h.html#af46331528972d3b475ed35e3fc006617">pocketcmd_lookup_t</a>&#160;</td>
          <td class="paramname"><em>search</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Init pocketBus command layer. </p>
<p><em>ctx</em> is pocketBus command layer context. <em>bus_ctx</em> is pocketBus context. <em>addr</em> is slave address (see pocketcmd_setAddr for details.) <em>search</em> is the lookup function used to search command ID callbacks. </p>

<p>Definition at line <a class="el" href="pocketcmd_8c_source.html#l00197">197</a> of file <a class="el" href="pocketcmd_8c_source.html">pocketcmd.c</a>.</p>

</div>
</div>
<a class="anchor" id="a03d8be6ba197eafbd3cf7985eb6a92d5"></a><!-- doxytag: member="pocketcmd.c::pocketcmd_poll" ref="a03d8be6ba197eafbd3cf7985eb6a92d5" args="(struct PocketCmdCtx *ctx)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void pocketcmd_poll </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structPocketCmdCtx.html">PocketCmdCtx</a> *&#160;</td>
          <td class="paramname"><em>ctx</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>pocketBus Command poll function. </p>
<p>Call it to read and process pocketBus commands. </p>

<p>Definition at line <a class="el" href="pocketcmd_8c_source.html#l00080">80</a> of file <a class="el" href="pocketcmd_8c_source.html">pocketcmd.c</a>.</p>

</div>
</div>
<a class="anchor" id="a23fc67283834014609b06cd4b318fc9e"></a><!-- doxytag: member="pocketcmd.c::pocketcmd_recv" ref="a23fc67283834014609b06cd4b318fc9e" args="(struct PocketCmdCtx *ctx, PocketCmdMsg *recv_msg)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool pocketcmd_recv </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structPocketCmdCtx.html">PocketCmdCtx</a> *&#160;</td>
          <td class="paramname"><em>ctx</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structPocketCmdMsg.html">PocketCmdMsg</a> *&#160;</td>
          <td class="paramname"><em>recv_msg</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>pocketBus Command recv function. </p>
<p>Call it to read and process pocketBus commands. </p>

<p>Definition at line <a class="el" href="pocketcmd_8c_source.html#l00100">100</a> of file <a class="el" href="pocketcmd_8c_source.html">pocketcmd.c</a>.</p>

</div>
</div>
<a class="anchor" id="a42cde2e81868cb68d11bc4b2ae50d354"></a><!-- doxytag: member="pocketcmd.c::pocketcmd_send" ref="a42cde2e81868cb68d11bc4b2ae50d354" args="(struct PocketCmdCtx *ctx, pocketcmd_t cmd, const void *buf, size_t len, bool wait_reply)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool pocketcmd_send </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structPocketCmdCtx.html">PocketCmdCtx</a> *&#160;</td>
          <td class="paramname"><em>ctx</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="pocketcmd_8h.html#affe678a12b9a8f6f3238b24e8eb4a9d7">pocketcmd_t</a>&#160;</td>
          <td class="paramname"><em>cmd</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const void *&#160;</td>
          <td class="paramname"><em>buf</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">size_t&#160;</td>
          <td class="paramname"><em>len</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">bool&#160;</td>
          <td class="paramname"><em>wait_reply</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Send command <em>cmd</em> to/from slave adding <em>len</em> arguments in <em>buf</em>. </p>
<p>Address used is contained in <em>ctx-&gt;addr</em> . If we are master and the message has a reply, you must set <em>wait_reply</em> to true. </p>
<dl class="return"><dt><b>Returns:</b></dt><dd>true if all is ok, false if we are already waiting a replay from another slave. </dd></dl>

<p>Definition at line <a class="el" href="pocketcmd_8c_source.html#l00154">154</a> of file <a class="el" href="pocketcmd_8c_source.html">pocketcmd.c</a>.</p>

</div>
</div>
</div>


