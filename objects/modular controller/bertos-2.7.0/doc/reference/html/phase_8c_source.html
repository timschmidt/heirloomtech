

<!-- Generated by Doxygen 1.7.4 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="dir_9fd71c1ac00056e7d855336b2291c56c.html">bertos</a>      </li>
      <li class="navelem"><a class="el" href="dir_f7c89dbd63e8f34e572fe939945c15d7.html">drv</a>      </li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">phase.c</div>  </div>
</div>
<div class="contents">
<a href="phase_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 
<a name="l00039"></a>00039 <span class="preprocessor">#include &quot;<a class="code" href="hw__phase_8h.html" title="Phase control hardware-specific definitions.">hw/hw_phase.h</a>&quot;</span>
<a name="l00040"></a>00040 
<a name="l00041"></a>00041 <span class="preprocessor">#include &lt;<a class="code" href="macros_8h.html">cfg/macros.h</a>&gt;</span>
<a name="l00042"></a>00042 <span class="preprocessor">#include &lt;<a class="code" href="compiler_8h.html" title="Additional support macros for compiler independance.">cfg/compiler.h</a>&gt;</span>
<a name="l00043"></a>00043 
<a name="l00044"></a>00044 <span class="preprocessor">#include &lt;<a class="code" href="cpu_2irq_8h.html" title="CPU-specific IRQ definitions.">cpu/irq.h</a>&gt;</span>
<a name="l00045"></a>00045 <span class="preprocessor">#include &lt;<a class="code" href="types_8h.html" title="CPU-specific type definitions.">cpu/types.h</a>&gt;</span>
<a name="l00046"></a>00046 
<a name="l00047"></a>00047 <span class="preprocessor">#include &lt;<a class="code" href="timer_8h.html">drv/timer.h</a>&gt;</span>
<a name="l00048"></a>00048 <span class="preprocessor">#include &lt;<a class="code" href="phase_8h.html" title="Phase partialization driver with TRIACs.">drv/phase.h</a>&gt;</span>
<a name="l00049"></a>00049 
<a name="l00050"></a>00050 <span class="preprocessor">#include &lt;math.h&gt;</span>
<a name="l00051"></a>00051 
<a name="l00053"></a><a class="code" href="phase_8c.html#a99acf0f08fc2dc5638d7f8aeebd34422">00053</a> <span class="keyword">static</span> Triac <a class="code" href="phase_8c.html#a99acf0f08fc2dc5638d7f8aeebd34422" title="Array of triacs.">triacs</a>[TRIAC_CNT];
<a name="l00054"></a>00054 
<a name="l00055"></a>00055 <a class="code" href="group__debug.html#ga5ae59b9945c3ef623af1719976ef3a1f" title="This macro can be used to conditionally exclude one or more statements conditioned on _DEBUG...">DB</a>(<span class="keywordtype">bool</span> phase_initialized;)
<a name="l00056"></a>00056 
<a name="l00064"></a><a class="code" href="phase_8c.html#a399f67d90ac15b304dc9d3045fecdb45">00064</a> <a class="code" href="phase_8c.html#a399f67d90ac15b304dc9d3045fecdb45" title="Zerocross interrupt, call when 220V cross zero.">DEFINE_ZEROCROSS_ISR</a>()
<a name="l00065"></a>00065 {
<a name="l00066"></a>00066     <a class="code" href="compiler_8h.html#a9f2d272efa5f391ffc4b9ec4eb59fa88" title="Type for time expressed in ticks.">ticks_t</a> period, now;
<a name="l00067"></a>00067     <span class="keyword">static</span> <a class="code" href="compiler_8h.html#a9f2d272efa5f391ffc4b9ec4eb59fa88" title="Type for time expressed in ticks.">ticks_t</a> prev_time;
<a name="l00068"></a>00068     TriacDev dev;
<a name="l00069"></a>00069 
<a name="l00070"></a>00070     now = <a class="code" href="group__drv__timers.html#ga91dc8903e46f81c8490adaec8f2b5069" title="Faster version of timer_clock(), to be called only when the timer interrupt is disabled (DISABLE_INTS...">timer_clock_unlocked</a>();
<a name="l00071"></a>00071     period = now - prev_time;
<a name="l00072"></a>00072 
<a name="l00073"></a>00073     <span class="keywordflow">for</span> (dev = 0; dev &lt; TRIAC_CNT; dev++)
<a name="l00074"></a>00074     {
<a name="l00075"></a>00075         <span class="comment">/* Only turn off triac if duty is != 100% */</span>
<a name="l00076"></a>00076         <span class="keywordflow">if</span> (<a class="code" href="phase_8c.html#a99acf0f08fc2dc5638d7f8aeebd34422" title="Array of triacs.">triacs</a>[dev].duty != <a class="code" href="cfg__phase_8h.html#a7a3e8b6747711ef8381c4f891fa32024" title="Max value of the duty cycle on triac.">CONFIG_TRIAC_MAX_DUTY</a>)
<a name="l00077"></a>00077             TRIAC_OFF(dev);
<a name="l00078"></a>00078         <span class="comment">/* Compute delay from duty */</span>
<a name="l00079"></a>00079         <a class="code" href="group__drv__timers.html#ga74311fd08b3bfdecb496f16b7465715b" title="Set the timer delay (the time before the event will be triggered)">timer_setDelay</a>(&amp;<a class="code" href="phase_8c.html#a99acf0f08fc2dc5638d7f8aeebd34422" title="Array of triacs.">triacs</a>[dev].timer, <a class="code" href="group__macros.html#ga1ddec5826f8a1f9010183107bb77c06d" title="Perform an integer division rounding the result to the nearest int value.">DIV_ROUND</a>(period * (<a class="code" href="cfg__phase_8h.html#a7a3e8b6747711ef8381c4f891fa32024" title="Max value of the duty cycle on triac.">CONFIG_TRIAC_MAX_DUTY</a> - <a class="code" href="phase_8c.html#a99acf0f08fc2dc5638d7f8aeebd34422" title="Array of triacs.">triacs</a>[dev].duty), <a class="code" href="cfg__phase_8h.html#a7a3e8b6747711ef8381c4f891fa32024" title="Max value of the duty cycle on triac.">CONFIG_TRIAC_MAX_DUTY</a>));
<a name="l00080"></a>00080 
<a name="l00081"></a>00081         <span class="comment">/* This check avoids inserting the same timer twice</span>
<a name="l00082"></a>00082 <span class="comment">         * in case of an intempestive zerocross or spike */</span>
<a name="l00083"></a>00083         <span class="keywordflow">if</span> (<a class="code" href="phase_8c.html#a99acf0f08fc2dc5638d7f8aeebd34422" title="Array of triacs.">triacs</a>[dev].running)
<a name="l00084"></a>00084         {
<a name="l00085"></a>00085             <a class="code" href="group__drv__timers.html#ga083b16dd889741b74ca1142fd6498ae9" title="Remove a timer from the timers queue before it has expired.">timer_abort</a>(&amp;<a class="code" href="phase_8c.html#a99acf0f08fc2dc5638d7f8aeebd34422" title="Array of triacs.">triacs</a>[dev].timer);
<a name="l00086"></a>00086             <span class="comment">//kprintf(&quot;[%lu]\n&quot;, timer_clock());</span>
<a name="l00087"></a>00087         }
<a name="l00088"></a>00088 
<a name="l00089"></a>00089         <a class="code" href="phase_8c.html#a99acf0f08fc2dc5638d7f8aeebd34422" title="Array of triacs.">triacs</a>[dev].running = <span class="keyword">true</span>;
<a name="l00090"></a>00090         <a class="code" href="group__drv__timers.html#ga31b280936e453dff724b326c0309af4c" title="Add the specified timer to the software timer service queue.">timer_add</a>(&amp;<a class="code" href="phase_8c.html#a99acf0f08fc2dc5638d7f8aeebd34422" title="Array of triacs.">triacs</a>[dev].timer);
<a name="l00091"></a>00091     }
<a name="l00092"></a>00092     prev_time = now;
<a name="l00093"></a>00093 }
<a name="l00094"></a>00094 
<a name="l00095"></a>00095 
<a name="l00096"></a>00096 
<a name="l00100"></a><a class="code" href="phase_8h.html#a56eb4dd06d6304ec88fb52bd714dcc23">00100</a> <span class="keywordtype">void</span> <a class="code" href="phase_8c.html#a56eb4dd06d6304ec88fb52bd714dcc23" title="Set duty of the triac channel dev (interrupt safe).">phase_setDuty</a>(TriacDev dev, triac_duty_t duty)
<a name="l00101"></a>00101 {
<a name="l00102"></a>00102     cpu_flags_t flags;
<a name="l00103"></a>00103     IRQ_SAVE_DISABLE(flags);
<a name="l00104"></a>00104 
<a name="l00105"></a>00105     <a class="code" href="phase_8c.html#a26204f92fbebed1e8106574087fb3364" title="Set duty of the triac channel dev (NOT INTERRUPT SAFE).">phase_setDutyUnlock</a>(dev,duty);
<a name="l00106"></a>00106 
<a name="l00107"></a>00107     IRQ_RESTORE(flags);
<a name="l00108"></a>00108 }
<a name="l00109"></a>00109 
<a name="l00110"></a>00110 
<a name="l00111"></a>00111 
<a name="l00115"></a><a class="code" href="phase_8h.html#a26204f92fbebed1e8106574087fb3364">00115</a> <span class="keywordtype">void</span> <a class="code" href="phase_8c.html#a26204f92fbebed1e8106574087fb3364" title="Set duty of the triac channel dev (NOT INTERRUPT SAFE).">phase_setDutyUnlock</a>(TriacDev dev, triac_duty_t duty)
<a name="l00116"></a>00116 {
<a name="l00117"></a>00117     <a class="code" href="phase_8c.html#a99acf0f08fc2dc5638d7f8aeebd34422" title="Array of triacs.">triacs</a>[dev].duty = MIN(duty, (triac_duty_t)<a class="code" href="cfg__phase_8h.html#a7a3e8b6747711ef8381c4f891fa32024" title="Max value of the duty cycle on triac.">CONFIG_TRIAC_MAX_DUTY</a>);
<a name="l00118"></a>00118 }
<a name="l00119"></a>00119 
<a name="l00120"></a>00120 
<a name="l00121"></a>00121 
<a name="l00128"></a><a class="code" href="phase_8h.html#af61a516675a997b877dd85e4c1c87a14">00128</a> <span class="keywordtype">void</span> <a class="code" href="phase_8c.html#af61a516675a997b877dd85e4c1c87a14" title="Set power of the triac channel dev (interrupt safe).">phase_setPower</a>(TriacDev dev, triac_power_t power)
<a name="l00129"></a>00129 {
<a name="l00130"></a>00130     <span class="keywordtype">bool</span> greater_fifty = <span class="keyword">false</span>;
<a name="l00131"></a>00131     triac_duty_t duty;
<a name="l00132"></a>00132 
<a name="l00133"></a>00133     power = MIN(power, (triac_power_t)<a class="code" href="cfg__phase_8h.html#a66685fd1198b7607a280aee926c32d46" title="Max value of the triac power.">CONFIG_TRIAC_MAX_POWER</a>);
<a name="l00134"></a>00134 
<a name="l00135"></a>00135     <span class="keywordflow">if</span> (power &gt; CONFIG_TRIAC_MAX_POWER / 2)
<a name="l00136"></a>00136     {
<a name="l00137"></a>00137         greater_fifty = <span class="keyword">true</span>;
<a name="l00138"></a>00138         power = CONFIG_TRIAC_MAX_POWER - power;
<a name="l00139"></a>00139     }
<a name="l00140"></a>00140 
<a name="l00141"></a>00141     duty = TRIAC_POWER_K * sqrt(power);
<a name="l00142"></a>00142 
<a name="l00143"></a>00143     <span class="keywordflow">if</span> (greater_fifty)
<a name="l00144"></a>00144         duty = <a class="code" href="cfg__phase_8h.html#a7a3e8b6747711ef8381c4f891fa32024" title="Max value of the duty cycle on triac.">CONFIG_TRIAC_MAX_DUTY</a> - duty;
<a name="l00145"></a>00145     <a class="code" href="phase_8c.html#a56eb4dd06d6304ec88fb52bd714dcc23" title="Set duty of the triac channel dev (interrupt safe).">phase_setDuty</a>(dev, duty);
<a name="l00146"></a>00146 }
<a name="l00147"></a>00147 
<a name="l00148"></a>00148 
<a name="l00149"></a>00149 
<a name="l00155"></a><a class="code" href="phase_8c.html#a823edd8bb0a53dc8b557c98daddc1db4">00155</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="phase_8c.html#a823edd8bb0a53dc8b557c98daddc1db4" title="Soft int for each _dev triac.">phase_softint</a>(<span class="keywordtype">void</span> *_dev)
<a name="l00156"></a>00156 {
<a name="l00157"></a>00157     TriacDev dev = (TriacDev)_dev;
<a name="l00158"></a>00158 
<a name="l00159"></a>00159     <span class="comment">/* Only turn on if duty is !=0 */</span>
<a name="l00160"></a>00160     <span class="keywordflow">if</span> (<a class="code" href="phase_8c.html#a99acf0f08fc2dc5638d7f8aeebd34422" title="Array of triacs.">triacs</a>[dev].duty)
<a name="l00161"></a>00161         TRIAC_ON(dev);
<a name="l00162"></a>00162     <a class="code" href="phase_8c.html#a99acf0f08fc2dc5638d7f8aeebd34422" title="Array of triacs.">triacs</a>[dev].running = <span class="keyword">false</span>;
<a name="l00163"></a>00163 }
<a name="l00164"></a>00164 
<a name="l00165"></a>00165 
<a name="l00166"></a>00166 
<a name="l00170"></a><a class="code" href="phase_8h.html#a5e43992dfa854b24be10d6c5913fc30e">00170</a> <span class="keywordtype">void</span> <a class="code" href="phase_8c.html#a5e43992dfa854b24be10d6c5913fc30e" title="Initialize phase control driver.">phase_init</a>(<span class="keywordtype">void</span>)
<a name="l00171"></a>00171 {
<a name="l00172"></a>00172     cpu_flags_t flags;
<a name="l00173"></a>00173     TriacDev dev;
<a name="l00174"></a>00174 
<a name="l00175"></a>00175     <span class="comment">/* Init timers and ensure that all triac are off */</span>
<a name="l00176"></a>00176     <span class="keywordflow">for</span> (dev = 0; dev &lt; TRIAC_CNT; dev++)
<a name="l00177"></a>00177     {
<a name="l00178"></a>00178         <a class="code" href="phase_8c.html#a99acf0f08fc2dc5638d7f8aeebd34422" title="Array of triacs.">triacs</a>[dev].duty = 0;
<a name="l00179"></a>00179         <a class="code" href="phase_8c.html#a99acf0f08fc2dc5638d7f8aeebd34422" title="Array of triacs.">triacs</a>[dev].running = <span class="keyword">false</span>;
<a name="l00180"></a>00180         SET_TRIAC_DDR(dev);
<a name="l00181"></a>00181         TRIAC_OFF(dev);
<a name="l00182"></a>00182         <a class="code" href="group__drv__timers.html#ga05183713aaa5b341bcda25af3837a111" title="Set the timer so that it calls an user hook when it expires.">timer_setSoftint</a>(&amp;<a class="code" href="phase_8c.html#a99acf0f08fc2dc5638d7f8aeebd34422" title="Array of triacs.">triacs</a>[dev].timer, (<a class="code" href="compiler_8h.html#a29da6a2c5167c69f4e05da8466f2b339" title="User defined callback type.">Hook</a>)<a class="code" href="phase_8c.html#a823edd8bb0a53dc8b557c98daddc1db4" title="Soft int for each _dev triac.">phase_softint</a>, (<span class="keywordtype">void</span> *)dev);
<a name="l00183"></a>00183     }
<a name="l00184"></a>00184     IRQ_SAVE_DISABLE(flags);
<a name="l00185"></a>00185 
<a name="l00186"></a>00186     <span class="comment">/* Init zero cross interrupt */</span>
<a name="l00187"></a>00187     PHASE_HW_INIT;
<a name="l00188"></a>00188     <a class="code" href="group__debug.html#ga5ae59b9945c3ef623af1719976ef3a1f" title="This macro can be used to conditionally exclude one or more statements conditioned on _DEBUG...">DB</a>(phase_initialized = <span class="keyword">true</span>;)
<a name="l00189"></a>00189     IRQ_RESTORE(flags);
<a name="l00190"></a>00190 }
<a name="l00191"></a>00191 
</pre></div></div>
</div>


