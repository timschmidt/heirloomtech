

<!-- Generated by Doxygen 1.7.4 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="dir_9fd71c1ac00056e7d855336b2291c56c.html">bertos</a>      </li>
      <li class="navelem"><a class="el" href="dir_cd5151ad4b595b3b6d6807653813384b.html">fs</a>      </li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">battfs.c</div>  </div>
</div>
<div class="contents">
<a href="battfs_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 
<a name="l00040"></a>00040 <span class="preprocessor">#include &quot;<a class="code" href="battfs_8h.html" title="BattFS: a filesystem for embedded platforms (interface). TODO: Add detailed filesystem description...">battfs.h</a>&quot;</span>
<a name="l00041"></a>00041 <span class="preprocessor">#include &quot;<a class="code" href="cfg__battfs_8h.html" title="Configuration file for BattFS module.">cfg/cfg_battfs.h</a>&quot;</span>
<a name="l00042"></a>00042 <span class="preprocessor">#include &lt;<a class="code" href="debug_8h.html">cfg/debug.h</a>&gt;</span>
<a name="l00043"></a>00043 <span class="preprocessor">#include &lt;<a class="code" href="macros_8h.html">cfg/macros.h</a>&gt;</span> <span class="comment">/* MIN, MAX */</span>
<a name="l00044"></a>00044 <span class="preprocessor">#include &lt;<a class="code" href="test_8h.html" title="Utility for the test suite.">cfg/test.h</a>&gt;</span>
<a name="l00045"></a>00045 <span class="preprocessor">#include &lt;<a class="code" href="cpu_2byteorder_8h.html" title="Functions to convert integers to/from host byte-order.">cpu/byteorder.h</a>&gt;</span> <span class="comment">/* cpu_to_xx */</span>
<a name="l00046"></a>00046 
<a name="l00047"></a>00047 <span class="preprocessor">#define LOG_LEVEL       BATTFS_LOG_LEVEL</span>
<a name="l00048"></a>00048 <span class="preprocessor"></span><span class="preprocessor">#define LOG_FORMAT      BATTFS_LOG_FORMAT</span>
<a name="l00049"></a>00049 <span class="preprocessor"></span><span class="preprocessor">#include &lt;<a class="code" href="log_8h.html">cfg/log.h</a>&gt;</span>
<a name="l00050"></a>00050 
<a name="l00051"></a>00051 <span class="preprocessor">#include &lt;string.h&gt;</span> <span class="comment">/* memset, memmove */</span>
<a name="l00052"></a>00052 
<a name="l00053"></a>00053 <span class="preprocessor">#if LOG_LEVEL &gt;= LOG_LVL_INFO</span>
<a name="l00054"></a>00054 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">void</span> dumpPageArray(<span class="keyword">struct</span> <a class="code" href="structBattFsSuper.html" title="Context used to describe a disk.">BattFsSuper</a> *disk)
<a name="l00055"></a>00055 {
<a name="l00056"></a>00056     kprintf(<span class="stringliteral">&quot;Page array dump, free_page_start %d:&quot;</span>, disk-&gt;<a class="code" href="structBattFsSuper.html#ac3d127852dca0d3de1fb9e5ccbec0ecd" title="Lowest address, in page array, for free pages.">free_page_start</a>);
<a name="l00057"></a>00057     <span class="keywordflow">for</span> (<a class="code" href="battfs_8h.html#ab696748712d719603833f401031a7907" title="Type for counting pages on disk.">pgcnt_t</a> i = 0; i &lt; disk-&gt;<a class="code" href="structBattFsSuper.html#a6da7bb93863793068a9ca2746fb035b4" title="Block device context (physical disk).">dev</a>-&gt;<a class="code" href="structKBlock.html#ad413baaa0d82a56b1006fd69acb53fcc" title="Number of blocks available in the device.">blk_cnt</a>; i++)
<a name="l00058"></a>00058     {
<a name="l00059"></a>00059         <span class="keywordflow">if</span> (!(i % 16))
<a name="l00060"></a>00060             kputchar(<span class="charliteral">&#39;\n&#39;</span>);
<a name="l00061"></a>00061         kprintf(<span class="stringliteral">&quot;%04d &quot;</span>, disk-&gt;<a class="code" href="structBattFsSuper.html#ae018010b1733f1a278a5c40792f393de" title="Page allocation array.">page_array</a>[i]);
<a name="l00062"></a>00062     }
<a name="l00063"></a>00063     kputchar(<span class="charliteral">&#39;\n&#39;</span>);
<a name="l00064"></a>00064 }
<a name="l00065"></a>00065 <span class="preprocessor">#endif</span>
<a name="l00066"></a>00066 <span class="preprocessor"></span>
<a name="l00071"></a><a class="code" href="battfs_8c.html#a2ab58e79b36e2d503e0a3197ca08b65a">00071</a> INLINE <span class="keywordtype">void</span> <a class="code" href="battfs_8c.html#a2ab58e79b36e2d503e0a3197ca08b65a" title="Convert from memory representation to disk structure.">battfs_to_disk</a>(<span class="keyword">struct</span> <a class="code" href="structBattFsPageHeader.html" title="BattFS page header, used to represent a page header in memory.">BattFsPageHeader</a> *hdr, uint8_t *buf)
<a name="l00072"></a>00072 {
<a name="l00073"></a>00073     <a class="code" href="compiler_8h.html#a695e64485eb9535f5ddcfec01167bddc" title="Issue a compilation error if the condition is false.">STATIC_ASSERT</a>(<a class="code" href="battfs_8h.html#a5f50d8650c7f510c735ea41d140fe8b6" title="Size of the header once saved on disk.">BATTFS_HEADER_LEN</a> == 12);
<a name="l00074"></a>00074     buf[0] = hdr-&gt;<a class="code" href="structBattFsPageHeader.html#a073705e71025f5e13f9ccd2f09f469ba" title="File inode (file identifier).">inode</a>;
<a name="l00075"></a>00075 
<a name="l00076"></a>00076     buf[1] = hdr-&gt;<a class="code" href="structBattFsPageHeader.html#a5c59ce00449c562009b680adef4aebe7" title="Filled bytes in page.">fill</a>;
<a name="l00077"></a>00077     buf[2] = hdr-&gt;<a class="code" href="structBattFsPageHeader.html#a5c59ce00449c562009b680adef4aebe7" title="Filled bytes in page.">fill</a> &gt;&gt; 8;
<a name="l00078"></a>00078 
<a name="l00079"></a>00079     buf[3] = hdr-&gt;<a class="code" href="structBattFsPageHeader.html#a8976d867f0fb78905c2a572e6cab2992" title="Page offset inside file.">pgoff</a>;
<a name="l00080"></a>00080     buf[4] = hdr-&gt;<a class="code" href="structBattFsPageHeader.html#a8976d867f0fb78905c2a572e6cab2992" title="Page offset inside file.">pgoff</a> &gt;&gt; 8;
<a name="l00081"></a>00081 
<a name="l00082"></a>00082     <span class="comment">/*</span>
<a name="l00083"></a>00083 <span class="comment">     * Sequence number is 40 bits long.</span>
<a name="l00084"></a>00084 <span class="comment">     * No need to take care of wraparonds: the memory will die first!</span>
<a name="l00085"></a>00085 <span class="comment">     */</span>
<a name="l00086"></a>00086     buf[5] = hdr-&gt;<a class="code" href="structBattFsPageHeader.html#aa819f5f419727fa1857635686710d34b" title="Page sequence number.">seq</a>;
<a name="l00087"></a>00087     buf[6] = hdr-&gt;<a class="code" href="structBattFsPageHeader.html#aa819f5f419727fa1857635686710d34b" title="Page sequence number.">seq</a> &gt;&gt; 8;
<a name="l00088"></a>00088     buf[7] = hdr-&gt;<a class="code" href="structBattFsPageHeader.html#aa819f5f419727fa1857635686710d34b" title="Page sequence number.">seq</a> &gt;&gt; 16;
<a name="l00089"></a>00089     buf[8] = hdr-&gt;<a class="code" href="structBattFsPageHeader.html#aa819f5f419727fa1857635686710d34b" title="Page sequence number.">seq</a> &gt;&gt; 24;
<a name="l00090"></a>00090     buf[9] = hdr-&gt;<a class="code" href="structBattFsPageHeader.html#aa819f5f419727fa1857635686710d34b" title="Page sequence number.">seq</a> &gt;&gt; 32;
<a name="l00091"></a>00091 
<a name="l00092"></a>00092     <span class="comment">/*</span>
<a name="l00093"></a>00093 <span class="comment">     * This field must be the last one!</span>
<a name="l00094"></a>00094 <span class="comment">     * This is needed because if the page is only partially</span>
<a name="l00095"></a>00095 <span class="comment">     * written, we can use this to detect it.</span>
<a name="l00096"></a>00096 <span class="comment">     */</span>
<a name="l00097"></a>00097     buf[10] = hdr-&gt;<a class="code" href="structBattFsPageHeader.html#a5f22e3d0d6a817a95b454dafd43aba3f" title="FCS (Frame Check Sequence) of the page header.">fcs</a>;
<a name="l00098"></a>00098     buf[11] = hdr-&gt;<a class="code" href="structBattFsPageHeader.html#a5f22e3d0d6a817a95b454dafd43aba3f" title="FCS (Frame Check Sequence) of the page header.">fcs</a> &gt;&gt; 8;
<a name="l00099"></a>00099 }
<a name="l00100"></a>00100 
<a name="l00105"></a><a class="code" href="battfs_8c.html#ab52ab90298977c2327a5d857fbb6517c">00105</a> INLINE <span class="keywordtype">void</span> <a class="code" href="battfs_8c.html#ab52ab90298977c2327a5d857fbb6517c" title="Convert from disk structure to memory representation.">disk_to_battfs</a>(uint8_t *buf, <span class="keyword">struct</span> <a class="code" href="structBattFsPageHeader.html" title="BattFS page header, used to represent a page header in memory.">BattFsPageHeader</a> *hdr)
<a name="l00106"></a>00106 {
<a name="l00107"></a>00107     <a class="code" href="compiler_8h.html#a695e64485eb9535f5ddcfec01167bddc" title="Issue a compilation error if the condition is false.">STATIC_ASSERT</a>(<a class="code" href="battfs_8h.html#a5f50d8650c7f510c735ea41d140fe8b6" title="Size of the header once saved on disk.">BATTFS_HEADER_LEN</a> == 12);
<a name="l00108"></a>00108     hdr-&gt;<a class="code" href="structBattFsPageHeader.html#a073705e71025f5e13f9ccd2f09f469ba" title="File inode (file identifier).">inode</a> = buf[0];
<a name="l00109"></a>00109     hdr-&gt;<a class="code" href="structBattFsPageHeader.html#a5c59ce00449c562009b680adef4aebe7" title="Filled bytes in page.">fill</a> = buf[2] &lt;&lt; 8 | buf[1];
<a name="l00110"></a>00110     hdr-&gt;<a class="code" href="structBattFsPageHeader.html#a8976d867f0fb78905c2a572e6cab2992" title="Page offset inside file.">pgoff</a> = buf[4] &lt;&lt; 8 | buf[3];
<a name="l00111"></a>00111     hdr-&gt;<a class="code" href="structBattFsPageHeader.html#aa819f5f419727fa1857635686710d34b" title="Page sequence number.">seq</a> = (<a class="code" href="battfs_8h.html#abbbad188c9c52701e8dbd92f0a5635f5" title="Type for page seq number, at least 40bits wide.">seq_t</a>)buf[9] &lt;&lt; 32 | (<a class="code" href="battfs_8h.html#abbbad188c9c52701e8dbd92f0a5635f5" title="Type for page seq number, at least 40bits wide.">seq_t</a>)buf[8] &lt;&lt; 24 | (<a class="code" href="battfs_8h.html#abbbad188c9c52701e8dbd92f0a5635f5" title="Type for page seq number, at least 40bits wide.">seq_t</a>)buf[7] &lt;&lt; 16 | buf[6] &lt;&lt; 8 | buf[5];
<a name="l00112"></a>00112     hdr-&gt;<a class="code" href="structBattFsPageHeader.html#a5f22e3d0d6a817a95b454dafd43aba3f" title="FCS (Frame Check Sequence) of the page header.">fcs</a> = buf[11] &lt;&lt; 8 | buf[10];
<a name="l00113"></a>00113 }
<a name="l00114"></a>00114 
<a name="l00118"></a><a class="code" href="battfs_8c.html#af1a47fc53b7a1972011ca0c9f8f7e927">00118</a> <span class="keyword">static</span> <a class="code" href="battfs_8h.html#aaf7617a98621b494ad58b8bbbdf9306e" title="Type for header FCS.">fcs_t</a> <a class="code" href="battfs_8c.html#af1a47fc53b7a1972011ca0c9f8f7e927" title="Compute the fcs of the header.">computeFcs</a>(<span class="keyword">struct</span> <a class="code" href="structBattFsPageHeader.html" title="BattFS page header, used to represent a page header in memory.">BattFsPageHeader</a> *hdr)
<a name="l00119"></a>00119 {
<a name="l00120"></a>00120     uint8_t buf[<a class="code" href="battfs_8h.html#a5f50d8650c7f510c735ea41d140fe8b6" title="Size of the header once saved on disk.">BATTFS_HEADER_LEN</a>];
<a name="l00121"></a>00121     <a class="code" href="battfs_8h.html#aaf7617a98621b494ad58b8bbbdf9306e" title="Type for header FCS.">fcs_t</a> cks;
<a name="l00122"></a>00122 
<a name="l00123"></a>00123     <a class="code" href="battfs_8c.html#a2ab58e79b36e2d503e0a3197ca08b65a" title="Convert from memory representation to disk structure.">battfs_to_disk</a>(hdr, buf);
<a name="l00124"></a>00124     <a class="code" href="rotating__hash_8h.html#a375e1ff60be4125f3174ad257094d983" title="Init rotating checksum.">rotating_init</a>(&amp;cks);
<a name="l00125"></a>00125     <span class="comment">/* fcs is at the end of whole header */</span>
<a name="l00126"></a>00126     <a class="code" href="rotating__hash_8h.html#ad4c2a97247c6e94ed69389adebf2f016" title="Update checksum pointed by rot with data supplied in buf.">rotating_update</a>(buf, <a class="code" href="battfs_8h.html#a5f50d8650c7f510c735ea41d140fe8b6" title="Size of the header once saved on disk.">BATTFS_HEADER_LEN</a> - <span class="keyword">sizeof</span>(<a class="code" href="battfs_8h.html#aaf7617a98621b494ad58b8bbbdf9306e" title="Type for header FCS.">fcs_t</a>), &amp;cks);
<a name="l00127"></a>00127     <span class="keywordflow">return</span> cks;
<a name="l00128"></a>00128 }
<a name="l00129"></a>00129 
<a name="l00134"></a><a class="code" href="battfs_8c.html#a041535a629472f6a28d1608337315ebc">00134</a> <span class="keyword">static</span> <span class="keywordtype">bool</span> <a class="code" href="battfs_8c.html#a041535a629472f6a28d1608337315ebc" title="Read header of page in hdr.">readHdr</a>(<span class="keyword">struct</span> <a class="code" href="structBattFsSuper.html" title="Context used to describe a disk.">BattFsSuper</a> *disk, <a class="code" href="battfs_8h.html#ab696748712d719603833f401031a7907" title="Type for counting pages on disk.">pgcnt_t</a> page, <span class="keyword">struct</span> <a class="code" href="structBattFsPageHeader.html" title="BattFS page header, used to represent a page header in memory.">BattFsPageHeader</a> *hdr)
<a name="l00135"></a>00135 {
<a name="l00136"></a>00136     uint8_t buf[<a class="code" href="battfs_8h.html#a5f50d8650c7f510c735ea41d140fe8b6" title="Size of the header once saved on disk.">BATTFS_HEADER_LEN</a>];
<a name="l00137"></a>00137 
<a name="l00138"></a>00138     <span class="comment">/*</span>
<a name="l00139"></a>00139 <span class="comment">     * Read header from disk.</span>
<a name="l00140"></a>00140 <span class="comment">     * Header is actually a footer, and so</span>
<a name="l00141"></a>00141 <span class="comment">     * resides at page end.</span>
<a name="l00142"></a>00142 <span class="comment">     */</span>
<a name="l00143"></a>00143     <span class="keywordflow">if</span> (<a class="code" href="group__io__kblock.html#ga1f50056687e375253e3d11b11bc060a5" title="Read data from the block device.">kblock_read</a>(disk-&gt;<a class="code" href="structBattFsSuper.html#a6da7bb93863793068a9ca2746fb035b4" title="Block device context (physical disk).">dev</a>, page, buf, disk-&gt;<a class="code" href="structBattFsSuper.html#afc13e79aa3e0714eba8038a97e58caaa" title="Size of space usable for data in a disk page, in bytes. The rest is used by the page header...">data_size</a>, <a class="code" href="battfs_8h.html#a5f50d8650c7f510c735ea41d140fe8b6" title="Size of the header once saved on disk.">BATTFS_HEADER_LEN</a>)
<a name="l00144"></a>00144         != <a class="code" href="battfs_8h.html#a5f50d8650c7f510c735ea41d140fe8b6" title="Size of the header once saved on disk.">BATTFS_HEADER_LEN</a>)
<a name="l00145"></a>00145     {
<a name="l00146"></a>00146         <a class="code" href="group__logging.html#ga19c97c740010c52ce6801d46a5346644" title="Output an error message.">LOG_ERR</a>(<span class="stringliteral">&quot;page[%d]\n&quot;</span>, page);
<a name="l00147"></a>00147         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00148"></a>00148     }
<a name="l00149"></a>00149 
<a name="l00150"></a>00150     <span class="comment">/* Fill header */</span>
<a name="l00151"></a>00151     <a class="code" href="battfs_8c.html#ab52ab90298977c2327a5d857fbb6517c" title="Convert from disk structure to memory representation.">disk_to_battfs</a>(buf, hdr);
<a name="l00152"></a>00152 
<a name="l00153"></a>00153     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00154"></a>00154 }
<a name="l00155"></a>00155 
<a name="l00156"></a>00156 <span class="keyword">static</span> <span class="keywordtype">bool</span> writeHdr(<span class="keyword">struct</span> <a class="code" href="structBattFsSuper.html" title="Context used to describe a disk.">BattFsSuper</a> *disk, <a class="code" href="battfs_8h.html#ab696748712d719603833f401031a7907" title="Type for counting pages on disk.">pgcnt_t</a> page, <span class="keyword">struct</span> <a class="code" href="structBattFsPageHeader.html" title="BattFS page header, used to represent a page header in memory.">BattFsPageHeader</a> *hdr)
<a name="l00157"></a>00157 {
<a name="l00158"></a>00158     uint8_t buf[<a class="code" href="battfs_8h.html#a5f50d8650c7f510c735ea41d140fe8b6" title="Size of the header once saved on disk.">BATTFS_HEADER_LEN</a>];
<a name="l00159"></a>00159 
<a name="l00160"></a>00160 <span class="preprocessor">    #warning FIXME:refactor computeFcs to save time and stack</span>
<a name="l00161"></a>00161 <span class="preprocessor"></span>    hdr-&gt;<a class="code" href="structBattFsPageHeader.html#a5f22e3d0d6a817a95b454dafd43aba3f" title="FCS (Frame Check Sequence) of the page header.">fcs</a> = <a class="code" href="battfs_8c.html#af1a47fc53b7a1972011ca0c9f8f7e927" title="Compute the fcs of the header.">computeFcs</a>(hdr);
<a name="l00162"></a>00162     <span class="comment">/* Fill buffer */</span>
<a name="l00163"></a>00163     <a class="code" href="battfs_8c.html#a2ab58e79b36e2d503e0a3197ca08b65a" title="Convert from memory representation to disk structure.">battfs_to_disk</a>(hdr, buf);
<a name="l00164"></a>00164 
<a name="l00165"></a>00165     <span class="comment">/*</span>
<a name="l00166"></a>00166 <span class="comment">     * write header to disk.</span>
<a name="l00167"></a>00167 <span class="comment">     * Header is actually a footer, and so</span>
<a name="l00168"></a>00168 <span class="comment">     * resides at page end.</span>
<a name="l00169"></a>00169 <span class="comment">     */</span>
<a name="l00170"></a>00170     <span class="keywordflow">if</span> (<a class="code" href="group__io__kblock.html#ga069340cc7fe0a6aec2bada078ad9c889" title="Write data to the block device.">kblock_write</a>(disk-&gt;<a class="code" href="structBattFsSuper.html#a6da7bb93863793068a9ca2746fb035b4" title="Block device context (physical disk).">dev</a>, page, buf, disk-&gt;<a class="code" href="structBattFsSuper.html#afc13e79aa3e0714eba8038a97e58caaa" title="Size of space usable for data in a disk page, in bytes. The rest is used by the page header...">data_size</a>, <a class="code" href="battfs_8h.html#a5f50d8650c7f510c735ea41d140fe8b6" title="Size of the header once saved on disk.">BATTFS_HEADER_LEN</a>)
<a name="l00171"></a>00171         != <a class="code" href="battfs_8h.html#a5f50d8650c7f510c735ea41d140fe8b6" title="Size of the header once saved on disk.">BATTFS_HEADER_LEN</a>)
<a name="l00172"></a>00172     {
<a name="l00173"></a>00173         <a class="code" href="group__logging.html#ga19c97c740010c52ce6801d46a5346644" title="Output an error message.">LOG_ERR</a>(<span class="stringliteral">&quot;writing to buffer\n&quot;</span>);
<a name="l00174"></a>00174         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00175"></a>00175     }
<a name="l00176"></a>00176     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00177"></a>00177 }
<a name="l00178"></a>00178 
<a name="l00179"></a>00179 
<a name="l00184"></a><a class="code" href="battfs_8c.html#a26ea14183c55be33c4e9af14fd7a6bec">00184</a> <span class="keyword">static</span> <a class="code" href="battfs_8h.html#ab696748712d719603833f401031a7907" title="Type for counting pages on disk.">pgcnt_t</a> <a class="code" href="battfs_8c.html#a26ea14183c55be33c4e9af14fd7a6bec" title="Count the number of pages from inode 0 to inode in filelen_table.">countPages</a>(<a class="code" href="battfs_8h.html#abd9d9d290feaf2e76bce6142ae59019e" title="Type for counting pages inside a file.">pgoff_t</a> *filelen_table, <a class="code" href="battfs_8h.html#a74713a2f9f355cad853593781defa824" title="Type for file inodes.">inode_t</a> inode)
<a name="l00185"></a>00185 {
<a name="l00186"></a>00186     <a class="code" href="battfs_8h.html#ab696748712d719603833f401031a7907" title="Type for counting pages on disk.">pgcnt_t</a> cnt = 0;
<a name="l00187"></a>00187 
<a name="l00188"></a>00188     <span class="keywordflow">for</span> (<a class="code" href="battfs_8h.html#a74713a2f9f355cad853593781defa824" title="Type for file inodes.">inode_t</a> i = 0; i &lt; inode; i++)
<a name="l00189"></a>00189         cnt += filelen_table[i];
<a name="l00190"></a>00190 
<a name="l00191"></a>00191     <span class="keywordflow">return</span> cnt;
<a name="l00192"></a>00192 }
<a name="l00193"></a>00193 
<a name="l00198"></a><a class="code" href="battfs_8c.html#a79846b7cea24a012d60d2720cb2b6d6c">00198</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="battfs_8c.html#a79846b7cea24a012d60d2720cb2b6d6c" title="Move all pages in page allocation array from src to src + offset.">movePages</a>(<span class="keyword">struct</span> <a class="code" href="structBattFsSuper.html" title="Context used to describe a disk.">BattFsSuper</a> *disk, <a class="code" href="battfs_8h.html#ab696748712d719603833f401031a7907" title="Type for counting pages on disk.">pgcnt_t</a> src, <span class="keywordtype">int</span> offset)
<a name="l00199"></a>00199 {
<a name="l00200"></a>00200     <a class="code" href="battfs_8h.html#ab696748712d719603833f401031a7907" title="Type for counting pages on disk.">pgcnt_t</a> dst = src + offset;
<a name="l00201"></a>00201     <a class="code" href="group__logging.html#gaa5595314cc54c304a127c75cfcec4017" title="Output an informative message.">LOG_INFO</a>(<span class="stringliteral">&quot;src %d, offset %d, size %d\n&quot;</span>, src, offset, (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)((disk-&gt;<a class="code" href="structBattFsSuper.html#a6da7bb93863793068a9ca2746fb035b4" title="Block device context (physical disk).">dev</a>-&gt;<a class="code" href="structKBlock.html#ad413baaa0d82a56b1006fd69acb53fcc" title="Number of blocks available in the device.">blk_cnt</a> - MAX(dst, src)) * <span class="keyword">sizeof</span>(<a class="code" href="battfs_8h.html#ab696748712d719603833f401031a7907" title="Type for counting pages on disk.">pgcnt_t</a>)));
<a name="l00202"></a>00202     memmove(&amp;disk-&gt;<a class="code" href="structBattFsSuper.html#ae018010b1733f1a278a5c40792f393de" title="Page allocation array.">page_array</a>[dst], &amp;disk-&gt;<a class="code" href="structBattFsSuper.html#ae018010b1733f1a278a5c40792f393de" title="Page allocation array.">page_array</a>[src], (disk-&gt;<a class="code" href="structBattFsSuper.html#a6da7bb93863793068a9ca2746fb035b4" title="Block device context (physical disk).">dev</a>-&gt;<a class="code" href="structKBlock.html#ad413baaa0d82a56b1006fd69acb53fcc" title="Number of blocks available in the device.">blk_cnt</a> - MAX(dst, src)) * <span class="keyword">sizeof</span>(<a class="code" href="battfs_8h.html#ab696748712d719603833f401031a7907" title="Type for counting pages on disk.">pgcnt_t</a>));
<a name="l00203"></a>00203 
<a name="l00204"></a>00204     <span class="keywordflow">if</span> (offset &lt; 0)
<a name="l00205"></a>00205     {
<a name="l00206"></a>00206         <span class="comment">/* Fill empty space in array with sentinel */</span>
<a name="l00207"></a>00207         <span class="keywordflow">for</span> (<a class="code" href="battfs_8h.html#ab696748712d719603833f401031a7907" title="Type for counting pages on disk.">pgcnt_t</a> page = disk-&gt;<a class="code" href="structBattFsSuper.html#a6da7bb93863793068a9ca2746fb035b4" title="Block device context (physical disk).">dev</a>-&gt;<a class="code" href="structKBlock.html#ad413baaa0d82a56b1006fd69acb53fcc" title="Number of blocks available in the device.">blk_cnt</a> + offset; page &lt; disk-&gt;dev-&gt;blk_cnt; page++)
<a name="l00208"></a>00208             disk-&gt;<a class="code" href="structBattFsSuper.html#ae018010b1733f1a278a5c40792f393de" title="Page allocation array.">page_array</a>[page] = <a class="code" href="battfs_8h.html#a953801195b124d1b4bca5df3c47ff645" title="Sentinel used to keep trace of unset pages in disk-&gt;page_array.">PAGE_UNSET_SENTINEL</a>;
<a name="l00209"></a>00209     }
<a name="l00210"></a>00210 }
<a name="l00211"></a>00211 
<a name="l00221"></a><a class="code" href="battfs_8c.html#a8383bbf0bbdb27c4d669bf2b3f05abb9">00221</a> <span class="keyword">static</span> <span class="keywordtype">bool</span> <a class="code" href="battfs_8c.html#a8383bbf0bbdb27c4d669bf2b3f05abb9" title="Count number of pages per file on disk.">countDiskFilePages</a>(<span class="keyword">struct</span> <a class="code" href="structBattFsSuper.html" title="Context used to describe a disk.">BattFsSuper</a> *disk, <a class="code" href="battfs_8h.html#abd9d9d290feaf2e76bce6142ae59019e" title="Type for counting pages inside a file.">pgoff_t</a> *filelen_table)
<a name="l00222"></a>00222 {
<a name="l00223"></a>00223     <a class="code" href="structBattFsPageHeader.html" title="BattFS page header, used to represent a page header in memory.">BattFsPageHeader</a> hdr;
<a name="l00224"></a>00224     disk-&gt;<a class="code" href="structBattFsSuper.html#ac3d127852dca0d3de1fb9e5ccbec0ecd" title="Lowest address, in page array, for free pages.">free_page_start</a> = 0;
<a name="l00225"></a>00225 
<a name="l00226"></a>00226     <span class="comment">/* Count the number of disk page per file */</span>
<a name="l00227"></a>00227     <span class="keywordflow">for</span> (<a class="code" href="battfs_8h.html#ab696748712d719603833f401031a7907" title="Type for counting pages on disk.">pgcnt_t</a> page = 0; page &lt; disk-&gt;<a class="code" href="structBattFsSuper.html#a6da7bb93863793068a9ca2746fb035b4" title="Block device context (physical disk).">dev</a>-&gt;<a class="code" href="structKBlock.html#ad413baaa0d82a56b1006fd69acb53fcc" title="Number of blocks available in the device.">blk_cnt</a>; page++)
<a name="l00228"></a>00228     {
<a name="l00229"></a>00229         <span class="keywordflow">if</span> (!<a class="code" href="battfs_8c.html#a041535a629472f6a28d1608337315ebc" title="Read header of page in hdr.">readHdr</a>(disk, page, &amp;hdr))
<a name="l00230"></a>00230             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00231"></a>00231 
<a name="l00232"></a>00232         <span class="comment">/* Increase free space */</span>
<a name="l00233"></a>00233         disk-&gt;<a class="code" href="structBattFsSuper.html#a274792c58d32ea62610a1f44c35b69ac" title="Free space on the disk.">free_bytes</a> += disk-&gt;<a class="code" href="structBattFsSuper.html#afc13e79aa3e0714eba8038a97e58caaa" title="Size of space usable for data in a disk page, in bytes. The rest is used by the page header...">data_size</a>;
<a name="l00234"></a>00234 
<a name="l00235"></a>00235         <span class="comment">/* Check header FCS */</span>
<a name="l00236"></a>00236         <span class="keywordflow">if</span> (hdr.<a class="code" href="structBattFsPageHeader.html#a5f22e3d0d6a817a95b454dafd43aba3f" title="FCS (Frame Check Sequence) of the page header.">fcs</a> == <a class="code" href="battfs_8c.html#af1a47fc53b7a1972011ca0c9f8f7e927" title="Compute the fcs of the header.">computeFcs</a>(&amp;hdr))
<a name="l00237"></a>00237         {
<a name="l00238"></a>00238             <a class="code" href="group__debug.html#gaca68c0d4ac8df0838e209fb5300f7be3" title="Assert a pre-condition on code.">ASSERT</a>(hdr.<a class="code" href="structBattFsPageHeader.html#a5c59ce00449c562009b680adef4aebe7" title="Filled bytes in page.">fill</a> &lt;= disk-&gt;<a class="code" href="structBattFsSuper.html#afc13e79aa3e0714eba8038a97e58caaa" title="Size of space usable for data in a disk page, in bytes. The rest is used by the page header...">data_size</a>);
<a name="l00239"></a>00239 
<a name="l00240"></a>00240             <span class="comment">/* Page is valid and is owned by a file */</span>
<a name="l00241"></a>00241             filelen_table[hdr.<a class="code" href="structBattFsPageHeader.html#a073705e71025f5e13f9ccd2f09f469ba" title="File inode (file identifier).">inode</a>]++;
<a name="l00242"></a>00242 
<a name="l00243"></a>00243             <span class="comment">/* Keep trace of free space */</span>
<a name="l00244"></a>00244             disk-&gt;<a class="code" href="structBattFsSuper.html#a274792c58d32ea62610a1f44c35b69ac" title="Free space on the disk.">free_bytes</a> -= hdr.<a class="code" href="structBattFsPageHeader.html#a5c59ce00449c562009b680adef4aebe7" title="Filled bytes in page.">fill</a>;
<a name="l00245"></a>00245             disk-&gt;<a class="code" href="structBattFsSuper.html#ac3d127852dca0d3de1fb9e5ccbec0ecd" title="Lowest address, in page array, for free pages.">free_page_start</a>++;
<a name="l00246"></a>00246         }
<a name="l00247"></a>00247     }
<a name="l00248"></a>00248     <a class="code" href="group__logging.html#gaa5595314cc54c304a127c75cfcec4017" title="Output an informative message.">LOG_INFO</a>(<span class="stringliteral">&quot;free_bytes:%ld, free_page_start:%d\n&quot;</span>, (<span class="keywordtype">long</span>)disk-&gt;<a class="code" href="structBattFsSuper.html#a274792c58d32ea62610a1f44c35b69ac" title="Free space on the disk.">free_bytes</a>, disk-&gt;<a class="code" href="structBattFsSuper.html#ac3d127852dca0d3de1fb9e5ccbec0ecd" title="Lowest address, in page array, for free pages.">free_page_start</a>);
<a name="l00249"></a>00249 
<a name="l00250"></a>00250     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00251"></a>00251 }
<a name="l00252"></a>00252 
<a name="l00267"></a><a class="code" href="battfs_8c.html#a157e4229f50cb7fb41f0113bb06a4ab3">00267</a> <span class="keyword">static</span> <span class="keywordtype">bool</span> <a class="code" href="battfs_8c.html#a157e4229f50cb7fb41f0113bb06a4ab3" title="Fill page allocation array of disk using file lenghts in filelen_table.">fillPageArray</a>(<span class="keyword">struct</span> <a class="code" href="structBattFsSuper.html" title="Context used to describe a disk.">BattFsSuper</a> *disk, <a class="code" href="battfs_8h.html#abd9d9d290feaf2e76bce6142ae59019e" title="Type for counting pages inside a file.">pgoff_t</a> *filelen_table)
<a name="l00268"></a>00268 {
<a name="l00269"></a>00269     <a class="code" href="structBattFsPageHeader.html" title="BattFS page header, used to represent a page header in memory.">BattFsPageHeader</a> hdr;
<a name="l00270"></a>00270     <a class="code" href="battfs_8h.html#ab696748712d719603833f401031a7907" title="Type for counting pages on disk.">pgcnt_t</a> curr_free_page = disk-&gt;<a class="code" href="structBattFsSuper.html#ac3d127852dca0d3de1fb9e5ccbec0ecd" title="Lowest address, in page array, for free pages.">free_page_start</a>;
<a name="l00271"></a>00271     <span class="comment">/* Fill page allocation array */</span>
<a name="l00272"></a>00272     <span class="keywordflow">for</span> (<a class="code" href="battfs_8h.html#ab696748712d719603833f401031a7907" title="Type for counting pages on disk.">pgcnt_t</a> page = 0; page &lt; disk-&gt;<a class="code" href="structBattFsSuper.html#a6da7bb93863793068a9ca2746fb035b4" title="Block device context (physical disk).">dev</a>-&gt;<a class="code" href="structKBlock.html#ad413baaa0d82a56b1006fd69acb53fcc" title="Number of blocks available in the device.">blk_cnt</a>; page++)
<a name="l00273"></a>00273     {
<a name="l00274"></a>00274         <span class="keywordflow">if</span> (!<a class="code" href="battfs_8c.html#a041535a629472f6a28d1608337315ebc" title="Read header of page in hdr.">readHdr</a>(disk, page, &amp;hdr))
<a name="l00275"></a>00275             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00276"></a>00276 
<a name="l00277"></a>00277         <span class="comment">/* Check header FCS */</span>
<a name="l00278"></a>00278         <span class="keywordflow">if</span> (hdr.<a class="code" href="structBattFsPageHeader.html#a5f22e3d0d6a817a95b454dafd43aba3f" title="FCS (Frame Check Sequence) of the page header.">fcs</a> == <a class="code" href="battfs_8c.html#af1a47fc53b7a1972011ca0c9f8f7e927" title="Compute the fcs of the header.">computeFcs</a>(&amp;hdr))
<a name="l00279"></a>00279         {
<a name="l00280"></a>00280             <span class="comment">/* Compute array position */</span>
<a name="l00281"></a>00281             <a class="code" href="battfs_8h.html#ab696748712d719603833f401031a7907" title="Type for counting pages on disk.">pgcnt_t</a> array_pos = <a class="code" href="battfs_8c.html#a26ea14183c55be33c4e9af14fd7a6bec" title="Count the number of pages from inode 0 to inode in filelen_table.">countPages</a>(filelen_table, hdr.<a class="code" href="structBattFsPageHeader.html#a073705e71025f5e13f9ccd2f09f469ba" title="File inode (file identifier).">inode</a>);
<a name="l00282"></a>00282             array_pos += hdr.<a class="code" href="structBattFsPageHeader.html#a8976d867f0fb78905c2a572e6cab2992" title="Page offset inside file.">pgoff</a>;
<a name="l00283"></a>00283 
<a name="l00284"></a>00284 
<a name="l00285"></a>00285             <span class="comment">/* Check if position is already used by another page of the same file */</span>
<a name="l00286"></a>00286             <span class="keywordflow">if</span> (disk-&gt;<a class="code" href="structBattFsSuper.html#ae018010b1733f1a278a5c40792f393de" title="Page allocation array.">page_array</a>[array_pos] == <a class="code" href="battfs_8h.html#a953801195b124d1b4bca5df3c47ff645" title="Sentinel used to keep trace of unset pages in disk-&gt;page_array.">PAGE_UNSET_SENTINEL</a>)
<a name="l00287"></a>00287                 disk-&gt;<a class="code" href="structBattFsSuper.html#ae018010b1733f1a278a5c40792f393de" title="Page allocation array.">page_array</a>[array_pos] = page;
<a name="l00288"></a>00288             <span class="keywordflow">else</span>
<a name="l00289"></a>00289             {
<a name="l00290"></a>00290                 <a class="code" href="structBattFsPageHeader.html" title="BattFS page header, used to represent a page header in memory.">BattFsPageHeader</a> hdr_prv;
<a name="l00291"></a>00291 
<a name="l00292"></a>00292                 <span class="keywordflow">if</span> (!<a class="code" href="battfs_8c.html#a041535a629472f6a28d1608337315ebc" title="Read header of page in hdr.">readHdr</a>(disk, disk-&gt;<a class="code" href="structBattFsSuper.html#ae018010b1733f1a278a5c40792f393de" title="Page allocation array.">page_array</a>[array_pos], &amp;hdr_prv))
<a name="l00293"></a>00293                     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00294"></a>00294 
<a name="l00295"></a>00295                 <span class="comment">/* Check header FCS */</span>
<a name="l00296"></a>00296                 <a class="code" href="group__debug.html#gaca68c0d4ac8df0838e209fb5300f7be3" title="Assert a pre-condition on code.">ASSERT</a>(hdr_prv.<a class="code" href="structBattFsPageHeader.html#a5f22e3d0d6a817a95b454dafd43aba3f" title="FCS (Frame Check Sequence) of the page header.">fcs</a> == <a class="code" href="battfs_8c.html#af1a47fc53b7a1972011ca0c9f8f7e927" title="Compute the fcs of the header.">computeFcs</a>(&amp;hdr_prv));
<a name="l00297"></a>00297 
<a name="l00298"></a>00298                 <span class="comment">/* Only the very same page with a different seq number can be here */</span>
<a name="l00299"></a>00299                 <a class="code" href="group__debug.html#gaca68c0d4ac8df0838e209fb5300f7be3" title="Assert a pre-condition on code.">ASSERT</a>(hdr.<a class="code" href="structBattFsPageHeader.html#a073705e71025f5e13f9ccd2f09f469ba" title="File inode (file identifier).">inode</a> == hdr_prv.<a class="code" href="structBattFsPageHeader.html#a073705e71025f5e13f9ccd2f09f469ba" title="File inode (file identifier).">inode</a>);
<a name="l00300"></a>00300                 <a class="code" href="group__debug.html#gaca68c0d4ac8df0838e209fb5300f7be3" title="Assert a pre-condition on code.">ASSERT</a>(hdr.<a class="code" href="structBattFsPageHeader.html#a8976d867f0fb78905c2a572e6cab2992" title="Page offset inside file.">pgoff</a> == hdr_prv.<a class="code" href="structBattFsPageHeader.html#a8976d867f0fb78905c2a572e6cab2992" title="Page offset inside file.">pgoff</a>);
<a name="l00301"></a>00301                 <a class="code" href="group__debug.html#gaca68c0d4ac8df0838e209fb5300f7be3" title="Assert a pre-condition on code.">ASSERT</a>(hdr.<a class="code" href="structBattFsPageHeader.html#aa819f5f419727fa1857635686710d34b" title="Page sequence number.">seq</a> != hdr_prv.<a class="code" href="structBattFsPageHeader.html#aa819f5f419727fa1857635686710d34b" title="Page sequence number.">seq</a>);
<a name="l00302"></a>00302 
<a name="l00303"></a>00303                 <a class="code" href="battfs_8h.html#ab696748712d719603833f401031a7907" title="Type for counting pages on disk.">pgcnt_t</a> new_page, old_page;
<a name="l00304"></a>00304                 <a class="code" href="battfs_8h.html#af0b3070403482fbfa266d6e3e6cff088" title="Type for keeping trace of space filled inside a page.">fill_t</a> old_fill;
<a name="l00305"></a>00305 
<a name="l00306"></a>00306                 <span class="comment">/*</span>
<a name="l00307"></a>00307 <span class="comment">                 * Sequence number comparison: since</span>
<a name="l00308"></a>00308 <span class="comment">                 * seq is 40 bits wide, it wraps once</span>
<a name="l00309"></a>00309 <span class="comment">                 * every 1.1E12 times.</span>
<a name="l00310"></a>00310 <span class="comment">                 * The memory will not live enough to</span>
<a name="l00311"></a>00311 <span class="comment">                 * see a wraparound, so we can use a simple</span>
<a name="l00312"></a>00312 <span class="comment">                 * compare here.</span>
<a name="l00313"></a>00313 <span class="comment">                 */</span>
<a name="l00314"></a>00314                 <span class="keywordflow">if</span> (hdr.<a class="code" href="structBattFsPageHeader.html#aa819f5f419727fa1857635686710d34b" title="Page sequence number.">seq</a> &gt; hdr_prv.<a class="code" href="structBattFsPageHeader.html#aa819f5f419727fa1857635686710d34b" title="Page sequence number.">seq</a>)
<a name="l00315"></a>00315                 {
<a name="l00316"></a>00316                     <span class="comment">/* Current header is newer than the previuos one */</span>
<a name="l00317"></a>00317                     old_page = disk-&gt;<a class="code" href="structBattFsSuper.html#ae018010b1733f1a278a5c40792f393de" title="Page allocation array.">page_array</a>[array_pos];
<a name="l00318"></a>00318                     new_page = page;
<a name="l00319"></a>00319                     old_fill = hdr_prv.<a class="code" href="structBattFsPageHeader.html#a5c59ce00449c562009b680adef4aebe7" title="Filled bytes in page.">fill</a>;
<a name="l00320"></a>00320                 }
<a name="l00321"></a>00321                 <span class="keywordflow">else</span>
<a name="l00322"></a>00322                 {
<a name="l00323"></a>00323                     <span class="comment">/* Previous header is newer than the current one */</span>
<a name="l00324"></a>00324                     old_page = page;
<a name="l00325"></a>00325                     new_page = disk-&gt;<a class="code" href="structBattFsSuper.html#ae018010b1733f1a278a5c40792f393de" title="Page allocation array.">page_array</a>[array_pos];
<a name="l00326"></a>00326                     old_fill = hdr.<a class="code" href="structBattFsPageHeader.html#a5c59ce00449c562009b680adef4aebe7" title="Filled bytes in page.">fill</a>;
<a name="l00327"></a>00327                 }
<a name="l00328"></a>00328 
<a name="l00329"></a>00329                 <span class="comment">/* Set new page */</span>
<a name="l00330"></a>00330                 disk-&gt;<a class="code" href="structBattFsSuper.html#ae018010b1733f1a278a5c40792f393de" title="Page allocation array.">page_array</a>[array_pos] = new_page;
<a name="l00331"></a>00331                 <span class="comment">/* Add free space */</span>
<a name="l00332"></a>00332                 disk-&gt;<a class="code" href="structBattFsSuper.html#a274792c58d32ea62610a1f44c35b69ac" title="Free space on the disk.">free_bytes</a> += old_fill;
<a name="l00333"></a>00333                 <span class="comment">/* Shift all array one position to the left, overwriting duplicate page */</span>
<a name="l00334"></a>00334                 array_pos -= hdr.<a class="code" href="structBattFsPageHeader.html#a8976d867f0fb78905c2a572e6cab2992" title="Page offset inside file.">pgoff</a>;
<a name="l00335"></a>00335                 array_pos += filelen_table[hdr.<a class="code" href="structBattFsPageHeader.html#a073705e71025f5e13f9ccd2f09f469ba" title="File inode (file identifier).">inode</a>];
<a name="l00336"></a>00336                 <a class="code" href="battfs_8c.html#a79846b7cea24a012d60d2720cb2b6d6c" title="Move all pages in page allocation array from src to src + offset.">movePages</a>(disk, array_pos, -1);
<a name="l00337"></a>00337                 <span class="comment">/* Move back all indexes */</span>
<a name="l00338"></a>00338                 filelen_table[hdr.<a class="code" href="structBattFsPageHeader.html#a073705e71025f5e13f9ccd2f09f469ba" title="File inode (file identifier).">inode</a>]--;
<a name="l00339"></a>00339                 disk-&gt;<a class="code" href="structBattFsSuper.html#ac3d127852dca0d3de1fb9e5ccbec0ecd" title="Lowest address, in page array, for free pages.">free_page_start</a>--;
<a name="l00340"></a>00340                 curr_free_page--;
<a name="l00341"></a>00341                 <span class="comment">/* Set old page as free */</span>
<a name="l00342"></a>00342                 <a class="code" href="group__debug.html#gaca68c0d4ac8df0838e209fb5300f7be3" title="Assert a pre-condition on code.">ASSERT</a>(disk-&gt;<a class="code" href="structBattFsSuper.html#ae018010b1733f1a278a5c40792f393de" title="Page allocation array.">page_array</a>[curr_free_page] == <a class="code" href="battfs_8h.html#a953801195b124d1b4bca5df3c47ff645" title="Sentinel used to keep trace of unset pages in disk-&gt;page_array.">PAGE_UNSET_SENTINEL</a>);
<a name="l00343"></a>00343                 disk-&gt;<a class="code" href="structBattFsSuper.html#ae018010b1733f1a278a5c40792f393de" title="Page allocation array.">page_array</a>[curr_free_page++] = old_page;
<a name="l00344"></a>00344 
<a name="l00345"></a>00345             }
<a name="l00346"></a>00346         }
<a name="l00347"></a>00347         <span class="keywordflow">else</span>
<a name="l00348"></a>00348         {
<a name="l00349"></a>00349             <span class="comment">/* Invalid page, keep as free */</span>
<a name="l00350"></a>00350             <a class="code" href="group__debug.html#gaca68c0d4ac8df0838e209fb5300f7be3" title="Assert a pre-condition on code.">ASSERT</a>(disk-&gt;<a class="code" href="structBattFsSuper.html#ae018010b1733f1a278a5c40792f393de" title="Page allocation array.">page_array</a>[curr_free_page] == <a class="code" href="battfs_8h.html#a953801195b124d1b4bca5df3c47ff645" title="Sentinel used to keep trace of unset pages in disk-&gt;page_array.">PAGE_UNSET_SENTINEL</a>);
<a name="l00351"></a>00351             <span class="comment">//LOG_INFO(&quot;Page %d invalid, keeping as free\n&quot;, page);</span>
<a name="l00352"></a>00352             disk-&gt;<a class="code" href="structBattFsSuper.html#ae018010b1733f1a278a5c40792f393de" title="Page allocation array.">page_array</a>[curr_free_page++] = page;
<a name="l00353"></a>00353         }
<a name="l00354"></a>00354     }
<a name="l00355"></a>00355     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00356"></a>00356 }
<a name="l00357"></a>00357 
<a name="l00358"></a>00358 
<a name="l00364"></a><a class="code" href="battfs_8h.html#a5ae502d0f195b3a16836f3883f80ebac">00364</a> <span class="keywordtype">bool</span> <a class="code" href="battfs_8c.html#a5ae502d0f195b3a16836f3883f80ebac" title="Initialize and mount disk described by disk.">battfs_mount</a>(<span class="keyword">struct</span> <a class="code" href="structBattFsSuper.html" title="Context used to describe a disk.">BattFsSuper</a> *disk, <span class="keyword">struct</span> <a class="code" href="structKBlock.html" title="KBlock: interface for a generic block device.">KBlock</a> *dev, <a class="code" href="battfs_8h.html#ab696748712d719603833f401031a7907" title="Type for counting pages on disk.">pgcnt_t</a> *page_array, <span class="keywordtype">size_t</span> array_size)
<a name="l00365"></a>00365 {
<a name="l00366"></a>00366     <a class="code" href="battfs_8h.html#abd9d9d290feaf2e76bce6142ae59019e" title="Type for counting pages inside a file.">pgoff_t</a> filelen_table[<a class="code" href="battfs_8h.html#a027862d094e3f04e031a45a0268f6a50" title="Max number of files.">BATTFS_MAX_FILES</a>];
<a name="l00367"></a>00367 
<a name="l00368"></a>00368     <a class="code" href="group__debug.html#gaca68c0d4ac8df0838e209fb5300f7be3" title="Assert a pre-condition on code.">ASSERT</a>(dev);
<a name="l00369"></a>00369     <a class="code" href="group__debug.html#gaca68c0d4ac8df0838e209fb5300f7be3" title="Assert a pre-condition on code.">ASSERT</a>(<a class="code" href="group__io__kblock.html#ga71ae645b5d672d3903b6646bd0955993">kblock_partialWrite</a>(dev));
<a name="l00370"></a>00370     disk-&gt;<a class="code" href="structBattFsSuper.html#a6da7bb93863793068a9ca2746fb035b4" title="Block device context (physical disk).">dev</a> = dev;
<a name="l00371"></a>00371 
<a name="l00372"></a>00372     <a class="code" href="group__debug.html#gaca68c0d4ac8df0838e209fb5300f7be3" title="Assert a pre-condition on code.">ASSERT</a>(disk-&gt;<a class="code" href="structBattFsSuper.html#a6da7bb93863793068a9ca2746fb035b4" title="Block device context (physical disk).">dev</a>-&gt;<a class="code" href="structKBlock.html#a4be3b0a7548ff44af20b88e63735f133" title="Block size.">blk_size</a> &gt; <a class="code" href="battfs_8h.html#a5f50d8650c7f510c735ea41d140fe8b6" title="Size of the header once saved on disk.">BATTFS_HEADER_LEN</a>);
<a name="l00373"></a>00373     <span class="comment">/* Fill page_size with the usable space */</span>
<a name="l00374"></a>00374     disk-&gt;<a class="code" href="structBattFsSuper.html#afc13e79aa3e0714eba8038a97e58caaa" title="Size of space usable for data in a disk page, in bytes. The rest is used by the page header...">data_size</a> = disk-&gt;<a class="code" href="structBattFsSuper.html#a6da7bb93863793068a9ca2746fb035b4" title="Block device context (physical disk).">dev</a>-&gt;<a class="code" href="structKBlock.html#a4be3b0a7548ff44af20b88e63735f133" title="Block size.">blk_size</a> - <a class="code" href="battfs_8h.html#a5f50d8650c7f510c735ea41d140fe8b6" title="Size of the header once saved on disk.">BATTFS_HEADER_LEN</a>;
<a name="l00375"></a>00375     <a class="code" href="group__debug.html#gaca68c0d4ac8df0838e209fb5300f7be3" title="Assert a pre-condition on code.">ASSERT</a>(disk-&gt;<a class="code" href="structBattFsSuper.html#a6da7bb93863793068a9ca2746fb035b4" title="Block device context (physical disk).">dev</a>-&gt;<a class="code" href="structKBlock.html#ad413baaa0d82a56b1006fd69acb53fcc" title="Number of blocks available in the device.">blk_cnt</a>);
<a name="l00376"></a>00376     <a class="code" href="group__debug.html#gaca68c0d4ac8df0838e209fb5300f7be3" title="Assert a pre-condition on code.">ASSERT</a>(disk-&gt;<a class="code" href="structBattFsSuper.html#a6da7bb93863793068a9ca2746fb035b4" title="Block device context (physical disk).">dev</a>-&gt;<a class="code" href="structKBlock.html#ad413baaa0d82a56b1006fd69acb53fcc" title="Number of blocks available in the device.">blk_cnt</a> &lt; <a class="code" href="battfs_8h.html#a953801195b124d1b4bca5df3c47ff645" title="Sentinel used to keep trace of unset pages in disk-&gt;page_array.">PAGE_UNSET_SENTINEL</a> - 1);
<a name="l00377"></a>00377     <a class="code" href="group__debug.html#gaca68c0d4ac8df0838e209fb5300f7be3" title="Assert a pre-condition on code.">ASSERT</a>(page_array);
<a name="l00378"></a>00378     disk-&gt;<a class="code" href="structBattFsSuper.html#ae018010b1733f1a278a5c40792f393de" title="Page allocation array.">page_array</a> = page_array;
<a name="l00379"></a>00379     <a class="code" href="group__debug.html#gaca68c0d4ac8df0838e209fb5300f7be3" title="Assert a pre-condition on code.">ASSERT</a>(array_size &gt;= disk-&gt;<a class="code" href="structBattFsSuper.html#a6da7bb93863793068a9ca2746fb035b4" title="Block device context (physical disk).">dev</a>-&gt;<a class="code" href="structKBlock.html#ad413baaa0d82a56b1006fd69acb53fcc" title="Number of blocks available in the device.">blk_cnt</a> * <span class="keyword">sizeof</span>(<a class="code" href="battfs_8h.html#ab696748712d719603833f401031a7907" title="Type for counting pages on disk.">pgcnt_t</a>));
<a name="l00380"></a>00380 
<a name="l00381"></a>00381     memset(filelen_table, 0, <a class="code" href="battfs_8h.html#a027862d094e3f04e031a45a0268f6a50" title="Max number of files.">BATTFS_MAX_FILES</a> * <span class="keyword">sizeof</span>(<a class="code" href="battfs_8h.html#abd9d9d290feaf2e76bce6142ae59019e" title="Type for counting pages inside a file.">pgoff_t</a>));
<a name="l00382"></a>00382 
<a name="l00383"></a>00383     disk-&gt;<a class="code" href="structBattFsSuper.html#a274792c58d32ea62610a1f44c35b69ac" title="Free space on the disk.">free_bytes</a> = 0;
<a name="l00384"></a>00384     disk-&gt;<a class="code" href="structBattFsSuper.html#a3230f964310e08bdc9a3fd42b28814f2" title="Size of the disk, in bytes (page_count * page_size).">disk_size</a> = (<a class="code" href="battfs_8h.html#a9017d685cb32390bc614feb39ecf2282" title="Type for disk sizes.">disk_size_t</a>)disk-&gt;<a class="code" href="structBattFsSuper.html#afc13e79aa3e0714eba8038a97e58caaa" title="Size of space usable for data in a disk page, in bytes. The rest is used by the page header...">data_size</a> * disk-&gt;<a class="code" href="structBattFsSuper.html#a6da7bb93863793068a9ca2746fb035b4" title="Block device context (physical disk).">dev</a>-&gt;<a class="code" href="structKBlock.html#ad413baaa0d82a56b1006fd69acb53fcc" title="Number of blocks available in the device.">blk_cnt</a>;
<a name="l00385"></a>00385 
<a name="l00386"></a>00386     <span class="comment">/* Count pages per file */</span>
<a name="l00387"></a>00387     if (!<a class="code" href="battfs_8c.html#a8383bbf0bbdb27c4d669bf2b3f05abb9" title="Count number of pages per file on disk.">countDiskFilePages</a>(disk, filelen_table))
<a name="l00388"></a>00388     {
<a name="l00389"></a>00389         <a class="code" href="group__logging.html#ga19c97c740010c52ce6801d46a5346644" title="Output an error message.">LOG_ERR</a>(<span class="stringliteral">&quot;counting file pages\n&quot;</span>);
<a name="l00390"></a>00390         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00391"></a>00391     }
<a name="l00392"></a>00392 
<a name="l00393"></a>00393     <span class="comment">/* Once here, we have filelen_table filled with file lengths */</span>
<a name="l00394"></a>00394 
<a name="l00395"></a>00395     <span class="comment">/* Fill page array with sentinel */</span>
<a name="l00396"></a>00396     <span class="keywordflow">for</span> (<a class="code" href="battfs_8h.html#ab696748712d719603833f401031a7907" title="Type for counting pages on disk.">pgcnt_t</a> page = 0; page &lt; disk-&gt;<a class="code" href="structBattFsSuper.html#a6da7bb93863793068a9ca2746fb035b4" title="Block device context (physical disk).">dev</a>-&gt;<a class="code" href="structKBlock.html#ad413baaa0d82a56b1006fd69acb53fcc" title="Number of blocks available in the device.">blk_cnt</a>; page++)
<a name="l00397"></a>00397         disk-&gt;<a class="code" href="structBattFsSuper.html#ae018010b1733f1a278a5c40792f393de" title="Page allocation array.">page_array</a>[page] = <a class="code" href="battfs_8h.html#a953801195b124d1b4bca5df3c47ff645" title="Sentinel used to keep trace of unset pages in disk-&gt;page_array.">PAGE_UNSET_SENTINEL</a>;
<a name="l00398"></a>00398 
<a name="l00399"></a>00399     <span class="comment">/* Fill page allocation array using filelen_table */</span>
<a name="l00400"></a>00400     if (!<a class="code" href="battfs_8c.html#a157e4229f50cb7fb41f0113bb06a4ab3" title="Fill page allocation array of disk using file lenghts in filelen_table.">fillPageArray</a>(disk, filelen_table))
<a name="l00401"></a>00401     {
<a name="l00402"></a>00402         <a class="code" href="group__logging.html#ga19c97c740010c52ce6801d46a5346644" title="Output an error message.">LOG_ERR</a>(<span class="stringliteral">&quot;filling page array\n&quot;</span>);
<a name="l00403"></a>00403         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00404"></a>00404     }
<a name="l00405"></a>00405 <span class="preprocessor">    #if LOG_LEVEL &gt;= LOG_LVL_INFO</span>
<a name="l00406"></a>00406 <span class="preprocessor"></span>        dumpPageArray(disk);
<a name="l00407"></a>00407 <span class="preprocessor">    #endif</span>
<a name="l00408"></a>00408 <span class="preprocessor"></span><span class="preprocessor">    #if CONFIG_BATTFS_SHUFFLE_FREE_PAGES</span>
<a name="l00409"></a>00409 <span class="preprocessor"></span>        <a class="code" href="group__macros.html#ga5b3faaa52bab8d724d07912876d30eee" title="Shuffle the content of array that counts len elements.">SHUFFLE</a>(&amp;disk-&gt;<a class="code" href="structBattFsSuper.html#ae018010b1733f1a278a5c40792f393de" title="Page allocation array.">page_array</a>[disk-&gt;<a class="code" href="structBattFsSuper.html#ac3d127852dca0d3de1fb9e5ccbec0ecd" title="Lowest address, in page array, for free pages.">free_page_start</a>], disk-&gt;<a class="code" href="structBattFsSuper.html#a6da7bb93863793068a9ca2746fb035b4" title="Block device context (physical disk).">dev</a>-&gt;<a class="code" href="structKBlock.html#ad413baaa0d82a56b1006fd69acb53fcc" title="Number of blocks available in the device.">blk_cnt</a> - disk-&gt;<a class="code" href="structBattFsSuper.html#ac3d127852dca0d3de1fb9e5ccbec0ecd" title="Lowest address, in page array, for free pages.">free_page_start</a>);
<a name="l00410"></a>00410 
<a name="l00411"></a>00411         <a class="code" href="group__logging.html#gaa5595314cc54c304a127c75cfcec4017" title="Output an informative message.">LOG_INFO</a>(<span class="stringliteral">&quot;Page array after shuffle:\n&quot;</span>);
<a name="l00412"></a>00412 <span class="preprocessor">        #if LOG_LEVEL &gt;= LOG_LVL_INFO</span>
<a name="l00413"></a>00413 <span class="preprocessor"></span>            dumpPageArray(disk);
<a name="l00414"></a>00414 <span class="preprocessor">        #endif</span>
<a name="l00415"></a>00415 <span class="preprocessor"></span><span class="preprocessor">    #endif</span>
<a name="l00416"></a>00416 <span class="preprocessor"></span>    <span class="comment">/* Init list for opened files. */</span>
<a name="l00417"></a>00417     <a class="code" href="group__list.html#ga005c60e8bdd32530e0ccd2374ba3289b" title="Initialize a list.">LIST_INIT</a>(&amp;disk-&gt;<a class="code" href="structBattFsSuper.html#a491a8251adeb2f4dafd70b62e26cc195" title="List used to keep trace of open files.">file_opened_list</a>);
<a name="l00418"></a>00418     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00419"></a>00419 }
<a name="l00420"></a>00420 
<a name="l00425"></a><a class="code" href="battfs_8h.html#abefec8a14bbb305b13d77adc7a56996b">00425</a> <span class="keywordtype">bool</span> <a class="code" href="battfs_8c.html#abefec8a14bbb305b13d77adc7a56996b" title="Check the filesystem.">battfs_fsck</a>(<span class="keyword">struct</span> <a class="code" href="structBattFsSuper.html" title="Context used to describe a disk.">BattFsSuper</a> *disk)
<a name="l00426"></a>00426 {
<a name="l00427"></a>00427 <span class="preprocessor">    #define FSCHECK(cond) do { if(!(cond)) { LOG_ERR(&quot;\&quot;&quot; #cond &quot;\&quot;\n&quot;); return false; } } while (0)</span>
<a name="l00428"></a>00428 <span class="preprocessor"></span>
<a name="l00429"></a>00429     FSCHECK(disk-&gt;<a class="code" href="structBattFsSuper.html#ac3d127852dca0d3de1fb9e5ccbec0ecd" title="Lowest address, in page array, for free pages.">free_page_start</a> &lt;= disk-&gt;<a class="code" href="structBattFsSuper.html#a6da7bb93863793068a9ca2746fb035b4" title="Block device context (physical disk).">dev</a>-&gt;<a class="code" href="structKBlock.html#ad413baaa0d82a56b1006fd69acb53fcc" title="Number of blocks available in the device.">blk_cnt</a>);
<a name="l00430"></a>00430     FSCHECK(disk-&gt;<a class="code" href="structBattFsSuper.html#afc13e79aa3e0714eba8038a97e58caaa" title="Size of space usable for data in a disk page, in bytes. The rest is used by the page header...">data_size</a> &lt; disk-&gt;<a class="code" href="structBattFsSuper.html#a6da7bb93863793068a9ca2746fb035b4" title="Block device context (physical disk).">dev</a>-&gt;<a class="code" href="structKBlock.html#a4be3b0a7548ff44af20b88e63735f133" title="Block size.">blk_size</a>);
<a name="l00431"></a>00431     FSCHECK(disk-&gt;<a class="code" href="structBattFsSuper.html#a274792c58d32ea62610a1f44c35b69ac" title="Free space on the disk.">free_bytes</a> &lt;= disk-&gt;<a class="code" href="structBattFsSuper.html#a3230f964310e08bdc9a3fd42b28814f2" title="Size of the disk, in bytes (page_count * page_size).">disk_size</a>);
<a name="l00432"></a>00432 
<a name="l00433"></a>00433     <a class="code" href="battfs_8h.html#a9017d685cb32390bc614feb39ecf2282" title="Type for disk sizes.">disk_size_t</a> free_bytes = 0;
<a name="l00434"></a>00434     <a class="code" href="structBattFsPageHeader.html" title="BattFS page header, used to represent a page header in memory.">BattFsPageHeader</a> hdr, prev_hdr;
<a name="l00435"></a>00435     <a class="code" href="battfs_8h.html#a74713a2f9f355cad853593781defa824" title="Type for file inodes.">inode_t</a> files = 0;
<a name="l00436"></a>00436     <a class="code" href="battfs_8h.html#ab696748712d719603833f401031a7907" title="Type for counting pages on disk.">pgcnt_t</a> page_used = 0;
<a name="l00437"></a>00437 
<a name="l00438"></a>00438     <span class="keywordtype">bool</span> start = <span class="keyword">true</span>;
<a name="l00439"></a>00439 
<a name="l00440"></a>00440     <span class="comment">/* Uneeded, the first time will be overwritten but useful to silence</span>
<a name="l00441"></a>00441 <span class="comment">     * the warning for uninitialized value */</span>
<a name="l00442"></a>00442     FSCHECK(<a class="code" href="battfs_8c.html#a041535a629472f6a28d1608337315ebc" title="Read header of page in hdr.">readHdr</a>(disk, 0, &amp;prev_hdr));
<a name="l00443"></a>00443     <span class="keywordflow">for</span> (<a class="code" href="battfs_8h.html#ab696748712d719603833f401031a7907" title="Type for counting pages on disk.">pgcnt_t</a> page = 0; page &lt; disk-&gt;<a class="code" href="structBattFsSuper.html#a6da7bb93863793068a9ca2746fb035b4" title="Block device context (physical disk).">dev</a>-&gt;<a class="code" href="structKBlock.html#ad413baaa0d82a56b1006fd69acb53fcc" title="Number of blocks available in the device.">blk_cnt</a>; page++)
<a name="l00444"></a>00444     {
<a name="l00445"></a>00445         FSCHECK(<a class="code" href="battfs_8c.html#a041535a629472f6a28d1608337315ebc" title="Read header of page in hdr.">readHdr</a>(disk, disk-&gt;<a class="code" href="structBattFsSuper.html#ae018010b1733f1a278a5c40792f393de" title="Page allocation array.">page_array</a>[page], &amp;hdr));
<a name="l00446"></a>00446         free_bytes += disk-&gt;<a class="code" href="structBattFsSuper.html#afc13e79aa3e0714eba8038a97e58caaa" title="Size of space usable for data in a disk page, in bytes. The rest is used by the page header...">data_size</a>;
<a name="l00447"></a>00447 
<a name="l00448"></a>00448         <span class="keywordflow">if</span> (page &lt; disk-&gt;free_page_start)
<a name="l00449"></a>00449         {
<a name="l00450"></a>00450             FSCHECK(<a class="code" href="battfs_8c.html#af1a47fc53b7a1972011ca0c9f8f7e927" title="Compute the fcs of the header.">computeFcs</a>(&amp;hdr) == hdr.<a class="code" href="structBattFsPageHeader.html#a5f22e3d0d6a817a95b454dafd43aba3f" title="FCS (Frame Check Sequence) of the page header.">fcs</a>);
<a name="l00451"></a>00451             page_used++;
<a name="l00452"></a>00452             free_bytes -= hdr.<a class="code" href="structBattFsPageHeader.html#a5c59ce00449c562009b680adef4aebe7" title="Filled bytes in page.">fill</a>;
<a name="l00453"></a>00453             <span class="keywordflow">if</span> (hdr.<a class="code" href="structBattFsPageHeader.html#a073705e71025f5e13f9ccd2f09f469ba" title="File inode (file identifier).">inode</a> != prev_hdr.<a class="code" href="structBattFsPageHeader.html#a073705e71025f5e13f9ccd2f09f469ba" title="File inode (file identifier).">inode</a> || start)
<a name="l00454"></a>00454             {
<a name="l00455"></a>00455                 <span class="keywordflow">if</span> (LIKELY(!start))
<a name="l00456"></a>00456                     FSCHECK(hdr.<a class="code" href="structBattFsPageHeader.html#a073705e71025f5e13f9ccd2f09f469ba" title="File inode (file identifier).">inode</a> &gt; prev_hdr.<a class="code" href="structBattFsPageHeader.html#a073705e71025f5e13f9ccd2f09f469ba" title="File inode (file identifier).">inode</a>);
<a name="l00457"></a>00457                 <span class="keywordflow">else</span>
<a name="l00458"></a>00458                     start = <span class="keyword">false</span>;
<a name="l00459"></a>00459 
<a name="l00460"></a>00460                 FSCHECK(hdr.<a class="code" href="structBattFsPageHeader.html#a8976d867f0fb78905c2a572e6cab2992" title="Page offset inside file.">pgoff</a> == 0);
<a name="l00461"></a>00461                 files++;
<a name="l00462"></a>00462             }
<a name="l00463"></a>00463             <span class="keywordflow">else</span>
<a name="l00464"></a>00464             {
<a name="l00465"></a>00465                 FSCHECK(hdr.<a class="code" href="structBattFsPageHeader.html#a5c59ce00449c562009b680adef4aebe7" title="Filled bytes in page.">fill</a> != 0);
<a name="l00466"></a>00466                 FSCHECK(prev_hdr.<a class="code" href="structBattFsPageHeader.html#a5c59ce00449c562009b680adef4aebe7" title="Filled bytes in page.">fill</a> == disk-&gt;<a class="code" href="structBattFsSuper.html#afc13e79aa3e0714eba8038a97e58caaa" title="Size of space usable for data in a disk page, in bytes. The rest is used by the page header...">data_size</a>);
<a name="l00467"></a>00467                 FSCHECK(hdr.<a class="code" href="structBattFsPageHeader.html#a8976d867f0fb78905c2a572e6cab2992" title="Page offset inside file.">pgoff</a> == prev_hdr.<a class="code" href="structBattFsPageHeader.html#a8976d867f0fb78905c2a572e6cab2992" title="Page offset inside file.">pgoff</a> + 1);
<a name="l00468"></a>00468             }
<a name="l00469"></a>00469             prev_hdr = hdr;
<a name="l00470"></a>00470         }
<a name="l00471"></a>00471     }
<a name="l00472"></a>00472 
<a name="l00473"></a>00473     FSCHECK(page_used == disk-&gt;<a class="code" href="structBattFsSuper.html#ac3d127852dca0d3de1fb9e5ccbec0ecd" title="Lowest address, in page array, for free pages.">free_page_start</a>);
<a name="l00474"></a>00474     FSCHECK(free_bytes == disk-&gt;<a class="code" href="structBattFsSuper.html#a274792c58d32ea62610a1f44c35b69ac" title="Free space on the disk.">free_bytes</a>);
<a name="l00475"></a>00475 
<a name="l00476"></a>00476     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00477"></a>00477 }
<a name="l00478"></a>00478 
<a name="l00483"></a><a class="code" href="battfs_8c.html#a5debb24bbd73cc9be4ae0e4f3882157f">00483</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="battfs_8c.html#a5debb24bbd73cc9be4ae0e4f3882157f" title="Flush file fd.">battfs_flush</a>(<span class="keyword">struct</span> <a class="code" href="structKFile.html" title="Context data for callback functions which operate on pseudo files.">KFile</a> *fd)
<a name="l00484"></a>00484 {
<a name="l00485"></a>00485     <a class="code" href="structBattFs.html" title="Describe a BattFs file usign a KFile.">BattFs</a> *fdb = <a class="code" href="battfs_8h.html#aa3454be3a409226483796545df248615" title="Macro used to cast a KFile to a BattFS.">BATTFS_CAST</a>(fd);
<a name="l00486"></a>00486 
<a name="l00487"></a>00487     <span class="keywordflow">if</span> (<a class="code" href="group__io__kblock.html#ga3c09ba3c8d69e8160284243c104ea6ae" title="Flush the cache (if any) to the device.">kblock_flush</a>(fdb-&gt;<a class="code" href="structBattFs.html#a06a576e0f36f94fb530930993e1d7a51" title="Disk context.">disk</a>-&gt;<a class="code" href="structBattFsSuper.html#a6da7bb93863793068a9ca2746fb035b4" title="Block device context (physical disk).">dev</a>) == 0)
<a name="l00488"></a>00488         <span class="keywordflow">return</span> 0;
<a name="l00489"></a>00489     <span class="keywordflow">else</span>
<a name="l00490"></a>00490     {
<a name="l00491"></a>00491         fdb-&gt;<a class="code" href="structBattFs.html#ae3dd3478b1e9c4b4fb77b0b2099be928" title="File status/errors.">errors</a> |= <a class="code" href="battfs_8h.html#ae58fb1fcd745519527a3df0b6143444c" title="Error flushing (writing) the current page to disk.">BATTFS_DISK_FLUSHBUF_ERR</a>;
<a name="l00492"></a>00492         <span class="keywordflow">return</span> EOF;
<a name="l00493"></a>00493     }
<a name="l00494"></a>00494 }
<a name="l00495"></a>00495 
<a name="l00500"></a><a class="code" href="battfs_8c.html#add20fbad9f3858073feddc78d3c68e91">00500</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="battfs_8c.html#add20fbad9f3858073feddc78d3c68e91" title="Close file fd.">battfs_fileclose</a>(<span class="keyword">struct</span> <a class="code" href="structKFile.html" title="Context data for callback functions which operate on pseudo files.">KFile</a> *fd)
<a name="l00501"></a>00501 {
<a name="l00502"></a>00502     <a class="code" href="structBattFs.html" title="Describe a BattFs file usign a KFile.">BattFs</a> *fdb = <a class="code" href="battfs_8h.html#aa3454be3a409226483796545df248615" title="Macro used to cast a KFile to a BattFS.">BATTFS_CAST</a>(fd);
<a name="l00503"></a>00503 
<a name="l00504"></a>00504     <span class="keywordflow">if</span> (<a class="code" href="battfs_8c.html#a5debb24bbd73cc9be4ae0e4f3882157f" title="Flush file fd.">battfs_flush</a>(fd) == 0)
<a name="l00505"></a>00505     {
<a name="l00506"></a>00506         <a class="code" href="group__list.html#ga849a0f1c77918e5845588373178ee4ca" title="Remove n from whatever list it is in.">REMOVE</a>(&amp;fdb-&gt;<a class="code" href="structBattFs.html#ab18ef03731072cdd67ccf55af005e781" title="Link for inserting in opened file list.">link</a>);
<a name="l00507"></a>00507         <span class="keywordflow">return</span> 0;
<a name="l00508"></a>00508     }
<a name="l00509"></a>00509     <span class="keywordflow">else</span>
<a name="l00510"></a>00510         <span class="keywordflow">return</span> EOF;
<a name="l00511"></a>00511 }
<a name="l00512"></a>00512 
<a name="l00513"></a>00513 <span class="preprocessor">#define NO_SPACE PAGE_UNSET_SENTINEL</span>
<a name="l00514"></a>00514 <span class="preprocessor"></span>
<a name="l00515"></a>00515 <span class="keyword">static</span> <a class="code" href="battfs_8h.html#ab696748712d719603833f401031a7907" title="Type for counting pages on disk.">pgcnt_t</a> allocateNewPage(<span class="keyword">struct</span> <a class="code" href="structBattFsSuper.html" title="Context used to describe a disk.">BattFsSuper</a> *disk, <a class="code" href="battfs_8h.html#ab696748712d719603833f401031a7907" title="Type for counting pages on disk.">pgcnt_t</a> new_pos, <a class="code" href="battfs_8h.html#a74713a2f9f355cad853593781defa824" title="Type for file inodes.">inode_t</a> inode)
<a name="l00516"></a>00516 {
<a name="l00517"></a>00517     <span class="keywordflow">if</span> (<a class="code" href="battfs_8h.html#a655dbaa973085429b2b0f5953f256c87" title="True if space on disk is over.">SPACE_OVER</a>(disk))
<a name="l00518"></a>00518     {
<a name="l00519"></a>00519         <a class="code" href="group__logging.html#ga19c97c740010c52ce6801d46a5346644" title="Output an error message.">LOG_ERR</a>(<span class="stringliteral">&quot;No disk space available!\n&quot;</span>);
<a name="l00520"></a>00520         <span class="keywordflow">return</span> NO_SPACE;
<a name="l00521"></a>00521     }
<a name="l00522"></a>00522 
<a name="l00523"></a>00523     <a class="code" href="group__logging.html#gaa5595314cc54c304a127c75cfcec4017" title="Output an informative message.">LOG_INFO</a>(<span class="stringliteral">&quot;Getting new page %d, pos %d\n&quot;</span>, disk-&gt;<a class="code" href="structBattFsSuper.html#ae018010b1733f1a278a5c40792f393de" title="Page allocation array.">page_array</a>[disk-&gt;<a class="code" href="structBattFsSuper.html#ac3d127852dca0d3de1fb9e5ccbec0ecd" title="Lowest address, in page array, for free pages.">free_page_start</a>], new_pos);
<a name="l00524"></a>00524     <a class="code" href="battfs_8h.html#ab696748712d719603833f401031a7907" title="Type for counting pages on disk.">pgcnt_t</a> new_page = disk-&gt;<a class="code" href="structBattFsSuper.html#ae018010b1733f1a278a5c40792f393de" title="Page allocation array.">page_array</a>[disk-&gt;<a class="code" href="structBattFsSuper.html#ac3d127852dca0d3de1fb9e5ccbec0ecd" title="Lowest address, in page array, for free pages.">free_page_start</a>++];
<a name="l00525"></a>00525     memmove(&amp;disk-&gt;<a class="code" href="structBattFsSuper.html#ae018010b1733f1a278a5c40792f393de" title="Page allocation array.">page_array</a>[new_pos + 1], &amp;disk-&gt;<a class="code" href="structBattFsSuper.html#ae018010b1733f1a278a5c40792f393de" title="Page allocation array.">page_array</a>[new_pos], (disk-&gt;<a class="code" href="structBattFsSuper.html#ac3d127852dca0d3de1fb9e5ccbec0ecd" title="Lowest address, in page array, for free pages.">free_page_start</a> - new_pos - 1) * <span class="keyword">sizeof</span>(<a class="code" href="battfs_8h.html#ab696748712d719603833f401031a7907" title="Type for counting pages on disk.">pgcnt_t</a>));
<a name="l00526"></a>00526 
<a name="l00527"></a>00527     <a class="code" href="structNode.html" title="This structure represents a node for bidirectional lists.">Node</a> *n;
<a name="l00528"></a>00528     <span class="comment">/* Move following file start point one position ahead. */</span>
<a name="l00529"></a>00529     <a class="code" href="group__list.html#ga91a9735c8acba8592b8b6872b1fbf2dd" title="Iterate over all nodes in a list.">FOREACH_NODE</a>(n, &amp;disk-&gt;<a class="code" href="structBattFsSuper.html#a491a8251adeb2f4dafd70b62e26cc195" title="List used to keep trace of open files.">file_opened_list</a>)
<a name="l00530"></a>00530     {
<a name="l00531"></a>00531         <a class="code" href="structBattFs.html" title="Describe a BattFs file usign a KFile.">BattFs</a> *file = <a class="code" href="compiler_8h.html#ad8a293330664172f7fb87c204bac34b3" title="Cast a member of a structure out to the containing structure.">containerof</a>(n, <a class="code" href="structBattFs.html" title="Describe a BattFs file usign a KFile.">BattFs</a>, link);
<a name="l00532"></a>00532         <span class="keywordflow">if</span> (file-&gt;<a class="code" href="structBattFs.html#ad6557799e39cb13d9ae6ce9bfbf50fe2" title="inode of the opened file">inode</a> &gt; inode)
<a name="l00533"></a>00533         {
<a name="l00534"></a>00534             <a class="code" href="group__logging.html#gaa5595314cc54c304a127c75cfcec4017" title="Output an informative message.">LOG_INFO</a>(<span class="stringliteral">&quot;Move file %d start pos\n&quot;</span>, file-&gt;<a class="code" href="structBattFs.html#ad6557799e39cb13d9ae6ce9bfbf50fe2" title="inode of the opened file">inode</a>);
<a name="l00535"></a>00535             file-&gt;<a class="code" href="structBattFs.html#ababfd85b718c28670a496a1a96f656e5" title="Pointer to page_array file start position.">start</a>++;
<a name="l00536"></a>00536         }
<a name="l00537"></a>00537     }
<a name="l00538"></a>00538 
<a name="l00539"></a>00539     disk-&gt;<a class="code" href="structBattFsSuper.html#ae018010b1733f1a278a5c40792f393de" title="Page allocation array.">page_array</a>[new_pos] = new_page;
<a name="l00540"></a>00540     <span class="keywordflow">return</span> new_page;
<a name="l00541"></a>00541 }
<a name="l00542"></a>00542 
<a name="l00543"></a>00543 <span class="keyword">static</span> <a class="code" href="battfs_8h.html#ab696748712d719603833f401031a7907" title="Type for counting pages on disk.">pgcnt_t</a> renewPage(<span class="keyword">struct</span> <a class="code" href="structBattFsSuper.html" title="Context used to describe a disk.">BattFsSuper</a> *disk, <a class="code" href="battfs_8h.html#ab696748712d719603833f401031a7907" title="Type for counting pages on disk.">pgcnt_t</a> old_pos)
<a name="l00544"></a>00544 {
<a name="l00545"></a>00545     <span class="keywordflow">if</span> (<a class="code" href="battfs_8h.html#a655dbaa973085429b2b0f5953f256c87" title="True if space on disk is over.">SPACE_OVER</a>(disk))
<a name="l00546"></a>00546     {
<a name="l00547"></a>00547         <a class="code" href="group__logging.html#ga19c97c740010c52ce6801d46a5346644" title="Output an error message.">LOG_ERR</a>(<span class="stringliteral">&quot;No disk space available!\n&quot;</span>);
<a name="l00548"></a>00548         <span class="keywordflow">return</span> NO_SPACE;
<a name="l00549"></a>00549     }
<a name="l00550"></a>00550 
<a name="l00551"></a>00551     <span class="comment">/* Get a free page */</span>
<a name="l00552"></a>00552     <a class="code" href="battfs_8h.html#ab696748712d719603833f401031a7907" title="Type for counting pages on disk.">pgcnt_t</a> new_page = disk-&gt;<a class="code" href="structBattFsSuper.html#ae018010b1733f1a278a5c40792f393de" title="Page allocation array.">page_array</a>[disk-&gt;<a class="code" href="structBattFsSuper.html#ac3d127852dca0d3de1fb9e5ccbec0ecd" title="Lowest address, in page array, for free pages.">free_page_start</a>];
<a name="l00553"></a>00553     <a class="code" href="battfs_8c.html#a79846b7cea24a012d60d2720cb2b6d6c" title="Move all pages in page allocation array from src to src + offset.">movePages</a>(disk, disk-&gt;<a class="code" href="structBattFsSuper.html#ac3d127852dca0d3de1fb9e5ccbec0ecd" title="Lowest address, in page array, for free pages.">free_page_start</a> + 1, -1);
<a name="l00554"></a>00554 
<a name="l00555"></a>00555     <span class="comment">/* Insert previous page in free blocks list */</span>
<a name="l00556"></a>00556     <a class="code" href="group__logging.html#gaa5595314cc54c304a127c75cfcec4017" title="Output an informative message.">LOG_INFO</a>(<span class="stringliteral">&quot;Setting page %d as free\n&quot;</span>, old_pos);
<a name="l00557"></a>00557     disk-&gt;<a class="code" href="structBattFsSuper.html#ae018010b1733f1a278a5c40792f393de" title="Page allocation array.">page_array</a>[disk-&gt;<a class="code" href="structBattFsSuper.html#a6da7bb93863793068a9ca2746fb035b4" title="Block device context (physical disk).">dev</a>-&gt;<a class="code" href="structKBlock.html#ad413baaa0d82a56b1006fd69acb53fcc" title="Number of blocks available in the device.">blk_cnt</a> - 1] = old_pos;
<a name="l00558"></a>00558     <span class="keywordflow">return</span> new_page;
<a name="l00559"></a>00559 }
<a name="l00560"></a>00560 
<a name="l00565"></a><a class="code" href="battfs_8c.html#ab2bc9f316bb9eee549712ed60b2429d4">00565</a> <span class="keyword">static</span> <span class="keywordtype">size_t</span> <a class="code" href="battfs_8c.html#ab2bc9f316bb9eee549712ed60b2429d4" title="Write to file fd size bytes from buf.">battfs_write</a>(<span class="keyword">struct</span> <a class="code" href="structKFile.html" title="Context data for callback functions which operate on pseudo files.">KFile</a> *fd, <span class="keyword">const</span> <span class="keywordtype">void</span> *_buf, <span class="keywordtype">size_t</span> size)
<a name="l00566"></a>00566 {
<a name="l00567"></a>00567     <a class="code" href="structBattFs.html" title="Describe a BattFs file usign a KFile.">BattFs</a> *fdb = <a class="code" href="battfs_8h.html#aa3454be3a409226483796545df248615" title="Macro used to cast a KFile to a BattFS.">BATTFS_CAST</a>(fd);
<a name="l00568"></a>00568     <a class="code" href="structBattFsSuper.html" title="Context used to describe a disk.">BattFsSuper</a> *disk = fdb-&gt;<a class="code" href="structBattFs.html#a06a576e0f36f94fb530930993e1d7a51" title="Disk context.">disk</a>;
<a name="l00569"></a>00569     <span class="keyword">const</span> uint8_t *buf = (<span class="keyword">const</span> uint8_t *)_buf;
<a name="l00570"></a>00570 
<a name="l00571"></a>00571     <span class="keywordtype">size_t</span> total_write = 0;
<a name="l00572"></a>00572     <a class="code" href="battfs_8h.html#abd9d9d290feaf2e76bce6142ae59019e" title="Type for counting pages inside a file.">pgoff_t</a> pg_offset;
<a name="l00573"></a>00573     <a class="code" href="battfs_8h.html#a533d079449525768fe3d92f4a8089c67" title="Type for addressing space inside a page.">pgaddr_t</a> addr_offset;
<a name="l00574"></a>00574     <a class="code" href="battfs_8h.html#a533d079449525768fe3d92f4a8089c67" title="Type for addressing space inside a page.">pgaddr_t</a> wr_len;
<a name="l00575"></a>00575     <a class="code" href="structBattFsPageHeader.html" title="BattFS page header, used to represent a page header in memory.">BattFsPageHeader</a> curr_hdr;
<a name="l00576"></a>00576     <a class="code" href="battfs_8h.html#ab696748712d719603833f401031a7907" title="Type for counting pages on disk.">pgcnt_t</a> new_page;
<a name="l00577"></a>00577 
<a name="l00578"></a>00578     <span class="keywordflow">if</span> (fd-&gt;seek_pos &lt; 0)
<a name="l00579"></a>00579     {
<a name="l00580"></a>00580         fdb-&gt;<a class="code" href="structBattFs.html#ae3dd3478b1e9c4b4fb77b0b2099be928" title="File status/errors.">errors</a> |= <a class="code" href="battfs_8h.html#a56f53433488152eaadf5f32af96b4fca" title="File errors.">BATTFS_NEGATIVE_SEEK_ERR</a>;
<a name="l00581"></a>00581         <span class="keywordflow">return</span> total_write;
<a name="l00582"></a>00582     }
<a name="l00583"></a>00583 
<a name="l00584"></a>00584     <span class="keywordflow">if</span> (fd-&gt;seek_pos &gt; fd-&gt;size)
<a name="l00585"></a>00585     {
<a name="l00586"></a>00586         <span class="keywordflow">if</span> (!<a class="code" href="battfs_8c.html#a041535a629472f6a28d1608337315ebc" title="Read header of page in hdr.">readHdr</a>(disk, fdb-&gt;<a class="code" href="structBattFs.html#ababfd85b718c28670a496a1a96f656e5" title="Pointer to page_array file start position.">start</a>[fdb-&gt;<a class="code" href="structBattFs.html#a60d0d47fd11329f3d579ff375333569d" title="Max page offset allocated for the file.">max_off</a>], &amp;curr_hdr))
<a name="l00587"></a>00587         {
<a name="l00588"></a>00588             fdb-&gt;<a class="code" href="structBattFs.html#ae3dd3478b1e9c4b4fb77b0b2099be928" title="File status/errors.">errors</a> |= <a class="code" href="battfs_8h.html#ad5f5f02fc2e2e920d004790a5ea0d4a5" title="Error reading from disk device.">BATTFS_DISK_READ_ERR</a>;
<a name="l00589"></a>00589             <span class="keywordflow">return</span> total_write;
<a name="l00590"></a>00590         }
<a name="l00591"></a>00591 
<a name="l00592"></a>00592         <span class="comment">/*</span>
<a name="l00593"></a>00593 <span class="comment">         * Renew page only if is not in cache.</span>
<a name="l00594"></a>00594 <span class="comment">         * This avoids rewriting the same page continuously</span>
<a name="l00595"></a>00595 <span class="comment">         * if the user code keeps writing in the same portion</span>
<a name="l00596"></a>00596 <span class="comment">         * of the file.</span>
<a name="l00597"></a>00597 <span class="comment">         */</span>
<a name="l00598"></a>00598         <span class="keywordflow">if</span> (<a class="code" href="group__io__kblock.html#gaa3d27079ce4119ed5549cde2deb98fe8">kblock_buffered</a>(disk-&gt;<a class="code" href="structBattFsSuper.html#a6da7bb93863793068a9ca2746fb035b4" title="Block device context (physical disk).">dev</a>)
<a name="l00599"></a>00599             &amp;&amp; ((fdb-&gt;<a class="code" href="structBattFs.html#ababfd85b718c28670a496a1a96f656e5" title="Pointer to page_array file start position.">start</a>[fdb-&gt;<a class="code" href="structBattFs.html#a60d0d47fd11329f3d579ff375333569d" title="Max page offset allocated for the file.">max_off</a>] != <a class="code" href="group__io__kblock.html#ga433e2e003e4fb47989dd60dea4baa062">kblock_cachedBlock</a>(disk-&gt;<a class="code" href="structBattFsSuper.html#a6da7bb93863793068a9ca2746fb035b4" title="Block device context (physical disk).">dev</a>)) || !<a class="code" href="group__io__kblock.html#ga98d097adfab2a37e9d25286a9c55f564" title="Return the status of the internal cache.">kblock_cacheDirty</a>(disk-&gt;<a class="code" href="structBattFsSuper.html#a6da7bb93863793068a9ca2746fb035b4" title="Block device context (physical disk).">dev</a>)))
<a name="l00600"></a>00600         {
<a name="l00601"></a>00601             new_page = renewPage(disk, fdb-&gt;<a class="code" href="structBattFs.html#ababfd85b718c28670a496a1a96f656e5" title="Pointer to page_array file start position.">start</a>[fdb-&gt;<a class="code" href="structBattFs.html#a60d0d47fd11329f3d579ff375333569d" title="Max page offset allocated for the file.">max_off</a>]);
<a name="l00602"></a>00602             <span class="keywordflow">if</span> (new_page == NO_SPACE)
<a name="l00603"></a>00603             {
<a name="l00604"></a>00604                 fdb-&gt;<a class="code" href="structBattFs.html#ae3dd3478b1e9c4b4fb77b0b2099be928" title="File status/errors.">errors</a> |= <a class="code" href="battfs_8h.html#a07e6c6967d3b82e1a6003ce648abbd43" title="No more disk space available.">BATTFS_DISK_SPACEOVER_ERR</a>;
<a name="l00605"></a>00605                 <span class="keywordflow">return</span> total_write;
<a name="l00606"></a>00606             }
<a name="l00607"></a>00607 
<a name="l00608"></a>00608             <a class="code" href="group__io__kblock.html#gaa2d454f0b9a082ded20f385c3cfc99a5" title="Copy one block to another.">kblock_copy</a>(disk-&gt;<a class="code" href="structBattFsSuper.html#a6da7bb93863793068a9ca2746fb035b4" title="Block device context (physical disk).">dev</a>, fdb-&gt;<a class="code" href="structBattFs.html#ababfd85b718c28670a496a1a96f656e5" title="Pointer to page_array file start position.">start</a>[fdb-&gt;<a class="code" href="structBattFs.html#a60d0d47fd11329f3d579ff375333569d" title="Max page offset allocated for the file.">max_off</a>], new_page);
<a name="l00609"></a>00609             fdb-&gt;<a class="code" href="structBattFs.html#ababfd85b718c28670a496a1a96f656e5" title="Pointer to page_array file start position.">start</a>[fdb-&gt;<a class="code" href="structBattFs.html#a60d0d47fd11329f3d579ff375333569d" title="Max page offset allocated for the file.">max_off</a>] = new_page;
<a name="l00610"></a>00610         }
<a name="l00611"></a>00611         <span class="keywordflow">else</span>
<a name="l00612"></a>00612             new_page = fdb-&gt;<a class="code" href="structBattFs.html#ababfd85b718c28670a496a1a96f656e5" title="Pointer to page_array file start position.">start</a>[fdb-&gt;<a class="code" href="structBattFs.html#a60d0d47fd11329f3d579ff375333569d" title="Max page offset allocated for the file.">max_off</a>];
<a name="l00613"></a>00613 
<a name="l00614"></a>00614         <span class="comment">/* Fill unused space of first page with 0s */</span>
<a name="l00615"></a>00615         uint8_t dummy = 0;
<a name="l00616"></a>00616         <span class="comment">// TODO: write in blocks to speed up things</span>
<a name="l00617"></a>00617         <a class="code" href="battfs_8h.html#a533d079449525768fe3d92f4a8089c67" title="Type for addressing space inside a page.">pgaddr_t</a> zero_bytes = MIN(fd-&gt;seek_pos - fd-&gt;size, (<a class="code" href="group__io__kfile.html#ga5137f80da20dbbbb731a84c9671612cd" title="KFile offset type, used by kfile_seek().">kfile_off_t</a>)(disk-&gt;<a class="code" href="structBattFsSuper.html#afc13e79aa3e0714eba8038a97e58caaa" title="Size of space usable for data in a disk page, in bytes. The rest is used by the page header...">data_size</a> - curr_hdr.<a class="code" href="structBattFsPageHeader.html#a5c59ce00449c562009b680adef4aebe7" title="Filled bytes in page.">fill</a>));
<a name="l00618"></a>00618         <span class="keywordflow">while</span> (zero_bytes--)
<a name="l00619"></a>00619         {
<a name="l00620"></a>00620             <span class="keywordflow">if</span> (<a class="code" href="group__io__kblock.html#ga069340cc7fe0a6aec2bada078ad9c889" title="Write data to the block device.">kblock_write</a>(disk-&gt;<a class="code" href="structBattFsSuper.html#a6da7bb93863793068a9ca2746fb035b4" title="Block device context (physical disk).">dev</a>, new_page, &amp;dummy, curr_hdr.<a class="code" href="structBattFsPageHeader.html#a5c59ce00449c562009b680adef4aebe7" title="Filled bytes in page.">fill</a>, 1) != 1)
<a name="l00621"></a>00621             {
<a name="l00622"></a>00622                 fdb-&gt;<a class="code" href="structBattFs.html#ae3dd3478b1e9c4b4fb77b0b2099be928" title="File status/errors.">errors</a> |= <a class="code" href="battfs_8h.html#a64b38adc1699a23bf33be496bc0a3a11" title="Error writing in the disk device.">BATTFS_DISK_WRITE_ERR</a>;
<a name="l00623"></a>00623                 <span class="keywordflow">return</span> total_write;
<a name="l00624"></a>00624             }
<a name="l00625"></a>00625             curr_hdr.<a class="code" href="structBattFsPageHeader.html#a5c59ce00449c562009b680adef4aebe7" title="Filled bytes in page.">fill</a>++;
<a name="l00626"></a>00626             fd-&gt;size++;
<a name="l00627"></a>00627             disk-&gt;<a class="code" href="structBattFsSuper.html#a274792c58d32ea62610a1f44c35b69ac" title="Free space on the disk.">free_bytes</a>--;
<a name="l00628"></a>00628         }
<a name="l00629"></a>00629         curr_hdr.<a class="code" href="structBattFsPageHeader.html#aa819f5f419727fa1857635686710d34b" title="Page sequence number.">seq</a>++;
<a name="l00630"></a>00630         <span class="keywordflow">if</span> (!writeHdr(disk, new_page, &amp;curr_hdr))
<a name="l00631"></a>00631         {
<a name="l00632"></a>00632             fdb-&gt;<a class="code" href="structBattFs.html#ae3dd3478b1e9c4b4fb77b0b2099be928" title="File status/errors.">errors</a> |= <a class="code" href="battfs_8h.html#a64b38adc1699a23bf33be496bc0a3a11" title="Error writing in the disk device.">BATTFS_DISK_WRITE_ERR</a>;
<a name="l00633"></a>00633             <span class="keywordflow">return</span> total_write;
<a name="l00634"></a>00634         }
<a name="l00635"></a>00635 
<a name="l00636"></a>00636         <span class="comment">/* Allocate the missing pages first. */</span>
<a name="l00637"></a>00637         <a class="code" href="battfs_8h.html#abd9d9d290feaf2e76bce6142ae59019e" title="Type for counting pages inside a file.">pgoff_t</a> missing_pages = fd-&gt;seek_pos / disk-&gt;<a class="code" href="structBattFsSuper.html#afc13e79aa3e0714eba8038a97e58caaa" title="Size of space usable for data in a disk page, in bytes. The rest is used by the page header...">data_size</a> - fdb-&gt;<a class="code" href="structBattFs.html#a60d0d47fd11329f3d579ff375333569d" title="Max page offset allocated for the file.">max_off</a>;
<a name="l00638"></a>00638 
<a name="l00639"></a>00639         <a class="code" href="group__logging.html#gaa5595314cc54c304a127c75cfcec4017" title="Output an informative message.">LOG_INFO</a>(<span class="stringliteral">&quot;missing pages: %d\n&quot;</span>, missing_pages);
<a name="l00640"></a>00640 
<a name="l00641"></a>00641         <span class="keywordflow">while</span> (missing_pages--)
<a name="l00642"></a>00642         {
<a name="l00643"></a>00643             zero_bytes = MIN((<a class="code" href="group__io__kfile.html#ga5137f80da20dbbbb731a84c9671612cd" title="KFile offset type, used by kfile_seek().">kfile_off_t</a>)disk-&gt;<a class="code" href="structBattFsSuper.html#afc13e79aa3e0714eba8038a97e58caaa" title="Size of space usable for data in a disk page, in bytes. The rest is used by the page header...">data_size</a>, fd-&gt;seek_pos - fd-&gt;size);
<a name="l00644"></a>00644 
<a name="l00645"></a>00645             new_page = allocateNewPage(disk, (fdb-&gt;<a class="code" href="structBattFs.html#ababfd85b718c28670a496a1a96f656e5" title="Pointer to page_array file start position.">start</a> - disk-&gt;<a class="code" href="structBattFsSuper.html#ae018010b1733f1a278a5c40792f393de" title="Page allocation array.">page_array</a>) + fdb-&gt;<a class="code" href="structBattFs.html#a60d0d47fd11329f3d579ff375333569d" title="Max page offset allocated for the file.">max_off</a> + 1, fdb-&gt;<a class="code" href="structBattFs.html#ad6557799e39cb13d9ae6ce9bfbf50fe2" title="inode of the opened file">inode</a>);
<a name="l00646"></a>00646             <span class="keywordflow">if</span> (new_page == NO_SPACE)
<a name="l00647"></a>00647             {
<a name="l00648"></a>00648                 fdb-&gt;<a class="code" href="structBattFs.html#ae3dd3478b1e9c4b4fb77b0b2099be928" title="File status/errors.">errors</a> |= <a class="code" href="battfs_8h.html#a07e6c6967d3b82e1a6003ce648abbd43" title="No more disk space available.">BATTFS_DISK_SPACEOVER_ERR</a>;
<a name="l00649"></a>00649                 <span class="keywordflow">return</span> total_write;
<a name="l00650"></a>00650             }
<a name="l00651"></a>00651 
<a name="l00652"></a>00652 
<a name="l00653"></a>00653             <span class="comment">// TODO: write in blocks to speed up things</span>
<a name="l00654"></a>00654             <span class="comment">/* Fill page buffer with 0 to avoid filling unused pages with garbage */</span>
<a name="l00655"></a>00655             <span class="keywordflow">for</span> (<a class="code" href="battfs_8h.html#a533d079449525768fe3d92f4a8089c67" title="Type for addressing space inside a page.">pgaddr_t</a> off = 0; off &lt; disk-&gt;<a class="code" href="structBattFsSuper.html#afc13e79aa3e0714eba8038a97e58caaa" title="Size of space usable for data in a disk page, in bytes. The rest is used by the page header...">data_size</a>; off++)
<a name="l00656"></a>00656             {
<a name="l00657"></a>00657                 <span class="keywordflow">if</span> (<a class="code" href="group__io__kblock.html#ga069340cc7fe0a6aec2bada078ad9c889" title="Write data to the block device.">kblock_write</a>(disk-&gt;<a class="code" href="structBattFsSuper.html#a6da7bb93863793068a9ca2746fb035b4" title="Block device context (physical disk).">dev</a>, new_page, &amp;dummy, off, 1) != 1)
<a name="l00658"></a>00658                 {
<a name="l00659"></a>00659                     fdb-&gt;<a class="code" href="structBattFs.html#ae3dd3478b1e9c4b4fb77b0b2099be928" title="File status/errors.">errors</a> |= <a class="code" href="battfs_8h.html#a64b38adc1699a23bf33be496bc0a3a11" title="Error writing in the disk device.">BATTFS_DISK_WRITE_ERR</a>;
<a name="l00660"></a>00660                     <span class="keywordflow">return</span> total_write;
<a name="l00661"></a>00661                 }
<a name="l00662"></a>00662             }
<a name="l00663"></a>00663             curr_hdr.<a class="code" href="structBattFsPageHeader.html#a073705e71025f5e13f9ccd2f09f469ba" title="File inode (file identifier).">inode</a> = fdb-&gt;<a class="code" href="structBattFs.html#ad6557799e39cb13d9ae6ce9bfbf50fe2" title="inode of the opened file">inode</a>;
<a name="l00664"></a>00664             curr_hdr.<a class="code" href="structBattFsPageHeader.html#a8976d867f0fb78905c2a572e6cab2992" title="Page offset inside file.">pgoff</a> = ++fdb-&gt;<a class="code" href="structBattFs.html#a60d0d47fd11329f3d579ff375333569d" title="Max page offset allocated for the file.">max_off</a>;
<a name="l00665"></a>00665             curr_hdr.<a class="code" href="structBattFsPageHeader.html#a5c59ce00449c562009b680adef4aebe7" title="Filled bytes in page.">fill</a> = zero_bytes;
<a name="l00666"></a>00666             curr_hdr.<a class="code" href="structBattFsPageHeader.html#aa819f5f419727fa1857635686710d34b" title="Page sequence number.">seq</a> = 0;
<a name="l00667"></a>00667 
<a name="l00668"></a>00668             <span class="keywordflow">if</span> (!writeHdr(disk, new_page, &amp;curr_hdr))
<a name="l00669"></a>00669             {
<a name="l00670"></a>00670                 fdb-&gt;<a class="code" href="structBattFs.html#ae3dd3478b1e9c4b4fb77b0b2099be928" title="File status/errors.">errors</a> |= <a class="code" href="battfs_8h.html#a64b38adc1699a23bf33be496bc0a3a11" title="Error writing in the disk device.">BATTFS_DISK_WRITE_ERR</a>;
<a name="l00671"></a>00671                 <span class="keywordflow">return</span> total_write;
<a name="l00672"></a>00672             }
<a name="l00673"></a>00673 
<a name="l00674"></a>00674             <span class="comment">/* Update size and free space left */</span>
<a name="l00675"></a>00675             fd-&gt;size += zero_bytes;
<a name="l00676"></a>00676             disk-&gt;<a class="code" href="structBattFsSuper.html#a274792c58d32ea62610a1f44c35b69ac" title="Free space on the disk.">free_bytes</a> -= zero_bytes;
<a name="l00677"></a>00677         }
<a name="l00678"></a>00678     }
<a name="l00679"></a>00679 
<a name="l00680"></a>00680     <span class="keywordflow">while</span> (size)
<a name="l00681"></a>00681     {
<a name="l00682"></a>00682         pg_offset = fd-&gt;seek_pos / disk-&gt;<a class="code" href="structBattFsSuper.html#afc13e79aa3e0714eba8038a97e58caaa" title="Size of space usable for data in a disk page, in bytes. The rest is used by the page header...">data_size</a>;
<a name="l00683"></a>00683         addr_offset = fd-&gt;seek_pos % disk-&gt;<a class="code" href="structBattFsSuper.html#afc13e79aa3e0714eba8038a97e58caaa" title="Size of space usable for data in a disk page, in bytes. The rest is used by the page header...">data_size</a>;
<a name="l00684"></a>00684         wr_len = MIN(size, (<span class="keywordtype">size_t</span>)(disk-&gt;<a class="code" href="structBattFsSuper.html#afc13e79aa3e0714eba8038a97e58caaa" title="Size of space usable for data in a disk page, in bytes. The rest is used by the page header...">data_size</a> - addr_offset));
<a name="l00685"></a>00685 
<a name="l00686"></a>00686         <span class="comment">/* Handle write outside EOF */</span>
<a name="l00687"></a>00687         <span class="keywordflow">if</span> (pg_offset &gt; fdb-&gt;<a class="code" href="structBattFs.html#a60d0d47fd11329f3d579ff375333569d" title="Max page offset allocated for the file.">max_off</a>)
<a name="l00688"></a>00688         {
<a name="l00689"></a>00689             <a class="code" href="group__logging.html#gaa5595314cc54c304a127c75cfcec4017" title="Output an informative message.">LOG_INFO</a>(<span class="stringliteral">&quot;New page needed, pg_offset %d, pos %d\n&quot;</span>, pg_offset, (<span class="keywordtype">int</span>)((fdb-&gt;<a class="code" href="structBattFs.html#ababfd85b718c28670a496a1a96f656e5" title="Pointer to page_array file start position.">start</a> - disk-&gt;<a class="code" href="structBattFsSuper.html#ae018010b1733f1a278a5c40792f393de" title="Page allocation array.">page_array</a>) + pg_offset));
<a name="l00690"></a>00690 
<a name="l00691"></a>00691             new_page = allocateNewPage(disk, (fdb-&gt;<a class="code" href="structBattFs.html#ababfd85b718c28670a496a1a96f656e5" title="Pointer to page_array file start position.">start</a> - disk-&gt;<a class="code" href="structBattFsSuper.html#ae018010b1733f1a278a5c40792f393de" title="Page allocation array.">page_array</a>) + pg_offset, fdb-&gt;<a class="code" href="structBattFs.html#ad6557799e39cb13d9ae6ce9bfbf50fe2" title="inode of the opened file">inode</a>);
<a name="l00692"></a>00692             <span class="keywordflow">if</span> (new_page == NO_SPACE)
<a name="l00693"></a>00693             {
<a name="l00694"></a>00694                 fdb-&gt;<a class="code" href="structBattFs.html#ae3dd3478b1e9c4b4fb77b0b2099be928" title="File status/errors.">errors</a> |= <a class="code" href="battfs_8h.html#a07e6c6967d3b82e1a6003ce648abbd43" title="No more disk space available.">BATTFS_DISK_SPACEOVER_ERR</a>;
<a name="l00695"></a>00695                 <span class="keywordflow">return</span> total_write;
<a name="l00696"></a>00696             }
<a name="l00697"></a>00697 
<a name="l00698"></a>00698             curr_hdr.<a class="code" href="structBattFsPageHeader.html#a073705e71025f5e13f9ccd2f09f469ba" title="File inode (file identifier).">inode</a> = fdb-&gt;<a class="code" href="structBattFs.html#ad6557799e39cb13d9ae6ce9bfbf50fe2" title="inode of the opened file">inode</a>;
<a name="l00699"></a>00699             curr_hdr.<a class="code" href="structBattFsPageHeader.html#a8976d867f0fb78905c2a572e6cab2992" title="Page offset inside file.">pgoff</a> = pg_offset;
<a name="l00700"></a>00700             curr_hdr.<a class="code" href="structBattFsPageHeader.html#a5c59ce00449c562009b680adef4aebe7" title="Filled bytes in page.">fill</a> = 0;
<a name="l00701"></a>00701             curr_hdr.<a class="code" href="structBattFsPageHeader.html#aa819f5f419727fa1857635686710d34b" title="Page sequence number.">seq</a> = 0;
<a name="l00702"></a>00702             fdb-&gt;<a class="code" href="structBattFs.html#a60d0d47fd11329f3d579ff375333569d" title="Max page offset allocated for the file.">max_off</a> = pg_offset;
<a name="l00703"></a>00703         }
<a name="l00704"></a>00704         <span class="keywordflow">else</span>
<a name="l00705"></a>00705         {
<a name="l00706"></a>00706             <span class="keywordflow">if</span> (!<a class="code" href="battfs_8c.html#a041535a629472f6a28d1608337315ebc" title="Read header of page in hdr.">readHdr</a>(disk, fdb-&gt;<a class="code" href="structBattFs.html#ababfd85b718c28670a496a1a96f656e5" title="Pointer to page_array file start position.">start</a>[pg_offset], &amp;curr_hdr))
<a name="l00707"></a>00707             {
<a name="l00708"></a>00708                 fdb-&gt;<a class="code" href="structBattFs.html#ae3dd3478b1e9c4b4fb77b0b2099be928" title="File status/errors.">errors</a> |= <a class="code" href="battfs_8h.html#ad5f5f02fc2e2e920d004790a5ea0d4a5" title="Error reading from disk device.">BATTFS_DISK_READ_ERR</a>;
<a name="l00709"></a>00709                 <span class="keywordflow">return</span> total_write;
<a name="l00710"></a>00710             }
<a name="l00711"></a>00711 
<a name="l00712"></a>00712             <span class="comment">/* Renew page only if is not in cache. */</span>
<a name="l00713"></a>00713             <span class="keywordflow">if</span> (<a class="code" href="group__io__kblock.html#gaa3d27079ce4119ed5549cde2deb98fe8">kblock_buffered</a>(disk-&gt;<a class="code" href="structBattFsSuper.html#a6da7bb93863793068a9ca2746fb035b4" title="Block device context (physical disk).">dev</a>)
<a name="l00714"></a>00714                 &amp;&amp; ((fdb-&gt;<a class="code" href="structBattFs.html#ababfd85b718c28670a496a1a96f656e5" title="Pointer to page_array file start position.">start</a>[fdb-&gt;<a class="code" href="structBattFs.html#a60d0d47fd11329f3d579ff375333569d" title="Max page offset allocated for the file.">max_off</a>] != <a class="code" href="group__io__kblock.html#ga433e2e003e4fb47989dd60dea4baa062">kblock_cachedBlock</a>(disk-&gt;<a class="code" href="structBattFsSuper.html#a6da7bb93863793068a9ca2746fb035b4" title="Block device context (physical disk).">dev</a>)) || !<a class="code" href="group__io__kblock.html#ga98d097adfab2a37e9d25286a9c55f564" title="Return the status of the internal cache.">kblock_cacheDirty</a>(disk-&gt;<a class="code" href="structBattFsSuper.html#a6da7bb93863793068a9ca2746fb035b4" title="Block device context (physical disk).">dev</a>)))
<a name="l00715"></a>00715             {
<a name="l00716"></a>00716                 new_page = renewPage(disk, fdb-&gt;<a class="code" href="structBattFs.html#ababfd85b718c28670a496a1a96f656e5" title="Pointer to page_array file start position.">start</a>[pg_offset]);
<a name="l00717"></a>00717                 <span class="keywordflow">if</span> (new_page == NO_SPACE)
<a name="l00718"></a>00718                 {
<a name="l00719"></a>00719                     fdb-&gt;<a class="code" href="structBattFs.html#ae3dd3478b1e9c4b4fb77b0b2099be928" title="File status/errors.">errors</a> |= <a class="code" href="battfs_8h.html#a07e6c6967d3b82e1a6003ce648abbd43" title="No more disk space available.">BATTFS_DISK_SPACEOVER_ERR</a>;
<a name="l00720"></a>00720                     <span class="keywordflow">return</span> total_write;
<a name="l00721"></a>00721                 }
<a name="l00722"></a>00722 
<a name="l00723"></a>00723                 <a class="code" href="group__logging.html#gaa5595314cc54c304a127c75cfcec4017" title="Output an informative message.">LOG_INFO</a>(<span class="stringliteral">&quot;Re-writing page %d to %d\n&quot;</span>, fdb-&gt;<a class="code" href="structBattFs.html#ababfd85b718c28670a496a1a96f656e5" title="Pointer to page_array file start position.">start</a>[pg_offset], new_page);
<a name="l00724"></a>00724                 <span class="keywordflow">if</span> (<a class="code" href="group__io__kblock.html#gaa2d454f0b9a082ded20f385c3cfc99a5" title="Copy one block to another.">kblock_copy</a>(disk-&gt;<a class="code" href="structBattFsSuper.html#a6da7bb93863793068a9ca2746fb035b4" title="Block device context (physical disk).">dev</a>, fdb-&gt;<a class="code" href="structBattFs.html#ababfd85b718c28670a496a1a96f656e5" title="Pointer to page_array file start position.">start</a>[pg_offset], new_page) != 0)
<a name="l00725"></a>00725                 {
<a name="l00726"></a>00726                     fdb-&gt;<a class="code" href="structBattFs.html#ae3dd3478b1e9c4b4fb77b0b2099be928" title="File status/errors.">errors</a> |= <a class="code" href="battfs_8h.html#a64b38adc1699a23bf33be496bc0a3a11" title="Error writing in the disk device.">BATTFS_DISK_WRITE_ERR</a>;
<a name="l00727"></a>00727                     <span class="keywordflow">return</span> total_write;
<a name="l00728"></a>00728                 }
<a name="l00729"></a>00729                 fdb-&gt;<a class="code" href="structBattFs.html#ababfd85b718c28670a496a1a96f656e5" title="Pointer to page_array file start position.">start</a>[pg_offset] = new_page;
<a name="l00730"></a>00730             }
<a name="l00731"></a>00731             <span class="keywordflow">else</span>
<a name="l00732"></a>00732             {
<a name="l00733"></a>00733                 <a class="code" href="group__logging.html#gaa5595314cc54c304a127c75cfcec4017" title="Output an informative message.">LOG_INFO</a>(<span class="stringliteral">&quot;Using cached block %d\n&quot;</span>, fdb-&gt;<a class="code" href="structBattFs.html#ababfd85b718c28670a496a1a96f656e5" title="Pointer to page_array file start position.">start</a>[pg_offset]);
<a name="l00734"></a>00734                 new_page = fdb-&gt;<a class="code" href="structBattFs.html#ababfd85b718c28670a496a1a96f656e5" title="Pointer to page_array file start position.">start</a>[pg_offset];
<a name="l00735"></a>00735             }
<a name="l00736"></a>00736 
<a name="l00737"></a>00737             curr_hdr.<a class="code" href="structBattFsPageHeader.html#aa819f5f419727fa1857635686710d34b" title="Page sequence number.">seq</a>++;
<a name="l00738"></a>00738         }
<a name="l00739"></a>00739         <span class="comment">//LOG_INFO(&quot;writing to buffer for page %d, offset %d, size %d\n&quot;, disk-&gt;curr_page, addr_offset, wr_len);</span>
<a name="l00740"></a>00740         <span class="keywordflow">if</span> (<a class="code" href="group__io__kblock.html#ga069340cc7fe0a6aec2bada078ad9c889" title="Write data to the block device.">kblock_write</a>(disk-&gt;<a class="code" href="structBattFsSuper.html#a6da7bb93863793068a9ca2746fb035b4" title="Block device context (physical disk).">dev</a>, new_page, buf, addr_offset, wr_len) != wr_len)
<a name="l00741"></a>00741         {
<a name="l00742"></a>00742             fdb-&gt;<a class="code" href="structBattFs.html#ae3dd3478b1e9c4b4fb77b0b2099be928" title="File status/errors.">errors</a> |= <a class="code" href="battfs_8h.html#a64b38adc1699a23bf33be496bc0a3a11" title="Error writing in the disk device.">BATTFS_DISK_WRITE_ERR</a>;
<a name="l00743"></a>00743             <span class="keywordflow">return</span> total_write;
<a name="l00744"></a>00744         }
<a name="l00745"></a>00745 
<a name="l00746"></a>00746         size -= wr_len;
<a name="l00747"></a>00747         fd-&gt;seek_pos += wr_len;
<a name="l00748"></a>00748         total_write += wr_len;
<a name="l00749"></a>00749         buf += wr_len;
<a name="l00750"></a>00750         <a class="code" href="battfs_8h.html#af0b3070403482fbfa266d6e3e6cff088" title="Type for keeping trace of space filled inside a page.">fill_t</a> fill_delta = MAX((int32_t)(addr_offset + wr_len) - curr_hdr.<a class="code" href="structBattFsPageHeader.html#a5c59ce00449c562009b680adef4aebe7" title="Filled bytes in page.">fill</a>, (int32_t)0);
<a name="l00751"></a>00751         disk-&gt;<a class="code" href="structBattFsSuper.html#a274792c58d32ea62610a1f44c35b69ac" title="Free space on the disk.">free_bytes</a> -= fill_delta;
<a name="l00752"></a>00752         fd-&gt;size += fill_delta;
<a name="l00753"></a>00753         curr_hdr.<a class="code" href="structBattFsPageHeader.html#a5c59ce00449c562009b680adef4aebe7" title="Filled bytes in page.">fill</a> += fill_delta;
<a name="l00754"></a>00754 
<a name="l00755"></a>00755         <span class="keywordflow">if</span> (!writeHdr(disk, new_page, &amp;curr_hdr))
<a name="l00756"></a>00756         {
<a name="l00757"></a>00757             fdb-&gt;<a class="code" href="structBattFs.html#ae3dd3478b1e9c4b4fb77b0b2099be928" title="File status/errors.">errors</a> |= <a class="code" href="battfs_8h.html#a64b38adc1699a23bf33be496bc0a3a11" title="Error writing in the disk device.">BATTFS_DISK_WRITE_ERR</a>;
<a name="l00758"></a>00758             <span class="keywordflow">return</span> total_write;
<a name="l00759"></a>00759         }
<a name="l00760"></a>00760 
<a name="l00761"></a>00761         <span class="comment">//LOG_INFO(&quot;free_bytes %d, seek_pos %d, size %d, curr_hdr.fill %d\n&quot;, disk-&gt;free_bytes, fd-&gt;seek_pos, fd-&gt;size, curr_hdr.fill);</span>
<a name="l00762"></a>00762     }
<a name="l00763"></a>00763     <span class="keywordflow">return</span> total_write;
<a name="l00764"></a>00764 }
<a name="l00765"></a>00765 
<a name="l00766"></a>00766 
<a name="l00771"></a><a class="code" href="battfs_8c.html#afd2ad685dca2d309e910aa6a0c5942b5">00771</a> <span class="keyword">static</span> <span class="keywordtype">size_t</span> <a class="code" href="battfs_8c.html#afd2ad685dca2d309e910aa6a0c5942b5" title="Read from file fd size bytes in buf.">battfs_read</a>(<span class="keyword">struct</span> <a class="code" href="structKFile.html" title="Context data for callback functions which operate on pseudo files.">KFile</a> *fd, <span class="keywordtype">void</span> *_buf, <span class="keywordtype">size_t</span> size)
<a name="l00772"></a>00772 {
<a name="l00773"></a>00773     <a class="code" href="structBattFs.html" title="Describe a BattFs file usign a KFile.">BattFs</a> *fdb = <a class="code" href="battfs_8h.html#aa3454be3a409226483796545df248615" title="Macro used to cast a KFile to a BattFS.">BATTFS_CAST</a>(fd);
<a name="l00774"></a>00774     <a class="code" href="structBattFsSuper.html" title="Context used to describe a disk.">BattFsSuper</a> *disk = fdb-&gt;<a class="code" href="structBattFs.html#a06a576e0f36f94fb530930993e1d7a51" title="Disk context.">disk</a>;
<a name="l00775"></a>00775     uint8_t *buf = (uint8_t *)_buf;
<a name="l00776"></a>00776 
<a name="l00777"></a>00777     <span class="keywordtype">size_t</span> total_read = 0;
<a name="l00778"></a>00778     <a class="code" href="battfs_8h.html#abd9d9d290feaf2e76bce6142ae59019e" title="Type for counting pages inside a file.">pgoff_t</a> pg_offset;
<a name="l00779"></a>00779     <a class="code" href="battfs_8h.html#a533d079449525768fe3d92f4a8089c67" title="Type for addressing space inside a page.">pgaddr_t</a> addr_offset;
<a name="l00780"></a>00780     <a class="code" href="battfs_8h.html#a533d079449525768fe3d92f4a8089c67" title="Type for addressing space inside a page.">pgaddr_t</a> read_len;
<a name="l00781"></a>00781 
<a name="l00782"></a>00782     <span class="keywordflow">if</span> (fd-&gt;seek_pos &lt; 0)
<a name="l00783"></a>00783     {
<a name="l00784"></a>00784         fdb-&gt;<a class="code" href="structBattFs.html#ae3dd3478b1e9c4b4fb77b0b2099be928" title="File status/errors.">errors</a> |= <a class="code" href="battfs_8h.html#a56f53433488152eaadf5f32af96b4fca" title="File errors.">BATTFS_NEGATIVE_SEEK_ERR</a>;
<a name="l00785"></a>00785         <span class="keywordflow">return</span> total_read;
<a name="l00786"></a>00786     }
<a name="l00787"></a>00787 
<a name="l00788"></a>00788     size = MIN((<a class="code" href="group__io__kfile.html#ga5137f80da20dbbbb731a84c9671612cd" title="KFile offset type, used by kfile_seek().">kfile_off_t</a>)size, MAX(fd-&gt;size - fd-&gt;seek_pos, (<a class="code" href="group__io__kfile.html#ga5137f80da20dbbbb731a84c9671612cd" title="KFile offset type, used by kfile_seek().">kfile_off_t</a>)0));
<a name="l00789"></a>00789 
<a name="l00790"></a>00790     <span class="keywordflow">while</span> (size)
<a name="l00791"></a>00791     {
<a name="l00792"></a>00792         pg_offset = fd-&gt;seek_pos / disk-&gt;<a class="code" href="structBattFsSuper.html#afc13e79aa3e0714eba8038a97e58caaa" title="Size of space usable for data in a disk page, in bytes. The rest is used by the page header...">data_size</a>;
<a name="l00793"></a>00793         addr_offset = fd-&gt;seek_pos % disk-&gt;<a class="code" href="structBattFsSuper.html#afc13e79aa3e0714eba8038a97e58caaa" title="Size of space usable for data in a disk page, in bytes. The rest is used by the page header...">data_size</a>;
<a name="l00794"></a>00794         read_len = MIN(size, (<span class="keywordtype">size_t</span>)(disk-&gt;<a class="code" href="structBattFsSuper.html#afc13e79aa3e0714eba8038a97e58caaa" title="Size of space usable for data in a disk page, in bytes. The rest is used by the page header...">data_size</a> - addr_offset));
<a name="l00795"></a>00795 
<a name="l00796"></a>00796         <span class="comment">//LOG_INFO(&quot;reading from page %d, offset %d, size %d\n&quot;, fdb-&gt;start[pg_offset], addr_offset, read_len);</span>
<a name="l00797"></a>00797         <span class="comment">/* Read from disk */</span>
<a name="l00798"></a>00798         <span class="keywordflow">if</span> (<a class="code" href="group__io__kblock.html#ga1f50056687e375253e3d11b11bc060a5" title="Read data from the block device.">kblock_read</a>(disk-&gt;<a class="code" href="structBattFsSuper.html#a6da7bb93863793068a9ca2746fb035b4" title="Block device context (physical disk).">dev</a>, fdb-&gt;<a class="code" href="structBattFs.html#ababfd85b718c28670a496a1a96f656e5" title="Pointer to page_array file start position.">start</a>[pg_offset], buf, addr_offset, read_len) != read_len)
<a name="l00799"></a>00799         {
<a name="l00800"></a>00800             fdb-&gt;<a class="code" href="structBattFs.html#ae3dd3478b1e9c4b4fb77b0b2099be928" title="File status/errors.">errors</a> |= <a class="code" href="battfs_8h.html#ad5f5f02fc2e2e920d004790a5ea0d4a5" title="Error reading from disk device.">BATTFS_DISK_READ_ERR</a>;
<a name="l00801"></a>00801             <span class="keywordflow">return</span> total_read;
<a name="l00802"></a>00802         }
<a name="l00803"></a>00803 
<a name="l00804"></a>00804 <span class="preprocessor">        #ifdef _DEBUG</span>
<a name="l00805"></a>00805 <span class="preprocessor"></span>            <a class="code" href="structBattFsPageHeader.html" title="BattFS page header, used to represent a page header in memory.">BattFsPageHeader</a> hdr;
<a name="l00806"></a>00806             <a class="code" href="battfs_8c.html#a041535a629472f6a28d1608337315ebc" title="Read header of page in hdr.">readHdr</a>(disk, fdb-&gt;<a class="code" href="structBattFs.html#ababfd85b718c28670a496a1a96f656e5" title="Pointer to page_array file start position.">start</a>[pg_offset], &amp;hdr);
<a name="l00807"></a>00807             <a class="code" href="group__debug.html#gaca68c0d4ac8df0838e209fb5300f7be3" title="Assert a pre-condition on code.">ASSERT</a>(hdr.<a class="code" href="structBattFsPageHeader.html#a073705e71025f5e13f9ccd2f09f469ba" title="File inode (file identifier).">inode</a> == fdb-&gt;<a class="code" href="structBattFs.html#ad6557799e39cb13d9ae6ce9bfbf50fe2" title="inode of the opened file">inode</a>);
<a name="l00808"></a>00808 <span class="preprocessor">        #endif</span>
<a name="l00809"></a>00809 <span class="preprocessor"></span>
<a name="l00810"></a>00810         size -= read_len;
<a name="l00811"></a>00811         fd-&gt;seek_pos += read_len;
<a name="l00812"></a>00812         total_read += read_len;
<a name="l00813"></a>00813         buf += read_len;
<a name="l00814"></a>00814     }
<a name="l00815"></a>00815     <span class="keywordflow">return</span> total_read;
<a name="l00816"></a>00816 }
<a name="l00817"></a>00817 
<a name="l00818"></a>00818 
<a name="l00827"></a><a class="code" href="battfs_8c.html#a96cb0603adb42df156113679352c65d8">00827</a> <span class="keyword">static</span> <span class="keywordtype">bool</span> <a class="code" href="battfs_8c.html#a96cb0603adb42df156113679352c65d8" title="Search file inode in disk using a binary search.">findFile</a>(<a class="code" href="structBattFsSuper.html" title="Context used to describe a disk.">BattFsSuper</a> *disk, <a class="code" href="battfs_8h.html#a74713a2f9f355cad853593781defa824" title="Type for file inodes.">inode_t</a> inode, <a class="code" href="battfs_8h.html#ab696748712d719603833f401031a7907" title="Type for counting pages on disk.">pgcnt_t</a> *last)
<a name="l00828"></a>00828 {
<a name="l00829"></a>00829     <a class="code" href="structBattFsPageHeader.html" title="BattFS page header, used to represent a page header in memory.">BattFsPageHeader</a> hdr;
<a name="l00830"></a>00830     <a class="code" href="battfs_8h.html#ab696748712d719603833f401031a7907" title="Type for counting pages on disk.">pgcnt_t</a> first = 0, page;
<a name="l00831"></a>00831     *last = disk-&gt;<a class="code" href="structBattFsSuper.html#ac3d127852dca0d3de1fb9e5ccbec0ecd" title="Lowest address, in page array, for free pages.">free_page_start</a>;
<a name="l00832"></a>00832     <a class="code" href="battfs_8h.html#aaf7617a98621b494ad58b8bbbdf9306e" title="Type for header FCS.">fcs_t</a> fcs;
<a name="l00833"></a>00833 
<a name="l00834"></a>00834     <span class="keywordflow">while</span> (first &lt; *last)
<a name="l00835"></a>00835     {
<a name="l00836"></a>00836         page = (first + *last) / 2;
<a name="l00837"></a>00837         <a class="code" href="group__logging.html#gaa5595314cc54c304a127c75cfcec4017" title="Output an informative message.">LOG_INFO</a>(<span class="stringliteral">&quot;first %d, last %d, page %d\n&quot;</span>, first, *last, page);
<a name="l00838"></a>00838         <span class="keywordflow">if</span> (!<a class="code" href="battfs_8c.html#a041535a629472f6a28d1608337315ebc" title="Read header of page in hdr.">readHdr</a>(disk, disk-&gt;<a class="code" href="structBattFsSuper.html#ae018010b1733f1a278a5c40792f393de" title="Page allocation array.">page_array</a>[page], &amp;hdr))
<a name="l00839"></a>00839             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00840"></a>00840         <a class="code" href="group__logging.html#gaa5595314cc54c304a127c75cfcec4017" title="Output an informative message.">LOG_INFO</a>(<span class="stringliteral">&quot;inode read: %d\n&quot;</span>, hdr.<a class="code" href="structBattFsPageHeader.html#a073705e71025f5e13f9ccd2f09f469ba" title="File inode (file identifier).">inode</a>);
<a name="l00841"></a>00841         fcs = <a class="code" href="battfs_8c.html#af1a47fc53b7a1972011ca0c9f8f7e927" title="Compute the fcs of the header.">computeFcs</a>(&amp;hdr);
<a name="l00842"></a>00842         <span class="keywordflow">if</span> (hdr.<a class="code" href="structBattFsPageHeader.html#a5f22e3d0d6a817a95b454dafd43aba3f" title="FCS (Frame Check Sequence) of the page header.">fcs</a> == fcs &amp;&amp; hdr.<a class="code" href="structBattFsPageHeader.html#a073705e71025f5e13f9ccd2f09f469ba" title="File inode (file identifier).">inode</a> == inode)
<a name="l00843"></a>00843         {
<a name="l00844"></a>00844             *last = page - hdr.<a class="code" href="structBattFsPageHeader.html#a8976d867f0fb78905c2a572e6cab2992" title="Page offset inside file.">pgoff</a>;
<a name="l00845"></a>00845             <a class="code" href="group__logging.html#gaa5595314cc54c304a127c75cfcec4017" title="Output an informative message.">LOG_INFO</a>(<span class="stringliteral">&quot;Found: %d\n&quot;</span>, *last);
<a name="l00846"></a>00846             <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00847"></a>00847         }
<a name="l00848"></a>00848         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (hdr.<a class="code" href="structBattFsPageHeader.html#a5f22e3d0d6a817a95b454dafd43aba3f" title="FCS (Frame Check Sequence) of the page header.">fcs</a> == fcs &amp;&amp; hdr.<a class="code" href="structBattFsPageHeader.html#a073705e71025f5e13f9ccd2f09f469ba" title="File inode (file identifier).">inode</a> &lt; inode)
<a name="l00849"></a>00849             first = page + 1;
<a name="l00850"></a>00850         <span class="keywordflow">else</span>
<a name="l00851"></a>00851             *last = page;
<a name="l00852"></a>00852     }
<a name="l00853"></a>00853     <a class="code" href="group__logging.html#gaa5595314cc54c304a127c75cfcec4017" title="Output an informative message.">LOG_INFO</a>(<span class="stringliteral">&quot;Not found: last %d\n&quot;</span>, *last);
<a name="l00854"></a>00854     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00855"></a>00855 }
<a name="l00856"></a>00856 
<a name="l00860"></a><a class="code" href="battfs_8h.html#a7469859a17ef79668fdc9b3e949bba7b">00860</a> <span class="keywordtype">bool</span> <a class="code" href="battfs_8c.html#a7469859a17ef79668fdc9b3e949bba7b">battfs_fileExists</a>(<a class="code" href="structBattFsSuper.html" title="Context used to describe a disk.">BattFsSuper</a> *disk, <a class="code" href="battfs_8h.html#a74713a2f9f355cad853593781defa824" title="Type for file inodes.">inode_t</a> inode)
<a name="l00861"></a>00861 {
<a name="l00862"></a>00862     <a class="code" href="battfs_8h.html#ab696748712d719603833f401031a7907" title="Type for counting pages on disk.">pgcnt_t</a> dummy;
<a name="l00863"></a>00863     <span class="keywordflow">return</span> <a class="code" href="battfs_8c.html#a96cb0603adb42df156113679352c65d8" title="Search file inode in disk using a binary search.">findFile</a>(disk, inode, &amp;dummy);
<a name="l00864"></a>00864 }
<a name="l00865"></a>00865 
<a name="l00871"></a><a class="code" href="battfs_8c.html#ad4ab98ab173f00db6190ff1f4c866b09">00871</a> <span class="keyword">static</span> <a class="code" href="battfs_8h.html#a63bb07cc5b9e2d76ea5499b397e2b4ee" title="Type for file sizes.">file_size_t</a> <a class="code" href="battfs_8c.html#ad4ab98ab173f00db6190ff1f4c866b09" title="Count size of file inode on disk, starting at pointer start in disk-&gt;page_array.">countFileSize</a>(<a class="code" href="structBattFsSuper.html" title="Context used to describe a disk.">BattFsSuper</a> *disk, <a class="code" href="battfs_8h.html#ab696748712d719603833f401031a7907" title="Type for counting pages on disk.">pgcnt_t</a> *start, <a class="code" href="battfs_8h.html#a74713a2f9f355cad853593781defa824" title="Type for file inodes.">inode_t</a> inode)
<a name="l00872"></a>00872 {
<a name="l00873"></a>00873     <a class="code" href="battfs_8h.html#a63bb07cc5b9e2d76ea5499b397e2b4ee" title="Type for file sizes.">file_size_t</a> size = 0;
<a name="l00874"></a>00874     <a class="code" href="structBattFsPageHeader.html" title="BattFS page header, used to represent a page header in memory.">BattFsPageHeader</a> hdr;
<a name="l00875"></a>00875 
<a name="l00876"></a>00876     <span class="keywordflow">while</span> (start &lt; &amp;disk-&gt;page_array[disk-&gt;<a class="code" href="structBattFsSuper.html#ac3d127852dca0d3de1fb9e5ccbec0ecd" title="Lowest address, in page array, for free pages.">free_page_start</a>])
<a name="l00877"></a>00877     {
<a name="l00878"></a>00878         <span class="keywordflow">if</span> (!<a class="code" href="battfs_8c.html#a041535a629472f6a28d1608337315ebc" title="Read header of page in hdr.">readHdr</a>(disk, *start++, &amp;hdr))
<a name="l00879"></a>00879             <span class="keywordflow">return</span> EOF;
<a name="l00880"></a>00880         <span class="keywordflow">if</span> (hdr.<a class="code" href="structBattFsPageHeader.html#a5f22e3d0d6a817a95b454dafd43aba3f" title="FCS (Frame Check Sequence) of the page header.">fcs</a> == <a class="code" href="battfs_8c.html#af1a47fc53b7a1972011ca0c9f8f7e927" title="Compute the fcs of the header.">computeFcs</a>(&amp;hdr) &amp;&amp; hdr.<a class="code" href="structBattFsPageHeader.html#a073705e71025f5e13f9ccd2f09f469ba" title="File inode (file identifier).">inode</a> == inode)
<a name="l00881"></a>00881             size += hdr.<a class="code" href="structBattFsPageHeader.html#a5c59ce00449c562009b680adef4aebe7" title="Filled bytes in page.">fill</a>;
<a name="l00882"></a>00882         <span class="keywordflow">else</span>
<a name="l00883"></a>00883             <span class="keywordflow">break</span>;
<a name="l00884"></a>00884     }
<a name="l00885"></a>00885     <span class="keywordflow">return</span> size;
<a name="l00886"></a>00886 }
<a name="l00887"></a>00887 
<a name="l00888"></a>00888 <span class="keyword">static</span> <span class="keywordtype">int</span> battfs_error(<span class="keyword">struct</span> <a class="code" href="structKFile.html" title="Context data for callback functions which operate on pseudo files.">KFile</a> *fd)
<a name="l00889"></a>00889 {
<a name="l00890"></a>00890     <a class="code" href="structBattFs.html" title="Describe a BattFs file usign a KFile.">BattFs</a> *fdb = <a class="code" href="battfs_8h.html#aa3454be3a409226483796545df248615" title="Macro used to cast a KFile to a BattFS.">BATTFS_CAST</a>(fd);
<a name="l00891"></a>00891     <span class="keywordflow">return</span> fdb-&gt;<a class="code" href="structBattFs.html#ae3dd3478b1e9c4b4fb77b0b2099be928" title="File status/errors.">errors</a>;
<a name="l00892"></a>00892 }
<a name="l00893"></a>00893 
<a name="l00894"></a>00894 
<a name="l00895"></a>00895 <span class="keyword">static</span> <span class="keywordtype">void</span> battfs_clearerr(<span class="keyword">struct</span> <a class="code" href="structKFile.html" title="Context data for callback functions which operate on pseudo files.">KFile</a> *fd)
<a name="l00896"></a>00896 {
<a name="l00897"></a>00897     <a class="code" href="structBattFs.html" title="Describe a BattFs file usign a KFile.">BattFs</a> *fdb = <a class="code" href="battfs_8h.html#aa3454be3a409226483796545df248615" title="Macro used to cast a KFile to a BattFS.">BATTFS_CAST</a>(fd);
<a name="l00898"></a>00898     fdb-&gt;<a class="code" href="structBattFs.html#ae3dd3478b1e9c4b4fb77b0b2099be928" title="File status/errors.">errors</a> = 0;
<a name="l00899"></a>00899 }
<a name="l00900"></a>00900 
<a name="l00906"></a><a class="code" href="battfs_8h.html#a8295240f9546944d0b8e1b06a1e5579d">00906</a> <span class="keywordtype">bool</span> <a class="code" href="battfs_8c.html#a8295240f9546944d0b8e1b06a1e5579d" title="Open file inode from disk in mode.">battfs_fileopen</a>(<a class="code" href="structBattFsSuper.html" title="Context used to describe a disk.">BattFsSuper</a> *disk, <a class="code" href="structBattFs.html" title="Describe a BattFs file usign a KFile.">BattFs</a> *fd, <a class="code" href="battfs_8h.html#a74713a2f9f355cad853593781defa824" title="Type for file inodes.">inode_t</a> inode, <a class="code" href="battfs_8h.html#adf5532a6841c3713f99a378e3f9f7a82" title="Type for file open modes.">filemode_t</a> mode)
<a name="l00907"></a>00907 {
<a name="l00908"></a>00908     <a class="code" href="structNode.html" title="This structure represents a node for bidirectional lists.">Node</a> *n;
<a name="l00909"></a>00909 
<a name="l00910"></a>00910     memset(fd, 0, <span class="keyword">sizeof</span>(*fd));
<a name="l00911"></a>00911 
<a name="l00912"></a>00912     <span class="comment">/* Search file start point in disk page array */</span>
<a name="l00913"></a>00913     <a class="code" href="battfs_8h.html#ab696748712d719603833f401031a7907" title="Type for counting pages on disk.">pgcnt_t</a> start_pos;
<a name="l00914"></a>00914     <span class="keywordflow">if</span> (!<a class="code" href="battfs_8c.html#a96cb0603adb42df156113679352c65d8" title="Search file inode in disk using a binary search.">findFile</a>(disk, inode, &amp;start_pos))
<a name="l00915"></a>00915     {
<a name="l00916"></a>00916         <a class="code" href="group__logging.html#gaa5595314cc54c304a127c75cfcec4017" title="Output an informative message.">LOG_INFO</a>(<span class="stringliteral">&quot;file %d not found\n&quot;</span>, inode);
<a name="l00917"></a>00917         <span class="keywordflow">if</span> (!(mode &amp; <a class="code" href="battfs_8h.html#a28f6a15a43a57c449718ae0d291cc6a8" title="Modes for battfs_fileopen.">BATTFS_CREATE</a>))
<a name="l00918"></a>00918         {
<a name="l00919"></a>00919             fd-&gt;<a class="code" href="structBattFs.html#ae3dd3478b1e9c4b4fb77b0b2099be928" title="File status/errors.">errors</a> |= <a class="code" href="battfs_8h.html#a60adbbfdf02b27134b0a24c7286371f4" title="File not found on disk.">BATTFS_FILE_NOT_FOUND_ERR</a>;
<a name="l00920"></a>00920             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00921"></a>00921         }
<a name="l00922"></a>00922         <span class="comment">/* Create the file */</span>
<a name="l00923"></a>00923         <a class="code" href="structBattFsPageHeader.html" title="BattFS page header, used to represent a page header in memory.">BattFsPageHeader</a> hdr;
<a name="l00924"></a>00924 
<a name="l00925"></a>00925         <span class="keywordflow">if</span> (allocateNewPage(disk, start_pos, inode) == NO_SPACE)
<a name="l00926"></a>00926         {
<a name="l00927"></a>00927             fd-&gt;<a class="code" href="structBattFs.html#ae3dd3478b1e9c4b4fb77b0b2099be928" title="File status/errors.">errors</a> |= <a class="code" href="battfs_8h.html#a07e6c6967d3b82e1a6003ce648abbd43" title="No more disk space available.">BATTFS_DISK_SPACEOVER_ERR</a>;
<a name="l00928"></a>00928             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00929"></a>00929         }
<a name="l00930"></a>00930 
<a name="l00931"></a>00931         hdr.<a class="code" href="structBattFsPageHeader.html#a073705e71025f5e13f9ccd2f09f469ba" title="File inode (file identifier).">inode</a> = inode;
<a name="l00932"></a>00932         hdr.<a class="code" href="structBattFsPageHeader.html#a8976d867f0fb78905c2a572e6cab2992" title="Page offset inside file.">pgoff</a> = 0;
<a name="l00933"></a>00933         hdr.<a class="code" href="structBattFsPageHeader.html#a5c59ce00449c562009b680adef4aebe7" title="Filled bytes in page.">fill</a> = 0;
<a name="l00934"></a>00934         hdr.<a class="code" href="structBattFsPageHeader.html#aa819f5f419727fa1857635686710d34b" title="Page sequence number.">seq</a> = 0;
<a name="l00935"></a>00935         <span class="keywordflow">if</span> (!writeHdr(disk, disk-&gt;<a class="code" href="structBattFsSuper.html#ae018010b1733f1a278a5c40792f393de" title="Page allocation array.">page_array</a>[start_pos], &amp;hdr))
<a name="l00936"></a>00936         {
<a name="l00937"></a>00937             fd-&gt;<a class="code" href="structBattFs.html#ae3dd3478b1e9c4b4fb77b0b2099be928" title="File status/errors.">errors</a> |= <a class="code" href="battfs_8h.html#a64b38adc1699a23bf33be496bc0a3a11" title="Error writing in the disk device.">BATTFS_DISK_WRITE_ERR</a>;
<a name="l00938"></a>00938             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00939"></a>00939         }
<a name="l00940"></a>00940     }
<a name="l00941"></a>00941     fd-&gt;<a class="code" href="structBattFs.html#ababfd85b718c28670a496a1a96f656e5" title="Pointer to page_array file start position.">start</a> = &amp;disk-&gt;<a class="code" href="structBattFsSuper.html#ae018010b1733f1a278a5c40792f393de" title="Page allocation array.">page_array</a>[start_pos];
<a name="l00942"></a>00942     <a class="code" href="group__logging.html#gaa5595314cc54c304a127c75cfcec4017" title="Output an informative message.">LOG_INFO</a>(<span class="stringliteral">&quot;Start pos %d\n&quot;</span>, start_pos);
<a name="l00943"></a>00943 
<a name="l00944"></a>00944     <span class="comment">/* Fill file size */</span>
<a name="l00945"></a>00945     <span class="keywordflow">if</span> ((fd-&gt;<a class="code" href="structBattFs.html#a1d23a5cab78d0c3831bf5eea4d9509bd" title="KFile context.">fd</a>.size = <a class="code" href="battfs_8c.html#ad4ab98ab173f00db6190ff1f4c866b09" title="Count size of file inode on disk, starting at pointer start in disk-&gt;page_array.">countFileSize</a>(disk, fd-&gt;<a class="code" href="structBattFs.html#ababfd85b718c28670a496a1a96f656e5" title="Pointer to page_array file start position.">start</a>, inode)) == EOF)
<a name="l00946"></a>00946     {
<a name="l00947"></a>00947         fd-&gt;<a class="code" href="structBattFs.html#ae3dd3478b1e9c4b4fb77b0b2099be928" title="File status/errors.">errors</a> |= <a class="code" href="battfs_8h.html#ad5f5f02fc2e2e920d004790a5ea0d4a5" title="Error reading from disk device.">BATTFS_DISK_READ_ERR</a>;
<a name="l00948"></a>00948         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00949"></a>00949     }
<a name="l00950"></a>00950     fd-&gt;<a class="code" href="structBattFs.html#a60d0d47fd11329f3d579ff375333569d" title="Max page offset allocated for the file.">max_off</a> = fd-&gt;<a class="code" href="structBattFs.html#a1d23a5cab78d0c3831bf5eea4d9509bd" title="KFile context.">fd</a>.size / disk-&gt;<a class="code" href="structBattFsSuper.html#afc13e79aa3e0714eba8038a97e58caaa" title="Size of space usable for data in a disk page, in bytes. The rest is used by the page header...">data_size</a>;
<a name="l00951"></a>00951 
<a name="l00952"></a>00952     <span class="comment">/* Reset seek position */</span>
<a name="l00953"></a>00953     fd-&gt;<a class="code" href="structBattFs.html#a1d23a5cab78d0c3831bf5eea4d9509bd" title="KFile context.">fd</a>.seek_pos = 0;
<a name="l00954"></a>00954 
<a name="l00955"></a>00955     <span class="comment">/* Insert file handle in list, ordered by inode, ascending. */</span>
<a name="l00956"></a>00956     <a class="code" href="group__list.html#ga91a9735c8acba8592b8b6872b1fbf2dd" title="Iterate over all nodes in a list.">FOREACH_NODE</a>(n, &amp;disk-&gt;<a class="code" href="structBattFsSuper.html#a491a8251adeb2f4dafd70b62e26cc195" title="List used to keep trace of open files.">file_opened_list</a>)
<a name="l00957"></a>00957     {
<a name="l00958"></a>00958         <a class="code" href="structBattFs.html" title="Describe a BattFs file usign a KFile.">BattFs</a> *file = <a class="code" href="compiler_8h.html#ad8a293330664172f7fb87c204bac34b3" title="Cast a member of a structure out to the containing structure.">containerof</a>(n, <a class="code" href="structBattFs.html" title="Describe a BattFs file usign a KFile.">BattFs</a>, link);
<a name="l00959"></a>00959         <span class="keywordflow">if</span> (file-&gt;<a class="code" href="structBattFs.html#ad6557799e39cb13d9ae6ce9bfbf50fe2" title="inode of the opened file">inode</a> &gt;= inode)
<a name="l00960"></a>00960             <span class="keywordflow">break</span>;
<a name="l00961"></a>00961     }
<a name="l00962"></a>00962     <a class="code" href="group__list.html#ga20a8012133533f871557feca959e7516" title="Insert node n before node ln.">INSERT_BEFORE</a>(&amp;fd-&gt;<a class="code" href="structBattFs.html#ab18ef03731072cdd67ccf55af005e781" title="Link for inserting in opened file list.">link</a>, n);
<a name="l00963"></a>00963 
<a name="l00964"></a>00964     <span class="comment">/* Fill in data */</span>
<a name="l00965"></a>00965     fd-&gt;<a class="code" href="structBattFs.html#ad6557799e39cb13d9ae6ce9bfbf50fe2" title="inode of the opened file">inode</a> = inode;
<a name="l00966"></a>00966     fd-&gt;<a class="code" href="structBattFs.html#a869405592419e5bb87961d4c93633d9c" title="File open mode.">mode</a> = mode;
<a name="l00967"></a>00967     fd-&gt;<a class="code" href="structBattFs.html#a06a576e0f36f94fb530930993e1d7a51" title="Disk context.">disk</a> = disk;
<a name="l00968"></a>00968 
<a name="l00969"></a>00969     fd-&gt;<a class="code" href="structBattFs.html#a1d23a5cab78d0c3831bf5eea4d9509bd" title="KFile context.">fd</a>.close = <a class="code" href="battfs_8c.html#add20fbad9f3858073feddc78d3c68e91" title="Close file fd.">battfs_fileclose</a>;
<a name="l00970"></a>00970     fd-&gt;<a class="code" href="structBattFs.html#a1d23a5cab78d0c3831bf5eea4d9509bd" title="KFile context.">fd</a>.flush = <a class="code" href="battfs_8c.html#a5debb24bbd73cc9be4ae0e4f3882157f" title="Flush file fd.">battfs_flush</a>;
<a name="l00971"></a>00971     fd-&gt;<a class="code" href="structBattFs.html#a1d23a5cab78d0c3831bf5eea4d9509bd" title="KFile context.">fd</a>.read = <a class="code" href="battfs_8c.html#afd2ad685dca2d309e910aa6a0c5942b5" title="Read from file fd size bytes in buf.">battfs_read</a>;
<a name="l00972"></a>00972     fd-&gt;<a class="code" href="structBattFs.html#a1d23a5cab78d0c3831bf5eea4d9509bd" title="KFile context.">fd</a>.reopen = <a class="code" href="group__io__kfile.html#ga1f1f5efe44ff91c5bea49f88f356059a" title="Reopen file fd.">kfile_genericReopen</a>;
<a name="l00973"></a>00973     fd-&gt;<a class="code" href="structBattFs.html#a1d23a5cab78d0c3831bf5eea4d9509bd" title="KFile context.">fd</a>.seek = <a class="code" href="group__io__kfile.html#gacac5698d355a3750f4b07415090ed7a4" title="Move fd file seek position of offset bytes from whence.">kfile_genericSeek</a>;
<a name="l00974"></a>00974     fd-&gt;<a class="code" href="structBattFs.html#a1d23a5cab78d0c3831bf5eea4d9509bd" title="KFile context.">fd</a>.write = <a class="code" href="battfs_8c.html#ab2bc9f316bb9eee549712ed60b2429d4" title="Write to file fd size bytes from buf.">battfs_write</a>;
<a name="l00975"></a>00975 
<a name="l00976"></a>00976     fd-&gt;<a class="code" href="structBattFs.html#a1d23a5cab78d0c3831bf5eea4d9509bd" title="KFile context.">fd</a>.error = battfs_error;
<a name="l00977"></a>00977     fd-&gt;<a class="code" href="structBattFs.html#a1d23a5cab78d0c3831bf5eea4d9509bd" title="KFile context.">fd</a>.clearerr = battfs_clearerr;
<a name="l00978"></a>00978 
<a name="l00979"></a>00979     <a class="code" href="group__debug.html#ga5ae59b9945c3ef623af1719976ef3a1f" title="This macro can be used to conditionally exclude one or more statements conditioned on _DEBUG...">DB</a>(fd-&gt;<a class="code" href="structBattFs.html#a1d23a5cab78d0c3831bf5eea4d9509bd" title="KFile context.">fd</a>._type = <a class="code" href="battfs_8h.html#a773a6de12626d04cb1311cf53cb88044" title="Id for battfs file descriptors.">KFT_BATTFS</a>);
<a name="l00980"></a>00980 
<a name="l00981"></a>00981     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00982"></a>00982 }
<a name="l00983"></a>00983 
<a name="l00984"></a>00984 
<a name="l00988"></a><a class="code" href="battfs_8h.html#a6059da32732f2272b68894610eddb99d">00988</a> <span class="keywordtype">bool</span> <a class="code" href="battfs_8c.html#a6059da32732f2272b68894610eddb99d" title="Umount disk.">battfs_umount</a>(<span class="keyword">struct</span> <a class="code" href="structBattFsSuper.html" title="Context used to describe a disk.">BattFsSuper</a> *disk)
<a name="l00989"></a>00989 {
<a name="l00990"></a>00990     <a class="code" href="structNode.html" title="This structure represents a node for bidirectional lists.">Node</a> *n;
<a name="l00991"></a>00991     <span class="keywordtype">int</span> res = 0;
<a name="l00992"></a>00992 
<a name="l00993"></a>00993     <span class="comment">/* Close all open files */</span>
<a name="l00994"></a>00994     <a class="code" href="group__list.html#ga91a9735c8acba8592b8b6872b1fbf2dd" title="Iterate over all nodes in a list.">FOREACH_NODE</a>(n, &amp;disk-&gt;<a class="code" href="structBattFsSuper.html#a491a8251adeb2f4dafd70b62e26cc195" title="List used to keep trace of open files.">file_opened_list</a>)
<a name="l00995"></a>00995     {
<a name="l00996"></a>00996         <a class="code" href="structBattFs.html" title="Describe a BattFs file usign a KFile.">BattFs</a> *file = <a class="code" href="compiler_8h.html#ad8a293330664172f7fb87c204bac34b3" title="Cast a member of a structure out to the containing structure.">containerof</a>(n, <a class="code" href="structBattFs.html" title="Describe a BattFs file usign a KFile.">BattFs</a>, link);
<a name="l00997"></a>00997         res += <a class="code" href="battfs_8c.html#add20fbad9f3858073feddc78d3c68e91" title="Close file fd.">battfs_fileclose</a>(&amp;file-&gt;<a class="code" href="structBattFs.html#a1d23a5cab78d0c3831bf5eea4d9509bd" title="KFile context.">fd</a>);
<a name="l00998"></a>00998     }
<a name="l00999"></a>00999 
<a name="l01000"></a>01000     <span class="comment">/* Close disk */</span>
<a name="l01001"></a>01001     <span class="keywordflow">return</span> (<a class="code" href="group__io__kblock.html#ga3c09ba3c8d69e8160284243c104ea6ae" title="Flush the cache (if any) to the device.">kblock_flush</a>(disk-&gt;<a class="code" href="structBattFsSuper.html#a6da7bb93863793068a9ca2746fb035b4" title="Block device context (physical disk).">dev</a>) == 0) &amp;&amp; (<a class="code" href="group__io__kblock.html#ga011015cdc89b0d465113e1644ec96967" title="Close the device.">kblock_close</a>(disk-&gt;<a class="code" href="structBattFsSuper.html#a6da7bb93863793068a9ca2746fb035b4" title="Block device context (physical disk).">dev</a>) == 0) &amp;&amp; (res == 0);
<a name="l01002"></a>01002 }
<a name="l01003"></a>01003 
<a name="l01004"></a>01004 <span class="preprocessor">#if UNIT_TEST</span>
<a name="l01005"></a>01005 <span class="preprocessor"></span>
<a name="l01006"></a>01006 <span class="keywordtype">void</span> <a class="code" href="battfs_8h.html#a71a27ec6b07d8232c5cbcc893eb07bfd" title="Modes for battfs_fileopen.">battfs_writeTestBlock</a>(<a class="code" href="structKBlock.html" title="KBlock: interface for a generic block device.">KBlock</a> *dev, <a class="code" href="battfs_8h.html#ab696748712d719603833f401031a7907" title="Type for counting pages on disk.">pgcnt_t</a> page, <a class="code" href="battfs_8h.html#a74713a2f9f355cad853593781defa824" title="Type for file inodes.">inode_t</a> inode, <a class="code" href="battfs_8h.html#abbbad188c9c52701e8dbd92f0a5635f5" title="Type for page seq number, at least 40bits wide.">seq_t</a> seq, <a class="code" href="battfs_8h.html#af0b3070403482fbfa266d6e3e6cff088" title="Type for keeping trace of space filled inside a page.">fill_t</a> fill, <a class="code" href="battfs_8h.html#abd9d9d290feaf2e76bce6142ae59019e" title="Type for counting pages inside a file.">pgoff_t</a> pgoff)
<a name="l01007"></a>01007 {
<a name="l01008"></a>01008     uint8_t buf[<a class="code" href="battfs_8h.html#a5f50d8650c7f510c735ea41d140fe8b6" title="Size of the header once saved on disk.">BATTFS_HEADER_LEN</a>];
<a name="l01009"></a>01009     <a class="code" href="battfs_8h.html#aa00a8d53d613cced6d6c36e3a8f92357" title="Modes for battfs_fileopen.">battfs_eraseBlock</a>(dev, page);
<a name="l01010"></a>01010 
<a name="l01011"></a>01011     <a class="code" href="structBattFsPageHeader.html" title="BattFS page header, used to represent a page header in memory.">BattFsPageHeader</a> hdr;
<a name="l01012"></a>01012     hdr.<a class="code" href="structBattFsPageHeader.html#a073705e71025f5e13f9ccd2f09f469ba" title="File inode (file identifier).">inode</a> = inode;
<a name="l01013"></a>01013     hdr.<a class="code" href="structBattFsPageHeader.html#a5c59ce00449c562009b680adef4aebe7" title="Filled bytes in page.">fill</a> = fill;
<a name="l01014"></a>01014     hdr.<a class="code" href="structBattFsPageHeader.html#a8976d867f0fb78905c2a572e6cab2992" title="Page offset inside file.">pgoff</a> = pgoff;
<a name="l01015"></a>01015     hdr.<a class="code" href="structBattFsPageHeader.html#aa819f5f419727fa1857635686710d34b" title="Page sequence number.">seq</a> = seq;
<a name="l01016"></a>01016     hdr.<a class="code" href="structBattFsPageHeader.html#a5f22e3d0d6a817a95b454dafd43aba3f" title="FCS (Frame Check Sequence) of the page header.">fcs</a> = <a class="code" href="battfs_8c.html#af1a47fc53b7a1972011ca0c9f8f7e927" title="Compute the fcs of the header.">computeFcs</a>(&amp;hdr);
<a name="l01017"></a>01017 
<a name="l01018"></a>01018     <a class="code" href="battfs_8c.html#a2ab58e79b36e2d503e0a3197ca08b65a" title="Convert from memory representation to disk structure.">battfs_to_disk</a>(&amp;hdr, buf);
<a name="l01019"></a>01019 
<a name="l01020"></a>01020     <a class="code" href="group__debug.html#gaca68c0d4ac8df0838e209fb5300f7be3" title="Assert a pre-condition on code.">ASSERT</a>(<a class="code" href="group__io__kblock.html#ga069340cc7fe0a6aec2bada078ad9c889" title="Write data to the block device.">kblock_write</a>(dev, page, buf, dev-&gt;<a class="code" href="structKBlock.html#a4be3b0a7548ff44af20b88e63735f133" title="Block size.">blk_size</a> - <a class="code" href="battfs_8h.html#a5f50d8650c7f510c735ea41d140fe8b6" title="Size of the header once saved on disk.">BATTFS_HEADER_LEN</a>, <a class="code" href="battfs_8h.html#a5f50d8650c7f510c735ea41d140fe8b6" title="Size of the header once saved on disk.">BATTFS_HEADER_LEN</a>) == <a class="code" href="battfs_8h.html#a5f50d8650c7f510c735ea41d140fe8b6" title="Size of the header once saved on disk.">BATTFS_HEADER_LEN</a>);
<a name="l01021"></a>01021     <a class="code" href="group__debug.html#gaca68c0d4ac8df0838e209fb5300f7be3" title="Assert a pre-condition on code.">ASSERT</a>(<a class="code" href="group__io__kblock.html#ga3c09ba3c8d69e8160284243c104ea6ae" title="Flush the cache (if any) to the device.">kblock_flush</a>(dev) == 0);
<a name="l01022"></a>01022 }
<a name="l01023"></a>01023 
<a name="l01024"></a>01024 <span class="keywordtype">void</span> <a class="code" href="battfs_8h.html#aa00a8d53d613cced6d6c36e3a8f92357" title="Modes for battfs_fileopen.">battfs_eraseBlock</a>(<a class="code" href="structKBlock.html" title="KBlock: interface for a generic block device.">KBlock</a> *dev, <a class="code" href="battfs_8h.html#ab696748712d719603833f401031a7907" title="Type for counting pages on disk.">pgcnt_t</a> page)
<a name="l01025"></a>01025 {
<a name="l01026"></a>01026     <span class="comment">/* Reset page to all 0xff */</span>
<a name="l01027"></a>01027     uint8_t buf[dev-&gt;<a class="code" href="structKBlock.html#a4be3b0a7548ff44af20b88e63735f133" title="Block size.">blk_size</a>];
<a name="l01028"></a>01028     memset(buf, 0xFF, dev-&gt;<a class="code" href="structKBlock.html#a4be3b0a7548ff44af20b88e63735f133" title="Block size.">blk_size</a>);
<a name="l01029"></a>01029     <a class="code" href="group__debug.html#gaca68c0d4ac8df0838e209fb5300f7be3" title="Assert a pre-condition on code.">ASSERT</a>(<a class="code" href="group__io__kblock.html#ga069340cc7fe0a6aec2bada078ad9c889" title="Write data to the block device.">kblock_write</a>(dev, page, buf, 0, dev-&gt;<a class="code" href="structKBlock.html#a4be3b0a7548ff44af20b88e63735f133" title="Block size.">blk_size</a>) == dev-&gt;<a class="code" href="structKBlock.html#a4be3b0a7548ff44af20b88e63735f133" title="Block size.">blk_size</a>);
<a name="l01030"></a>01030     <a class="code" href="group__debug.html#gaca68c0d4ac8df0838e209fb5300f7be3" title="Assert a pre-condition on code.">ASSERT</a>(<a class="code" href="group__io__kblock.html#ga3c09ba3c8d69e8160284243c104ea6ae" title="Flush the cache (if any) to the device.">kblock_flush</a>(dev) == 0);
<a name="l01031"></a>01031 }
<a name="l01032"></a>01032 
<a name="l01033"></a>01033 <span class="preprocessor">#endif</span>
</pre></div></div>
</div>


