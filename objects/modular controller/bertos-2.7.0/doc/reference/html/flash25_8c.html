

<!-- Generated by Doxygen 1.7.4 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="dir_9fd71c1ac00056e7d855336b2291c56c.html">bertos</a>      </li>
      <li class="navelem"><a class="el" href="dir_f7c89dbd63e8f34e572fe939945c15d7.html">drv</a>      </li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="summary">
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle">
<div class="title">flash25.c File Reference</div>  </div>
</div>
<div class="contents">

<p>Function library for serial <a class="el" href="structFlash.html" title="EmbFlash KBlock context structure.">Flash</a> memory.  
<a href="#details">More...</a></p>
<div class="textblock"><code>#include &quot;<a class="el" href="hw__spi_8h_source.html">hw/hw_spi.h</a>&quot;</code><br/>
<code>#include &lt;<a class="el" href="macros_8h_source.html">cfg/macros.h</a>&gt;</code><br/>
<code>#include &lt;<a class="el" href="debug_8h_source.html">cfg/debug.h</a>&gt;</code><br/>
<code>#include &lt;<a class="el" href="timer_8h_source.html">drv/timer.h</a>&gt;</code><br/>
<code>#include &lt;<a class="el" href="flash25_8h_source.html">drv/flash25.h</a>&gt;</code><br/>
<code>#include &lt;<a class="el" href="io_2kfile_8h_source.html">io/kfile.h</a>&gt;</code><br/>
<code>#include &lt;<a class="el" href="power_8h_source.html">cpu/power.h</a>&gt;</code><br/>
</div>
<p><a href="flash25_8c_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr><td colspan="2"><h2><a name="func-members"></a>
Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="ab48becdeb7dbb8c0e6c07731dd799510"></a><!-- doxytag: member="flash25.c::flash25_waitReady" ref="ab48becdeb7dbb8c0e6c07731dd799510" args="(Flash25 *fd)" -->
static void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="flash25_8c.html#ab48becdeb7dbb8c0e6c07731dd799510">flash25_waitReady</a> (<a class="el" href="structFlash25.html">Flash25</a> *fd)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Wait until flash memory is ready. <br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a1b8e88f2832b8f6fb5beb57cbdd6a409"></a><!-- doxytag: member="flash25.c::flash25_sendCmd" ref="a1b8e88f2832b8f6fb5beb57cbdd6a409" args="(Flash25 *fd, Flash25Opcode cmd)" -->
static void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="flash25_8c.html#a1b8e88f2832b8f6fb5beb57cbdd6a409">flash25_sendCmd</a> (<a class="el" href="structFlash25.html">Flash25</a> *fd, <a class="el" href="flash25_8h.html#a1316fb8f73aab9304ffa5d5266b4d2f2">Flash25Opcode</a> cmd)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Send a single command to serial flash memory. <br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="flash25_8c.html#a8f6f4e95aac7f04e89e6533d0bd4c779">flash25_pin_init</a> (<a class="el" href="structFlash25.html">Flash25</a> *fd)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">flash25 init function.  <a href="#a8f6f4e95aac7f04e89e6533d0bd4c779"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static <a class="el" href="structKFile.html">KFile</a> *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="flash25_8c.html#aae1bdac06bc3cf5c18a5ebc89ef0b4c3">flash25_reopen</a> (struct <a class="el" href="structKFile.html">KFile</a> *_fd)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Reopen a serial memory interface.  <a href="#aae1bdac06bc3cf5c18a5ebc89ef0b4c3"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="flash25_8c.html#a38af292af792b8ed338900e5d77d6ee4">flash25_close</a> (UNUSED_ARG(struct <a class="el" href="structKFile.html">KFile</a> *, fd))</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Close a serial memory interface.  <a href="#a38af292af792b8ed338900e5d77d6ee4"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static size_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="flash25_8c.html#a70aefe1c649d721ba828b7c1862daf50">flash25_read</a> (struct <a class="el" href="structKFile.html">KFile</a> *_fd, void *buf, size_t size)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Read <em>_buf</em> lenght <em>size</em> byte from serial flash memmory.  <a href="#a70aefe1c649d721ba828b7c1862daf50"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static size_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="flash25_8c.html#af94e83783bb6c388440d1d730721d21a">flash25_write</a> (struct <a class="el" href="structKFile.html">KFile</a> *_fd, const void *_buf, size_t size)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Write <em>_buf</em> in serial flash memory.  <a href="#af94e83783bb6c388440d1d730721d21a"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="flash25_8c.html#a8b90ef6909c4b8c536cef52a9a8506fa">flash25_sectorErase</a> (<a class="el" href="structFlash25.html">Flash25</a> *fd, <a class="el" href="flash25_8h.html#a4a39dd8c8453af325a550678d19c4149">Flash25Sector</a> sector)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Sector erase function.  <a href="#a8b90ef6909c4b8c536cef52a9a8506fa"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="flash25_8c.html#aa4798197fae4a3eb7af814c2223d13e9">flash25_chipErase</a> (<a class="el" href="structFlash25.html">Flash25</a> *fd)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Chip erase function.  <a href="#aa4798197fae4a3eb7af814c2223d13e9"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="aec953d4584d90f7d9311eaf7a5498f76"></a><!-- doxytag: member="flash25.c::flash25_init" ref="aec953d4584d90f7d9311eaf7a5498f76" args="(Flash25 *fd, KFile *ch)" -->
void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="flash25_8c.html#aec953d4584d90f7d9311eaf7a5498f76">flash25_init</a> (<a class="el" href="structFlash25.html">Flash25</a> *fd, <a class="el" href="structKFile.html">KFile</a> *ch)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Init data flash memory interface. <br/></td></tr>
</table>
<hr/><a name="details" id="details"></a><h2>Detailed Description</h2>
<div class="textblock"><p>Function library for serial <a class="el" href="structFlash.html" title="EmbFlash KBlock context structure.">Flash</a> memory. </p>
<p>Module provide a kfile interface, that ensure an abstraction from comunication channel and give a standard interface. Typicaly this kind of memory use an SPI bus, but you should use another comunication channel you have defined.</p>
<dl class="author"><dt><b>Author:</b></dt><dd>Daniele Basile &lt;<a href="mailto:asterix@develer.com">asterix@develer.com</a>&gt; </dd></dl>

<p>Definition in file <a class="el" href="flash25_8c_source.html">flash25.c</a>.</p>
</div><hr/><h2>Function Documentation</h2>
<a class="anchor" id="aa4798197fae4a3eb7af814c2223d13e9"></a><!-- doxytag: member="flash25.c::flash25_chipErase" ref="aa4798197fae4a3eb7af814c2223d13e9" args="(Flash25 *fd)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void flash25_chipErase </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structFlash25.html">Flash25</a> *&#160;</td>
          <td class="paramname"><em>fd</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Chip erase function. </p>
<p>Erase all sector of serial flash memory.</p>
<dl class="note"><dt><b>Note:</b></dt><dd>This operation could take a while. </dd></dl>

<p>Definition at line <a class="el" href="flash25_8c_source.html#l00337">337</a> of file <a class="el" href="flash25_8c_source.html">flash25.c</a>.</p>

</div>
</div>
<a class="anchor" id="a38af292af792b8ed338900e5d77d6ee4"></a><!-- doxytag: member="flash25.c::flash25_close" ref="a38af292af792b8ed338900e5d77d6ee4" args="(UNUSED_ARG(struct KFile *, fd))" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int flash25_close </td>
          <td>(</td>
          <td class="paramtype">UNUSED_ARG(struct <a class="el" href="structKFile.html">KFile</a> *, fd)&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Close a serial memory interface. </p>
<p>For serial memory this funtion do nothing, and return always 0. </p>

<p>Definition at line <a class="el" href="flash25_8c_source.html#l00152">152</a> of file <a class="el" href="flash25_8c_source.html">flash25.c</a>.</p>

</div>
</div>
<a class="anchor" id="a8f6f4e95aac7f04e89e6533d0bd4c779"></a><!-- doxytag: member="flash25.c::flash25_pin_init" ref="a8f6f4e95aac7f04e89e6533d0bd4c779" args="(Flash25 *fd)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static bool flash25_pin_init </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structFlash25.html">Flash25</a> *&#160;</td>
          <td class="paramname"><em>fd</em></td><td>)</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>flash25 init function. </p>
<p>This function init a comunication channel and try to read manufacturer id of serial memory, then check if is equal to selected type. </p>

<p>Definition at line <a class="el" href="flash25_8c_source.html#l00101">101</a> of file <a class="el" href="flash25_8c_source.html">flash25.c</a>.</p>

</div>
</div>
<a class="anchor" id="a70aefe1c649d721ba828b7c1862daf50"></a><!-- doxytag: member="flash25.c::flash25_read" ref="a70aefe1c649d721ba828b7c1862daf50" args="(struct KFile *_fd, void *buf, size_t size)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static size_t flash25_read </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structKFile.html">KFile</a> *&#160;</td>
          <td class="paramname"><em>_fd</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">void *&#160;</td>
          <td class="paramname"><em>buf</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">size_t&#160;</td>
          <td class="paramname"><em>size</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Read <em>_buf</em> lenght <em>size</em> byte from serial flash memmory. </p>
<p>For read in serial flash memory we enble cs pin and send one byte of read opcode, and then 3 byte of address of memory cell we want to read. After the last byte of address we can read data from so pin.</p>
<dl class="return"><dt><b>Returns:</b></dt><dd>the number of bytes read. </dd></dl>

<p>Definition at line <a class="el" href="flash25_8c_source.html#l00169">169</a> of file <a class="el" href="flash25_8c_source.html">flash25.c</a>.</p>

</div>
</div>
<a class="anchor" id="aae1bdac06bc3cf5c18a5ebc89ef0b4c3"></a><!-- doxytag: member="flash25.c::flash25_reopen" ref="aae1bdac06bc3cf5c18a5ebc89ef0b4c3" args="(struct KFile *_fd)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static <a class="el" href="structKFile.html">KFile</a>* flash25_reopen </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structKFile.html">KFile</a> *&#160;</td>
          <td class="paramname"><em>_fd</em></td><td>)</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Reopen a serial memory interface. </p>
<p>For serial memory this function reinit only the size and seek_pos in kfile stucture. Return a kfile pointer, after assert check. </p>

<p>Definition at line <a class="el" href="flash25_8c_source.html#l00135">135</a> of file <a class="el" href="flash25_8c_source.html">flash25.c</a>.</p>

</div>
</div>
<a class="anchor" id="a8b90ef6909c4b8c536cef52a9a8506fa"></a><!-- doxytag: member="flash25.c::flash25_sectorErase" ref="a8b90ef6909c4b8c536cef52a9a8506fa" args="(Flash25 *fd, Flash25Sector sector)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void flash25_sectorErase </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structFlash25.html">Flash25</a> *&#160;</td>
          <td class="paramname"><em>fd</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="flash25_8h.html#a4a39dd8c8453af325a550678d19c4149">Flash25Sector</a>&#160;</td>
          <td class="paramname"><em>sector</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Sector erase function. </p>
<p>Erase a select <code>sector</code> of serial flash memory.</p>
<dl class="note"><dt><b>Note:</b></dt><dd>A sector size is FLASH25_SECTOR_SIZE. This operation could take a while. </dd></dl>

<p>Definition at line <a class="el" href="flash25_8c_source.html#l00291">291</a> of file <a class="el" href="flash25_8c_source.html">flash25.c</a>.</p>

</div>
</div>
<a class="anchor" id="af94e83783bb6c388440d1d730721d21a"></a><!-- doxytag: member="flash25.c::flash25_write" ref="af94e83783bb6c388440d1d730721d21a" args="(struct KFile *_fd, const void *_buf, size_t size)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static size_t flash25_write </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structKFile.html">KFile</a> *&#160;</td>
          <td class="paramname"><em>_fd</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const void *&#160;</td>
          <td class="paramname"><em>_buf</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">size_t&#160;</td>
          <td class="paramname"><em>size</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Write <em>_buf</em> in serial flash memory. </p>
<p>Before to write data into flash we must enable memory writing. To do this we send a WRE command opcode. After this command the flash is ready to be write, and so we send a PROGRAM opcode followed to 3 byte of address memory, at the end of last address byte we can send the data. When we finish to send all data, we disable cs and flash write received data bytes on its memory.</p>
<dl class="note"><dt><b>Note:</b></dt><dd>: WARNING: you could write only on erased memory section! Each write time you could write max a memory page size, because if you write more than memory page size the address roll over to first byte of page.</dd></dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>the number of bytes write. </dd></dl>

<p>Definition at line <a class="el" href="flash25_8c_source.html#l00219">219</a> of file <a class="el" href="flash25_8c_source.html">flash25.c</a>.</p>

</div>
</div>
</div>


