

<!-- Generated by Doxygen 1.7.4 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="dir_9fd71c1ac00056e7d855336b2291c56c.html">bertos</a>      </li>
      <li class="navelem"><a class="el" href="dir_f7c89dbd63e8f34e572fe939945c15d7.html">drv</a>      </li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">lcd_hd44.c</div>  </div>
</div>
<div class="contents">
<a href="lcd__hd44_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 
<a name="l00039"></a>00039 <span class="preprocessor">#include &quot;<a class="code" href="lcd__hd44_8h.html" title="Hitachi HD44780 and clones LCD module.">lcd_hd44.h</a>&quot;</span>
<a name="l00040"></a>00040 
<a name="l00041"></a>00041 <span class="preprocessor">#include &quot;<a class="code" href="hw__lcd__hd44_8h.html" title="LCD low-level hardware macros.">hw/hw_lcd_hd44.h</a>&quot;</span>
<a name="l00042"></a>00042 
<a name="l00043"></a>00043 <span class="preprocessor">#include &quot;<a class="code" href="cfg__arch_8h.html" title="Set system configuration.">cfg/cfg_arch.h</a>&quot;</span>
<a name="l00044"></a>00044 
<a name="l00045"></a>00045 <span class="preprocessor">#include &lt;<a class="code" href="timer_8h.html">drv/timer.h</a>&gt;</span>
<a name="l00046"></a>00046 
<a name="l00047"></a>00047 <span class="preprocessor">#warning FIXME: Revise and refactor this code.</span>
<a name="l00048"></a>00048 <span class="preprocessor"></span>
<a name="l00049"></a>00049 <span class="preprocessor">#if defined(LCD_READ_H) &amp;&amp; defined(LCD_READ_L) &amp;&amp; defined(LCD_WRITE_H) &amp;&amp; defined(LCD_WRITE_L)</span>
<a name="l00050"></a>00050 <span class="preprocessor"></span><span class="preprocessor">    #define CONFIG_LCD_4BIT 1</span>
<a name="l00051"></a>00051 <span class="preprocessor"></span><span class="preprocessor">#elif defined(LCD_READ) &amp;&amp; defined(LCD_WRITE)</span>
<a name="l00052"></a>00052 <span class="preprocessor"></span><span class="preprocessor">    #define CONFIG_LCD_4BIT 0</span>
<a name="l00053"></a>00053 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l00054"></a>00054 <span class="preprocessor"></span><span class="preprocessor">    #error Incomplete or missing LCD_READ/LCD_WRITE macros</span>
<a name="l00055"></a>00055 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00056"></a>00056 <span class="preprocessor"></span>
<a name="l00058"></a><a class="code" href="lcd__hd44_8c.html#a8b59c49ba61fd230389663dbdffdd6c1">00058</a> <span class="preprocessor">#define LCDF_BUSY  BV(7)</span>
<a name="l00059"></a>00059 <span class="preprocessor"></span>
<a name="l00060"></a>00060 <span class="preprocessor">#if CONFIG_LCD_ADDRESS_FAST == 1</span>
<a name="l00061"></a>00061 <span class="preprocessor"></span><span class="preprocessor">#define lcd_address(x) lcd_address[x]</span>
<a name="l00062"></a>00062 <span class="preprocessor"></span>
<a name="l00066"></a>00066 <span class="keyword">static</span> <span class="keyword">const</span> uint8_t <a class="code" href="lcd__hd44_8c.html#a99705358436a43e451011ea62edd575c" title="Addresses of LCD display character positions, calculated runtime to save RAM.">lcd_address</a>[] =
<a name="l00067"></a>00067 {
<a name="l00068"></a>00068     <span class="comment">/* row 0 */</span>
<a name="l00069"></a>00069     0x80, 0x81, 0x82, 0x83,
<a name="l00070"></a>00070     0x84, 0x85, 0x86, 0x87,
<a name="l00071"></a>00071     0x88, 0x89, 0x8A, 0x8B,
<a name="l00072"></a>00072     0x8C, 0x8D, 0x8E, 0x8F,
<a name="l00073"></a>00073 <span class="preprocessor">#if CONFIG_LCD_COLS &gt; 16</span>
<a name="l00074"></a>00074 <span class="preprocessor"></span>    0x90, 0x91, 0x92, 0x93,
<a name="l00075"></a>00075 <span class="preprocessor">#endif</span>
<a name="l00076"></a>00076 <span class="preprocessor"></span>
<a name="l00077"></a>00077     <span class="comment">/* row 1 */</span>
<a name="l00078"></a>00078     0xC0, 0xC1, 0xC2, 0xC3,
<a name="l00079"></a>00079     0xC4, 0xC5, 0xC6, 0xC7,
<a name="l00080"></a>00080     0xC8, 0xC9, 0xCA, 0xCB,
<a name="l00081"></a>00081     0xCC, 0xCD, 0xCE, 0xCF,
<a name="l00082"></a>00082 <span class="preprocessor">#if CONFIG_LCD_COLS &gt; 16</span>
<a name="l00083"></a>00083 <span class="preprocessor"></span>    0xD0, 0xD1, 0xD2, 0xD3,
<a name="l00084"></a>00084 <span class="preprocessor">#endif</span>
<a name="l00085"></a>00085 <span class="preprocessor"></span>
<a name="l00086"></a>00086 <span class="preprocessor">#if CONFIG_LCD_ROWS &gt; 2</span>
<a name="l00087"></a>00087 <span class="preprocessor"></span>    <span class="comment">/* row 2 */</span>
<a name="l00088"></a>00088     0x94, 0x95, 0x96, 0x97,
<a name="l00089"></a>00089     0x98, 0x99, 0x9A, 0x9B,
<a name="l00090"></a>00090     0x9C, 0x9D, 0x9E, 0x9F,
<a name="l00091"></a>00091     0xA0, 0xA1, 0xA2, 0xA3,
<a name="l00092"></a>00092 <span class="preprocessor">#if CONFIG_LCD_COLS &gt; 16</span>
<a name="l00093"></a>00093 <span class="preprocessor"></span>    0xA4, 0xA5, 0xA6, 0xA7,
<a name="l00094"></a>00094 <span class="preprocessor">#endif</span>
<a name="l00095"></a>00095 <span class="preprocessor"></span>
<a name="l00096"></a>00096     <span class="comment">/* row 3 */</span>
<a name="l00097"></a>00097     0xD4, 0xD5, 0xD6, 0xD7,
<a name="l00098"></a>00098     0xD8, 0xD9, 0xDA, 0xDB,
<a name="l00099"></a>00099     0xDC, 0xDD, 0xDE, 0xDF,
<a name="l00100"></a>00100     0xE0, 0xE1, 0xE2, 0xE3,
<a name="l00101"></a>00101 <span class="preprocessor">#if CONFIG_LCD_COLS &gt; 16</span>
<a name="l00102"></a>00102 <span class="preprocessor"></span>    0xE4, 0xE5, 0xE6, 0xE7,
<a name="l00103"></a>00103 <span class="preprocessor">#endif</span>
<a name="l00104"></a>00104 <span class="preprocessor"></span>
<a name="l00105"></a>00105 <span class="preprocessor">#endif </span><span class="comment">/* CONFIG_LCD_ROWS &gt; 2 */</span>
<a name="l00106"></a>00106 };
<a name="l00107"></a>00107 
<a name="l00108"></a>00108 <a class="code" href="compiler_8h.html#a695e64485eb9535f5ddcfec01167bddc" title="Issue a compilation error if the condition is false.">STATIC_ASSERT</a>(<a class="code" href="compiler_8h.html#a3c5cd622462bb50b6dab4c189e219eb9" title="Count the number of elements in the static array a.">countof</a>(<a class="code" href="lcd__hd44_8c.html#a99705358436a43e451011ea62edd575c" title="Addresses of LCD display character positions, calculated runtime to save RAM.">lcd_address</a>) == <a class="code" href="cfg__lcd__hd44_8h.html#a3ba3d985c1ee580232383c75eb54fb84" title="Number of rows in LCD display.">CONFIG_LCD_ROWS</a> * <a class="code" href="cfg__lcd__hd44_8h.html#a51ddf49250894d315c04c9a191d58f2f" title="Number of columns in LCD display.">CONFIG_LCD_COLS</a>);
<a name="l00109"></a>00109 <span class="preprocessor">#else  </span><span class="comment">/* CONFIG_LCD_ADDRESS_FAST == 0 */</span>
<a name="l00110"></a>00110 
<a name="l00111"></a>00111 <span class="keyword">static</span> <span class="keyword">const</span> uint8_t col_address[] =
<a name="l00112"></a>00112 {
<a name="l00113"></a>00113     0x80,
<a name="l00114"></a>00114     0xC0,
<a name="l00115"></a>00115 <span class="preprocessor">#if CONFIG_LCD_ROWS &gt; 2</span>
<a name="l00116"></a>00116 <span class="preprocessor"></span>    0x94,
<a name="l00117"></a>00117     0xD4
<a name="l00118"></a>00118 <span class="preprocessor">#endif</span>
<a name="l00119"></a>00119 <span class="preprocessor"></span>};
<a name="l00120"></a>00120 <a class="code" href="compiler_8h.html#a695e64485eb9535f5ddcfec01167bddc" title="Issue a compilation error if the condition is false.">STATIC_ASSERT</a>(<a class="code" href="compiler_8h.html#a3c5cd622462bb50b6dab4c189e219eb9" title="Count the number of elements in the static array a.">countof</a>(col_address) == <a class="code" href="cfg__lcd__hd44_8h.html#a3ba3d985c1ee580232383c75eb54fb84" title="Number of rows in LCD display.">CONFIG_LCD_ROWS</a>);
<a name="l00124"></a><a class="code" href="lcd__hd44_8c.html#a99705358436a43e451011ea62edd575c">00124</a> <span class="keyword">static</span> uint8_t <a class="code" href="lcd__hd44_8c.html#a99705358436a43e451011ea62edd575c" title="Addresses of LCD display character positions, calculated runtime to save RAM.">lcd_address</a>(uint8_t addr)
<a name="l00125"></a>00125 {
<a name="l00126"></a>00126     <span class="keywordflow">return</span> col_address[addr / <a class="code" href="cfg__lcd__hd44_8h.html#a51ddf49250894d315c04c9a191d58f2f" title="Number of columns in LCD display.">CONFIG_LCD_COLS</a>] + addr % <a class="code" href="cfg__lcd__hd44_8h.html#a51ddf49250894d315c04c9a191d58f2f" title="Number of columns in LCD display.">CONFIG_LCD_COLS</a>;
<a name="l00127"></a>00127 }
<a name="l00128"></a>00128 <span class="preprocessor">#endif </span><span class="comment">/* CONFIG_LCD_ADDRESS_FAST */</span>
<a name="l00129"></a>00129 
<a name="l00134"></a><a class="code" href="lcd__hd44_8c.html#a1b422fb65bb0daabac7ebc73ff598335">00134</a> <span class="keyword">static</span> <a class="code" href="lcd__hd44_8h.html#a702c97e9cd6cf2c8bad2044f87a24ba6" title="Type for combined LCD cursor position (x,y).">lcdpos_t</a> <a class="code" href="lcd__hd44_8c.html#a1b422fb65bb0daabac7ebc73ff598335" title="Current display position.">lcd_current_addr</a>;
<a name="l00135"></a>00135 
<a name="l00136"></a>00136 
<a name="l00137"></a>00137 <span class="preprocessor">#if !defined(ARCH_EMUL) || !(ARCH &amp; ARCH_EMUL)</span>
<a name="l00138"></a>00138 <span class="preprocessor"></span><span class="comment">/*      __________________</span>
<a name="l00139"></a>00139 <span class="comment"> * RS</span>
<a name="l00140"></a>00140 <span class="comment"> *</span>
<a name="l00141"></a>00141 <span class="comment"> * R/W  __________________</span>
<a name="l00142"></a>00142 <span class="comment"> *            _______</span>
<a name="l00143"></a>00143 <span class="comment"> * ENA  _____/       \____</span>
<a name="l00144"></a>00144 <span class="comment"> *</span>
<a name="l00145"></a>00145 <span class="comment"> * DATA -&lt;================</span>
<a name="l00146"></a>00146 <span class="comment"> */</span>
<a name="l00147"></a>00147 INLINE <span class="keywordtype">void</span> <a class="code" href="lcd__rit128x96_8c.html#a65ad9bd4a05056b18c55dabc3bacf4bc" title="Write a sequence of data bytes to the LCD controller.">lcd_dataWrite</a>(uint8_t data)
<a name="l00148"></a>00148 {
<a name="l00149"></a>00149 <span class="preprocessor">#if CONFIG_LCD_4BIT</span>
<a name="l00150"></a>00150 <span class="preprocessor"></span>    <span class="comment">/* Write high nibble */</span>
<a name="l00151"></a>00151     LCD_WRITE_H(data);
<a name="l00152"></a>00152     LCD_SET_E;
<a name="l00153"></a>00153     <a class="code" href="hw__lcd__32122a_8h.html#a412fd50d7add9264007510e6b31c0f27" title="Delay for write (Enable pulse width, 220ns)">LCD_DELAY_WRITE</a>;
<a name="l00154"></a>00154     LCD_CLR_E;
<a name="l00155"></a>00155     <a class="code" href="hw__lcd__32122a_8h.html#a412fd50d7add9264007510e6b31c0f27" title="Delay for write (Enable pulse width, 220ns)">LCD_DELAY_WRITE</a>;
<a name="l00156"></a>00156 
<a name="l00157"></a>00157     <span class="comment">/* Write low nibble */</span>
<a name="l00158"></a>00158     LCD_WRITE_L(data);
<a name="l00159"></a>00159     LCD_SET_E;
<a name="l00160"></a>00160     <a class="code" href="hw__lcd__32122a_8h.html#a412fd50d7add9264007510e6b31c0f27" title="Delay for write (Enable pulse width, 220ns)">LCD_DELAY_WRITE</a>;
<a name="l00161"></a>00161     LCD_CLR_E;
<a name="l00162"></a>00162     <a class="code" href="hw__lcd__32122a_8h.html#a412fd50d7add9264007510e6b31c0f27" title="Delay for write (Enable pulse width, 220ns)">LCD_DELAY_WRITE</a>;
<a name="l00163"></a>00163 
<a name="l00164"></a>00164 <span class="preprocessor">#else </span><span class="comment">/* !CONFIG_LCD_4BIT */</span>
<a name="l00165"></a>00165 
<a name="l00166"></a>00166     <span class="comment">/* Write data */</span>
<a name="l00167"></a>00167     <a class="code" href="hw__lcd__32122a_8h.html#a6326a09a9d661786dd2367290c0a969e" title="Read from the LCD data bus (DB[0-7])">LCD_WRITE</a>(data);
<a name="l00168"></a>00168     LCD_SET_E;
<a name="l00169"></a>00169     <a class="code" href="hw__lcd__32122a_8h.html#a412fd50d7add9264007510e6b31c0f27" title="Delay for write (Enable pulse width, 220ns)">LCD_DELAY_WRITE</a>;
<a name="l00170"></a>00170     LCD_CLR_E;
<a name="l00171"></a>00171     <a class="code" href="hw__lcd__32122a_8h.html#a412fd50d7add9264007510e6b31c0f27" title="Delay for write (Enable pulse width, 220ns)">LCD_DELAY_WRITE</a>;
<a name="l00172"></a>00172 
<a name="l00173"></a>00173 <span class="preprocessor">#endif </span><span class="comment">/* !CONFIG_LCD_4BIT */</span>
<a name="l00174"></a>00174 }
<a name="l00175"></a>00175 
<a name="l00176"></a>00176 <span class="comment">/*      __________________</span>
<a name="l00177"></a>00177 <span class="comment"> * RS</span>
<a name="l00178"></a>00178 <span class="comment"> *         ____________</span>
<a name="l00179"></a>00179 <span class="comment"> * R/W  __/            \__</span>
<a name="l00180"></a>00180 <span class="comment"> *            _______</span>
<a name="l00181"></a>00181 <span class="comment"> * ENA  _____/       \____</span>
<a name="l00182"></a>00182 <span class="comment"> *        ______      ____</span>
<a name="l00183"></a>00183 <span class="comment"> * DATA X/      \====/</span>
<a name="l00184"></a>00184 <span class="comment"> */</span>
<a name="l00185"></a>00185 INLINE uint8_t lcd_dataRead(<span class="keywordtype">void</span>)
<a name="l00186"></a>00186 {
<a name="l00187"></a>00187     uint8_t data;
<a name="l00188"></a>00188 
<a name="l00189"></a>00189     LCD_SET_RD;
<a name="l00190"></a>00190     <a class="code" href="hw__lcd__32122a_8h.html#a3f0aa4d7b865312a8364a9c2dde02f35" title="Set data bus direction to input (read from display)">LCD_DB_IN</a>;  <span class="comment">/* Set bus as input! */</span>
<a name="l00191"></a>00191     <a class="code" href="hw__lcd__32122a_8h.html#a9d8d3c053710aa4a70f1ed153b1bb8a2" title="Delay for read (Data ouput delay time, 120ns)">LCD_DELAY_READ</a>;
<a name="l00192"></a>00192 
<a name="l00193"></a>00193 <span class="preprocessor">#if CONFIG_LCD_4BIT</span>
<a name="l00194"></a>00194 <span class="preprocessor"></span>
<a name="l00195"></a>00195     <span class="comment">/* Read high nibble */</span>
<a name="l00196"></a>00196     LCD_SET_E;
<a name="l00197"></a>00197     <a class="code" href="hw__lcd__32122a_8h.html#a9d8d3c053710aa4a70f1ed153b1bb8a2" title="Delay for read (Data ouput delay time, 120ns)">LCD_DELAY_READ</a>;
<a name="l00198"></a>00198     data = LCD_READ_H;
<a name="l00199"></a>00199     LCD_CLR_E;
<a name="l00200"></a>00200     <a class="code" href="hw__lcd__32122a_8h.html#a9d8d3c053710aa4a70f1ed153b1bb8a2" title="Delay for read (Data ouput delay time, 120ns)">LCD_DELAY_READ</a>;
<a name="l00201"></a>00201 
<a name="l00202"></a>00202     <span class="comment">/* Read low nibble */</span>
<a name="l00203"></a>00203     LCD_SET_E;
<a name="l00204"></a>00204     <a class="code" href="hw__lcd__32122a_8h.html#a9d8d3c053710aa4a70f1ed153b1bb8a2" title="Delay for read (Data ouput delay time, 120ns)">LCD_DELAY_READ</a>;
<a name="l00205"></a>00205     data |= LCD_READ_L;
<a name="l00206"></a>00206     LCD_CLR_E;
<a name="l00207"></a>00207     <a class="code" href="hw__lcd__32122a_8h.html#a9d8d3c053710aa4a70f1ed153b1bb8a2" title="Delay for read (Data ouput delay time, 120ns)">LCD_DELAY_READ</a>;
<a name="l00208"></a>00208 
<a name="l00209"></a>00209 <span class="preprocessor">#else </span><span class="comment">/* !CONFIG_LCD_4BIT */</span>
<a name="l00210"></a>00210 
<a name="l00211"></a>00211     <span class="comment">/* Read data */</span>
<a name="l00212"></a>00212     LCD_SET_E;
<a name="l00213"></a>00213     <a class="code" href="hw__lcd__32122a_8h.html#a9d8d3c053710aa4a70f1ed153b1bb8a2" title="Delay for read (Data ouput delay time, 120ns)">LCD_DELAY_READ</a>;
<a name="l00214"></a>00214     data = <a class="code" href="hw__lcd__32122a_8h.html#ad543004401896d9736084fcd833b7fd6" title="Write to the LCD data bus (DB[0-7])">LCD_READ</a>;
<a name="l00215"></a>00215     LCD_CLR_E;
<a name="l00216"></a>00216     <a class="code" href="hw__lcd__32122a_8h.html#a9d8d3c053710aa4a70f1ed153b1bb8a2" title="Delay for read (Data ouput delay time, 120ns)">LCD_DELAY_READ</a>;
<a name="l00217"></a>00217 
<a name="l00218"></a>00218 <span class="preprocessor">#endif </span><span class="comment">/* !CONFIG_LCD_4BIT */</span>
<a name="l00219"></a>00219 
<a name="l00220"></a>00220     LCD_CLR_RD;
<a name="l00221"></a>00221     <a class="code" href="hw__lcd__32122a_8h.html#a6f9cf39164a5735c4f34ca3cd1853a7c" title="Set data bus direction to output (write to display)">LCD_DB_OUT</a>; <span class="comment">/* Reset bus as output! */</span>
<a name="l00222"></a>00222 
<a name="l00223"></a>00223     <span class="keywordflow">return</span> data;
<a name="l00224"></a>00224 }
<a name="l00225"></a>00225 
<a name="l00226"></a>00226 <span class="comment">/*      ___             __</span>
<a name="l00227"></a>00227 <span class="comment"> * RS      \___________/</span>
<a name="l00228"></a>00228 <span class="comment"> *</span>
<a name="l00229"></a>00229 <span class="comment"> * READ __________________</span>
<a name="l00230"></a>00230 <span class="comment"> *            _______</span>
<a name="l00231"></a>00231 <span class="comment"> * ENA  _____/       \____</span>
<a name="l00232"></a>00232 <span class="comment"> *</span>
<a name="l00233"></a>00233 <span class="comment"> * DATA --&lt;===============</span>
<a name="l00234"></a>00234 <span class="comment"> */</span>
<a name="l00235"></a>00235 INLINE <span class="keywordtype">void</span> lcd_regWrite(uint8_t data)
<a name="l00236"></a>00236 {
<a name="l00237"></a>00237     LCD_CLR_RS;
<a name="l00238"></a>00238     <a class="code" href="lcd__rit128x96_8c.html#a65ad9bd4a05056b18c55dabc3bacf4bc" title="Write a sequence of data bytes to the LCD controller.">lcd_dataWrite</a>(data);
<a name="l00239"></a>00239     LCD_SET_RS;
<a name="l00240"></a>00240 }
<a name="l00241"></a>00241 
<a name="l00242"></a>00242 <span class="comment">/*      __               _</span>
<a name="l00243"></a>00243 <span class="comment"> * RS     \_____________/</span>
<a name="l00244"></a>00244 <span class="comment"> *          ___________</span>
<a name="l00245"></a>00245 <span class="comment"> * READ ___/           \__</span>
<a name="l00246"></a>00246 <span class="comment"> *            _______</span>
<a name="l00247"></a>00247 <span class="comment"> * ENA  _____/       \____</span>
<a name="l00248"></a>00248 <span class="comment"> *        ______      ____</span>
<a name="l00249"></a>00249 <span class="comment"> * DATA X/      \====/</span>
<a name="l00250"></a>00250 <span class="comment"> */</span>
<a name="l00251"></a>00251 INLINE uint8_t lcd_regRead(<span class="keywordtype">void</span>)
<a name="l00252"></a>00252 {
<a name="l00253"></a>00253     uint8_t data;
<a name="l00254"></a>00254 
<a name="l00255"></a>00255     LCD_CLR_RS;
<a name="l00256"></a>00256     data = lcd_dataRead();
<a name="l00257"></a>00257     LCD_SET_RS;
<a name="l00258"></a>00258     <span class="keywordflow">return</span> data;
<a name="l00259"></a>00259 }
<a name="l00260"></a>00260 
<a name="l00261"></a>00261 <span class="preprocessor">#if CONFIG_LCD_4BIT</span>
<a name="l00262"></a>00262 <span class="preprocessor"></span>
<a name="l00263"></a>00263 INLINE <span class="keywordtype">void</span> lcd_mode4Bit(<span class="keywordtype">void</span>)
<a name="l00264"></a>00264 {
<a name="l00265"></a>00265     LCD_CLR_RS;
<a name="l00266"></a>00266 
<a name="l00267"></a>00267     LCD_WRITE_H(<a class="code" href="lcd__hd44_8h.html#a36b671f82e6943b6495b5166dd9be5bb" title="8 bits, 2 lines, 5x7 dots">LCD_CMD_SETFUNC</a>);
<a name="l00268"></a>00268     LCD_SET_E;
<a name="l00269"></a>00269     <a class="code" href="hw__lcd__32122a_8h.html#a412fd50d7add9264007510e6b31c0f27" title="Delay for write (Enable pulse width, 220ns)">LCD_DELAY_WRITE</a>;
<a name="l00270"></a>00270     LCD_CLR_E;
<a name="l00271"></a>00271     <a class="code" href="hw__lcd__32122a_8h.html#a412fd50d7add9264007510e6b31c0f27" title="Delay for write (Enable pulse width, 220ns)">LCD_DELAY_WRITE</a>;
<a name="l00272"></a>00272 
<a name="l00273"></a>00273     LCD_SET_RS;
<a name="l00274"></a>00274 }
<a name="l00275"></a>00275 
<a name="l00276"></a>00276 <span class="preprocessor">#endif </span><span class="comment">/* CONFIG_LCD_4BIT */</span>
<a name="l00277"></a>00277 
<a name="l00278"></a>00278 <span class="preprocessor">#else </span><span class="comment">/* ARCH_EMUL */</span>
<a name="l00279"></a>00279 
<a name="l00280"></a>00280 <span class="keyword">extern</span> <span class="keywordtype">void</span> Emul_LCDWriteReg(uint8_t d);
<a name="l00281"></a>00281 <span class="keyword">extern</span> uint8_t Emul_LCDReadReg(<span class="keywordtype">void</span>);
<a name="l00282"></a>00282 <span class="keyword">extern</span> <span class="keywordtype">void</span> Emul_LCDWriteData(uint8_t d);
<a name="l00283"></a>00283 <span class="keyword">extern</span> uint8_t Emul_LCDReadData(<span class="keywordtype">void</span>);
<a name="l00284"></a>00284 
<a name="l00285"></a>00285 <span class="preprocessor">#define lcd_regWrite(d)   Emul_LCDWriteReg(d)</span>
<a name="l00286"></a>00286 <span class="preprocessor"></span><span class="preprocessor">#define lcd_regRead(d)    Emul_LCDReadReg()</span>
<a name="l00287"></a>00287 <span class="preprocessor"></span><span class="preprocessor">#define lcd_dataWrite(d)  Emul_LCDWriteData(d)</span>
<a name="l00288"></a>00288 <span class="preprocessor"></span><span class="preprocessor">#define lcd_dataRead(d)   Emul_LCDReadData()</span>
<a name="l00289"></a>00289 <span class="preprocessor"></span>
<a name="l00290"></a>00290 <span class="preprocessor">#endif </span><span class="comment">/* ARCH_EMUL */</span>
<a name="l00291"></a>00291 
<a name="l00292"></a>00292 
<a name="l00296"></a><a class="code" href="lcd__hd44_8h.html#a210dbfdc18b72c60d36e52f675d04ac4">00296</a> <span class="keywordtype">void</span> <a class="code" href="lcd__hd44_8c.html#a210dbfdc18b72c60d36e52f675d04ac4" title="Wait until the LCD busy flag clears.">lcd_waitBusy</a>(<span class="keywordtype">void</span>)
<a name="l00297"></a>00297 {
<a name="l00298"></a>00298     <span class="keywordflow">for</span> (;;)
<a name="l00299"></a>00299     {
<a name="l00300"></a>00300         uint8_t val = lcd_regRead();
<a name="l00301"></a>00301         <span class="keywordflow">if</span> (!(val &amp; <a class="code" href="lcd__hd44_8c.html#a8b59c49ba61fd230389663dbdffdd6c1" title="Flag di stato del display.">LCDF_BUSY</a>))
<a name="l00302"></a>00302             <span class="keywordflow">break</span>;
<a name="l00303"></a>00303     }
<a name="l00304"></a>00304 }
<a name="l00305"></a>00305 
<a name="l00306"></a>00306 
<a name="l00310"></a><a class="code" href="lcd__hd44_8h.html#a7de3dfdd59f76420f2d9be1b495e7c41">00310</a> <span class="keywordtype">void</span> <a class="code" href="lcd__hd44_8c.html#a7de3dfdd59f76420f2d9be1b495e7c41" title="Move the cursor to addr, only if not already there.">lcd_moveTo</a>(uint8_t addr)
<a name="l00311"></a>00311 {
<a name="l00312"></a>00312     <span class="keywordflow">if</span> (addr != lcd_current_addr)
<a name="l00313"></a>00313     {
<a name="l00314"></a>00314         <a class="code" href="lcd__hd44_8c.html#a210dbfdc18b72c60d36e52f675d04ac4" title="Wait until the LCD busy flag clears.">lcd_waitBusy</a>();
<a name="l00315"></a>00315         lcd_regWrite(<a class="code" href="lcd__hd44_8c.html#a99705358436a43e451011ea62edd575c" title="Addresses of LCD display character positions, calculated runtime to save RAM.">lcd_address</a>(addr));
<a name="l00316"></a>00316         lcd_current_addr = addr;
<a name="l00317"></a>00317     }
<a name="l00318"></a>00318 }
<a name="l00319"></a>00319 
<a name="l00320"></a>00320 
<a name="l00324"></a><a class="code" href="lcd__hd44_8h.html#abecd10fb31a5b39d6692cdcb9fa09f9d">00324</a> <span class="keywordtype">void</span> <a class="code" href="lcd__hd44_8c.html#abecd10fb31a5b39d6692cdcb9fa09f9d" title="Write a value in LCD data register, waiting for the busy flag.">lcd_setReg</a>(uint8_t val)
<a name="l00325"></a>00325 {
<a name="l00326"></a>00326     <a class="code" href="lcd__hd44_8c.html#a210dbfdc18b72c60d36e52f675d04ac4" title="Wait until the LCD busy flag clears.">lcd_waitBusy</a>();
<a name="l00327"></a>00327     lcd_regWrite(val);
<a name="l00328"></a>00328 }
<a name="l00329"></a>00329 
<a name="l00330"></a>00330 <span class="preprocessor">#include &lt;<a class="code" href="debug_8h.html">cfg/debug.h</a>&gt;</span>
<a name="l00338"></a><a class="code" href="lcd__hd44_8h.html#a91955f3d80d3a7faa722c4845e37017a">00338</a> <span class="keywordtype">void</span> <a class="code" href="lcd__hd44_8c.html#aa629df1bfcac6d148c5129037c92deec" title="Write the character c on display address addr.">lcd_putc</a>(uint8_t addr, uint8_t c)
<a name="l00339"></a>00339 {
<a name="l00340"></a>00340     <span class="keywordflow">if</span> (addr != lcd_current_addr)
<a name="l00341"></a>00341         <a class="code" href="lcd__hd44_8c.html#abecd10fb31a5b39d6692cdcb9fa09f9d" title="Write a value in LCD data register, waiting for the busy flag.">lcd_setReg</a>(<a class="code" href="lcd__hd44_8c.html#a99705358436a43e451011ea62edd575c" title="Addresses of LCD display character positions, calculated runtime to save RAM.">lcd_address</a>(addr));
<a name="l00342"></a>00342 
<a name="l00343"></a>00343     <a class="code" href="lcd__hd44_8c.html#a210dbfdc18b72c60d36e52f675d04ac4" title="Wait until the LCD busy flag clears.">lcd_waitBusy</a>();
<a name="l00344"></a>00344     <a class="code" href="lcd__rit128x96_8c.html#a65ad9bd4a05056b18c55dabc3bacf4bc" title="Write a sequence of data bytes to the LCD controller.">lcd_dataWrite</a>(c);
<a name="l00345"></a>00345     lcd_current_addr = addr + 1;
<a name="l00346"></a>00346 
<a name="l00347"></a>00347     <span class="comment">/* If we are at end of display wrap the address to 0 */</span>
<a name="l00348"></a>00348     <span class="keywordflow">if</span> (lcd_current_addr == <a class="code" href="cfg__lcd__hd44_8h.html#a51ddf49250894d315c04c9a191d58f2f" title="Number of columns in LCD display.">CONFIG_LCD_COLS</a> * <a class="code" href="cfg__lcd__hd44_8h.html#a3ba3d985c1ee580232383c75eb54fb84" title="Number of rows in LCD display.">CONFIG_LCD_ROWS</a>)
<a name="l00349"></a>00349         lcd_current_addr = 0;
<a name="l00350"></a>00350 
<a name="l00351"></a>00351     <span class="comment">/* If we are at the end of a row put the cursor at the beginning of the next */</span>
<a name="l00352"></a>00352     <span class="keywordflow">if</span> (!(lcd_current_addr % <a class="code" href="cfg__lcd__hd44_8h.html#a51ddf49250894d315c04c9a191d58f2f" title="Number of columns in LCD display.">CONFIG_LCD_COLS</a>))
<a name="l00353"></a>00353         <a class="code" href="lcd__hd44_8c.html#abecd10fb31a5b39d6692cdcb9fa09f9d" title="Write a value in LCD data register, waiting for the busy flag.">lcd_setReg</a>(<a class="code" href="lcd__hd44_8c.html#a99705358436a43e451011ea62edd575c" title="Addresses of LCD display character positions, calculated runtime to save RAM.">lcd_address</a>(lcd_current_addr));
<a name="l00354"></a>00354 }
<a name="l00355"></a>00355 
<a name="l00356"></a>00356 
<a name="l00363"></a><a class="code" href="lcd__hd44_8h.html#a401571504f83e24cbf55ab9a6f063736">00363</a> <span class="keywordtype">void</span> <a class="code" href="lcd__hd44_8c.html#a401571504f83e24cbf55ab9a6f063736" title="Remap the glyph of a character.">lcd_remapChar</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *glyph, <span class="keywordtype">char</span> code)
<a name="l00364"></a>00364 {
<a name="l00365"></a>00365     <span class="keywordtype">int</span> i;
<a name="l00366"></a>00366 
<a name="l00367"></a>00367     <span class="comment">/* Set CG RAM address */</span>
<a name="l00368"></a>00368     <a class="code" href="lcd__hd44_8c.html#abecd10fb31a5b39d6692cdcb9fa09f9d" title="Write a value in LCD data register, waiting for the busy flag.">lcd_setReg</a>((uint8_t)((1&lt;&lt;6) | (code &lt;&lt; 3)));
<a name="l00369"></a>00369 
<a name="l00370"></a>00370     <span class="comment">/* Write bitmap data */</span>
<a name="l00371"></a>00371     <span class="keywordflow">for</span> (i = 0; i &lt; 8; i++)
<a name="l00372"></a>00372     {
<a name="l00373"></a>00373         <a class="code" href="lcd__hd44_8c.html#a210dbfdc18b72c60d36e52f675d04ac4" title="Wait until the LCD busy flag clears.">lcd_waitBusy</a>();
<a name="l00374"></a>00374         <a class="code" href="lcd__rit128x96_8c.html#a65ad9bd4a05056b18c55dabc3bacf4bc" title="Write a sequence of data bytes to the LCD controller.">lcd_dataWrite</a>(glyph[i]);
<a name="l00375"></a>00375     }
<a name="l00376"></a>00376 
<a name="l00377"></a>00377     <span class="comment">/* Move back to original address */</span>
<a name="l00378"></a>00378     <a class="code" href="lcd__hd44_8c.html#abecd10fb31a5b39d6692cdcb9fa09f9d" title="Write a value in LCD data register, waiting for the busy flag.">lcd_setReg</a>(<a class="code" href="lcd__hd44_8c.html#a99705358436a43e451011ea62edd575c" title="Addresses of LCD display character positions, calculated runtime to save RAM.">lcd_address</a>(lcd_current_addr));
<a name="l00379"></a>00379 }
<a name="l00380"></a>00380 
<a name="l00381"></a>00381 
<a name="l00382"></a>00382 <span class="preprocessor">#if 0 </span><span class="comment">/* unused */</span>
<a name="l00383"></a>00383 <span class="keywordtype">void</span> lcd_remapfont(<span class="keywordtype">void</span>)
<a name="l00384"></a>00384 {
<a name="l00385"></a>00385     <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> lcd_glyphs[8] =
<a name="l00386"></a>00386     {
<a name="l00387"></a>00387         0x04, 0x0E, 0x15, 0x04, 0x04, 0x04, 0x04, 0x00 <span class="comment">/* up arrow */</span>
<a name="l00388"></a>00388     };
<a name="l00389"></a>00389     <span class="keywordtype">int</span> i;
<a name="l00390"></a>00390 
<a name="l00391"></a>00391     <span class="keywordflow">for</span> (i = 0; i &lt; 15; i++)
<a name="l00392"></a>00392         <a class="code" href="lcd__hd44_8c.html#a401571504f83e24cbf55ab9a6f063736" title="Remap the glyph of a character.">lcd_remapChar</a>(i, bernie_char);
<a name="l00393"></a>00393 
<a name="l00394"></a>00394 
<a name="l00395"></a>00395     lcd_setAddr(lcd_DefLayer, 0);
<a name="l00396"></a>00396     <span class="keywordflow">for</span> (i = 0; i &lt; 80; i++)
<a name="l00397"></a>00397         <a class="code" href="lcd__text_8c.html#a8673e14b85d182c1bff9e48da4ec7683" title="Write one character to the display at the current cursor prosition, then move the cursor right...">lcd_putCharUnlocked</a>(i);
<a name="l00398"></a>00398 }
<a name="l00399"></a>00399 <span class="preprocessor">#endif </span><span class="comment">/* unused */</span>
<a name="l00400"></a>00400 
<a name="l00401"></a>00401 <span class="keywordtype">void</span> lcd_hw_init(<span class="keywordtype">void</span>)
<a name="l00402"></a>00402 {
<a name="l00403"></a>00403     lcd_hd44_hw_bus_init();
<a name="l00404"></a>00404 
<a name="l00405"></a>00405     <a class="code" href="group__drv__timers.html#gace6fb3d382bd740f9cee1b139e12f7a6" title="Wait some time [ms].">timer_delay</a>(50);
<a name="l00406"></a>00406 
<a name="l00407"></a>00407 <span class="preprocessor">#if CONFIG_LCD_4BIT</span>
<a name="l00408"></a>00408 <span class="preprocessor"></span>    lcd_regWrite(<a class="code" href="lcd__hd44_8h.html#a812cc7020757670402ecfe8c9989b968" title="8 bits, 2 lines, 5x7 dots">LCD_CMD_SET8BIT</a>);
<a name="l00409"></a>00409     lcd_mode4Bit();
<a name="l00410"></a>00410     <a class="code" href="group__drv__timers.html#gace6fb3d382bd740f9cee1b139e12f7a6" title="Wait some time [ms].">timer_delay</a>(2);
<a name="l00411"></a>00411 <span class="preprocessor">#endif </span><span class="comment">/* CONFIG_LCD_4BIT */</span>
<a name="l00412"></a>00412 
<a name="l00413"></a>00413     lcd_regWrite(<a class="code" href="lcd__hd44_8h.html#a36b671f82e6943b6495b5166dd9be5bb" title="8 bits, 2 lines, 5x7 dots">LCD_CMD_SETFUNC</a>);
<a name="l00414"></a>00414     <a class="code" href="group__drv__timers.html#gace6fb3d382bd740f9cee1b139e12f7a6" title="Wait some time [ms].">timer_delay</a>(2);
<a name="l00415"></a>00415 
<a name="l00416"></a>00416     lcd_regWrite(<a class="code" href="lcd__hd44_8h.html#a7572bc6998f73117e83b184aba2e40ea" title="Switch on display.">LCD_CMD_DISPLAY_ON</a>);
<a name="l00417"></a>00417     <a class="code" href="group__drv__timers.html#gace6fb3d382bd740f9cee1b139e12f7a6" title="Wait some time [ms].">timer_delay</a>(2);
<a name="l00418"></a>00418 
<a name="l00419"></a>00419     lcd_regWrite(<a class="code" href="lcd__hd44_8h.html#a297b2c9447670639c97dd56f22205a58" title="Clear display.">LCD_CMD_CLEAR</a>);
<a name="l00420"></a>00420     <a class="code" href="group__drv__timers.html#gace6fb3d382bd740f9cee1b139e12f7a6" title="Wait some time [ms].">timer_delay</a>(2);
<a name="l00421"></a>00421 
<a name="l00422"></a>00422 <span class="preprocessor">#if !CONFIG_LCD_4BIT</span>
<a name="l00423"></a>00423 <span class="preprocessor"></span>    lcd_regWrite(<a class="code" href="lcd__hd44_8h.html#a5bb3f7ab3e6a972ab1f32542e789b1c9" title="8 bits, 2 lines, 5x7 dots">LCD_CMD_RESET_DDRAM</a>); <span class="comment">// 4 bit mode doesn&#39;t allow char reprogramming</span>
<a name="l00424"></a>00424 <span class="preprocessor">#endif</span>
<a name="l00425"></a>00425 <span class="preprocessor"></span>    lcd_regWrite(<a class="code" href="lcd__hd44_8h.html#a4b12ee223cdec256e869fcf91cc6bd46" title="8 bits, 2 lines, 5x7 dots">LCD_CMD_DISPLAYMODE</a>);
<a name="l00426"></a>00426     <a class="code" href="group__drv__timers.html#gace6fb3d382bd740f9cee1b139e12f7a6" title="Wait some time [ms].">timer_delay</a>(2);
<a name="l00427"></a>00427 }
<a name="l00428"></a>00428 
<a name="l00429"></a>00429 
</pre></div></div>
</div>


