

<!-- Generated by Doxygen 1.7.4 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="summary">
<a href="#define-members">Defines</a> &#124;
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle">
<div class="title">Event handling module</div>  </div>
<div class="ingroups"><a class="el" href="group__core.html">BeRTOS core functionality</a></div></div>
<div class="contents">

<p>Events handling.  
<a href="#details">More...</a></p>
<table class="memberdecls">
<tr><td colspan="2"><h2><a name="define-members"></a>
Defines</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="gaed0c230a6b1d9a1c8766e21cc60e3c17"></a><!-- doxytag: member="event_handling::event_initNone" ref="gaed0c230a6b1d9a1c8766e21cc60e3c17" args="(e)" -->
#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__event__handling.html#gaed0c230a6b1d9a1c8766e21cc60e3c17">event_initNone</a>(e)&#160;&#160;&#160;((e)-&gt;action = event_hook_ignore)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Initialize the event <em>e</em> as a no-op. <br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="gaca50ea4a82621e6c3e4d8c4d7627dcdf"></a><!-- doxytag: member="event_handling::event_initSoftint" ref="gaca50ea4a82621e6c3e4d8c4d7627dcdf" args="(e, f, u)" -->
#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__event__handling.html#gaca50ea4a82621e6c3e4d8c4d7627dcdf">event_initSoftint</a>(e, f, u)&#160;&#160;&#160;((e)-&gt;action = event_hook_softint,(e)-&gt;Ev.Int.func = (f), (e)-&gt;Ev.Int.user_data = (u))</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Initialize the event <em>e</em> with a software interrupt (call function <em>f</em>, with parameter <em>u</em>) <br/></td></tr>
<tr><td colspan="2"><h2><a name="func-members"></a>
Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="ga4b616c26fd10ad53a85556f9e1ed456d"></a><!-- doxytag: member="event_handling::event_createNone" ref="ga4b616c26fd10ad53a85556f9e1ed456d" args="(void)" -->
Event&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__event__handling.html#ga4b616c26fd10ad53a85556f9e1ed456d">event_createNone</a> (void)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Same as <a class="el" href="group__event__handling.html#gaed0c230a6b1d9a1c8766e21cc60e3c17" title="Initialize the event e as a no-op.">event_initNone()</a>, but returns the initialized event. <br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="gae3a25f40f1890354a850df3fa01fb632"></a><!-- doxytag: member="event_handling::event_createSoftint" ref="gae3a25f40f1890354a850df3fa01fb632" args="(Hook func, void *user_data)" -->
Event&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__event__handling.html#gae3a25f40f1890354a850df3fa01fb632">event_createSoftint</a> (<a class="el" href="compiler_8h.html#a29da6a2c5167c69f4e05da8466f2b339">Hook</a> func, void *user_data)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Same as <a class="el" href="group__event__handling.html#gaca50ea4a82621e6c3e4d8c4d7627dcdf" title="Initialize the event e with a software interrupt (call function f, with parameter u)...">event_initSoftint()</a>, but returns the initialized event. <br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">Event&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__event__handling.html#ga2f9ed6537c234137352db380a42744a1">event_createGeneric</a> (void)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Create a generic sleepable event.  <a href="#ga2f9ed6537c234137352db380a42744a1"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__event__handling.html#ga2dc29c321fb1c8e61ee67e64d85ad256">event_wait</a> (Event *e)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Wait the completion of event <em>e</em>.  <a href="#ga2dc29c321fb1c8e61ee67e64d85ad256"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__event__handling.html#ga69976a76ee2aaddbc0c0c8e9d9d0862f">event_select</a> (Event **evs, int n, <a class="el" href="compiler_8h.html#a9f2d272efa5f391ffc4b9ec4eb59fa88">ticks_t</a> timeout)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Wait for multiple events.  <a href="#ga69976a76ee2aaddbc0c0c8e9d9d0862f"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__event__handling.html#gad38e26e299d33c925cec519c4005ecf4">event_waitTimeout</a> (Event *e, <a class="el" href="compiler_8h.html#a9f2d272efa5f391ffc4b9ec4eb59fa88">ticks_t</a> timeout)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Wait the completion of event <em>e</em> or <em>timeout</em> elapses.  <a href="#gad38e26e299d33c925cec519c4005ecf4"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__event__handling.html#gae46f6285c3609bf8d6e484926dae455c">event_do</a> (struct Event *e)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Trigger an event.  <a href="#gae46f6285c3609bf8d6e484926dae455c"></a><br/></td></tr>
</table>
<hr/><a name="details" id="details"></a><h2>Detailed Description</h2>
<p>Events handling. </p>
<p>This module implements a common system for executing a user defined action calling a hook function.</p>
<p>Device drivers often need to wait the completion of some event, usually to allow the hardware to accomplish some asynchronous task.</p>
<p>A common approach is to place a busy wait with a <a class="el" href="power_8h.html#aa0eaaa5f710ff7d97371d8053e73e692" title="Let the CPU rest in tight busy loops.">cpu_relax()</a> loop that invokes the architecture-specific instructions to say that we're not doing much with the processor.</p>
<p>Although technically correct, the busy loop degrades the overall system performance in presence of multiple processes and power consumption.</p>
<p>With the kernel the natural way to implement such wait/complete mechanism is to use signals via <a class="el" href="group__kern__signal.html#ga83accf7cc9eb33c748b2670b8f272060" title="Sleep until any of the signals in sigs occurs.">sig_wait()</a> and <a class="el" href="group__kern__signal.html#ga5348234f4750db67796ad17d82bb30fc" title="Send the signals sigs to the process proc.">sig_post()</a>/sig_send().</p>
<p>However, signals in BeRTOS are only available in presence of the kernel (that is just a compile-time option). This means that each device driver must provide two different interfaces to implement the wait/complete semantic: one with the kernel and another without the kernel.</p>
<p>The purpose of the completion events is to provide a generic interface to implement a synchronization mechanism to block the execution of code until a specific event happens.</p>
<p>This interface does not depend on the presence of the kernel and it automatically uses the appropriate event backend to provide the same behaviour with or without the kernel.</p>
<p>Example usage (wait for a generic device driver initialization): </p>
<div class="fragment"><pre class="fragment">  <span class="keyword">static</span> Event e;

  <span class="keyword">static</span> <span class="keywordtype">void</span> irq_handler(<span class="keywordtype">void</span>)
  {
      <span class="comment">// Completion event has happened, resume the execution of init()</span>
      <a class="code" href="group__event__handling.html#gae46f6285c3609bf8d6e484926dae455c" title="Trigger an event.">event_do</a>(&amp;e);
  }

  <span class="keyword">static</span> <span class="keywordtype">void</span> init(<span class="keywordtype">void</span>)
  {
      <span class="comment">// Declare the generic completion event</span>
      event_initGeneric(&amp;e);
      <span class="comment">// Submit the hardware initialization request</span>
      async_hw_init();
      <span class="comment">// Wait for the completion of the event</span>
      <a class="code" href="group__event__handling.html#ga2dc29c321fb1c8e61ee67e64d85ad256" title="Wait the completion of event e.">event_wait</a>(&amp;e);
  }
</pre></div><p>Example usage: wait multiple generic events via <a class="el" href="group__event__handling.html#ga69976a76ee2aaddbc0c0c8e9d9d0862f" title="Wait for multiple events.">event_select()</a> </p>
<div class="fragment"><pre class="fragment"> Event ev1;
 Event ev2;

 <span class="keywordtype">void</span> event_notifier(<span class="keywordtype">void</span>)
 {
      Event *evs[] = { &amp;ev1, &amp;ev2 };

      event_initGeneric(&amp;ev1);
      event_initGeneric(&amp;ev2);

      <span class="keywordflow">while</span> (1)
      {
              <span class="keywordtype">int</span> <span class="keywordtype">id</span> = <a class="code" href="group__event__handling.html#ga69976a76ee2aaddbc0c0c8e9d9d0862f" title="Wait for multiple events.">event_select</a>(evs, <a class="code" href="compiler_8h.html#a3c5cd622462bb50b6dab4c189e219eb9" title="Count the number of elements in the static array a.">countof</a>(evs),
                                      <a class="code" href="group__drv__timers.html#ga1058ec50197d9ff9483be09612022929" title="Convert ms [ms] to ticks.">ms_to_ticks</a>(100));
              <span class="keywordflow">if</span> (<span class="keywordtype">id</span> &lt; 0)
              {
                      kprintf(<span class="stringliteral">&quot;no IRQ\n&quot;</span>);
                      <span class="keywordflow">continue</span>;
              }
              kprintf(<span class="stringliteral">&quot;IRQ %d happened\n&quot;</span>, <span class="keywordtype">id</span>);
      }
 }

 <span class="keywordtype">void</span> irq1_handler(<span class="keywordtype">void</span>)
 {
      <span class="comment">// do something</span>
      ...

      <span class="comment">// notify the completion of event 1</span>
      <a class="code" href="group__event__handling.html#gae46f6285c3609bf8d6e484926dae455c" title="Trigger an event.">event_do</a>(&amp;ev1);
 }

 <span class="keywordtype">void</span> irq2_handler(<span class="keywordtype">void</span>)
 {
      <span class="comment">// do something</span>
      ...

      <span class="comment">// notify the completion of event 2</span>
      <a class="code" href="group__event__handling.html#gae46f6285c3609bf8d6e484926dae455c" title="Trigger an event.">event_do</a>(&amp;ev2);
 }
</pre></div><dl class="author"><dt><b>Author:</b></dt><dd>Bernie Innocenti &lt;<a href="mailto:bernie@codewiz.org">bernie@codewiz.org</a>&gt; </dd></dl>
<hr/><h2>Function Documentation</h2>
<a class="anchor" id="ga2f9ed6537c234137352db380a42744a1"></a><!-- doxytag: member="event.h::event_createGeneric" ref="ga2f9ed6537c234137352db380a42744a1" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">Event event_createGeneric </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td><code> [inline]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Create a generic sleepable event. </p>
<dl class="return"><dt><b>Returns:</b></dt><dd>the properly initialized generic event structure. </dd></dl>

<p>Definition at line <a class="el" href="event_8h_source.html#l00249">249</a> of file <a class="el" href="event_8h_source.html">event.h</a>.</p>

</div>
</div>
<a class="anchor" id="gae46f6285c3609bf8d6e484926dae455c"></a><!-- doxytag: member="event.h::event_do" ref="gae46f6285c3609bf8d6e484926dae455c" args="(struct Event *e)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void event_do </td>
          <td>(</td>
          <td class="paramtype">struct Event *&#160;</td>
          <td class="paramname"><em>e</em></td><td>)</td>
          <td><code> [inline]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Trigger an event. </p>
<p>Execute the callback function associated with event <em>e</em>.</p>
<p>This function can be used also in interrupt routines, but only if the event was created as a signal or generic event. </p>

<p>Definition at line <a class="el" href="event_8h_source.html#l00303">303</a> of file <a class="el" href="event_8h_source.html">event.h</a>.</p>

</div>
</div>
<a class="anchor" id="ga69976a76ee2aaddbc0c0c8e9d9d0862f"></a><!-- doxytag: member="event.h::event_select" ref="ga69976a76ee2aaddbc0c0c8e9d9d0862f" args="(Event **evs, int n, ticks_t timeout)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int event_select </td>
          <td>(</td>
          <td class="paramtype">Event **&#160;</td>
          <td class="paramname"><em>evs</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>n</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="compiler_8h.html#a9f2d272efa5f391ffc4b9ec4eb59fa88">ticks_t</a>&#160;</td>
          <td class="paramname"><em>timeout</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Wait for multiple events. </p>
<p>On success return the offset in the <em>evs</em> vector of the Event that happened, -1 if the timeout expires.</p>
<p>NOTE: timeout == 0 means no timeout.</p>
<dl class="attention"><dt><b>Attention:</b></dt><dd>The API is work in progress and may change in future versions. </dd></dl>

<p>Definition at line <a class="el" href="event_8c_source.html#l00193">193</a> of file <a class="el" href="event_8c_source.html">event.c</a>.</p>

</div>
</div>
<a class="anchor" id="ga2dc29c321fb1c8e61ee67e64d85ad256"></a><!-- doxytag: member="event.h::event_wait" ref="ga2dc29c321fb1c8e61ee67e64d85ad256" args="(Event *e)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void event_wait </td>
          <td>(</td>
          <td class="paramtype">Event *&#160;</td>
          <td class="paramname"><em>e</em></td><td>)</td>
          <td><code> [inline]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Wait the completion of event <em>e</em>. </p>
<p>This function releases the CPU the application is configured to use the kernel, otherwise it's just a busy wait. </p>
<dl class="note"><dt><b>Note:</b></dt><dd>It's forbidden to use this function inside irq handling functions. </dd></dl>

<p>Definition at line <a class="el" href="event_8h_source.html#l00263">263</a> of file <a class="el" href="event_8h_source.html">event.h</a>.</p>

</div>
</div>
<a class="anchor" id="gad38e26e299d33c925cec519c4005ecf4"></a><!-- doxytag: member="event.h::event_waitTimeout" ref="gad38e26e299d33c925cec519c4005ecf4" args="(Event *e, ticks_t timeout)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool event_waitTimeout </td>
          <td>(</td>
          <td class="paramtype">Event *&#160;</td>
          <td class="paramname"><em>e</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="compiler_8h.html#a9f2d272efa5f391ffc4b9ec4eb59fa88">ticks_t</a>&#160;</td>
          <td class="paramname"><em>timeout</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Wait the completion of event <em>e</em> or <em>timeout</em> elapses. </p>
<dl class="note"><dt><b>Note:</b></dt><dd>It's forbidden to use this function inside irq handling functions. </dd></dl>

<p>Definition at line <a class="el" href="event_8c_source.html#l00178">178</a> of file <a class="el" href="event_8c_source.html">event.c</a>.</p>

</div>
</div>
</div>


