

<!-- Generated by Doxygen 1.7.4 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="dir_9fd71c1ac00056e7d855336b2291c56c.html">bertos</a>      </li>
      <li class="navelem"><a class="el" href="dir_5b85ff6a72c79a71106598e13514bf0c.html">mware</a>      </li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">resource.c</div>  </div>
</div>
<div class="contents">
<div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 
<a name="l00002"></a>00002 <span class="preprocessor">#include &quot;<a class="code" href="resource_8h.html" title="TODO:">resource.h</a>&quot;</span>
<a name="l00003"></a>00003 <span class="preprocessor">#include &lt;<a class="code" href="observer_8h.html" title="Simple notifier for the subject/observer pattern (interface)">mware/observer.h</a>&gt;</span>
<a name="l00004"></a>00004 
<a name="l00009"></a><a class="code" href="structResourceWaiter.html">00009</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="structResourceWaiter.html" title="Internal structure for building a priority queue of processes waiting for the resource to become free...">ResourceWaiter</a>
<a name="l00010"></a>00010 {
<a name="l00011"></a>00011     <a class="code" href="structPriNode.html" title="Extended node for priority queues.">PriNode</a> link;
<a name="l00012"></a>00012     <span class="keyword">struct </span><a class="code" href="structObserver.html" title="Here&#39;s a simple example:">Observer</a> *owner;
<a name="l00013"></a>00013 
<a name="l00014"></a>00014 } <a class="code" href="structResourceWaiter.html" title="Internal structure for building a priority queue of processes waiting for the resource to become free...">ResourceWaiter</a>;
<a name="l00015"></a>00015 
<a name="l00016"></a>00016 
<a name="l00017"></a><a class="code" href="resource_8h.html#aacb04e463005aea2bc8c5b330a55d19e">00017</a> <span class="keywordtype">bool</span> ResMan_Alloc(<a class="code" href="structResource.html" title="Hold context information for a resource such as an audio channel.">Resource</a> *res, <span class="keywordtype">int</span> pri, ResMan_time_t timeout, <span class="keyword">struct</span> <a class="code" href="structObserver.html" title="Here&#39;s a simple example:">Observer</a> *releaseRequest)
<a name="l00018"></a>00018 {
<a name="l00019"></a>00019     <span class="keywordtype">bool</span> success = <span class="keyword">false</span>;
<a name="l00020"></a>00020 
<a name="l00021"></a>00021     <a class="code" href="group__debug.html#gaca68c0d4ac8df0838e209fb5300f7be3" title="Assert a pre-condition on code.">ASSERT</a>(releaseRequest);
<a name="l00022"></a>00022 
<a name="l00023"></a>00023     <a class="code" href="group__kern__sem.html#ga2fb0fdb9c4df8dc0a2d288b8e8325784" title="Lock a semaphore.">sem_obtain</a>(&amp;res-&gt;<a class="code" href="structResource.html#a9d4e2322f86007d34fe8b88bc6f2fdf9" title="Control access to fields below.">lock</a>);
<a name="l00024"></a>00024 
<a name="l00025"></a>00025     <span class="keywordflow">if</span> (res-&gt;<a class="code" href="structResource.html#a41bc534479f14c1d40e9af2124f909ee" title="Pointer to current owner&#39;s observer. NULL if resource is free.">owner</a> == releaseRequest)
<a name="l00026"></a>00026     {
<a name="l00027"></a>00027         <span class="comment">// Already ours</span>
<a name="l00028"></a>00028         res-&gt;<a class="code" href="structResource.html#a776512832e677c0af917d267fd16079c" title="Priority of current owner (higher values mean higher priority).">pri</a> = pri;
<a name="l00029"></a>00029         success = <span class="keyword">true</span>;
<a name="l00030"></a>00030     }
<a name="l00031"></a>00031     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!res-&gt;<a class="code" href="structResource.html#a41bc534479f14c1d40e9af2124f909ee" title="Pointer to current owner&#39;s observer. NULL if resource is free.">owner</a>)
<a name="l00032"></a>00032     {
<a name="l00033"></a>00033         <span class="comment">// Trivial acquire: nobody was owning the resource</span>
<a name="l00034"></a>00034         res-&gt;<a class="code" href="structResource.html#a776512832e677c0af917d267fd16079c" title="Priority of current owner (higher values mean higher priority).">pri</a> = pri;
<a name="l00035"></a>00035         res-&gt;<a class="code" href="structResource.html#a41bc534479f14c1d40e9af2124f909ee" title="Pointer to current owner&#39;s observer. NULL if resource is free.">owner</a> = releaseRequest;
<a name="l00036"></a>00036         success = <span class="keyword">true</span>;
<a name="l00037"></a>00037     }
<a name="l00038"></a>00038     <span class="keywordflow">else</span>
<a name="l00039"></a>00039     {
<a name="l00040"></a>00040         <a class="code" href="structResourceWaiter.html" title="Internal structure for building a priority queue of processes waiting for the resource to become free...">ResourceWaiter</a> waiter;
<a name="l00041"></a>00041 
<a name="l00042"></a>00042         <span class="comment">// Setup waiter structure and enqueue it to resource</span>
<a name="l00043"></a>00043         waiter.owner = releaseRequest;
<a name="l00044"></a>00044         waiter.link.pri = pri;
<a name="l00045"></a>00045         <a class="code" href="group__list.html#gafce5b0341c2b60e46398240b0eebd467" title="Insert a priority node in a priority queue.">LIST_ENQUEUE</a>(&amp;res-&gt;<a class="code" href="structResource.html#a6962c93bf9942c1f4149c96f88f961ee" title="Queue of processes waiting to obtain the resource.">queue</a>, &amp;waiter.link);
<a name="l00046"></a>00046 
<a name="l00047"></a>00047         <span class="comment">// Resource busy: are we eligible for preemption?</span>
<a name="l00048"></a>00048         <span class="keywordflow">if</span> ((res-&gt;<a class="code" href="structResource.html#a776512832e677c0af917d267fd16079c" title="Priority of current owner (higher values mean higher priority).">pri</a> &lt; pri) &amp;&amp; res-&gt;<a class="code" href="structResource.html#a41bc534479f14c1d40e9af2124f909ee" title="Pointer to current owner&#39;s observer. NULL if resource is free.">owner</a>-&gt;event)
<a name="l00049"></a>00049             res-&gt;<a class="code" href="structResource.html#a41bc534479f14c1d40e9af2124f909ee" title="Pointer to current owner&#39;s observer. NULL if resource is free.">owner</a>-&gt;event(EVENT_RELEASE, res);
<a name="l00050"></a>00050 
<a name="l00051"></a>00051         <span class="comment">// Wait in the queue until the timeout occurs.</span>
<a name="l00052"></a>00052         <span class="keywordflow">do</span>
<a name="l00053"></a>00053         {
<a name="l00054"></a>00054             <a class="code" href="group__kern__sem.html#gaac4a9c65d88722462731fb75f590adb8" title="Release a lock on a previously locked semaphore.">sem_release</a>(&amp;res-&gt;<a class="code" href="structResource.html#a9d4e2322f86007d34fe8b88bc6f2fdf9" title="Control access to fields below.">lock</a>);
<a name="l00055"></a>00055             <span class="comment">// TODO: use a semaphore here instead</span>
<a name="l00056"></a>00056             ResMan_sleep();
<a name="l00057"></a>00057             <a class="code" href="group__kern__sem.html#ga2fb0fdb9c4df8dc0a2d288b8e8325784" title="Lock a semaphore.">sem_obtain</a>(&amp;res-&gt;<a class="code" href="structResource.html#a9d4e2322f86007d34fe8b88bc6f2fdf9" title="Control access to fields below.">lock</a>);
<a name="l00058"></a>00058 
<a name="l00059"></a>00059             <span class="comment">// Check for ownership</span>
<a name="l00060"></a>00060             <span class="keywordflow">if</span> (res-&gt;<a class="code" href="structResource.html#a41bc534479f14c1d40e9af2124f909ee" title="Pointer to current owner&#39;s observer. NULL if resource is free.">owner</a> == releaseRequest)
<a name="l00061"></a>00061             {
<a name="l00062"></a>00062                 success = <span class="keyword">true</span>;
<a name="l00063"></a>00063                 <span class="keywordflow">break</span>;
<a name="l00064"></a>00064             }
<a name="l00065"></a>00065         }
<a name="l00066"></a>00066         <span class="keywordflow">while</span> (timeout--);
<a name="l00067"></a>00067 
<a name="l00068"></a>00068         <span class="comment">// Remove pending waiter</span>
<a name="l00069"></a>00069         <span class="keywordflow">if</span> (!success)
<a name="l00070"></a>00070             <a class="code" href="group__list.html#ga849a0f1c77918e5845588373178ee4ca" title="Remove n from whatever list it is in.">REMOVE</a>(&amp;waiter.link.link);
<a name="l00071"></a>00071     }
<a name="l00072"></a>00072 
<a name="l00073"></a>00073     <a class="code" href="group__kern__sem.html#gaac4a9c65d88722462731fb75f590adb8" title="Release a lock on a previously locked semaphore.">sem_release</a>(&amp;res-&gt;<a class="code" href="structResource.html#a9d4e2322f86007d34fe8b88bc6f2fdf9" title="Control access to fields below.">lock</a>);
<a name="l00074"></a>00074     <span class="keywordflow">return</span> success;
<a name="l00075"></a>00075 }
<a name="l00076"></a>00076 
<a name="l00077"></a><a class="code" href="resource_8h.html#af5c46223b63fd2a4f70555f11ae18d3f">00077</a> <span class="keywordtype">void</span> ResMan_Free(<a class="code" href="structResource.html" title="Hold context information for a resource such as an audio channel.">Resource</a> *res)
<a name="l00078"></a>00078 {
<a name="l00079"></a>00079     <a class="code" href="structResourceWaiter.html" title="Internal structure for building a priority queue of processes waiting for the resource to become free...">ResourceWaiter</a> *waiter;
<a name="l00080"></a>00080 
<a name="l00081"></a>00081     <a class="code" href="group__kern__sem.html#ga2fb0fdb9c4df8dc0a2d288b8e8325784" title="Lock a semaphore.">sem_obtain</a>(&amp;res-&gt;<a class="code" href="structResource.html#a9d4e2322f86007d34fe8b88bc6f2fdf9" title="Control access to fields below.">lock</a>);
<a name="l00082"></a>00082 
<a name="l00083"></a>00083 
<a name="l00084"></a>00084     <a class="code" href="group__debug.html#gaca68c0d4ac8df0838e209fb5300f7be3" title="Assert a pre-condition on code.">ASSERT</a>(res-&gt;<a class="code" href="structResource.html#a41bc534479f14c1d40e9af2124f909ee" title="Pointer to current owner&#39;s observer. NULL if resource is free.">owner</a>);
<a name="l00085"></a>00085     <span class="comment">//TODO: check for real owner calling free</span>
<a name="l00086"></a>00086 
<a name="l00087"></a>00087     <span class="comment">// Check for new owner candidates.</span>
<a name="l00088"></a>00088     <span class="keywordflow">if</span> ((waiter = (<a class="code" href="structResourceWaiter.html" title="Internal structure for building a priority queue of processes waiting for the resource to become free...">ResourceWaiter</a> *)<a class="code" href="group__list.html#ga711eeee335e5022e1d50b7a5085cb611" title="Unlink a node from the head of the list l.">list_remHead</a>(&amp;res-&gt;<a class="code" href="structResource.html#a6962c93bf9942c1f4149c96f88f961ee" title="Queue of processes waiting to obtain the resource.">queue</a>)))
<a name="l00089"></a>00089     {
<a name="l00090"></a>00090         <span class="comment">// Transfer ownership of the resource</span>
<a name="l00091"></a>00091         res-&gt;<a class="code" href="structResource.html#a41bc534479f14c1d40e9af2124f909ee" title="Pointer to current owner&#39;s observer. NULL if resource is free.">owner</a> = waiter-&gt;owner;
<a name="l00092"></a>00092         res-&gt;<a class="code" href="structResource.html#a776512832e677c0af917d267fd16079c" title="Priority of current owner (higher values mean higher priority).">pri</a> = waiter-&gt;link.pri;
<a name="l00093"></a>00093         <span class="comment">//ResMan_wakeup(waiter);</span>
<a name="l00094"></a>00094     }
<a name="l00095"></a>00095     <span class="keywordflow">else</span>
<a name="l00096"></a>00096     {
<a name="l00097"></a>00097         <span class="comment">// Nobody waiting, free the resource</span>
<a name="l00098"></a>00098         res-&gt;<a class="code" href="structResource.html#a41bc534479f14c1d40e9af2124f909ee" title="Pointer to current owner&#39;s observer. NULL if resource is free.">owner</a> = NULL;
<a name="l00099"></a>00099         res-&gt;<a class="code" href="structResource.html#a776512832e677c0af917d267fd16079c" title="Priority of current owner (higher values mean higher priority).">pri</a> = -1;
<a name="l00100"></a>00100     }
<a name="l00101"></a>00101 
<a name="l00102"></a>00102     <a class="code" href="group__kern__sem.html#gaac4a9c65d88722462731fb75f590adb8" title="Release a lock on a previously locked semaphore.">sem_release</a>(&amp;res-&gt;<a class="code" href="structResource.html#a9d4e2322f86007d34fe8b88bc6f2fdf9" title="Control access to fields below.">lock</a>);
<a name="l00103"></a>00103 }
<a name="l00104"></a>00104 
<a name="l00105"></a>00105 <span class="keywordtype">void</span> ResMan_Init(<a class="code" href="structResource.html" title="Hold context information for a resource such as an audio channel.">Resource</a> *res)
<a name="l00106"></a>00106 {
<a name="l00107"></a>00107     res-&gt;<a class="code" href="structResource.html#a41bc534479f14c1d40e9af2124f909ee" title="Pointer to current owner&#39;s observer. NULL if resource is free.">owner</a> = NULL;
<a name="l00108"></a>00108     res-&gt;<a class="code" href="structResource.html#a776512832e677c0af917d267fd16079c" title="Priority of current owner (higher values mean higher priority).">pri</a> = -1;
<a name="l00109"></a>00109 
<a name="l00110"></a>00110     <a class="code" href="group__kern__sem.html#ga4ab83c8e2d390203ae8772d2419f1514" title="Initialize a Semaphore structure.">sem_init</a>(&amp;res-&gt;<a class="code" href="structResource.html#a9d4e2322f86007d34fe8b88bc6f2fdf9" title="Control access to fields below.">lock</a>);
<a name="l00111"></a>00111     <a class="code" href="group__list.html#ga005c60e8bdd32530e0ccd2374ba3289b" title="Initialize a list.">LIST_INIT</a>(&amp;res-&gt;<a class="code" href="structResource.html#a6962c93bf9942c1f4149c96f88f961ee" title="Queue of processes waiting to obtain the resource.">queue</a>);
<a name="l00112"></a>00112 }
<a name="l00113"></a>00113 
</pre></div></div>
</div>


