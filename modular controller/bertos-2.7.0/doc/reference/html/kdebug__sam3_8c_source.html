

<!-- Generated by Doxygen 1.7.4 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="dir_9fd71c1ac00056e7d855336b2291c56c.html">bertos</a>      </li>
      <li class="navelem"><a class="el" href="dir_a5de7543e32a5f073daa04f8834eb5fd.html">cpu</a>      </li>
      <li class="navelem"><a class="el" href="dir_b85b1b77342b0233aa6bdb4655adc5e9.html">cortex-m3</a>      </li>
      <li class="navelem"><a class="el" href="dir_67d33e4ffe4ff938d746541f95b62a0f.html">drv</a>      </li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">kdebug_sam3.c</div>  </div>
</div>
<div class="contents">
<a href="kdebug__sam3_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 
<a name="l00038"></a>00038 <span class="preprocessor">#include &lt;<a class="code" href="cfg__debug_8h.html" title="Configuration file for Debug module.">cfg/cfg_debug.h</a>&gt;</span>
<a name="l00039"></a>00039 <span class="preprocessor">#include &lt;<a class="code" href="macros_8h.html">cfg/macros.h</a>&gt;</span> <span class="comment">/* for BV() */</span>
<a name="l00040"></a>00040 
<a name="l00041"></a>00041 <span class="preprocessor">#include &lt;<a class="code" href="types_8h.html" title="CPU-specific type definitions.">cpu/types.h</a>&gt;</span>
<a name="l00042"></a>00042 
<a name="l00043"></a>00043 <span class="preprocessor">#include &lt;<a class="code" href="sam3_8h.html">io/sam3.h</a>&gt;</span>
<a name="l00044"></a>00044 
<a name="l00045"></a>00045 
<a name="l00046"></a>00046 <span class="preprocessor">#if (CONFIG_KDEBUG_PORT == 0)</span>
<a name="l00047"></a>00047 <span class="preprocessor"></span><span class="preprocessor">    #define UART_BASE       UART0_BASE</span>
<a name="l00048"></a>00048 <span class="preprocessor"></span><span class="preprocessor">    #define UART_ID         UART0_ID</span>
<a name="l00049"></a>00049 <span class="preprocessor"></span><span class="preprocessor">    #define UART_PIO_BASE   UART0_PORT</span>
<a name="l00050"></a>00050 <span class="preprocessor"></span><span class="preprocessor">    #define UART_PERIPH     UART0_PERIPH</span>
<a name="l00051"></a>00051 <span class="preprocessor"></span><span class="preprocessor">    #define UART_PINS       (BV(URXD0) | BV(UTXD0))</span>
<a name="l00052"></a>00052 <span class="preprocessor"></span><span class="preprocessor">#elif (CONFIG_KDEBUG_PORT == 1) &amp;&amp; UART_PORTS &gt; 1</span>
<a name="l00053"></a>00053 <span class="preprocessor"></span><span class="preprocessor">    #define UART_BASE       UART1_BASE</span>
<a name="l00054"></a>00054 <span class="preprocessor"></span><span class="preprocessor">    #define UART_ID         UART1_ID</span>
<a name="l00055"></a>00055 <span class="preprocessor"></span><span class="preprocessor">    #define UART_PIO_BASE   UART1_PORT</span>
<a name="l00056"></a>00056 <span class="preprocessor"></span><span class="preprocessor">    #define UART_PERIPH     UART1_PERIPH</span>
<a name="l00057"></a>00057 <span class="preprocessor"></span><span class="preprocessor">    #define UART_PINS       (BV(URXD1) | BV(UTXD1))</span>
<a name="l00058"></a>00058 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l00059"></a>00059 <span class="preprocessor"></span><span class="preprocessor">    #error &quot;UART port not supported in this board&quot;</span>
<a name="l00060"></a>00060 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00061"></a>00061 <span class="preprocessor"></span>
<a name="l00062"></a>00062 <span class="comment">// TODO: refactor serial simple functions and use them, see lm3s kdebug</span>
<a name="l00063"></a>00063 <span class="preprocessor">#define KDBG_WAIT_READY()     while (!(HWREG(UART_BASE + UART_SR_OFF) &amp; BV(UART_SR_TXRDY))) {}</span>
<a name="l00064"></a>00064 <span class="preprocessor"></span><span class="preprocessor">#define KDBG_WAIT_TXDONE()    while (!(HWREG(UART_BASE + UART_SR_OFF) &amp; BV(UART_SR_TXEMPTY))) {}</span>
<a name="l00065"></a>00065 <span class="preprocessor"></span>
<a name="l00066"></a>00066 <span class="preprocessor">#define KDBG_WRITE_CHAR(c)    do { HWREG(UART_BASE + UART_THR_OFF) = (c); } while(0)</span>
<a name="l00067"></a>00067 <span class="preprocessor"></span>
<a name="l00068"></a>00068 <span class="comment">/* Debug unit is used only for debug purposes so does not generate interrupts. */</span>
<a name="l00069"></a>00069 <span class="preprocessor">#define KDBG_MASK_IRQ(old)    do { (void)old; } while(0)</span>
<a name="l00070"></a>00070 <span class="preprocessor"></span>
<a name="l00071"></a>00071 <span class="comment">/* Debug unit is used only for debug purposes so does not generate interrupts. */</span>
<a name="l00072"></a>00072 <span class="preprocessor">#define KDBG_RESTORE_IRQ(old) do { (void)old; } while(0)</span>
<a name="l00073"></a>00073 <span class="preprocessor"></span>
<a name="l00074"></a>00074 <span class="keyword">typedef</span> uint32_t kdbg_irqsave_t;
<a name="l00075"></a>00075 
<a name="l00076"></a>00076 
<a name="l00077"></a>00077 INLINE <span class="keywordtype">void</span> kdbg_hw_init(<span class="keywordtype">void</span>)
<a name="l00078"></a>00078 {
<a name="l00079"></a>00079     <span class="comment">/*</span>
<a name="l00080"></a>00080 <span class="comment">     * Disable PIO mode and set appropriate UART pins peripheral mode.</span>
<a name="l00081"></a>00081 <span class="comment">     * SAM3X,A,N,S,U: all of them has all UARTs on peripheral A.</span>
<a name="l00082"></a>00082 <span class="comment">     */</span>
<a name="l00083"></a>00083     <a class="code" href="types_8h.html#ac9660181819fceac0b5abcd67d76ca6e" title="Macros for hardware access, both direct and via the bit-band region.">HWREG</a>(UART_PIO_BASE + <a class="code" href="at91__pio_8h.html#a11253fa76c9b130382a24f18ac955fec" title="PIO disable register offset.">PIO_PDR_OFF</a>) = UART_PINS;
<a name="l00084"></a>00084     <a class="code" href="sam3__pio_8h.html#a6544370a96422be457b10327b960f393" title="Set peripheral on I/O ports.">PIO_PERIPH_SEL</a>(UART_PIO_BASE, UART_PINS, UART_PERIPH);
<a name="l00085"></a>00085 
<a name="l00086"></a>00086     <span class="comment">/* Enable the peripheral clock */</span>
<a name="l00087"></a>00087     <a class="code" href="sam3__pmc_8h.html#ab52e15eab47e357c27f86a5f8b0ba532" title="Enable a peripheral clock.">pmc_periphEnable</a>(UART_ID);
<a name="l00088"></a>00088 
<a name="l00089"></a>00089     <span class="comment">/* Reset and disable receiver &amp; transmitter */</span>
<a name="l00090"></a>00090     <a class="code" href="types_8h.html#ac9660181819fceac0b5abcd67d76ca6e" title="Macros for hardware access, both direct and via the bit-band region.">HWREG</a>(UART_BASE + <a class="code" href="sam3__uart_8h.html#afbdd5a1daa050d08e7b15869ecbcc231" title="UART registers base addresses.">UART_CR_OFF</a>) = <a class="code" href="group__macros.html#ga663d8c125655d41622b1e6bc96e5d63d" title="Convert a bit value to a binary flag.">BV</a>(<a class="code" href="sam3__uart_8h.html#ab2193c2bb327b5df1c99da7956a07031" title="UART register addresses.">UART_CR_RSTRX</a>) | <a class="code" href="group__macros.html#ga663d8c125655d41622b1e6bc96e5d63d" title="Convert a bit value to a binary flag.">BV</a>(<a class="code" href="sam3__uart_8h.html#adb048d2ffec0172e0845678f564a1b4a" title="UART register addresses.">UART_CR_RSTTX</a>) | <a class="code" href="group__macros.html#ga663d8c125655d41622b1e6bc96e5d63d" title="Convert a bit value to a binary flag.">BV</a>(<a class="code" href="sam3__uart_8h.html#a8fc6e9b08440c7c0c79312f16b66b5a8" title="UART register addresses.">UART_CR_RXDIS</a>) | <a class="code" href="group__macros.html#ga663d8c125655d41622b1e6bc96e5d63d" title="Convert a bit value to a binary flag.">BV</a>(<a class="code" href="sam3__uart_8h.html#ab822b68f656ad659006963366cd63ce1" title="UART register addresses.">UART_CR_TXDIS</a>);
<a name="l00091"></a>00091 
<a name="l00092"></a>00092     <span class="comment">/* Set mode: normal, no parity */</span>
<a name="l00093"></a>00093     <a class="code" href="types_8h.html#ac9660181819fceac0b5abcd67d76ca6e" title="Macros for hardware access, both direct and via the bit-band region.">HWREG</a>(UART_BASE + <a class="code" href="sam3__uart_8h.html#ae2b29c7d933a246dc1e544f10a69cdd5" title="UART registers base addresses.">UART_MR_OFF</a>) = <a class="code" href="sam3__uart_8h.html#af355d1f016ec0085bc24f4ad2b31bd30" title="Bit fields in the UART_MR register.">UART_MR_PAR_NO</a>;
<a name="l00094"></a>00094 
<a name="l00095"></a>00095     <span class="comment">/* Set baud rate */</span>
<a name="l00096"></a>00096     <a class="code" href="types_8h.html#ac9660181819fceac0b5abcd67d76ca6e" title="Macros for hardware access, both direct and via the bit-band region.">HWREG</a>(UART_BASE + <a class="code" href="sam3__uart_8h.html#a734867ae939391205590298c27eca0fd" title="UART registers base addresses.">UART_BRGR_OFF</a>) = CPU_FREQ / <a class="code" href="cfg__debug_8h.html#a3bcab381af1f88874c4dc3b26faa32a0" title="Baudrate for the debug console.">CONFIG_KDEBUG_BAUDRATE</a> / 16;
<a name="l00097"></a>00097 
<a name="l00098"></a>00098     <span class="comment">/* Enable receiver &amp; transmitter */</span>
<a name="l00099"></a>00099     <a class="code" href="types_8h.html#ac9660181819fceac0b5abcd67d76ca6e" title="Macros for hardware access, both direct and via the bit-band region.">HWREG</a>(UART_BASE + <a class="code" href="sam3__uart_8h.html#afbdd5a1daa050d08e7b15869ecbcc231" title="UART registers base addresses.">UART_CR_OFF</a>) = <a class="code" href="group__macros.html#ga663d8c125655d41622b1e6bc96e5d63d" title="Convert a bit value to a binary flag.">BV</a>(<a class="code" href="sam3__uart_8h.html#a5c00b17618413c54bda1d45350afb693" title="UART register addresses.">UART_CR_RXEN</a>) | <a class="code" href="group__macros.html#ga663d8c125655d41622b1e6bc96e5d63d" title="Convert a bit value to a binary flag.">BV</a>(<a class="code" href="sam3__uart_8h.html#a8a305762b980c740221e6ead8d8aee87" title="UART register addresses.">UART_CR_TXEN</a>);
<a name="l00100"></a>00100 }
</pre></div></div>
</div>


