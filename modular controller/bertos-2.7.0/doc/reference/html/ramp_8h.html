

<!-- Generated by Doxygen 1.7.4 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="dir_9fd71c1ac00056e7d855336b2291c56c.html">bertos</a>      </li>
      <li class="navelem"><a class="el" href="dir_7a1c32e0b61e66bba4924a9a48a40b57.html">algo</a>      </li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="summary">
<a href="#nested-classes">Data Structures</a> &#124;
<a href="#define-members">Defines</a> &#124;
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle">
<div class="title">ramp.h File Reference</div>  </div>
</div>
<div class="contents">

<p>Compute, save and load ramps for stepper motors.  
<a href="#details">More...</a></p>
<div class="textblock"><code>#include &quot;<a class="el" href="hw__stepper_8h_source.html">hw/hw_stepper.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="cfg__ramp_8h_source.html">cfg/cfg_ramp.h</a>&quot;</code><br/>
<code>#include &lt;<a class="el" href="compiler_8h_source.html">cfg/compiler.h</a>&gt;</code><br/>
</div>
<p><a href="ramp_8h_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr><td colspan="2"><h2><a name="nested-classes"></a>
Data Structures</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">struct &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="structRampPrecalc.html">RampPrecalc</a></td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Structure holding pre-calculated data for speeding up real-time evaluation of the ramp.  <a href="structRampPrecalc.html#details">More...</a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">struct &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="structRamp.html">Ramp</a></td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight"><a class="el" href="structRamp.html" title="Ramp structure.">Ramp</a> structure.  <a href="structRamp.html#details">More...</a><br/></td></tr>
<tr><td colspan="2"><h2><a name="define-members"></a>
Defines</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a42d42f0f46d83d44850674f55be3e21f"></a><!-- doxytag: member="ramp.h::TIME2CLOCKS" ref="a42d42f0f46d83d44850674f55be3e21f" args="(micros)" -->
#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="ramp_8h.html#a42d42f0f46d83d44850674f55be3e21f">TIME2CLOCKS</a>(micros)&#160;&#160;&#160;((uint32_t)(micros) * (STEPPER_CLOCK / 1000000))</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Convert microseconds to timer clock ticks. <br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a5f696630d96c1fc408ced59ce597510b"></a><!-- doxytag: member="ramp.h::CLOCKS2TIME" ref="a5f696630d96c1fc408ced59ce597510b" args="(clocks)" -->
#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="ramp_8h.html#a5f696630d96c1fc408ced59ce597510b">CLOCKS2TIME</a>(clocks)&#160;&#160;&#160;((uint32_t)(clocks) / (STEPPER_CLOCK / 1000000))</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Convert timer clock ticks back to microseconds. <br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="ae3028562cf5a55a7f29687d562e83d58"></a><!-- doxytag: member="ramp.h::MICROS2FREQ" ref="ae3028562cf5a55a7f29687d562e83d58" args="(micros)" -->
#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="ramp_8h.html#ae3028562cf5a55a7f29687d562e83d58">MICROS2FREQ</a>(micros)&#160;&#160;&#160;(1000000UL / ((uint32_t)(micros)))</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Convert microseconds to Hz. <br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="ae38ff71cbe498aa6b8f95375695163c3"></a><!-- doxytag: member="ramp.h::FREQ2MICROS" ref="ae38ff71cbe498aa6b8f95375695163c3" args="(hz)" -->
#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="ramp_8h.html#ae38ff71cbe498aa6b8f95375695163c3">FREQ2MICROS</a>(hz)&#160;&#160;&#160;(1000000UL / ((uint32_t)(hz)))</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Convert frequency (in Hz) to time (in microseconds) <br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="ab753a6c52129601b59bf013fb07dfb67"></a><!-- doxytag: member="ramp.h::FIX_MULT32" ref="ab753a6c52129601b59bf013fb07dfb67" args="(a, b)" -->
#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="ramp_8h.html#ab753a6c52129601b59bf013fb07dfb67">FIX_MULT32</a>(a, b)&#160;&#160;&#160;(((uint64_t)(a)*(uint32_t)(b)) &gt;&gt; 16)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Multiply <code>a</code> and <code>b</code> two integer at 32 bit and extract the high 16 bit word. <br/></td></tr>
<tr><td colspan="2"><h2><a name="func-members"></a>
Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="ramp_8h.html#ad3a92eef6fab7683cfd82a8f3812f5e4">ramp_setup</a> (struct <a class="el" href="structRamp.html">Ramp</a> *ramp, uint32_t length, uint32_t minFreq, uint32_t maxFreq)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Setup an acceleration ramp for a stepper motor.  <a href="#ad3a92eef6fab7683cfd82a8f3812f5e4"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a8aa35cc1f9521284603dcce38911197a"></a><!-- doxytag: member="ramp.h::ramp_default" ref="a8aa35cc1f9521284603dcce38911197a" args="(struct Ramp *ramp)" -->
void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="ramp_8h.html#a8aa35cc1f9521284603dcce38911197a">ramp_default</a> (struct <a class="el" href="structRamp.html">Ramp</a> *ramp)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Initialize a new ramp with default values. <br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">uint16_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="ramp_8h.html#a5356088b652b01368f89582574abe4a8">ramp_evaluate</a> (const struct <a class="el" href="structRamp.html">Ramp</a> *ramp, uint32_t curClock)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Evaluate the ramp at the given point.  <a href="#a5356088b652b01368f89582574abe4a8"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a2475a7e41e58e412f37d24974b24ad70"></a><!-- doxytag: member="ramp.h::ramp_testSetup" ref="a2475a7e41e58e412f37d24974b24ad70" args="(void)" -->
int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="ramp_8h.html#a2475a7e41e58e412f37d24974b24ad70">ramp_testSetup</a> (void)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Self test. <br/></td></tr>
</table>
<hr/><a name="details" id="details"></a><h2>Detailed Description</h2>
<div class="textblock"><p>Compute, save and load ramps for stepper motors. </p>
<p>The acceleration ramp is used to properly accelerate a stepper motor. The main entry point is the function <a class="el" href="ramp_8c.html#abb2bb4ceeaebfaeac46cf852d7ac253a" title="Evaluate the ramp at the given point.">ramp_evaluate()</a>, which must be called at every step of the motor: it gets as input the time elapsed since the stepper started accelerating, and returns the time to wait before sending the next step. A pseudo usage pattern is as follows:</p>
<pre>
  float time = 0;
  while (1)
  {
      float delta = ramp_evaluate(&amp;my_ramp, time);
      sleep(delta);
      do_motor_step();
      time += delta;
  }
 </pre><p>A similar pattern can be used to decelerate (it is sufficient to move the total time backward, such as "time -= delta").</p>
<p>The ramp can be configured with <a class="el" href="ramp_8c.html#ad3a92eef6fab7683cfd82a8f3812f5e4" title="Setup an acceleration ramp for a stepper motor.">ramp_setup()</a>, providing it with the minimum and maximum operating frequency of the motor, and the total acceleration time in milliseconds (that is, the time that will be needed to accelerate from the minimum frequency to the maximum frequency).</p>
<p>Both a very precise floating point and a very fast fixed point implementation of the ramp evaluation are provided. The fixed point is hand-optimized assembly for DSP56000 (but a portable C version of it can be easily written, see the comments in the code).</p>
<dl class="author"><dt><b>Author:</b></dt><dd>Simone Zinanni &lt;<a href="mailto:s.zinanni@develer.com">s.zinanni@develer.com</a>&gt; </dd>
<dd>
Giovanni Bajo &lt;<a href="mailto:rasky@develer.com">rasky@develer.com</a>&gt; </dd>
<dd>
Daniele Basile &lt;<a href="mailto:asterix@develer.com">asterix@develer.com</a>&gt; </dd></dl>

<p>Definition in file <a class="el" href="ramp_8h_source.html">ramp.h</a>.</p>
</div><hr/><h2>Function Documentation</h2>
<a class="anchor" id="a5356088b652b01368f89582574abe4a8"></a><!-- doxytag: member="ramp.h::ramp_evaluate" ref="a5356088b652b01368f89582574abe4a8" args="(const struct Ramp *ramp, uint32_t curClock)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">uint16_t ramp_evaluate </td>
          <td>(</td>
          <td class="paramtype">const struct <a class="el" href="structRamp.html">Ramp</a> *&#160;</td>
          <td class="paramname"><em>ramp</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint32_t&#160;</td>
          <td class="paramname"><em>curClock</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Evaluate the ramp at the given point. </p>
<p>Given a <em>ramp</em>, and the current <em>clock</em> since the start of the acceleration, compute the next step, that is the interval at which send the signal to the motor.</p>
<dl class="note"><dt><b>Note:</b></dt><dd>The fixed point version does not work when curClock is zero. Anyway, the first step is always clocksMaxWL, as stored within the ramp structure. </dd></dl>

<p>Definition at line <a class="el" href="ramp_8c_source.html#l00189">189</a> of file <a class="el" href="ramp_8c_source.html">ramp.c</a>.</p>

</div>
</div>
<a class="anchor" id="ad3a92eef6fab7683cfd82a8f3812f5e4"></a><!-- doxytag: member="ramp.h::ramp_setup" ref="ad3a92eef6fab7683cfd82a8f3812f5e4" args="(struct Ramp *ramp, uint32_t length, uint32_t minFreq, uint32_t maxFreq)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void ramp_setup </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structRamp.html">Ramp</a> *&#160;</td>
          <td class="paramname"><em>ramp</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint32_t&#160;</td>
          <td class="paramname"><em>length</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint32_t&#160;</td>
          <td class="paramname"><em>minFreq</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint32_t&#160;</td>
          <td class="paramname"><em>maxFreq</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Setup an acceleration ramp for a stepper motor. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table class="params">
    <tr><td class="paramname">ramp</td><td><a class="el" href="structRamp.html" title="Ramp structure.">Ramp</a> to fill </td></tr>
    <tr><td class="paramname">length</td><td>Length of the ramp (milliseconds) </td></tr>
    <tr><td class="paramname">minFreq</td><td>Minimum operating frequency of the motor (hertz) </td></tr>
    <tr><td class="paramname">maxFreq</td><td>Maximum operating frequency of the motor (hertz) </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="ramp_8c_source.html#l00139">139</a> of file <a class="el" href="ramp_8c_source.html">ramp.c</a>.</p>

</div>
</div>
</div>


