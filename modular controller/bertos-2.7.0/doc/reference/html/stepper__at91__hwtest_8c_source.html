

<!-- Generated by Doxygen 1.7.4 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="dir_9fd71c1ac00056e7d855336b2291c56c.html">bertos</a>      </li>
      <li class="navelem"><a class="el" href="dir_a5de7543e32a5f073daa04f8834eb5fd.html">cpu</a>      </li>
      <li class="navelem"><a class="el" href="dir_3ade2df878d06c00b7da75ebdc1e74f5.html">arm</a>      </li>
      <li class="navelem"><a class="el" href="dir_88b011769bd68bcbdcfc8a5f3d937253.html">drv</a>      </li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">stepper_at91_hwtest.c</div>  </div>
</div>
<div class="contents">
<a href="stepper__at91__hwtest_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 
<a name="l00039"></a>00039 <span class="preprocessor">#include &quot;<a class="code" href="stepper__at91_8h.html" title="Stepper hardware-specific definitions.">stepper_at91.h</a>&quot;</span>
<a name="l00040"></a>00040 
<a name="l00041"></a>00041 <span class="preprocessor">#include &quot;<a class="code" href="cfg__stepper_8h.html" title="Configuration file for stepper motor module.">cfg/cfg_stepper.h</a>&quot;</span>
<a name="l00042"></a>00042 <span class="preprocessor">#include &lt;<a class="code" href="macros_8h.html">cfg/macros.h</a>&gt;</span>
<a name="l00043"></a>00043 <span class="preprocessor">#include &lt;<a class="code" href="debug_8h.html">cfg/debug.h</a>&gt;</span>
<a name="l00044"></a>00044 
<a name="l00045"></a>00045 <span class="preprocessor">#include &lt;<a class="code" href="types_8h.html" title="CPU-specific type definitions.">cpu/types.h</a>&gt;</span>
<a name="l00046"></a>00046 <span class="preprocessor">#include &lt;<a class="code" href="cpu_2irq_8h.html" title="CPU-specific IRQ definitions.">cpu/irq.h</a>&gt;</span>
<a name="l00047"></a>00047 
<a name="l00048"></a>00048 <span class="preprocessor">#include &lt;<a class="code" href="arm_8h.html">io/arm.h</a>&gt;</span>
<a name="l00049"></a>00049 
<a name="l00050"></a>00050 
<a name="l00051"></a>00051 <span class="preprocessor">#warning FIXME:This test is incomplete.. you MUST review..</span>
<a name="l00052"></a>00052 <span class="preprocessor"></span>
<a name="l00053"></a>00053 <span class="preprocessor">#if 0</span>
<a name="l00054"></a>00054 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">void</span> stepper_test_irq_schedule(<span class="keyword">struct</span> <a class="code" href="structStepper.html" title="Motor context structure.">Stepper</a> *motor, stepper_time_t delay)
<a name="l00055"></a>00055 {
<a name="l00056"></a>00056     <a class="code" href="stepper__at91_8h.html#a7cdf19802f5271aa899be78df2a540d8" title="Programm timer counter to generate a pulse on select TIO output.">stepper_tc_doPulse</a>(motor-&gt;<a class="code" href="structStepper.html#ab25891ff82308c33b08fd157c76e96b8" title="HW timer bound to this motor.">timer</a>);
<a name="l00057"></a>00057     <a class="code" href="stepper__at91_8h.html#a26d8a0aa285a29dc3d8fabdcf6f292d9" title="Set delay for next interrupt compare event.">stepper_tc_setDelay</a>(motor-&gt;<a class="code" href="structStepper.html#ab25891ff82308c33b08fd157c76e96b8" title="HW timer bound to this motor.">timer</a>, delay);
<a name="l00058"></a>00058 }
<a name="l00059"></a>00059 
<a name="l00060"></a>00060 <span class="keyword">static</span> <span class="keywordtype">void</span> stepper_test_irq(<span class="keyword">struct</span> <a class="code" href="structStepper.html" title="Motor context structure.">Stepper</a> *motor)
<a name="l00061"></a>00061 {
<a name="l00062"></a>00062 
<a name="l00063"></a>00063     stepper_test_irq_schedule(motor, 300);
<a name="l00064"></a>00064 }
<a name="l00065"></a>00065 <span class="comment">/*</span>
<a name="l00066"></a>00066 <span class="comment"> * Test a timer couter driver</span>
<a name="l00067"></a>00067 <span class="comment"> */</span>
<a name="l00068"></a>00068 <span class="keywordtype">void</span> stepper_timer_test_prestepper(<span class="keyword">struct</span> <a class="code" href="structStepper.html" title="Motor context structure.">Stepper</a> *local_motor, <span class="keyword">struct</span> <a class="code" href="structStepperConfig.html" title="Stepper configuration.">StepperConfig</a> *local_cfg, <span class="keywordtype">int</span> <a class="code" href="structStepper.html#acfddd8d030494e0b3faa5d1b9968df21" title="Index of the motor.">index</a>)
<a name="l00069"></a>00069 {
<a name="l00070"></a>00070     local_cfg-&gt;<a class="code" href="structStepperConfig.html#abe8154e81559d8392380d2bde609a146" title="(clocks) Length of the clock pulse used to drive the motor">pulse</a> = 300;
<a name="l00071"></a>00071 
<a name="l00072"></a>00072     local_motor-&gt;<a class="code" href="structStepper.html#a9e2e8431a32420d054b70f440eff7ccf" title="Configuration of this stepper.">cfg</a> = local_cfg;
<a name="l00073"></a>00073     <a class="code" href="stepper__at91_8c.html#ac7283f5e3fd3758df32d2c894832f571" title="Timer counter init.">stepper_tc_init</a>(index, &amp;stepper_test_irq, local_motor);
<a name="l00074"></a>00074     <a class="code" href="stepper__at91_8h.html#a67ca7375cbe1fc64231f636114a8f051" title="Enable interrupt for timer counter compare event.">stepper_tc_irq_enable</a>(local_motor-&gt;<a class="code" href="structStepper.html#ab25891ff82308c33b08fd157c76e96b8" title="HW timer bound to this motor.">timer</a>);
<a name="l00075"></a>00075 }
<a name="l00076"></a>00076 
<a name="l00077"></a>00077 
<a name="l00078"></a>00078 <span class="keywordtype">bool</span> su = <span class="keyword">true</span>;
<a name="l00079"></a>00079 <span class="keywordtype">bool</span> sub = <span class="keyword">true</span>;
<a name="l00080"></a>00080 uint16_t periodo_st0 = 100;
<a name="l00081"></a>00081 uint16_t periodo_st1 = 233;
<a name="l00082"></a>00082 
<a name="l00083"></a>00083 <span class="keyword">static</span> <span class="keywordtype">void</span> tc_irq(<span class="keywordtype">void</span>) __attribute__ ((interrupt));
<a name="l00084"></a>00084 static <span class="keywordtype">void</span> tc_irq(<span class="keywordtype">void</span>)
<a name="l00085"></a>00085 {
<a name="l00086"></a>00086     uint32_t status_reg = <a class="code" href="at91__tc_8h.html#ae0bbdbd2f1cccfd0a6a23e6cfbb39c2b" title="Status register address.">TC2_SR</a> &amp; <a class="code" href="at91__tc_8h.html#a59fb84894981440289cb971a3113cf64" title="Channel 2 interrupt mask register address.">TC2_IMR</a>;
<a name="l00087"></a>00087 
<a name="l00088"></a>00088     <span class="keywordflow">if</span> (status_reg &amp; <a class="code" href="group__macros.html#ga663d8c125655d41622b1e6bc96e5d63d" title="Convert a bit value to a binary flag.">BV</a>(<a class="code" href="at91__tc_8h.html#a44370952dcc2973fdccbe58e4d08f756" title="RA compare flag.">TC_CPAS</a>))
<a name="l00089"></a>00089     {
<a name="l00090"></a>00090         <a class="code" href="at91__tc_8h.html#a681e8a768f7e5f653f1ec977ece0d9d2" title="Channel 2 mode register address.">TC2_CMR</a> &amp;= ~<a class="code" href="at91__tc_8h.html#aacd71db054b2160f82ecc808de07e65c" title="Masks RA compare effect on TIOA.">TC_ACPA_MASK</a>;
<a name="l00091"></a>00091         <span class="keywordflow">if</span> (su)
<a name="l00092"></a>00092         {
<a name="l00093"></a>00093             <a class="code" href="at91__tc_8h.html#a681e8a768f7e5f653f1ec977ece0d9d2" title="Channel 2 mode register address.">TC2_CMR</a> |= <a class="code" href="at91__tc_8h.html#a9ad68f250d389d72c285bd7dfb1019b4" title="RA compare clears TIOA.">TC_ACPA_CLEAR_OUTPUT</a>;
<a name="l00094"></a>00094             <a class="code" href="at91__tc_8h.html#ac07909cdb0848d29daa1c25c046e41a0" title="Channel 2 register A.">TC2_RA</a> += periodo_st0;
<a name="l00095"></a>00095         }
<a name="l00096"></a>00096         <span class="keywordflow">else</span>
<a name="l00097"></a>00097         {
<a name="l00098"></a>00098             <a class="code" href="at91__tc_8h.html#a681e8a768f7e5f653f1ec977ece0d9d2" title="Channel 2 mode register address.">TC2_CMR</a> |= <a class="code" href="at91__tc_8h.html#a6ab34dfcaa2463c8ed389d3eeaf3e052" title="RA compare sets TIOA.">TC_ACPA_SET_OUTPUT</a>;
<a name="l00099"></a>00099             <a class="code" href="at91__tc_8h.html#ac07909cdb0848d29daa1c25c046e41a0" title="Channel 2 register A.">TC2_RA</a> += periodo_st1;
<a name="l00100"></a>00100         }
<a name="l00101"></a>00101         su = !su;
<a name="l00102"></a>00102     }
<a name="l00103"></a>00103     <span class="keywordflow">if</span> (status_reg &amp; <a class="code" href="group__macros.html#ga663d8c125655d41622b1e6bc96e5d63d" title="Convert a bit value to a binary flag.">BV</a>(<a class="code" href="at91__tc_8h.html#a43e64a88e17afe352aa631d635c576bc" title="RB compare flag.">TC_CPBS</a>))
<a name="l00104"></a>00104     {
<a name="l00105"></a>00105         <a class="code" href="at91__tc_8h.html#a681e8a768f7e5f653f1ec977ece0d9d2" title="Channel 2 mode register address.">TC2_CMR</a> &amp;= ~<a class="code" href="at91__tc_8h.html#a5e32c41bf2e5570ccb45fbce1aa9d563" title="Masks RB compare effect on TIOB.">TC_BCPB_MASK</a> ;
<a name="l00106"></a>00106         <span class="keywordflow">if</span> (sub)
<a name="l00107"></a>00107         {
<a name="l00108"></a>00108             <a class="code" href="at91__tc_8h.html#a681e8a768f7e5f653f1ec977ece0d9d2" title="Channel 2 mode register address.">TC2_CMR</a> |= <a class="code" href="at91__tc_8h.html#a49369f4ae22ef83ddc1676eb3622e097" title="RB compare clears TIOB.">TC_BCPB_CLEAR_OUTPUT</a>;
<a name="l00109"></a>00109             <a class="code" href="at91__tc_8h.html#a09aad00548e63a9b2ab6889f1d3e5b68" title="Channel 2 register B.">TC2_RB</a> += periodo_st0;
<a name="l00110"></a>00110         }
<a name="l00111"></a>00111         <span class="keywordflow">else</span>
<a name="l00112"></a>00112         {
<a name="l00113"></a>00113             <a class="code" href="at91__tc_8h.html#a681e8a768f7e5f653f1ec977ece0d9d2" title="Channel 2 mode register address.">TC2_CMR</a> |= <a class="code" href="at91__tc_8h.html#abd30aee9d4b9f97b4e84c7fe6bfcdd17" title="RB compare sets TIOB.">TC_BCPB_SET_OUTPUT</a>;
<a name="l00114"></a>00114             <a class="code" href="at91__tc_8h.html#a09aad00548e63a9b2ab6889f1d3e5b68" title="Channel 2 register B.">TC2_RB</a> += periodo_st1;
<a name="l00115"></a>00115         }
<a name="l00116"></a>00116         sub = !sub;
<a name="l00117"></a>00117     }
<a name="l00118"></a>00118     <span class="comment">/* Inform hw that we have served the IRQ */</span>
<a name="l00119"></a>00119     <a class="code" href="at91__aic_8h.html#aa2e41fc2a881cdeab65a204875cad3e7" title="End of interrupt command register address.">AIC_EOICR</a> = 0;
<a name="l00120"></a>00120 }
<a name="l00121"></a>00121 
<a name="l00122"></a>00122 <span class="comment">/*</span>
<a name="l00123"></a>00123 <span class="comment"> * Test a timer couter hardware</span>
<a name="l00124"></a>00124 <span class="comment"> */</span>
<a name="l00125"></a>00125 <span class="keywordtype">void</span> stepper_timer_test_brute(<span class="keywordtype">void</span>)
<a name="l00126"></a>00126 {
<a name="l00127"></a>00127     <a class="code" href="sam3__pio_8h.html#a5f995a869c97e633de77b4a8576c7ab4" title="PIO disable register address.">PIOA_PDR</a> |= <a class="code" href="group__macros.html#ga663d8c125655d41622b1e6bc96e5d63d" title="Convert a bit value to a binary flag.">BV</a>(26) | <a class="code" href="group__macros.html#ga663d8c125655d41622b1e6bc96e5d63d" title="Convert a bit value to a binary flag.">BV</a>(27);
<a name="l00128"></a>00128     PIOA_BSR |= <a class="code" href="group__macros.html#ga663d8c125655d41622b1e6bc96e5d63d" title="Convert a bit value to a binary flag.">BV</a>(26) | <a class="code" href="group__macros.html#ga663d8c125655d41622b1e6bc96e5d63d" title="Convert a bit value to a binary flag.">BV</a>(27);
<a name="l00129"></a>00129 
<a name="l00130"></a>00130     <span class="comment">// Power on TCLK0</span>
<a name="l00131"></a>00131     <a class="code" href="at91__pmc_8h.html#a17654b41c5f9f88c153bad07eaaf9afc" title="Peripheral clock enable register address.">PMC_PCER</a> |= <a class="code" href="group__macros.html#ga663d8c125655d41622b1e6bc96e5d63d" title="Convert a bit value to a binary flag.">BV</a>(TC2_ID);<span class="comment">// | BV(TC1_ID) | BV(TC2_ID);</span>
<a name="l00132"></a>00132 
<a name="l00133"></a>00133     <a class="code" href="at91__tc_8h.html#a4a443c52fa0df0726b0c25205ea856e1" title="Block control register address.">TC_BCR</a> = 1;
<a name="l00134"></a>00134     <a class="code" href="at91__tc_8h.html#a5df5c858a1d6a5e79f8ee194de365e12" title="Block mode register address.">TC_BMR</a> |= <a class="code" href="at91__tc_8h.html#a2d2acab73e23162346025c625f7a49ac" title="None selected.">TC_NONEXC2</a>;
<a name="l00135"></a>00135 
<a name="l00136"></a>00136     <span class="comment">// Select waveform mode</span>
<a name="l00137"></a>00137     <a class="code" href="at91__tc_8h.html#a681e8a768f7e5f653f1ec977ece0d9d2" title="Channel 2 mode register address.">TC2_CMR</a> = <a class="code" href="group__macros.html#ga663d8c125655d41622b1e6bc96e5d63d" title="Convert a bit value to a binary flag.">BV</a>(<a class="code" href="at91__tc_8h.html#ab25fc25035091fc7a07bdd50485ca2b4" title="Selects waveform mode.">TC_WAVE</a>);
<a name="l00138"></a>00138 
<a name="l00139"></a>00139     <a class="code" href="at91__tc_8h.html#a681e8a768f7e5f653f1ec977ece0d9d2" title="Channel 2 mode register address.">TC2_CMR</a> |= <a class="code" href="at91__tc_8h.html#a821482af6b9edc7269dfdff98d2f1a27" title="XC2 selected as external event.">TC_EEVT_XC2</a>;
<a name="l00140"></a>00140     <a class="code" href="at91__tc_8h.html#a681e8a768f7e5f653f1ec977ece0d9d2" title="Channel 2 mode register address.">TC2_CMR</a> |= <a class="code" href="at91__tc_8h.html#a766c48ad563c3047397e258cd01aee1a" title="UP mode whitout automatic trigger on RC compare.">TC_WAVSEL_UP</a>;
<a name="l00141"></a>00141     <a class="code" href="at91__tc_8h.html#a681e8a768f7e5f653f1ec977ece0d9d2" title="Channel 2 mode register address.">TC2_CMR</a> |= <a class="code" href="at91__tc_8h.html#abbf6a3c1652968c7c86b2d20c7412b4f" title="Selects MCK / 8.">TC_CLKS_MCK8</a>;
<a name="l00142"></a>00142 
<a name="l00143"></a>00143     <span class="comment">//Set waveform on TIOA and TIOB</span>
<a name="l00144"></a>00144     <a class="code" href="at91__tc_8h.html#a681e8a768f7e5f653f1ec977ece0d9d2" title="Channel 2 mode register address.">TC2_CMR</a> |= <a class="code" href="at91__tc_8h.html#a6ab34dfcaa2463c8ed389d3eeaf3e052" title="RA compare sets TIOA.">TC_ACPA_SET_OUTPUT</a>;
<a name="l00145"></a>00145     <a class="code" href="at91__tc_8h.html#a681e8a768f7e5f653f1ec977ece0d9d2" title="Channel 2 mode register address.">TC2_CMR</a> |= <a class="code" href="at91__tc_8h.html#abd30aee9d4b9f97b4e84c7fe6bfcdd17" title="RB compare sets TIOB.">TC_BCPB_SET_OUTPUT</a>;
<a name="l00146"></a>00146 
<a name="l00147"></a>00147 
<a name="l00148"></a>00148     <span class="comment">//Reset all comp_reg register</span>
<a name="l00149"></a>00149     <a class="code" href="at91__tc_8h.html#ac07909cdb0848d29daa1c25c046e41a0" title="Channel 2 register A.">TC2_RA</a> = 0;
<a name="l00150"></a>00150     <a class="code" href="at91__tc_8h.html#a09aad00548e63a9b2ab6889f1d3e5b68" title="Channel 2 register B.">TC2_RB</a> = 0;
<a name="l00151"></a>00151 
<a name="l00152"></a>00152     cpuflags_t flags;
<a name="l00153"></a>00153     IRQ_SAVE_DISABLE(flags);
<a name="l00154"></a>00154 
<a name="l00155"></a>00155     <span class="comment">/* Set the vector. */</span>
<a name="l00156"></a>00156     <a class="code" href="at91__aic_8h.html#addd72d70adf6f3093b99bc2ad3a0f2a2" title="Interrupt Source Vector Registers.">AIC_SVR</a>(TC2_ID) = tc_irq;
<a name="l00157"></a>00157     <span class="comment">/* Initialize to edge triggered with defined priority. */</span>
<a name="l00158"></a>00158     <a class="code" href="at91__aic_8h.html#aeb7a154ccc076c9a13fab657c32ee891" title="Source mode register array.">AIC_SMR</a>(TC2_ID) = <a class="code" href="at91__aic_8h.html#a2d91ee1adc1ef33a042d6d022e980fb8" title="Internal edge triggered.">AIC_SRCTYPE_INT_EDGE_TRIGGERED</a>;
<a name="l00159"></a>00159     <span class="comment">/* Enable the USART IRQ */</span>
<a name="l00160"></a>00160     <a class="code" href="at91__aic_8h.html#a45352b181aa207c667ae1a30c878044f" title="Interrupt enable command register address.">AIC_IECR</a> = <a class="code" href="group__macros.html#ga663d8c125655d41622b1e6bc96e5d63d" title="Convert a bit value to a binary flag.">BV</a>(TC2_ID);
<a name="l00161"></a>00161 
<a name="l00162"></a>00162     IRQ_RESTORE(flags);
<a name="l00163"></a>00163 
<a name="l00164"></a>00164     <span class="comment">// Disable all interrupt</span>
<a name="l00165"></a>00165     <a class="code" href="at91__tc_8h.html#a911aeca9cc239b954aa5c3f2ab100c06" title="Channel 2 interrupt disable register address.">TC2_IDR</a> = 0xFFFFFFFF;
<a name="l00166"></a>00166 
<a name="l00167"></a>00167     <span class="comment">//Enable interrupt on RA, RB</span>
<a name="l00168"></a>00168     <a class="code" href="at91__tc_8h.html#a421fb19b947ab50cb578c43043e2a95e" title="Channel 2 interrupt enable register address.">TC2_IER</a> = <a class="code" href="group__macros.html#ga663d8c125655d41622b1e6bc96e5d63d" title="Convert a bit value to a binary flag.">BV</a>(<a class="code" href="at91__tc_8h.html#a44370952dcc2973fdccbe58e4d08f756" title="RA compare flag.">TC_CPAS</a>) | <a class="code" href="group__macros.html#ga663d8c125655d41622b1e6bc96e5d63d" title="Convert a bit value to a binary flag.">BV</a>(<a class="code" href="at91__tc_8h.html#a43e64a88e17afe352aa631d635c576bc" title="RB compare flag.">TC_CPBS</a>);
<a name="l00169"></a>00169 
<a name="l00170"></a>00170     <span class="comment">//Enable timer and trig it</span>
<a name="l00171"></a>00171     <a class="code" href="at91__tc_8h.html#a8815563e4922ca09713e4409a762908b" title="Channel 2 control register address.">TC2_CCR</a> = <a class="code" href="group__macros.html#ga663d8c125655d41622b1e6bc96e5d63d" title="Convert a bit value to a binary flag.">BV</a>(<a class="code" href="at91__tc_8h.html#a528d19caa388df147ca8fae91be193d5" title="Clock enable command.">TC_CLKEN</a>) | <a class="code" href="group__macros.html#ga663d8c125655d41622b1e6bc96e5d63d" title="Convert a bit value to a binary flag.">BV</a>(<a class="code" href="at91__tc_8h.html#afcebd8f6e7bef145922d447059a1554b" title="Software trigger command.">TC_SWTRG</a>);
<a name="l00172"></a>00172 }
<a name="l00173"></a>00173 <span class="preprocessor">#endif</span>
<a name="l00174"></a>00174 <span class="preprocessor"></span>
</pre></div></div>
</div>


