

<!-- Generated by Doxygen 1.7.4 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="dir_9fd71c1ac00056e7d855336b2291c56c.html">bertos</a>      </li>
      <li class="navelem"><a class="el" href="dir_e91c80130e425b11d52da5b92a7aa933.html">net</a>      </li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">pocketbus.c</div>  </div>
</div>
<div class="contents">
<a href="pocketbus_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 
<a name="l00079"></a>00079 <span class="preprocessor">#include &quot;<a class="code" href="pocketbus_8h.html" title="Basical functions to use pocketBus protocol.">pocketbus.h</a>&quot;</span>
<a name="l00080"></a>00080 
<a name="l00081"></a>00081 <span class="preprocessor">#include &quot;<a class="code" href="cfg__pocketbus_8h.html" title="Configuration file for pocketbus module.">cfg/cfg_pocketbus.h</a>&quot;</span>
<a name="l00082"></a>00082 
<a name="l00083"></a>00083 <span class="comment">// Define logging setting (for cfg/log.h module).</span>
<a name="l00084"></a>00084 <span class="preprocessor">#define LOG_LEVEL         POCKETBUS_LOG_LEVEL</span>
<a name="l00085"></a>00085 <span class="preprocessor"></span><span class="preprocessor">#define LOG_VERBOSITY     POCKETBUS_LOG_FORMAT</span>
<a name="l00086"></a>00086 <span class="preprocessor"></span><span class="preprocessor">#include &lt;<a class="code" href="log_8h.html">cfg/log.h</a>&gt;</span>
<a name="l00087"></a>00087 <span class="preprocessor">#include &lt;<a class="code" href="debug_8h.html">cfg/debug.h</a>&gt;</span>
<a name="l00088"></a>00088 <span class="preprocessor">#include &lt;<a class="code" href="macros_8h.html">cfg/macros.h</a>&gt;</span>
<a name="l00089"></a>00089 
<a name="l00090"></a>00090 <span class="preprocessor">#include &lt;<a class="code" href="io_2kfile_8h.html">io/kfile.h</a>&gt;</span>
<a name="l00091"></a>00091 
<a name="l00092"></a>00092 <span class="preprocessor">#include &lt;<a class="code" href="cpu_2byteorder_8h.html" title="Functions to convert integers to/from host byte-order.">cpu/byteorder.h</a>&gt;</span>
<a name="l00093"></a>00093 
<a name="l00094"></a>00094 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00095"></a>00095 
<a name="l00099"></a><a class="code" href="pocketbus_8h.html#ae6a9a07114695dc497be7a9d19dfc153">00099</a> <span class="keywordtype">void</span> <a class="code" href="pocketbus_8c.html#ae6a9a07114695dc497be7a9d19dfc153" title="Send a character over pocketBus channel stream, handling escape mode.">pocketbus_putchar</a>(<span class="keyword">struct</span> <a class="code" href="structPocketBusCtx.html" title="pocketBus context structure.">PocketBusCtx</a> *ctx, uint8_t c)
<a name="l00100"></a>00100 {
<a name="l00101"></a>00101     <span class="comment">/* Update checksum */</span>
<a name="l00102"></a>00102     <a class="code" href="rotating__hash_8h.html#a2c7a3397cd5e62f5a54c612e7e98822c" title="Update checksum pointed by rot with c data.">rotating_update1</a>(c, &amp;ctx-&gt;<a class="code" href="structPocketBusCtx.html#ac0514ebcce95b0d22bd8551196cd4c5f" title="Checksum computation for transmitted data.">out_cks</a>);
<a name="l00103"></a>00103 
<a name="l00104"></a>00104     <span class="comment">/* Escape characters with special meaning */</span>
<a name="l00105"></a>00105     <span class="keywordflow">if</span> (c == <a class="code" href="pocketbus_8h.html#ae8d63dbc87418d7ab43cc2164f4c5e9c" title="pocketBus special characters definitions.">POCKETBUS_ESC</a> || c == <a class="code" href="pocketbus_8h.html#a2f2189c4c3d45ced8701224d970013c2" title="pocketBus special characters definitions.">POCKETBUS_STX</a> || c == <a class="code" href="pocketbus_8h.html#aec6c2bc5f1440007c1d459972fed5a3e" title="pocketBus special characters definitions.">POCKETBUS_ETX</a>)
<a name="l00106"></a>00106         <a class="code" href="group__io__kfile.html#ga480c14426dc77cdfd786c3b5b9a9adf2" title="Generic putc() implementation using fd-&gt;write.">kfile_putc</a>(<a class="code" href="pocketbus_8h.html#ae8d63dbc87418d7ab43cc2164f4c5e9c" title="pocketBus special characters definitions.">POCKETBUS_ESC</a>, ctx-&gt;<a class="code" href="structPocketBusCtx.html#abf9becd84a17b6e96966922b4af7093a" title="File descriptor.">fd</a>);
<a name="l00107"></a>00107 
<a name="l00108"></a>00108     <a class="code" href="group__io__kfile.html#ga480c14426dc77cdfd786c3b5b9a9adf2" title="Generic putc() implementation using fd-&gt;write.">kfile_putc</a>(c, ctx-&gt;<a class="code" href="structPocketBusCtx.html#abf9becd84a17b6e96966922b4af7093a" title="File descriptor.">fd</a>);
<a name="l00109"></a>00109 }
<a name="l00110"></a>00110 
<a name="l00114"></a><a class="code" href="pocketbus_8h.html#a9e64fea54236836ebbb111188a386213">00114</a> <span class="keywordtype">void</span> <a class="code" href="pocketbus_8c.html#a9e64fea54236836ebbb111188a386213" title="Send pocketBus packet header.">pocketbus_begin</a>(<span class="keyword">struct</span> <a class="code" href="structPocketBusCtx.html" title="pocketBus context structure.">PocketBusCtx</a> *ctx, <a class="code" href="pocketbus_8h.html#af63b5ecec3f1a8ffaf7d711181392dec" title="Type for pocketBus addresses.">pocketbus_addr_t</a> addr)
<a name="l00115"></a>00115 {
<a name="l00116"></a>00116     <a class="code" href="structPocketBusHdr.html" title="Header of pocketBus messages.">PocketBusHdr</a> hdr;
<a name="l00117"></a>00117 
<a name="l00118"></a>00118     hdr.<a class="code" href="structPocketBusHdr.html#ab1ba4d24145973544ee08818ed2e98f7" title="packet version">ver</a> = POCKETBUS_VER;
<a name="l00119"></a>00119     hdr.<a class="code" href="structPocketBusHdr.html#a9b8dbd7319a98b27d9775e30708efa83" title="slave address">addr</a> = cpu_to_be16(addr);
<a name="l00120"></a>00120     <a class="code" href="rotating__hash_8h.html#a375e1ff60be4125f3174ad257094d983" title="Init rotating checksum.">rotating_init</a>(&amp;ctx-&gt;<a class="code" href="structPocketBusCtx.html#ac0514ebcce95b0d22bd8551196cd4c5f" title="Checksum computation for transmitted data.">out_cks</a>);
<a name="l00121"></a>00121 
<a name="l00122"></a>00122     <span class="comment">/* Send STX */</span>
<a name="l00123"></a>00123     <a class="code" href="group__io__kfile.html#ga480c14426dc77cdfd786c3b5b9a9adf2" title="Generic putc() implementation using fd-&gt;write.">kfile_putc</a>(<a class="code" href="pocketbus_8h.html#a2f2189c4c3d45ced8701224d970013c2" title="pocketBus special characters definitions.">POCKETBUS_STX</a>, ctx-&gt;<a class="code" href="structPocketBusCtx.html#abf9becd84a17b6e96966922b4af7093a" title="File descriptor.">fd</a>);
<a name="l00124"></a>00124 
<a name="l00125"></a>00125     <span class="comment">/* Send header */</span>
<a name="l00126"></a>00126     <a class="code" href="pocketbus_8c.html#a9589e76fc410f9fed1b25807baf8ba6d" title="Send buffer _data over bus, handling escape.">pocketbus_write</a>(ctx, &amp;hdr, <span class="keyword">sizeof</span>(hdr));
<a name="l00127"></a>00127 }
<a name="l00128"></a>00128 
<a name="l00132"></a><a class="code" href="pocketbus_8h.html#a9589e76fc410f9fed1b25807baf8ba6d">00132</a> <span class="keywordtype">void</span> <a class="code" href="pocketbus_8c.html#a9589e76fc410f9fed1b25807baf8ba6d" title="Send buffer _data over bus, handling escape.">pocketbus_write</a>(<span class="keyword">struct</span> <a class="code" href="structPocketBusCtx.html" title="pocketBus context structure.">PocketBusCtx</a> *ctx, <span class="keyword">const</span> <span class="keywordtype">void</span> *_data, <span class="keywordtype">size_t</span> len)
<a name="l00133"></a>00133 {
<a name="l00134"></a>00134     <span class="keyword">const</span> uint8_t *data = (<span class="keyword">const</span> uint8_t *)_data;
<a name="l00135"></a>00135 
<a name="l00136"></a>00136     <span class="keywordflow">while</span> (len--)
<a name="l00137"></a>00137         <a class="code" href="pocketbus_8c.html#ae6a9a07114695dc497be7a9d19dfc153" title="Send a character over pocketBus channel stream, handling escape mode.">pocketbus_putchar</a>(ctx, *data++);
<a name="l00138"></a>00138 }
<a name="l00139"></a>00139 
<a name="l00143"></a><a class="code" href="pocketbus_8h.html#ac87ef3191ab444e8a02abd7819a7d068">00143</a> <span class="keywordtype">void</span> <a class="code" href="pocketbus_8c.html#ac87ef3191ab444e8a02abd7819a7d068" title="Send pocketBus packet tail.">pocketbus_end</a>(<span class="keyword">struct</span> <a class="code" href="structPocketBusCtx.html" title="pocketBus context structure.">PocketBusCtx</a> *ctx)
<a name="l00144"></a>00144 {
<a name="l00145"></a>00145     <span class="comment">/* Send checksum */</span>
<a name="l00146"></a>00146     rotating_t cks = cpu_to_be16(ctx-&gt;<a class="code" href="structPocketBusCtx.html#ac0514ebcce95b0d22bd8551196cd4c5f" title="Checksum computation for transmitted data.">out_cks</a>);
<a name="l00147"></a>00147     <a class="code" href="pocketbus_8c.html#a9589e76fc410f9fed1b25807baf8ba6d" title="Send buffer _data over bus, handling escape.">pocketbus_write</a>(ctx, &amp;cks, <span class="keyword">sizeof</span>(cks));
<a name="l00148"></a>00148 
<a name="l00149"></a>00149     <span class="comment">/* Send ETX */</span>
<a name="l00150"></a>00150     <a class="code" href="group__io__kfile.html#ga480c14426dc77cdfd786c3b5b9a9adf2" title="Generic putc() implementation using fd-&gt;write.">kfile_putc</a>(<a class="code" href="pocketbus_8h.html#aec6c2bc5f1440007c1d459972fed5a3e" title="pocketBus special characters definitions.">POCKETBUS_ETX</a>, ctx-&gt;<a class="code" href="structPocketBusCtx.html#abf9becd84a17b6e96966922b4af7093a" title="File descriptor.">fd</a>);
<a name="l00151"></a>00151 }
<a name="l00152"></a>00152 
<a name="l00156"></a><a class="code" href="pocketbus_8h.html#afd291395155722155fc63cd63a0e1b15">00156</a> <span class="keywordtype">void</span> <a class="code" href="pocketbus_8c.html#afd291395155722155fc63cd63a0e1b15" title="Send buffer of data to address addr with a pocketBus packet over channel stream.">pocketbus_send</a>(<span class="keyword">struct</span> <a class="code" href="structPocketBusCtx.html" title="pocketBus context structure.">PocketBusCtx</a> *ctx, <a class="code" href="pocketbus_8h.html#af63b5ecec3f1a8ffaf7d711181392dec" title="Type for pocketBus addresses.">pocketbus_addr_t</a> addr, <span class="keyword">const</span> <span class="keywordtype">void</span> *data, <span class="keywordtype">size_t</span> len)
<a name="l00157"></a>00157 {
<a name="l00158"></a>00158     <a class="code" href="pocketbus_8c.html#a9e64fea54236836ebbb111188a386213" title="Send pocketBus packet header.">pocketbus_begin</a>(ctx, addr);
<a name="l00159"></a>00159 
<a name="l00160"></a>00160     <span class="comment">/* Send data */</span>
<a name="l00161"></a>00161     <a class="code" href="pocketbus_8c.html#a9589e76fc410f9fed1b25807baf8ba6d" title="Send buffer _data over bus, handling escape.">pocketbus_write</a>(ctx, data, len);
<a name="l00162"></a>00162 
<a name="l00163"></a>00163     <a class="code" href="pocketbus_8c.html#ac87ef3191ab444e8a02abd7819a7d068" title="Send pocketBus packet tail.">pocketbus_end</a>(ctx);
<a name="l00164"></a>00164 }
<a name="l00165"></a>00165 
<a name="l00166"></a>00166 
<a name="l00171"></a><a class="code" href="pocketbus_8h.html#ab5c6bf4b8545d77f30c6f92f97684106">00171</a> <span class="keywordtype">bool</span> <a class="code" href="pocketbus_8c.html#ab5c6bf4b8545d77f30c6f92f97684106" title="Try to read a packet from the pocketBus.">pocketbus_recv</a>(<span class="keyword">struct</span> <a class="code" href="structPocketBusCtx.html" title="pocketBus context structure.">PocketBusCtx</a> *ctx, <span class="keyword">struct</span> <a class="code" href="structPocketMsg.html" title="Structure holding pocketBus message parameters.">PocketMsg</a> *msg)
<a name="l00172"></a>00172 {
<a name="l00173"></a>00173     <span class="keywordtype">int</span> c;
<a name="l00174"></a>00174 
<a name="l00175"></a>00175     <span class="comment">/* Process incoming characters until buffer is not empty */</span>
<a name="l00176"></a>00176     <span class="keywordflow">while</span> ((c = <a class="code" href="group__io__kfile.html#ga09cca6f02dc337ddff2b36b66a3fdd1c" title="Generic getc() implementation using fd-&gt;read.">kfile_getc</a>(ctx-&gt;<a class="code" href="structPocketBusCtx.html#abf9becd84a17b6e96966922b4af7093a" title="File descriptor.">fd</a>)) != EOF)
<a name="l00177"></a>00177     {
<a name="l00178"></a>00178         <span class="comment">/* Look for STX char */</span>
<a name="l00179"></a>00179         <span class="keywordflow">if</span> (c == <a class="code" href="pocketbus_8h.html#a2f2189c4c3d45ced8701224d970013c2" title="pocketBus special characters definitions.">POCKETBUS_STX</a> &amp;&amp; !ctx-&gt;<a class="code" href="structPocketBusCtx.html#a0a98cf14df674c7a8d443adade357eec" title="Status flag: true if we are in escape mode, false otherwise.">escape</a>)
<a name="l00180"></a>00180         {
<a name="l00181"></a>00181             <span class="comment">/* When an STX is found, inconditionally start a new packet */</span>
<a name="l00182"></a>00182             <span class="keywordflow">if</span> (ctx-&gt;<a class="code" href="structPocketBusCtx.html#a38f89072c821b818d3f895e1bbbe3283" title="Status flag: true if we have received an STX, false otherwise.">sync</a>)
<a name="l00183"></a>00183                 kprintf(<span class="stringliteral">&quot;pocketBus double sync!\n&quot;</span>);
<a name="l00184"></a>00184 
<a name="l00185"></a>00185             ctx-&gt;<a class="code" href="structPocketBusCtx.html#a38f89072c821b818d3f895e1bbbe3283" title="Status flag: true if we have received an STX, false otherwise.">sync</a> = <span class="keyword">true</span>;
<a name="l00186"></a>00186             ctx-&gt;<a class="code" href="structPocketBusCtx.html#a79f45c81258788997cdd2f9fd94f8a66" title="Received length.">len</a> = 0;
<a name="l00187"></a>00187             <a class="code" href="rotating__hash_8h.html#a375e1ff60be4125f3174ad257094d983" title="Init rotating checksum.">rotating_init</a>(&amp;ctx-&gt;<a class="code" href="structPocketBusCtx.html#a0594688ef2e92a736dfa6e54b2b3c803" title="Checksum computation for received data.">in_cks</a>);
<a name="l00188"></a>00188             <span class="keywordflow">continue</span>;
<a name="l00189"></a>00189         }
<a name="l00190"></a>00190 
<a name="l00191"></a>00191         <span class="keywordflow">if</span> (ctx-&gt;<a class="code" href="structPocketBusCtx.html#a38f89072c821b818d3f895e1bbbe3283" title="Status flag: true if we have received an STX, false otherwise.">sync</a>)
<a name="l00192"></a>00192         {
<a name="l00193"></a>00193             <span class="comment">/* Handle escape mode */</span>
<a name="l00194"></a>00194             <span class="keywordflow">if</span> (c == <a class="code" href="pocketbus_8h.html#ae8d63dbc87418d7ab43cc2164f4c5e9c" title="pocketBus special characters definitions.">POCKETBUS_ESC</a> &amp;&amp; !ctx-&gt;<a class="code" href="structPocketBusCtx.html#a0a98cf14df674c7a8d443adade357eec" title="Status flag: true if we are in escape mode, false otherwise.">escape</a>)
<a name="l00195"></a>00195             {
<a name="l00196"></a>00196                 ctx-&gt;<a class="code" href="structPocketBusCtx.html#a0a98cf14df674c7a8d443adade357eec" title="Status flag: true if we are in escape mode, false otherwise.">escape</a> = <span class="keyword">true</span>;
<a name="l00197"></a>00197                 <span class="keywordflow">continue</span>;
<a name="l00198"></a>00198             }
<a name="l00199"></a>00199 
<a name="l00200"></a>00200             <span class="comment">/* Handle message end */</span>
<a name="l00201"></a>00201             <span class="keywordflow">if</span> (c == <a class="code" href="pocketbus_8h.html#aec6c2bc5f1440007c1d459972fed5a3e" title="pocketBus special characters definitions.">POCKETBUS_ETX</a> &amp;&amp; !ctx-&gt;<a class="code" href="structPocketBusCtx.html#a0a98cf14df674c7a8d443adade357eec" title="Status flag: true if we are in escape mode, false otherwise.">escape</a>)
<a name="l00202"></a>00202             {
<a name="l00203"></a>00203                 ctx-&gt;<a class="code" href="structPocketBusCtx.html#a38f89072c821b818d3f895e1bbbe3283" title="Status flag: true if we have received an STX, false otherwise.">sync</a> = <span class="keyword">false</span>;
<a name="l00204"></a>00204 
<a name="l00205"></a>00205                 <span class="comment">/* Check minimum size */</span>
<a name="l00206"></a>00206                 <span class="keywordflow">if</span> (ctx-&gt;<a class="code" href="structPocketBusCtx.html#a79f45c81258788997cdd2f9fd94f8a66" title="Received length.">len</a> &lt; <span class="keyword">sizeof</span>(<a class="code" href="structPocketBusHdr.html" title="Header of pocketBus messages.">PocketBusHdr</a>) + <span class="keyword">sizeof</span>(rotating_t))
<a name="l00207"></a>00207                 {
<a name="l00208"></a>00208                     kprintf(<span class="stringliteral">&quot;pocketBus short pkt!\n&quot;</span>);
<a name="l00209"></a>00209                     <span class="keywordflow">continue</span>;
<a name="l00210"></a>00210                 }
<a name="l00211"></a>00211 
<a name="l00212"></a>00212                 <span class="comment">/* Remove checksum bytes from packet len */</span>
<a name="l00213"></a>00213                 ctx-&gt;<a class="code" href="structPocketBusCtx.html#a79f45c81258788997cdd2f9fd94f8a66" title="Received length.">len</a> -= <span class="keyword">sizeof</span>(rotating_t);
<a name="l00214"></a>00214 
<a name="l00215"></a>00215                 <span class="comment">/* Compute checksum */</span>
<a name="l00216"></a>00216                 <a class="code" href="rotating__hash_8h.html#ad4c2a97247c6e94ed69389adebf2f016" title="Update checksum pointed by rot with data supplied in buf.">rotating_update</a>(ctx-&gt;<a class="code" href="structPocketBusCtx.html#a44fa9585b743eb44482eca7abecba34e" title="receiving Buffer">buf</a>, ctx-&gt;<a class="code" href="structPocketBusCtx.html#a79f45c81258788997cdd2f9fd94f8a66" title="Received length.">len</a>, &amp;ctx-&gt;<a class="code" href="structPocketBusCtx.html#a0594688ef2e92a736dfa6e54b2b3c803" title="Checksum computation for received data.">in_cks</a>);
<a name="l00217"></a>00217                 uint8_t cks_h = *(ctx-&gt;<a class="code" href="structPocketBusCtx.html#a44fa9585b743eb44482eca7abecba34e" title="receiving Buffer">buf</a> + ctx-&gt;<a class="code" href="structPocketBusCtx.html#a79f45c81258788997cdd2f9fd94f8a66" title="Received length.">len</a>);
<a name="l00218"></a>00218                 uint8_t cks_l = *(ctx-&gt;<a class="code" href="structPocketBusCtx.html#a44fa9585b743eb44482eca7abecba34e" title="receiving Buffer">buf</a> + ctx-&gt;<a class="code" href="structPocketBusCtx.html#a79f45c81258788997cdd2f9fd94f8a66" title="Received length.">len</a> + 1);
<a name="l00219"></a>00219 
<a name="l00220"></a>00220                 rotating_t recv_cks = (cks_h &lt;&lt; 8) | cks_l;
<a name="l00221"></a>00221 
<a name="l00222"></a>00222                 <span class="comment">/* Checksum check */</span>
<a name="l00223"></a>00223                 <span class="keywordflow">if</span> (recv_cks == ctx-&gt;<a class="code" href="structPocketBusCtx.html#a0594688ef2e92a736dfa6e54b2b3c803" title="Checksum computation for received data.">in_cks</a>)
<a name="l00224"></a>00224                 {
<a name="l00225"></a>00225                     <a class="code" href="structPocketBusHdr.html" title="Header of pocketBus messages.">PocketBusHdr</a> *hdr = (<a class="code" href="structPocketBusHdr.html" title="Header of pocketBus messages.">PocketBusHdr</a> *)ctx;
<a name="l00226"></a>00226 
<a name="l00227"></a>00227                     <span class="comment">/* Check packet version */</span>
<a name="l00228"></a>00228                     <span class="keywordflow">if</span> (hdr-&gt;<a class="code" href="structPocketBusHdr.html#ab1ba4d24145973544ee08818ed2e98f7" title="packet version">ver</a> == POCKETBUS_VER)
<a name="l00229"></a>00229                     {
<a name="l00230"></a>00230                         <span class="comment">/* Packet received, set msg fields */</span>
<a name="l00231"></a>00231                         msg-&gt;<a class="code" href="structPocketMsg.html#a691da6b0989c0f6c2fc9df89f5f17daa" title="payload data">payload</a> = ctx-&gt;<a class="code" href="structPocketBusCtx.html#a44fa9585b743eb44482eca7abecba34e" title="receiving Buffer">buf</a> + <span class="keyword">sizeof</span>(<a class="code" href="structPocketBusHdr.html" title="Header of pocketBus messages.">PocketBusHdr</a>);
<a name="l00232"></a>00232                         msg-&gt;<a class="code" href="structPocketMsg.html#a3c591539dfb92e4f0f3e243963a32041" title="address for received packet">addr</a> = be16_to_cpu(hdr-&gt;<a class="code" href="structPocketBusHdr.html#a9b8dbd7319a98b27d9775e30708efa83" title="slave address">addr</a>);
<a name="l00233"></a>00233                         msg-&gt;<a class="code" href="structPocketMsg.html#accc0775a89a1a322a83bd77d28c4f22a" title="payload length">len</a> = ctx-&gt;<a class="code" href="structPocketBusCtx.html#a79f45c81258788997cdd2f9fd94f8a66" title="Received length.">len</a> - <span class="keyword">sizeof</span>(<a class="code" href="structPocketBusHdr.html" title="Header of pocketBus messages.">PocketBusHdr</a>);
<a name="l00234"></a>00234                         msg-&gt;<a class="code" href="structPocketMsg.html#ada982dfaafdde28a2dabab5608f6f3c2" title="pocketBus message context">ctx</a> = ctx;
<a name="l00235"></a>00235                         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00236"></a>00236                     }
<a name="l00237"></a>00237                     <span class="keywordflow">else</span>
<a name="l00238"></a>00238                     {
<a name="l00239"></a>00239                         kprintf(<span class="stringliteral">&quot;pocketBus version mismatch, here[%d], there[%d]\n&quot;</span>, POCKETBUS_VER, hdr-&gt;<a class="code" href="structPocketBusHdr.html#ab1ba4d24145973544ee08818ed2e98f7" title="packet version">ver</a>);
<a name="l00240"></a>00240                         <span class="keywordflow">continue</span>;
<a name="l00241"></a>00241                     }
<a name="l00242"></a>00242                 }
<a name="l00243"></a>00243                 <span class="keywordflow">else</span>
<a name="l00244"></a>00244                 {
<a name="l00245"></a>00245                     kprintf(<span class="stringliteral">&quot;pocketBus cks error, here[%04X], there[%04X]\n&quot;</span>, ctx-&gt;<a class="code" href="structPocketBusCtx.html#a0594688ef2e92a736dfa6e54b2b3c803" title="Checksum computation for received data.">in_cks</a>, recv_cks);
<a name="l00246"></a>00246                     <span class="keywordflow">continue</span>;
<a name="l00247"></a>00247                 }
<a name="l00248"></a>00248 
<a name="l00249"></a>00249             }
<a name="l00250"></a>00250 
<a name="l00251"></a>00251             ctx-&gt;<a class="code" href="structPocketBusCtx.html#a0a98cf14df674c7a8d443adade357eec" title="Status flag: true if we are in escape mode, false otherwise.">escape</a> = <span class="keyword">false</span>;
<a name="l00252"></a>00252 
<a name="l00253"></a>00253             <span class="comment">/* Check buffer overflow: simply ignore</span>
<a name="l00254"></a>00254 <span class="comment">               received data and go to unsynced state. */</span>
<a name="l00255"></a>00255             <span class="keywordflow">if</span> (ctx-&gt;<a class="code" href="structPocketBusCtx.html#a79f45c81258788997cdd2f9fd94f8a66" title="Received length.">len</a> &gt;= <a class="code" href="cfg__pocketbus_8h.html#a8df6303314c579786d81eb15e0300626" title="Buffer len for pockebus protocol.">CONFIG_POCKETBUS_BUFLEN</a>)
<a name="l00256"></a>00256             {
<a name="l00257"></a>00257                 kprintf(<span class="stringliteral">&quot;pocketBus buffer overflow\n&quot;</span>);
<a name="l00258"></a>00258                 ctx-&gt;<a class="code" href="structPocketBusCtx.html#a38f89072c821b818d3f895e1bbbe3283" title="Status flag: true if we have received an STX, false otherwise.">sync</a> = <span class="keyword">false</span>;
<a name="l00259"></a>00259                 <span class="keywordflow">continue</span>;
<a name="l00260"></a>00260             }
<a name="l00261"></a>00261 
<a name="l00262"></a>00262             <span class="comment">/* Put received data in the buffer */</span>
<a name="l00263"></a>00263             ctx-&gt;<a class="code" href="structPocketBusCtx.html#a44fa9585b743eb44482eca7abecba34e" title="receiving Buffer">buf</a>[ctx-&gt;<a class="code" href="structPocketBusCtx.html#a79f45c81258788997cdd2f9fd94f8a66" title="Received length.">len</a>] = c;
<a name="l00264"></a>00264             ctx-&gt;<a class="code" href="structPocketBusCtx.html#a79f45c81258788997cdd2f9fd94f8a66" title="Received length.">len</a>++;
<a name="l00265"></a>00265         }
<a name="l00266"></a>00266     }
<a name="l00267"></a>00267 
<a name="l00268"></a>00268     <span class="comment">/*</span>
<a name="l00269"></a>00269 <span class="comment">     * Check stream status.</span>
<a name="l00270"></a>00270 <span class="comment">     */</span>
<a name="l00271"></a>00271     <span class="keywordflow">if</span> (<a class="code" href="group__io__kfile.html#ga9638c7d7f76976a58ceb670c28e13c39" title="Get file error mask.">kfile_error</a>(ctx-&gt;<a class="code" href="structPocketBusCtx.html#abf9becd84a17b6e96966922b4af7093a" title="File descriptor.">fd</a>))
<a name="l00272"></a>00272     {
<a name="l00273"></a>00273         <a class="code" href="group__logging.html#ga19c97c740010c52ce6801d46a5346644" title="Output an error message.">LOG_ERR</a>(<span class="stringliteral">&quot;fd status[%04X]\n&quot;</span>, <a class="code" href="group__io__kfile.html#ga9638c7d7f76976a58ceb670c28e13c39" title="Get file error mask.">kfile_error</a>(ctx-&gt;<a class="code" href="structPocketBusCtx.html#abf9becd84a17b6e96966922b4af7093a" title="File descriptor.">fd</a>));
<a name="l00274"></a>00274         <a class="code" href="group__io__kfile.html#ga40a4b4a6c5b44f6377e51e7484650324" title="Clear errors.">kfile_clearerr</a>(ctx-&gt;<a class="code" href="structPocketBusCtx.html#abf9becd84a17b6e96966922b4af7093a" title="File descriptor.">fd</a>);
<a name="l00275"></a>00275     }
<a name="l00276"></a>00276 
<a name="l00277"></a>00277     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00278"></a>00278 }
<a name="l00279"></a>00279 
<a name="l00280"></a>00280 
<a name="l00284"></a><a class="code" href="pocketbus_8h.html#a35e365a7ea36ce352e9895d01d81b8a8">00284</a> <span class="keywordtype">void</span> <a class="code" href="pocketbus_8c.html#a35e365a7ea36ce352e9895d01d81b8a8" title="Initialize pocketBus protocol handler.">pocketbus_init</a>(<span class="keyword">struct</span> <a class="code" href="structPocketBusCtx.html" title="pocketBus context structure.">PocketBusCtx</a> *ctx, <span class="keyword">struct</span> <a class="code" href="structKFile.html" title="Context data for callback functions which operate on pseudo files.">KFile</a> *fd)
<a name="l00285"></a>00285 {
<a name="l00286"></a>00286     <a class="code" href="group__debug.html#gaca68c0d4ac8df0838e209fb5300f7be3" title="Assert a pre-condition on code.">ASSERT</a>(ctx);
<a name="l00287"></a>00287     <a class="code" href="group__debug.html#gaca68c0d4ac8df0838e209fb5300f7be3" title="Assert a pre-condition on code.">ASSERT</a>(fd);
<a name="l00288"></a>00288 
<a name="l00289"></a>00289     memset(ctx, 0, <span class="keyword">sizeof</span>(*ctx));
<a name="l00290"></a>00290     ctx-&gt;<a class="code" href="structPocketBusCtx.html#abf9becd84a17b6e96966922b4af7093a" title="File descriptor.">fd</a> = fd;
<a name="l00291"></a>00291 }
</pre></div></div>
</div>


