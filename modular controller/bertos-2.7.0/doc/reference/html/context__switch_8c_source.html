

<!-- Generated by Doxygen 1.7.4 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="dir_9fd71c1ac00056e7d855336b2291c56c.html">bertos</a>      </li>
      <li class="navelem"><a class="el" href="dir_ff1b722fbb0a5cb762803f437275c8fc.html">benchmark</a>      </li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">context_switch.c</div>  </div>
</div>
<div class="contents">
<a href="context__switch_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 
<a name="l00039"></a>00039 <span class="preprocessor">#include &quot;<a class="code" href="context__switch_8h.html" title="Context switch benchmark.">context_switch.h</a>&quot;</span>
<a name="l00040"></a>00040 
<a name="l00041"></a>00041 <span class="preprocessor">#include &quot;<a class="code" href="hw__led_8h.html" title="Led on/off macros.">hw/hw_led.h</a>&quot;</span>
<a name="l00042"></a>00042 
<a name="l00043"></a>00043 <span class="preprocessor">#include &quot;<a class="code" href="cfg__context__switch_8h.html" title="Configuration file for the context switch benchmark.">cfg/cfg_context_switch.h</a>&quot;</span>
<a name="l00044"></a>00044 <span class="preprocessor">#include &lt;<a class="code" href="debug_8h.html">cfg/debug.h</a>&gt;</span>
<a name="l00045"></a>00045 
<a name="l00046"></a>00046 <span class="preprocessor">#include &lt;<a class="code" href="cpu_2irq_8h.html" title="CPU-specific IRQ definitions.">cpu/irq.h</a>&gt;</span>
<a name="l00047"></a>00047 <span class="preprocessor">#include &lt;<a class="code" href="power_8h.html" title="CPU power management functions.">cpu/power.h</a>&gt;</span>
<a name="l00048"></a>00048 
<a name="l00049"></a>00049 <span class="preprocessor">#include &lt;<a class="code" href="timer_8h.html">drv/timer.h</a>&gt;</span>
<a name="l00050"></a>00050 <span class="preprocessor">#if CONFIG_USE_HP_TIMER</span>
<a name="l00051"></a>00051 <span class="preprocessor"></span><span class="preprocessor">#include &lt;<a class="code" href="ser_8h.html" title="High level serial I/O API.">drv/ser.h</a>&gt;</span>
<a name="l00052"></a>00052 <span class="keyword">static</span> <a class="code" href="structSerial.html" title="Serial handle structure.">Serial</a> out;
<a name="l00053"></a>00053 <span class="preprocessor">#endif</span>
<a name="l00054"></a>00054 <span class="preprocessor"></span>
<a name="l00055"></a>00055 <span class="preprocessor">#include &lt;<a class="code" href="proc_8h.html">kern/proc.h</a>&gt;</span>
<a name="l00056"></a>00056 
<a name="l00057"></a>00057 <span class="preprocessor">#define PROC_STACK_SIZE    KERN_MINSTACKSIZE</span>
<a name="l00058"></a>00058 <span class="preprocessor"></span>
<a name="l00059"></a>00059 <span class="keyword">static</span> <a class="code" href="group__kern__proc.html#gad78992529a7850e21738807c606482fb" title="Utility macro to allocate a stack of size size.">PROC_DEFINE_STACK</a>(hp_stack, PROC_STACK_SIZE);
<a name="l00060"></a>00060 <span class="keyword">static</span> <a class="code" href="group__kern__proc.html#gad78992529a7850e21738807c606482fb" title="Utility macro to allocate a stack of size size.">PROC_DEFINE_STACK</a>(lp_stack, PROC_STACK_SIZE);
<a name="l00061"></a>00061 
<a name="l00062"></a>00062 <span class="keyword">static</span> Process *hp_proc, *lp_proc, *main_proc;
<a name="l00063"></a>00063 <span class="preprocessor">#if CONFIG_USE_HP_TIMER</span>
<a name="l00064"></a>00064 <span class="preprocessor"></span><span class="keyword">static</span> <a class="code" href="timer__lpc2_8h.html#a39ca00de3e892de8f389dd23dc6f1053" title="Type of time expressed in ticks of the hardware high-precision timer.">hptime_t</a> start, end;
<a name="l00065"></a>00065 <span class="preprocessor">#endif</span>
<a name="l00066"></a>00066 <span class="preprocessor"></span>
<a name="l00067"></a>00067 <span class="keyword">static</span> <span class="keywordtype">void</span> NORETURN hp_process(<span class="keywordtype">void</span>)
<a name="l00068"></a>00068 {
<a name="l00069"></a>00069     <span class="keywordflow">while</span> (1)
<a name="l00070"></a>00070     {
<a name="l00071"></a>00071         <a class="code" href="group__kern__signal.html#ga83accf7cc9eb33c748b2670b8f272060" title="Sleep until any of the signals in sigs occurs.">sig_wait</a>(<a class="code" href="group__kern__signal.html#ga75be8f1e5c431785f5ee2fcf1b1d6de3" title="Free for user usage.">SIG_USER0</a>);
<a name="l00072"></a>00072 <span class="preprocessor">        #if CONFIG_USE_LED</span>
<a name="l00073"></a>00073 <span class="preprocessor"></span>            LED_ON();
<a name="l00074"></a>00074 <span class="preprocessor">        #endif</span>
<a name="l00075"></a>00075 <span class="preprocessor"></span><span class="preprocessor">        #if CONFIG_USE_HP_TIMER</span>
<a name="l00076"></a>00076 <span class="preprocessor"></span>            end = <a class="code" href="timer__lpc2_8h.html#a3dbeffcee7c05cbf0291dcdeccaa3248" title="System timer on Timer0 Compare match0.">timer_hw_hpread</a>();
<a name="l00077"></a>00077 <span class="preprocessor">        #endif</span>
<a name="l00078"></a>00078 <span class="preprocessor"></span>        <a class="code" href="group__kern__signal.html#ga9532c2e6c4894d567f648530b9500e8c" title="Send the signals sigs to the process proc and immeditaly dispatch it for execution.">sig_send</a>(main_proc, <a class="code" href="group__kern__signal.html#ga75be8f1e5c431785f5ee2fcf1b1d6de3" title="Free for user usage.">SIG_USER0</a>);
<a name="l00079"></a>00079     }
<a name="l00080"></a>00080 }
<a name="l00081"></a>00081 
<a name="l00082"></a>00082 <span class="keyword">static</span> <span class="keywordtype">void</span> NORETURN lp_process(<span class="keywordtype">void</span>)
<a name="l00083"></a>00083 {
<a name="l00084"></a>00084     <span class="keywordflow">while</span> (1)
<a name="l00085"></a>00085     {
<a name="l00086"></a>00086         <a class="code" href="group__kern__signal.html#ga83accf7cc9eb33c748b2670b8f272060" title="Sleep until any of the signals in sigs occurs.">sig_wait</a>(<a class="code" href="group__kern__signal.html#ga75be8f1e5c431785f5ee2fcf1b1d6de3" title="Free for user usage.">SIG_USER0</a>);
<a name="l00087"></a>00087 <span class="preprocessor">        #if CONFIG_USE_LED</span>
<a name="l00088"></a>00088 <span class="preprocessor"></span>            LED_ON();
<a name="l00089"></a>00089             LED_OFF();
<a name="l00090"></a>00090 <span class="preprocessor">        #endif</span>
<a name="l00091"></a>00091 <span class="preprocessor"></span><span class="preprocessor">        #if CONFIG_USE_HP_TIMER</span>
<a name="l00092"></a>00092 <span class="preprocessor"></span>            start = <a class="code" href="timer__lpc2_8h.html#a3dbeffcee7c05cbf0291dcdeccaa3248" title="System timer on Timer0 Compare match0.">timer_hw_hpread</a>();
<a name="l00093"></a>00093 <span class="preprocessor">        #endif</span>
<a name="l00094"></a>00094 <span class="preprocessor"></span>        <a class="code" href="group__kern__signal.html#ga9532c2e6c4894d567f648530b9500e8c" title="Send the signals sigs to the process proc and immeditaly dispatch it for execution.">sig_send</a>(hp_proc, <a class="code" href="group__kern__signal.html#ga75be8f1e5c431785f5ee2fcf1b1d6de3" title="Free for user usage.">SIG_USER0</a>);
<a name="l00095"></a>00095     }
<a name="l00096"></a>00096 }
<a name="l00097"></a>00097 
<a name="l00098"></a>00098 
<a name="l00099"></a>00099 <span class="keywordtype">void</span> NORETURN context_switch(<span class="keywordtype">void</span>)
<a name="l00100"></a>00100 {
<a name="l00101"></a>00101     IRQ_ENABLE;
<a name="l00102"></a>00102     timer_init();
<a name="l00103"></a>00103     <a class="code" href="group__kern__proc.html#gafdd9e124a2e47f620d4165b86713c516" title="Initialize the process subsystem (kernel).">proc_init</a>();
<a name="l00104"></a>00104 
<a name="l00105"></a>00105 <span class="preprocessor">    #if CONFIG_USE_HP_TIMER</span>
<a name="l00106"></a>00106 <span class="preprocessor"></span>        <a class="code" href="ser_8c.html#a088372086f192b2a8cfc8b12f80a1fb7" title="Init serial driver for unit.">ser_init</a>(&amp;out, <a class="code" href="cfg__context__switch_8h.html#a005bf3fda72504b15be8d66ca9e41ec7" title="Debug console port.">CONFIG_CTX_DEBUG_PORT</a>);
<a name="l00107"></a>00107         <a class="code" href="ser_8c.html#a11f9fc76f87264fb606d3a479454facb" title="Set the baudrate for the serial port.">ser_setbaudrate</a>(&amp;out, <a class="code" href="cfg__context__switch_8h.html#ac5200838801f804e036f917f48055241" title="Baudrate for the debug console.">CONFIG_CTX_DEBUG_BAUDRATE</a>);
<a name="l00108"></a>00108 <span class="preprocessor">    #endif</span>
<a name="l00109"></a>00109 <span class="preprocessor"></span>
<a name="l00110"></a>00110 <span class="preprocessor">    #if CONFIG_USE_LED</span>
<a name="l00111"></a>00111 <span class="preprocessor"></span>        LED_INIT();
<a name="l00112"></a>00112 <span class="preprocessor">    #endif</span>
<a name="l00113"></a>00113 <span class="preprocessor"></span>
<a name="l00114"></a>00114     <a class="code" href="group__kern__proc.html#ga4161db7fa7a7302cd1cce624ac210ef4" title="Disable preemptive task switching.">proc_forbid</a>();
<a name="l00115"></a>00115     hp_proc = <a class="code" href="group__kern__proc.html#gaca4f0091f2e3c8115a1be7aabc0866ef" title="Create a new named process and schedules it for execution.">proc_new</a>(hp_process, NULL, PROC_STACK_SIZE, hp_stack);
<a name="l00116"></a>00116     lp_proc = <a class="code" href="group__kern__proc.html#gaca4f0091f2e3c8115a1be7aabc0866ef" title="Create a new named process and schedules it for execution.">proc_new</a>(lp_process, NULL, PROC_STACK_SIZE, lp_stack);
<a name="l00117"></a>00117     main_proc = <a class="code" href="group__kern__proc.html#gaaf85f02d7fa77e547dd2a770f2707b5f" title="Return the context structure of the currently running process.">proc_current</a>();
<a name="l00118"></a>00118     <a class="code" href="group__kern__proc.html#gaab27aeaf1d2db5432406b4564e4bf63a" title="Change the scheduling priority of a process.">proc_setPri</a>(hp_proc, 2);
<a name="l00119"></a>00119     <a class="code" href="group__kern__proc.html#gaab27aeaf1d2db5432406b4564e4bf63a" title="Change the scheduling priority of a process.">proc_setPri</a>(lp_proc, 1);
<a name="l00120"></a>00120     <a class="code" href="group__kern__proc.html#ga537a0dc1c882de1e2d1648e934327ce0" title="Re-enable preemptive task switching.">proc_permit</a>();
<a name="l00121"></a>00121 
<a name="l00122"></a>00122     <span class="keywordflow">while</span> (1)
<a name="l00123"></a>00123     {
<a name="l00124"></a>00124         <a class="code" href="group__drv__timers.html#gace6fb3d382bd740f9cee1b139e12f7a6" title="Wait some time [ms].">timer_delay</a>(100);
<a name="l00125"></a>00125 
<a name="l00126"></a>00126         <a class="code" href="group__kern__signal.html#ga9532c2e6c4894d567f648530b9500e8c" title="Send the signals sigs to the process proc and immeditaly dispatch it for execution.">sig_send</a>(lp_proc, <a class="code" href="group__kern__signal.html#ga75be8f1e5c431785f5ee2fcf1b1d6de3" title="Free for user usage.">SIG_USER0</a>);
<a name="l00127"></a>00127         <a class="code" href="group__kern__signal.html#ga83accf7cc9eb33c748b2670b8f272060" title="Sleep until any of the signals in sigs occurs.">sig_wait</a>(<a class="code" href="group__kern__signal.html#ga75be8f1e5c431785f5ee2fcf1b1d6de3" title="Free for user usage.">SIG_USER0</a>);
<a name="l00128"></a>00128 
<a name="l00129"></a>00129 <span class="preprocessor">        #if CONFIG_USE_HP_TIMER</span>
<a name="l00130"></a>00130 <span class="preprocessor"></span>            <a class="code" href="group__io__kfile.html#gaa04c60fc2dec055903884ab7d4a09111" title="Formatted write.">kfile_printf</a>(&amp;out.<a class="code" href="structSerial.html#aa44c022a49bfe13f3ece632288cdda74" title="Serial have a KFile struct implementation.">fd</a>,
<a name="l00131"></a>00131                 <span class="stringliteral">&quot;Switch: %lu.%lu usec\n\r&quot;</span>,
<a name="l00132"></a>00132                 <a class="code" href="group__drv__timers.html#gaf9a389338d010ad77bf863d4fcef26d4" title="Convert hpticks [hptime] to usec.">hptime_to_us</a>((end - start)),
<a name="l00133"></a>00133                 <a class="code" href="group__drv__timers.html#gaf9a389338d010ad77bf863d4fcef26d4" title="Convert hpticks [hptime] to usec.">hptime_to_us</a>((end - start) * 1000) % 1000);
<a name="l00134"></a>00134 <span class="preprocessor">        #endif</span>
<a name="l00135"></a>00135 <span class="preprocessor"></span>    }
<a name="l00136"></a>00136 }
</pre></div></div>
</div>


