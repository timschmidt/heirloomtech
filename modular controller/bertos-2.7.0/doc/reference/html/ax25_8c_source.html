

<!-- Generated by Doxygen 1.7.4 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="dir_9fd71c1ac00056e7d855336b2291c56c.html">bertos</a>      </li>
      <li class="navelem"><a class="el" href="dir_e91c80130e425b11d52da5b92a7aa933.html">net</a>      </li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">ax25.c</div>  </div>
</div>
<div class="contents">
<a href="ax25_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 
<a name="l00041"></a>00041 <span class="preprocessor">#include &quot;<a class="code" href="ax25_8h.html" title="Simple AX25 data link layer implementation.">ax25.h</a>&quot;</span>
<a name="l00042"></a>00042 <span class="preprocessor">#include &quot;<a class="code" href="cfg__ax25_8h.html" title="Configuration file for the AX25 protocol module.">cfg/cfg_ax25.h</a>&quot;</span>
<a name="l00043"></a>00043 
<a name="l00044"></a>00044 <span class="preprocessor">#include &lt;<a class="code" href="crc__ccitt_8h.html" title="CCITT Cyclic Redundancy Check (CRC-CCITT).">algo/crc_ccitt.h</a>&gt;</span>
<a name="l00045"></a>00045 
<a name="l00046"></a>00046 <span class="preprocessor">#define LOG_LEVEL  AX25_LOG_LEVEL</span>
<a name="l00047"></a>00047 <span class="preprocessor"></span><span class="preprocessor">#define LOG_FORMAT AX25_LOG_FORMAT</span>
<a name="l00048"></a>00048 <span class="preprocessor"></span><span class="preprocessor">#include &lt;<a class="code" href="log_8h.html">cfg/log.h</a>&gt;</span>
<a name="l00049"></a>00049 
<a name="l00050"></a>00050 <span class="preprocessor">#include &lt;string.h&gt;</span> <span class="comment">//memset, memcmp</span>
<a name="l00051"></a>00051 <span class="preprocessor">#include &lt;ctype.h&gt;</span>  <span class="comment">//isalnum, toupper</span>
<a name="l00052"></a>00052 
<a name="l00053"></a>00053 <span class="preprocessor">#if CONFIG_AX25_RPT_LST</span>
<a name="l00054"></a>00054 <span class="preprocessor"></span><span class="preprocessor">    #define AX25_SET_REPEATED(msg, idx, val) \</span>
<a name="l00055"></a>00055 <span class="preprocessor">        do \</span>
<a name="l00056"></a>00056 <span class="preprocessor">        { \</span>
<a name="l00057"></a>00057 <span class="preprocessor">            if (val) \</span>
<a name="l00058"></a>00058 <span class="preprocessor">                (msg)-&gt;rpt_flags |= BV(idx) ; \</span>
<a name="l00059"></a>00059 <span class="preprocessor">            else \</span>
<a name="l00060"></a>00060 <span class="preprocessor">                (msg)-&gt;rpt_flags &amp;= ~BV(idx) ; \</span>
<a name="l00061"></a>00061 <span class="preprocessor">        } while(0) </span>
<a name="l00062"></a>00062 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00063"></a>00063 <span class="preprocessor"></span>
<a name="l00064"></a>00064 <span class="preprocessor">#define DECODE_CALL(buf, addr) \</span>
<a name="l00065"></a>00065 <span class="preprocessor">    for (unsigned i = 0; i &lt; sizeof((addr)); i++) \</span>
<a name="l00066"></a>00066 <span class="preprocessor">    { \</span>
<a name="l00067"></a>00067 <span class="preprocessor">        char c = (*(buf)++ &gt;&gt; 1); \</span>
<a name="l00068"></a>00068 <span class="preprocessor">        (addr)[i] = (c == &#39; &#39;) ? &#39;\x0&#39; : c; \</span>
<a name="l00069"></a>00069 <span class="preprocessor">    }</span>
<a name="l00070"></a>00070 <span class="preprocessor"></span>
<a name="l00071"></a>00071 <span class="keyword">static</span> <span class="keywordtype">void</span> ax25_decode(<a class="code" href="structAX25Ctx.html" title="AX25 Protocol context.">AX25Ctx</a> *ctx)
<a name="l00072"></a>00072 {
<a name="l00073"></a>00073     <a class="code" href="structAX25Msg.html" title="AX25 Message.">AX25Msg</a> msg;
<a name="l00074"></a>00074     uint8_t *buf = ctx-&gt;<a class="code" href="structAX25Ctx.html#ab0ba422bb687dfaaecb7bcd704cd7b5c" title="buffer for received chars">buf</a>;
<a name="l00075"></a>00075 
<a name="l00076"></a>00076     DECODE_CALL(buf, msg.<a class="code" href="structAX25Msg.html#a38dc18966290b4f8cb24651e9e75ef66" title="Destination address.">dst</a>.<a class="code" href="structAX25Call.html#a40822310cacc1cc2ca715d8475953152" title="Call string, max 6 character.">call</a>);
<a name="l00077"></a>00077     msg.<a class="code" href="structAX25Msg.html#a38dc18966290b4f8cb24651e9e75ef66" title="Destination address.">dst</a>.<a class="code" href="structAX25Call.html#aab01f56f5e1cd0599dcf01f6a65b2415" title="SSID (secondary station ID) for the call.">ssid</a> = (*buf++ &gt;&gt; 1) &amp; 0x0F;
<a name="l00078"></a>00078 
<a name="l00079"></a>00079     DECODE_CALL(buf, msg.<a class="code" href="structAX25Msg.html#a1f0571ab6f708e1725ad9a8be8e6b28a" title="Source adress.">src</a>.<a class="code" href="structAX25Call.html#a40822310cacc1cc2ca715d8475953152" title="Call string, max 6 character.">call</a>);
<a name="l00080"></a>00080     msg.<a class="code" href="structAX25Msg.html#a1f0571ab6f708e1725ad9a8be8e6b28a" title="Source adress.">src</a>.<a class="code" href="structAX25Call.html#aab01f56f5e1cd0599dcf01f6a65b2415" title="SSID (secondary station ID) for the call.">ssid</a> = (*buf &gt;&gt; 1) &amp; 0x0F;
<a name="l00081"></a>00081 
<a name="l00082"></a>00082     <a class="code" href="group__logging.html#gaa5595314cc54c304a127c75cfcec4017" title="Output an informative message.">LOG_INFO</a>(<span class="stringliteral">&quot;SRC[%.6s-%d], DST[%.6s-%d]\n&quot;</span>, msg.<a class="code" href="structAX25Msg.html#a1f0571ab6f708e1725ad9a8be8e6b28a" title="Source adress.">src</a>.<a class="code" href="structAX25Call.html#a40822310cacc1cc2ca715d8475953152" title="Call string, max 6 character.">call</a>, msg.<a class="code" href="structAX25Msg.html#a1f0571ab6f708e1725ad9a8be8e6b28a" title="Source adress.">src</a>.<a class="code" href="structAX25Call.html#aab01f56f5e1cd0599dcf01f6a65b2415" title="SSID (secondary station ID) for the call.">ssid</a>, msg.<a class="code" href="structAX25Msg.html#a38dc18966290b4f8cb24651e9e75ef66" title="Destination address.">dst</a>.<a class="code" href="structAX25Call.html#a40822310cacc1cc2ca715d8475953152" title="Call string, max 6 character.">call</a>, msg.<a class="code" href="structAX25Msg.html#a38dc18966290b4f8cb24651e9e75ef66" title="Destination address.">dst</a>.<a class="code" href="structAX25Call.html#aab01f56f5e1cd0599dcf01f6a65b2415" title="SSID (secondary station ID) for the call.">ssid</a>);
<a name="l00083"></a>00083 
<a name="l00084"></a>00084     <span class="comment">/* Repeater addresses */</span>
<a name="l00085"></a>00085 <span class="preprocessor">    #if CONFIG_AX25_RPT_LST</span>
<a name="l00086"></a>00086 <span class="preprocessor"></span>        <span class="keywordflow">for</span> (msg.rpt_cnt = 0; !(*buf++ &amp; 0x01) &amp;&amp; (msg.rpt_cnt &lt; <a class="code" href="compiler_8h.html#a3c5cd622462bb50b6dab4c189e219eb9" title="Count the number of elements in the static array a.">countof</a>(msg.rpt_lst)); msg.rpt_cnt++)
<a name="l00087"></a>00087         {
<a name="l00088"></a>00088             DECODE_CALL(buf, msg.rpt_lst[msg.rpt_cnt].call);
<a name="l00089"></a>00089             msg.rpt_lst[msg.rpt_cnt].ssid = (*buf &gt;&gt; 1) &amp; 0x0F;
<a name="l00090"></a>00090             AX25_SET_REPEATED(&amp;msg, msg.rpt_cnt, (*buf &amp; 0x80));
<a name="l00091"></a>00091 
<a name="l00092"></a>00092             <a class="code" href="group__logging.html#gaa5595314cc54c304a127c75cfcec4017" title="Output an informative message.">LOG_INFO</a>(<span class="stringliteral">&quot;RPT%d[%.6s-%d]%c\n&quot;</span>, msg.rpt_cnt, 
<a name="l00093"></a>00093                 msg.rpt_lst[msg.rpt_cnt].call, 
<a name="l00094"></a>00094                 msg.rpt_lst[msg.rpt_cnt].ssid,
<a name="l00095"></a>00095                 (AX25_REPEATED(&amp;msg, msg.rpt_cnt) ? <span class="charliteral">&#39;*&#39;</span> : <span class="charliteral">&#39; &#39;</span>));
<a name="l00096"></a>00096         }
<a name="l00097"></a>00097 <span class="preprocessor">    #else</span>
<a name="l00098"></a>00098 <span class="preprocessor"></span>        <span class="keywordflow">while</span> (!(*buf++ &amp; 0x01))
<a name="l00099"></a>00099         {
<a name="l00100"></a>00100             <span class="keywordtype">char</span> rpt[6];
<a name="l00101"></a>00101             uint8_t ssid;
<a name="l00102"></a>00102             DECODE_CALL(buf, rpt);
<a name="l00103"></a>00103             ssid = (*buf &gt;&gt; 1) &amp; 0x0F;
<a name="l00104"></a>00104             <a class="code" href="group__logging.html#gaa5595314cc54c304a127c75cfcec4017" title="Output an informative message.">LOG_INFO</a>(<span class="stringliteral">&quot;RPT[%.6s-%d]\n&quot;</span>, rpt, ssid);
<a name="l00105"></a>00105         }
<a name="l00106"></a>00106 <span class="preprocessor">    #endif</span>
<a name="l00107"></a>00107 <span class="preprocessor"></span>
<a name="l00108"></a>00108     msg.<a class="code" href="structAX25Msg.html#a375105fdcb83cb525082d8dbc22c2d33" title="AX25 control field.">ctrl</a> = *buf++;
<a name="l00109"></a>00109     <span class="keywordflow">if</span> (msg.<a class="code" href="structAX25Msg.html#a375105fdcb83cb525082d8dbc22c2d33" title="AX25 control field.">ctrl</a> != AX25_CTRL_UI)
<a name="l00110"></a>00110     {
<a name="l00111"></a>00111         <a class="code" href="group__logging.html#ga8ebacc20e06eb7d7a9e2959e4db8cc5f" title="Output a warning message.">LOG_WARN</a>(<span class="stringliteral">&quot;Only UI frames are handled, got [%02X]\n&quot;</span>, msg.<a class="code" href="structAX25Msg.html#a375105fdcb83cb525082d8dbc22c2d33" title="AX25 control field.">ctrl</a>);
<a name="l00112"></a>00112         <span class="keywordflow">return</span>;
<a name="l00113"></a>00113     }
<a name="l00114"></a>00114 
<a name="l00115"></a>00115     msg.<a class="code" href="structAX25Msg.html#ae2e8532da38c1a6fac980377ab9b494b" title="AX25 PID field.">pid</a> = *buf++;
<a name="l00116"></a>00116     <span class="keywordflow">if</span> (msg.<a class="code" href="structAX25Msg.html#ae2e8532da38c1a6fac980377ab9b494b" title="AX25 PID field.">pid</a> != AX25_PID_NOLAYER3)
<a name="l00117"></a>00117     {
<a name="l00118"></a>00118         <a class="code" href="group__logging.html#ga8ebacc20e06eb7d7a9e2959e4db8cc5f" title="Output a warning message.">LOG_WARN</a>(<span class="stringliteral">&quot;Only frames without layer3 protocol are handled, got [%02X]\n&quot;</span>, msg.<a class="code" href="structAX25Msg.html#ae2e8532da38c1a6fac980377ab9b494b" title="AX25 PID field.">pid</a>);
<a name="l00119"></a>00119         <span class="keywordflow">return</span>;
<a name="l00120"></a>00120     }
<a name="l00121"></a>00121 
<a name="l00122"></a>00122     msg.<a class="code" href="structAX25Msg.html#a45b0f4c6c77aec02cd647b51e0f736e1" title="Payload length.">len</a> = ctx-&gt;<a class="code" href="structAX25Ctx.html#aaaf3150e7a61858d023c722e6fb46206" title="received frame length.">frm_len</a> - 2 - (buf - ctx-&gt;<a class="code" href="structAX25Ctx.html#ab0ba422bb687dfaaecb7bcd704cd7b5c" title="buffer for received chars">buf</a>);
<a name="l00123"></a>00123     msg.<a class="code" href="structAX25Msg.html#ac2aec986679b69baa42af40caf9a48bd" title="Pointer to the info field (payload) of the message.">info</a> = buf;
<a name="l00124"></a>00124     <a class="code" href="group__logging.html#gaa5595314cc54c304a127c75cfcec4017" title="Output an informative message.">LOG_INFO</a>(<span class="stringliteral">&quot;DATA: %.*s\n&quot;</span>, msg.<a class="code" href="structAX25Msg.html#a45b0f4c6c77aec02cd647b51e0f736e1" title="Payload length.">len</a>, msg.<a class="code" href="structAX25Msg.html#ac2aec986679b69baa42af40caf9a48bd" title="Pointer to the info field (payload) of the message.">info</a>);
<a name="l00125"></a>00125 
<a name="l00126"></a>00126     <span class="keywordflow">if</span> (ctx-&gt;<a class="code" href="structAX25Ctx.html#aaf4149ca8e0ac15cb846f57b5a2056cd" title="Hook function to be called when a message is received.">hook</a>)
<a name="l00127"></a>00127         ctx-&gt;<a class="code" href="structAX25Ctx.html#aaf4149ca8e0ac15cb846f57b5a2056cd" title="Hook function to be called when a message is received.">hook</a>(&amp;msg);
<a name="l00128"></a>00128 }
<a name="l00129"></a>00129 
<a name="l00130"></a>00130 
<a name="l00141"></a><a class="code" href="ax25_8h.html#a852682ef0f0f2764ea1dbacebfa2a4e7">00141</a> <span class="keywordtype">void</span> <a class="code" href="ax25_8c.html#a852682ef0f0f2764ea1dbacebfa2a4e7" title="Check if there are any AX25 messages to be processed.">ax25_poll</a>(<a class="code" href="structAX25Ctx.html" title="AX25 Protocol context.">AX25Ctx</a> *ctx)
<a name="l00142"></a>00142 {
<a name="l00143"></a>00143     <span class="keywordtype">int</span> c;
<a name="l00144"></a>00144 
<a name="l00145"></a>00145     <span class="keywordflow">while</span> ((c = <a class="code" href="group__io__kfile.html#ga09cca6f02dc337ddff2b36b66a3fdd1c" title="Generic getc() implementation using fd-&gt;read.">kfile_getc</a>(ctx-&gt;<a class="code" href="structAX25Ctx.html#a9eeed7428d5f20fe2b39d5ac70b09b44" title="KFile used to access the physical medium.">ch</a>)) != EOF)
<a name="l00146"></a>00146     {
<a name="l00147"></a>00147         <span class="keywordflow">if</span> (!ctx-&gt;<a class="code" href="structAX25Ctx.html#a2cf354b3ec66e851815667cf1ac43c06" title="True when we have to escape the following char.">escape</a> &amp;&amp; c == HDLC_FLAG)
<a name="l00148"></a>00148         {
<a name="l00149"></a>00149             <span class="keywordflow">if</span> (ctx-&gt;<a class="code" href="structAX25Ctx.html#aaaf3150e7a61858d023c722e6fb46206" title="received frame length.">frm_len</a> &gt;= <a class="code" href="ax25_8h.html#a4dc6bc53a35714e315e64780885500d5" title="Maximum size of a AX25 frame.">AX25_MIN_FRAME_LEN</a>)
<a name="l00150"></a>00150             {
<a name="l00151"></a>00151                 <span class="keywordflow">if</span> (ctx-&gt;<a class="code" href="structAX25Ctx.html#acba5c6c48b277cd5520a4060abac3a63" title="CRC for current received frame.">crc_in</a> == <a class="code" href="ax25_8h.html#ae8a60e641e91e4c15b901fdefa6809cf" title="CRC computation on correct AX25 packets should give this result (don&#39;t ask why).">AX25_CRC_CORRECT</a>)
<a name="l00152"></a>00152                 {
<a name="l00153"></a>00153                     <a class="code" href="group__logging.html#gaa5595314cc54c304a127c75cfcec4017" title="Output an informative message.">LOG_INFO</a>(<span class="stringliteral">&quot;Frame found!\n&quot;</span>);
<a name="l00154"></a>00154                     ax25_decode(ctx);
<a name="l00155"></a>00155                 }
<a name="l00156"></a>00156                 <span class="keywordflow">else</span>
<a name="l00157"></a>00157                 {
<a name="l00158"></a>00158                     <a class="code" href="group__logging.html#gaa5595314cc54c304a127c75cfcec4017" title="Output an informative message.">LOG_INFO</a>(<span class="stringliteral">&quot;CRC error, computed [%04X]\n&quot;</span>, ctx-&gt;<a class="code" href="structAX25Ctx.html#acba5c6c48b277cd5520a4060abac3a63" title="CRC for current received frame.">crc_in</a>);
<a name="l00159"></a>00159                 }
<a name="l00160"></a>00160             }
<a name="l00161"></a>00161             ctx-&gt;<a class="code" href="structAX25Ctx.html#a9ff9110cc05e86005aaab19c41aa3237" title="True if we have received a HDLC flag.">sync</a> = <span class="keyword">true</span>;
<a name="l00162"></a>00162             ctx-&gt;<a class="code" href="structAX25Ctx.html#acba5c6c48b277cd5520a4060abac3a63" title="CRC for current received frame.">crc_in</a> = <a class="code" href="crc__ccitt_8h.html#a4fc816f60939b5a504de4106680b111c" title="CRC-CCITT init value.">CRC_CCITT_INIT_VAL</a>;
<a name="l00163"></a>00163             ctx-&gt;<a class="code" href="structAX25Ctx.html#aaaf3150e7a61858d023c722e6fb46206" title="received frame length.">frm_len</a> = 0;
<a name="l00164"></a>00164             <span class="keywordflow">continue</span>;
<a name="l00165"></a>00165         }
<a name="l00166"></a>00166 
<a name="l00167"></a>00167         <span class="keywordflow">if</span> (!ctx-&gt;<a class="code" href="structAX25Ctx.html#a2cf354b3ec66e851815667cf1ac43c06" title="True when we have to escape the following char.">escape</a> &amp;&amp; c == HDLC_RESET)
<a name="l00168"></a>00168         {
<a name="l00169"></a>00169             <a class="code" href="group__logging.html#gaa5595314cc54c304a127c75cfcec4017" title="Output an informative message.">LOG_INFO</a>(<span class="stringliteral">&quot;HDLC reset\n&quot;</span>);
<a name="l00170"></a>00170             ctx-&gt;<a class="code" href="structAX25Ctx.html#a9ff9110cc05e86005aaab19c41aa3237" title="True if we have received a HDLC flag.">sync</a> = <span class="keyword">false</span>;
<a name="l00171"></a>00171             <span class="keywordflow">continue</span>;
<a name="l00172"></a>00172         }
<a name="l00173"></a>00173 
<a name="l00174"></a>00174         <span class="keywordflow">if</span> (!ctx-&gt;<a class="code" href="structAX25Ctx.html#a2cf354b3ec66e851815667cf1ac43c06" title="True when we have to escape the following char.">escape</a> &amp;&amp; c == AX25_ESC)
<a name="l00175"></a>00175         {
<a name="l00176"></a>00176             ctx-&gt;<a class="code" href="structAX25Ctx.html#a2cf354b3ec66e851815667cf1ac43c06" title="True when we have to escape the following char.">escape</a> = <span class="keyword">true</span>;
<a name="l00177"></a>00177             <span class="keywordflow">continue</span>;
<a name="l00178"></a>00178         }
<a name="l00179"></a>00179 
<a name="l00180"></a>00180         <span class="keywordflow">if</span> (ctx-&gt;<a class="code" href="structAX25Ctx.html#a9ff9110cc05e86005aaab19c41aa3237" title="True if we have received a HDLC flag.">sync</a>)
<a name="l00181"></a>00181         {
<a name="l00182"></a>00182             <span class="keywordflow">if</span> (ctx-&gt;<a class="code" href="structAX25Ctx.html#aaaf3150e7a61858d023c722e6fb46206" title="received frame length.">frm_len</a> &lt; <a class="code" href="cfg__ax25_8h.html#a7814a5985786c36227869bfc41932ac5" title="AX25 frame buffer lenght.">CONFIG_AX25_FRAME_BUF_LEN</a>)
<a name="l00183"></a>00183             {
<a name="l00184"></a>00184                 ctx-&gt;<a class="code" href="structAX25Ctx.html#ab0ba422bb687dfaaecb7bcd704cd7b5c" title="buffer for received chars">buf</a>[ctx-&gt;<a class="code" href="structAX25Ctx.html#aaaf3150e7a61858d023c722e6fb46206" title="received frame length.">frm_len</a>++] = c;
<a name="l00185"></a>00185                 ctx-&gt;<a class="code" href="structAX25Ctx.html#acba5c6c48b277cd5520a4060abac3a63" title="CRC for current received frame.">crc_in</a> = <a class="code" href="crc__ccitt_8h.html#a02d1ffc2b83acd5dd0f80d44336a754b" title="Compute the updated CRC-CCITT value for one octet (inline version)">updcrc_ccitt</a>(c, ctx-&gt;<a class="code" href="structAX25Ctx.html#acba5c6c48b277cd5520a4060abac3a63" title="CRC for current received frame.">crc_in</a>);
<a name="l00186"></a>00186             }
<a name="l00187"></a>00187             <span class="keywordflow">else</span>
<a name="l00188"></a>00188             {
<a name="l00189"></a>00189                 <a class="code" href="group__logging.html#gaa5595314cc54c304a127c75cfcec4017" title="Output an informative message.">LOG_INFO</a>(<span class="stringliteral">&quot;Buffer overrun&quot;</span>);
<a name="l00190"></a>00190                 ctx-&gt;<a class="code" href="structAX25Ctx.html#a9ff9110cc05e86005aaab19c41aa3237" title="True if we have received a HDLC flag.">sync</a> = <span class="keyword">false</span>;
<a name="l00191"></a>00191             }
<a name="l00192"></a>00192         }
<a name="l00193"></a>00193         ctx-&gt;<a class="code" href="structAX25Ctx.html#a2cf354b3ec66e851815667cf1ac43c06" title="True when we have to escape the following char.">escape</a> = <span class="keyword">false</span>;
<a name="l00194"></a>00194     }
<a name="l00195"></a>00195 
<a name="l00196"></a>00196     <span class="keywordflow">if</span> (<a class="code" href="group__io__kfile.html#ga9638c7d7f76976a58ceb670c28e13c39" title="Get file error mask.">kfile_error</a>(ctx-&gt;<a class="code" href="structAX25Ctx.html#a9eeed7428d5f20fe2b39d5ac70b09b44" title="KFile used to access the physical medium.">ch</a>))
<a name="l00197"></a>00197     {
<a name="l00198"></a>00198         <a class="code" href="group__logging.html#ga19c97c740010c52ce6801d46a5346644" title="Output an error message.">LOG_ERR</a>(<span class="stringliteral">&quot;Channel error [%04x]\n&quot;</span>, <a class="code" href="group__io__kfile.html#ga9638c7d7f76976a58ceb670c28e13c39" title="Get file error mask.">kfile_error</a>(ctx-&gt;<a class="code" href="structAX25Ctx.html#a9eeed7428d5f20fe2b39d5ac70b09b44" title="KFile used to access the physical medium.">ch</a>));
<a name="l00199"></a>00199         <a class="code" href="group__io__kfile.html#ga40a4b4a6c5b44f6377e51e7484650324" title="Clear errors.">kfile_clearerr</a>(ctx-&gt;<a class="code" href="structAX25Ctx.html#a9eeed7428d5f20fe2b39d5ac70b09b44" title="KFile used to access the physical medium.">ch</a>);
<a name="l00200"></a>00200     }
<a name="l00201"></a>00201 }
<a name="l00202"></a>00202 
<a name="l00203"></a>00203 <span class="keyword">static</span> <span class="keywordtype">void</span> ax25_putchar(<a class="code" href="structAX25Ctx.html" title="AX25 Protocol context.">AX25Ctx</a> *ctx, uint8_t c)
<a name="l00204"></a>00204 {
<a name="l00205"></a>00205     <span class="keywordflow">if</span> (c == HDLC_FLAG || c == HDLC_RESET
<a name="l00206"></a>00206         || c == AX25_ESC)
<a name="l00207"></a>00207         <a class="code" href="group__io__kfile.html#ga480c14426dc77cdfd786c3b5b9a9adf2" title="Generic putc() implementation using fd-&gt;write.">kfile_putc</a>(AX25_ESC, ctx-&gt;<a class="code" href="structAX25Ctx.html#a9eeed7428d5f20fe2b39d5ac70b09b44" title="KFile used to access the physical medium.">ch</a>);
<a name="l00208"></a>00208     ctx-&gt;<a class="code" href="structAX25Ctx.html#aea6a6b921e34e3ed514e4598a907adf1" title="CRC of current sent frame.">crc_out</a> = <a class="code" href="crc__ccitt_8h.html#a02d1ffc2b83acd5dd0f80d44336a754b" title="Compute the updated CRC-CCITT value for one octet (inline version)">updcrc_ccitt</a>(c, ctx-&gt;<a class="code" href="structAX25Ctx.html#aea6a6b921e34e3ed514e4598a907adf1" title="CRC of current sent frame.">crc_out</a>);
<a name="l00209"></a>00209     <a class="code" href="group__io__kfile.html#ga480c14426dc77cdfd786c3b5b9a9adf2" title="Generic putc() implementation using fd-&gt;write.">kfile_putc</a>(c, ctx-&gt;<a class="code" href="structAX25Ctx.html#a9eeed7428d5f20fe2b39d5ac70b09b44" title="KFile used to access the physical medium.">ch</a>);
<a name="l00210"></a>00210 }
<a name="l00211"></a>00211 
<a name="l00212"></a>00212 <span class="keyword">static</span> <span class="keywordtype">void</span> ax25_sendCall(<a class="code" href="structAX25Ctx.html" title="AX25 Protocol context.">AX25Ctx</a> *ctx, <span class="keyword">const</span> <a class="code" href="structAX25Call.html" title="AX25 Call sign.">AX25Call</a> *addr, <span class="keywordtype">bool</span> last)
<a name="l00213"></a>00213 {
<a name="l00214"></a>00214     <span class="keywordtype">unsigned</span> len = MIN(<span class="keyword">sizeof</span>(addr-&gt;<a class="code" href="structAX25Call.html#a40822310cacc1cc2ca715d8475953152" title="Call string, max 6 character.">call</a>), strlen(addr-&gt;<a class="code" href="structAX25Call.html#a40822310cacc1cc2ca715d8475953152" title="Call string, max 6 character.">call</a>));
<a name="l00215"></a>00215 
<a name="l00216"></a>00216     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> i = 0; i &lt; len; i++)
<a name="l00217"></a>00217     {
<a name="l00218"></a>00218         uint8_t c = addr-&gt;<a class="code" href="structAX25Call.html#a40822310cacc1cc2ca715d8475953152" title="Call string, max 6 character.">call</a>[i];
<a name="l00219"></a>00219         <a class="code" href="group__debug.html#gaca68c0d4ac8df0838e209fb5300f7be3" title="Assert a pre-condition on code.">ASSERT</a>(isalnum(c) || c == <span class="charliteral">&#39; &#39;</span>);
<a name="l00220"></a>00220         c = toupper(c);
<a name="l00221"></a>00221         ax25_putchar(ctx, c &lt;&lt; 1);
<a name="l00222"></a>00222     }
<a name="l00223"></a>00223 
<a name="l00224"></a>00224     <span class="comment">/* Fill with spaces the rest of the CALL if it&#39;s shorter */</span>
<a name="l00225"></a>00225     <span class="keywordflow">if</span> (len &lt; <span class="keyword">sizeof</span>(addr-&gt;<a class="code" href="structAX25Call.html#a40822310cacc1cc2ca715d8475953152" title="Call string, max 6 character.">call</a>))
<a name="l00226"></a>00226         <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> i = 0; i &lt; <span class="keyword">sizeof</span>(addr-&gt;<a class="code" href="structAX25Call.html#a40822310cacc1cc2ca715d8475953152" title="Call string, max 6 character.">call</a>) - len; i++)
<a name="l00227"></a>00227             ax25_putchar(ctx, <span class="charliteral">&#39; &#39;</span> &lt;&lt; 1);
<a name="l00228"></a>00228 
<a name="l00229"></a>00229     <span class="comment">/* The bit7 &quot;has-been-repeated&quot; flag is not implemented here */</span>
<a name="l00230"></a>00230     <span class="comment">/* Bits6:5 should be set to 1 for all SSIDs (0x60) */</span>
<a name="l00231"></a>00231     <span class="comment">/* The bit0 of last call SSID should be set to 1 */</span>
<a name="l00232"></a>00232     uint8_t ssid = 0x60 | (addr-&gt;<a class="code" href="structAX25Call.html#aab01f56f5e1cd0599dcf01f6a65b2415" title="SSID (secondary station ID) for the call.">ssid</a> &lt;&lt; 1) | (last ? 0x01 : 0);
<a name="l00233"></a>00233     ax25_putchar(ctx, ssid);
<a name="l00234"></a>00234 }
<a name="l00235"></a>00235 
<a name="l00245"></a><a class="code" href="ax25_8h.html#aeb4be1c44c0faeb1fc73dbb04ac59a6e">00245</a> <span class="keywordtype">void</span> <a class="code" href="ax25_8c.html#aeb4be1c44c0faeb1fc73dbb04ac59a6e" title="Send an AX25 frame on the channel through a specific path.">ax25_sendVia</a>(<a class="code" href="structAX25Ctx.html" title="AX25 Protocol context.">AX25Ctx</a> *ctx, <span class="keyword">const</span> <a class="code" href="structAX25Call.html" title="AX25 Call sign.">AX25Call</a> *path, <span class="keywordtype">size_t</span> path_len, <span class="keyword">const</span> <span class="keywordtype">void</span> *_buf, <span class="keywordtype">size_t</span> len)
<a name="l00246"></a>00246 {
<a name="l00247"></a>00247     <span class="keyword">const</span> uint8_t *buf = (<span class="keyword">const</span> uint8_t *)_buf;
<a name="l00248"></a>00248     <a class="code" href="group__debug.html#gaca68c0d4ac8df0838e209fb5300f7be3" title="Assert a pre-condition on code.">ASSERT</a>(path);
<a name="l00249"></a>00249     <a class="code" href="group__debug.html#gaca68c0d4ac8df0838e209fb5300f7be3" title="Assert a pre-condition on code.">ASSERT</a>(path_len &gt;= 2);
<a name="l00250"></a>00250 
<a name="l00251"></a>00251     ctx-&gt;<a class="code" href="structAX25Ctx.html#aea6a6b921e34e3ed514e4598a907adf1" title="CRC of current sent frame.">crc_out</a> = <a class="code" href="crc__ccitt_8h.html#a4fc816f60939b5a504de4106680b111c" title="CRC-CCITT init value.">CRC_CCITT_INIT_VAL</a>;
<a name="l00252"></a>00252     <a class="code" href="group__io__kfile.html#ga480c14426dc77cdfd786c3b5b9a9adf2" title="Generic putc() implementation using fd-&gt;write.">kfile_putc</a>(HDLC_FLAG, ctx-&gt;<a class="code" href="structAX25Ctx.html#a9eeed7428d5f20fe2b39d5ac70b09b44" title="KFile used to access the physical medium.">ch</a>);
<a name="l00253"></a>00253 
<a name="l00254"></a>00254 
<a name="l00255"></a>00255     <span class="comment">/* Send call */</span>
<a name="l00256"></a>00256     <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i = 0; i &lt; path_len; i++)
<a name="l00257"></a>00257         ax25_sendCall(ctx, &amp;path[i], (i == path_len - 1));
<a name="l00258"></a>00258 
<a name="l00259"></a>00259     ax25_putchar(ctx, AX25_CTRL_UI);
<a name="l00260"></a>00260     ax25_putchar(ctx, AX25_PID_NOLAYER3);
<a name="l00261"></a>00261 
<a name="l00262"></a>00262     <span class="keywordflow">while</span> (len--)
<a name="l00263"></a>00263         ax25_putchar(ctx, *buf++);
<a name="l00264"></a>00264 
<a name="l00265"></a>00265     <span class="comment">/*</span>
<a name="l00266"></a>00266 <span class="comment">     * According to AX25 protocol,</span>
<a name="l00267"></a>00267 <span class="comment">     * CRC is sent in reverse order!</span>
<a name="l00268"></a>00268 <span class="comment">     */</span>
<a name="l00269"></a>00269     uint8_t crcl = (ctx-&gt;<a class="code" href="structAX25Ctx.html#aea6a6b921e34e3ed514e4598a907adf1" title="CRC of current sent frame.">crc_out</a> &amp; 0xff) ^ 0xff;
<a name="l00270"></a>00270     uint8_t crch = (ctx-&gt;<a class="code" href="structAX25Ctx.html#aea6a6b921e34e3ed514e4598a907adf1" title="CRC of current sent frame.">crc_out</a> &gt;&gt; 8) ^ 0xff;
<a name="l00271"></a>00271     ax25_putchar(ctx, crcl);
<a name="l00272"></a>00272     ax25_putchar(ctx, crch);
<a name="l00273"></a>00273 
<a name="l00274"></a>00274     <a class="code" href="group__debug.html#gaca68c0d4ac8df0838e209fb5300f7be3" title="Assert a pre-condition on code.">ASSERT</a>(ctx-&gt;<a class="code" href="structAX25Ctx.html#aea6a6b921e34e3ed514e4598a907adf1" title="CRC of current sent frame.">crc_out</a> == <a class="code" href="ax25_8h.html#ae8a60e641e91e4c15b901fdefa6809cf" title="CRC computation on correct AX25 packets should give this result (don&#39;t ask why).">AX25_CRC_CORRECT</a>);
<a name="l00275"></a>00275 
<a name="l00276"></a>00276     <a class="code" href="group__io__kfile.html#ga480c14426dc77cdfd786c3b5b9a9adf2" title="Generic putc() implementation using fd-&gt;write.">kfile_putc</a>(HDLC_FLAG, ctx-&gt;<a class="code" href="structAX25Ctx.html#a9eeed7428d5f20fe2b39d5ac70b09b44" title="KFile used to access the physical medium.">ch</a>);
<a name="l00277"></a>00277 }
<a name="l00278"></a>00278 
<a name="l00279"></a>00279 <span class="keyword">static</span> <span class="keywordtype">void</span> print_call(<a class="code" href="structKFile.html" title="Context data for callback functions which operate on pseudo files.">KFile</a> *ch, <span class="keyword">const</span> <a class="code" href="structAX25Call.html" title="AX25 Call sign.">AX25Call</a> *call)
<a name="l00280"></a>00280 {
<a name="l00281"></a>00281     <a class="code" href="group__io__kfile.html#gaa04c60fc2dec055903884ab7d4a09111" title="Formatted write.">kfile_printf</a>(ch, <span class="stringliteral">&quot;%.6s&quot;</span>, call-&gt;<a class="code" href="structAX25Call.html#a40822310cacc1cc2ca715d8475953152" title="Call string, max 6 character.">call</a>);
<a name="l00282"></a>00282     <span class="keywordflow">if</span> (call-&gt;<a class="code" href="structAX25Call.html#aab01f56f5e1cd0599dcf01f6a65b2415" title="SSID (secondary station ID) for the call.">ssid</a>)
<a name="l00283"></a>00283         <a class="code" href="group__io__kfile.html#gaa04c60fc2dec055903884ab7d4a09111" title="Formatted write.">kfile_printf</a>(ch, <span class="stringliteral">&quot;-%d&quot;</span>, call-&gt;<a class="code" href="structAX25Call.html#aab01f56f5e1cd0599dcf01f6a65b2415" title="SSID (secondary station ID) for the call.">ssid</a>);
<a name="l00284"></a>00284 }
<a name="l00285"></a>00285 
<a name="l00291"></a><a class="code" href="ax25_8h.html#a90563f3e3c197ea55f024dfaf7891aeb">00291</a> <span class="keywordtype">void</span> <a class="code" href="ax25_8c.html#a90563f3e3c197ea55f024dfaf7891aeb" title="Print a AX25 message in TNC-2 packet monitor format.">ax25_print</a>(<a class="code" href="structKFile.html" title="Context data for callback functions which operate on pseudo files.">KFile</a> *ch, <span class="keyword">const</span> <a class="code" href="structAX25Msg.html" title="AX25 Message.">AX25Msg</a> *msg)
<a name="l00292"></a>00292 {
<a name="l00293"></a>00293     print_call(ch, &amp;msg-&gt;<a class="code" href="structAX25Msg.html#a1f0571ab6f708e1725ad9a8be8e6b28a" title="Source adress.">src</a>);
<a name="l00294"></a>00294     <a class="code" href="group__io__kfile.html#ga480c14426dc77cdfd786c3b5b9a9adf2" title="Generic putc() implementation using fd-&gt;write.">kfile_putc</a>(<span class="charliteral">&#39;&gt;&#39;</span>, ch);
<a name="l00295"></a>00295     print_call(ch, &amp;msg-&gt;<a class="code" href="structAX25Msg.html#a38dc18966290b4f8cb24651e9e75ef66" title="Destination address.">dst</a>);
<a name="l00296"></a>00296 
<a name="l00297"></a>00297 <span class="preprocessor">    #if CONFIG_AX25_RPT_LST</span>
<a name="l00298"></a>00298 <span class="preprocessor"></span>    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; msg-&gt;rpt_cnt; i++)
<a name="l00299"></a>00299     {
<a name="l00300"></a>00300         <a class="code" href="group__io__kfile.html#ga480c14426dc77cdfd786c3b5b9a9adf2" title="Generic putc() implementation using fd-&gt;write.">kfile_putc</a>(<span class="charliteral">&#39;,&#39;</span>, ch);
<a name="l00301"></a>00301         print_call(ch, &amp;msg-&gt;rpt_lst[i]);
<a name="l00302"></a>00302         <span class="comment">/* Print a &#39;*&#39; if packet has already been transmitted </span>
<a name="l00303"></a>00303 <span class="comment">         * by this repeater */</span>
<a name="l00304"></a>00304         <span class="keywordflow">if</span> (AX25_REPEATED(msg, i))
<a name="l00305"></a>00305             <a class="code" href="group__io__kfile.html#ga480c14426dc77cdfd786c3b5b9a9adf2" title="Generic putc() implementation using fd-&gt;write.">kfile_putc</a>(<span class="charliteral">&#39;*&#39;</span>, ch);
<a name="l00306"></a>00306     }
<a name="l00307"></a>00307 <span class="preprocessor">    #endif</span>
<a name="l00308"></a>00308 <span class="preprocessor"></span>
<a name="l00309"></a>00309     <a class="code" href="group__io__kfile.html#gaa04c60fc2dec055903884ab7d4a09111" title="Formatted write.">kfile_printf</a>(ch, <span class="stringliteral">&quot;:%.*s\n&quot;</span>, msg-&gt;<a class="code" href="structAX25Msg.html#a45b0f4c6c77aec02cd647b51e0f736e1" title="Payload length.">len</a>, msg-&gt;<a class="code" href="structAX25Msg.html#ac2aec986679b69baa42af40caf9a48bd" title="Pointer to the info field (payload) of the message.">info</a>);
<a name="l00310"></a>00310 }
<a name="l00311"></a>00311 
<a name="l00312"></a>00312 
<a name="l00320"></a><a class="code" href="ax25_8h.html#a3144cd329146fff767b284401511313f">00320</a> <span class="keywordtype">void</span> <a class="code" href="ax25_8c.html#a3144cd329146fff767b284401511313f" title="Init the AX25 protocol decoder.">ax25_init</a>(<a class="code" href="structAX25Ctx.html" title="AX25 Protocol context.">AX25Ctx</a> *ctx, <a class="code" href="structKFile.html" title="Context data for callback functions which operate on pseudo files.">KFile</a> *channel, <a class="code" href="ax25_8h.html#ac2f79198fd7eec52cc825dd92cec7400" title="Type for AX25 messages callback.">ax25_callback_t</a> hook)
<a name="l00321"></a>00321 {
<a name="l00322"></a>00322     <a class="code" href="group__debug.html#gaca68c0d4ac8df0838e209fb5300f7be3" title="Assert a pre-condition on code.">ASSERT</a>(ctx);
<a name="l00323"></a>00323     <a class="code" href="group__debug.html#gaca68c0d4ac8df0838e209fb5300f7be3" title="Assert a pre-condition on code.">ASSERT</a>(channel);
<a name="l00324"></a>00324 
<a name="l00325"></a>00325     memset(ctx, 0, <span class="keyword">sizeof</span>(*ctx));
<a name="l00326"></a>00326     ctx-&gt;<a class="code" href="structAX25Ctx.html#a9eeed7428d5f20fe2b39d5ac70b09b44" title="KFile used to access the physical medium.">ch</a> = channel;
<a name="l00327"></a>00327     ctx-&gt;<a class="code" href="structAX25Ctx.html#aaf4149ca8e0ac15cb846f57b5a2056cd" title="Hook function to be called when a message is received.">hook</a> = hook;
<a name="l00328"></a>00328     ctx-&gt;<a class="code" href="structAX25Ctx.html#acba5c6c48b277cd5520a4060abac3a63" title="CRC for current received frame.">crc_in</a> = ctx-&gt;<a class="code" href="structAX25Ctx.html#aea6a6b921e34e3ed514e4598a907adf1" title="CRC of current sent frame.">crc_out</a> = <a class="code" href="crc__ccitt_8h.html#a4fc816f60939b5a504de4106680b111c" title="CRC-CCITT init value.">CRC_CCITT_INIT_VAL</a>;
<a name="l00329"></a>00329 }
</pre></div></div>
</div>


