

<!-- Generated by Doxygen 1.7.4 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="dir_9fd71c1ac00056e7d855336b2291c56c.html">bertos</a>      </li>
      <li class="navelem"><a class="el" href="dir_e91c80130e425b11d52da5b92a7aa933.html">net</a>      </li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="summary">
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle">
<div class="title">pocketbus.c File Reference</div>  </div>
</div>
<div class="contents">

<p>pocketBus protocol implementation.  
<a href="#details">More...</a></p>
<div class="textblock"><code>#include &quot;<a class="el" href="pocketbus_8h_source.html">pocketbus.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="cfg__pocketbus_8h_source.html">cfg/cfg_pocketbus.h</a>&quot;</code><br/>
<code>#include &lt;<a class="el" href="log_8h_source.html">cfg/log.h</a>&gt;</code><br/>
<code>#include &lt;<a class="el" href="debug_8h_source.html">cfg/debug.h</a>&gt;</code><br/>
<code>#include &lt;<a class="el" href="macros_8h_source.html">cfg/macros.h</a>&gt;</code><br/>
<code>#include &lt;<a class="el" href="io_2kfile_8h_source.html">io/kfile.h</a>&gt;</code><br/>
<code>#include &lt;<a class="el" href="cpu_2byteorder_8h_source.html">cpu/byteorder.h</a>&gt;</code><br/>
<code>#include &lt;string.h&gt;</code><br/>
</div>
<p><a href="pocketbus_8c_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr><td colspan="2"><h2><a name="func-members"></a>
Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="ae6a9a07114695dc497be7a9d19dfc153"></a><!-- doxytag: member="pocketbus.c::pocketbus_putchar" ref="ae6a9a07114695dc497be7a9d19dfc153" args="(struct PocketBusCtx *ctx, uint8_t c)" -->
void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="pocketbus_8c.html#ae6a9a07114695dc497be7a9d19dfc153">pocketbus_putchar</a> (struct <a class="el" href="structPocketBusCtx.html">PocketBusCtx</a> *ctx, uint8_t c)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Send a character over pocketBus channel stream, handling escape mode. <br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a9e64fea54236836ebbb111188a386213"></a><!-- doxytag: member="pocketbus.c::pocketbus_begin" ref="a9e64fea54236836ebbb111188a386213" args="(struct PocketBusCtx *ctx, pocketbus_addr_t addr)" -->
void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="pocketbus_8c.html#a9e64fea54236836ebbb111188a386213">pocketbus_begin</a> (struct <a class="el" href="structPocketBusCtx.html">PocketBusCtx</a> *ctx, <a class="el" href="pocketbus_8h.html#af63b5ecec3f1a8ffaf7d711181392dec">pocketbus_addr_t</a> addr)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Send pocketBus packet header. <br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a9589e76fc410f9fed1b25807baf8ba6d"></a><!-- doxytag: member="pocketbus.c::pocketbus_write" ref="a9589e76fc410f9fed1b25807baf8ba6d" args="(struct PocketBusCtx *ctx, const void *_data, size_t len)" -->
void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="pocketbus_8c.html#a9589e76fc410f9fed1b25807baf8ba6d">pocketbus_write</a> (struct <a class="el" href="structPocketBusCtx.html">PocketBusCtx</a> *ctx, const void *_data, size_t len)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Send buffer <em>_data</em> over bus, handling escape. <br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="ac87ef3191ab444e8a02abd7819a7d068"></a><!-- doxytag: member="pocketbus.c::pocketbus_end" ref="ac87ef3191ab444e8a02abd7819a7d068" args="(struct PocketBusCtx *ctx)" -->
void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="pocketbus_8c.html#ac87ef3191ab444e8a02abd7819a7d068">pocketbus_end</a> (struct <a class="el" href="structPocketBusCtx.html">PocketBusCtx</a> *ctx)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Send pocketBus packet tail. <br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="afd291395155722155fc63cd63a0e1b15"></a><!-- doxytag: member="pocketbus.c::pocketbus_send" ref="afd291395155722155fc63cd63a0e1b15" args="(struct PocketBusCtx *ctx, pocketbus_addr_t addr, const void *data, size_t len)" -->
void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="pocketbus_8c.html#afd291395155722155fc63cd63a0e1b15">pocketbus_send</a> (struct <a class="el" href="structPocketBusCtx.html">PocketBusCtx</a> *ctx, <a class="el" href="pocketbus_8h.html#af63b5ecec3f1a8ffaf7d711181392dec">pocketbus_addr_t</a> addr, const void *data, size_t len)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Send buffer of <em>data</em> to address <em>addr</em> with a pocketBus packet over channel stream. <br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="pocketbus_8c.html#ab5c6bf4b8545d77f30c6f92f97684106">pocketbus_recv</a> (struct <a class="el" href="structPocketBusCtx.html">PocketBusCtx</a> *ctx, struct <a class="el" href="structPocketMsg.html">PocketMsg</a> *msg)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Try to read a packet from the pocketBus.  <a href="#ab5c6bf4b8545d77f30c6f92f97684106"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a35e365a7ea36ce352e9895d01d81b8a8"></a><!-- doxytag: member="pocketbus.c::pocketbus_init" ref="a35e365a7ea36ce352e9895d01d81b8a8" args="(struct PocketBusCtx *ctx, struct KFile *fd)" -->
void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="pocketbus_8c.html#a35e365a7ea36ce352e9895d01d81b8a8">pocketbus_init</a> (struct <a class="el" href="structPocketBusCtx.html">PocketBusCtx</a> *ctx, struct <a class="el" href="structKFile.html">KFile</a> *fd)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Initialize pocketBus protocol handler. <br/></td></tr>
</table>
<hr/><a name="details" id="details"></a><h2>Detailed Description</h2>
<div class="textblock"><p>pocketBus protocol implementation. </p>
<p>pocketBus protocol is a simple strictly master-slave protocol, usable in embedded systems. pocketBus frame is as follows: </p>
<pre>
 +----------------------------------------+
 | STX | VER | ADDR | PAYLOAD | CKS | ETX |
 +----------------------------------------+
 |     |     |      |         |     |     |
 + 1B  + 1B  +  2B  + N Byte  + 2B  + 1B  +
 </pre><ul>
<li>STX, 1 byte (0x02), packet start</li>
<li>VER, 1 byte, packet version</li>
<li>ADDR, 2 byte, slave address</li>
<li>PAYLOAD, N byte, data field</li>
<li>CKS, 2 byte, checksum</li>
<li>ETX, 1 byte, (0x03) packet end</li>
</ul>
<p>Protocol parsing start on STX reception. When the receiving routine finds an STX char, it starts to read characters from the bus until an ETX is received. Once a packet is received, the parser checks packet correctness and checksum. If all is OK the payload is returned.</p>
<p>STX (0x02), ETX(0x03) and ESC(0x1B) are special characters and cannot be transmitted inside payload without escaping them. To escape a character you must precede it by the ESC char. E.G. STX -&gt; ESC + STX ETX -&gt; ESC + ETX ESC -&gt; ESC + ESC</p>
<p>In the ADDR field is always specified the slave address. In the case of master trasmitting, ADDR contains the slave destination address. In case of slave replying, ADDR contains the slave address itself. Thus, the master device does not have an address. Packet must be routed to master by hardware bus design.</p>
<p>The checksum algorithm used is rotating hash algortihm, quite simple but more reliable than simple checksum. The checksum in computed on all fields excluding STX, ETX and CHK fields itself. Checksum is computed on the packet *before* escaping. Escape sequence counts for 1 character only (the escaped one). </p>

<p>Definition in file <a class="el" href="pocketbus_8c_source.html">pocketbus.c</a>.</p>
</div><hr/><h2>Function Documentation</h2>
<a class="anchor" id="ab5c6bf4b8545d77f30c6f92f97684106"></a><!-- doxytag: member="pocketbus.c::pocketbus_recv" ref="ab5c6bf4b8545d77f30c6f92f97684106" args="(struct PocketBusCtx *ctx, struct PocketMsg *msg)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool pocketbus_recv </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structPocketBusCtx.html">PocketBusCtx</a> *&#160;</td>
          <td class="paramname"><em>ctx</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structPocketMsg.html">PocketMsg</a> *&#160;</td>
          <td class="paramname"><em>msg</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Try to read a packet from the pocketBus. </p>
<dl class="return"><dt><b>Returns:</b></dt><dd>true if a packet is received, false otherwise. </dd></dl>

<p>Definition at line <a class="el" href="pocketbus_8c_source.html#l00171">171</a> of file <a class="el" href="pocketbus_8c_source.html">pocketbus.c</a>.</p>

</div>
</div>
</div>


