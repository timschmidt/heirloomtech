

<!-- Generated by Doxygen 1.7.4 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="dir_9fd71c1ac00056e7d855336b2291c56c.html">bertos</a>      </li>
      <li class="navelem"><a class="el" href="dir_a5de7543e32a5f073daa04f8834eb5fd.html">cpu</a>      </li>
      <li class="navelem"><a class="el" href="dir_b85b1b77342b0233aa6bdb4655adc5e9.html">cortex-m3</a>      </li>
      <li class="navelem"><a class="el" href="dir_67d33e4ffe4ff938d746541f95b62a0f.html">drv</a>      </li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">adc_sam3.c</div>  </div>
</div>
<div class="contents">
<a href="adc__sam3_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 
<a name="l00039"></a>00039 <span class="preprocessor">#include &quot;<a class="code" href="adc__sam3_8h.html" title="ADC hardware-specific definition.">adc_sam3.h</a>&quot;</span>
<a name="l00040"></a>00040 
<a name="l00041"></a>00041 <span class="preprocessor">#include &quot;<a class="code" href="cfg__adc_8h.html" title="Configuration file for the ADC module.">cfg/cfg_adc.h</a>&quot;</span>
<a name="l00042"></a>00042 
<a name="l00043"></a>00043 <span class="preprocessor">#include &lt;<a class="code" href="macros_8h.html">cfg/macros.h</a>&gt;</span>
<a name="l00044"></a>00044 <span class="preprocessor">#include &lt;<a class="code" href="compiler_8h.html" title="Additional support macros for compiler independance.">cfg/compiler.h</a>&gt;</span>
<a name="l00045"></a>00045 
<a name="l00046"></a>00046 <span class="comment">// Define log settings for cfg/log.h.</span>
<a name="l00047"></a>00047 <span class="preprocessor">#define LOG_LEVEL         ADC_LOG_LEVEL</span>
<a name="l00048"></a>00048 <span class="preprocessor"></span><span class="preprocessor">#define LOG_FORMAT        ADC_LOG_FORMAT</span>
<a name="l00049"></a>00049 <span class="preprocessor"></span><span class="preprocessor">#include &lt;<a class="code" href="log_8h.html">cfg/log.h</a>&gt;</span>
<a name="l00050"></a>00050 
<a name="l00051"></a>00051 <span class="preprocessor">#include &lt;<a class="code" href="adc_8h.html">drv/adc.h</a>&gt;</span>
<a name="l00052"></a>00052 <span class="preprocessor">#include &lt;<a class="code" href="irq__cm3_8h.html" title="IRQ management for the Cortex-M3 processor.">drv/irq_cm3.h</a>&gt;</span>
<a name="l00053"></a>00053 
<a name="l00054"></a>00054 <span class="preprocessor">#include &lt;<a class="code" href="cpu_2irq_8h.html" title="CPU-specific IRQ definitions.">cpu/irq.h</a>&gt;</span>
<a name="l00055"></a>00055 
<a name="l00056"></a>00056 <span class="preprocessor">#include &lt;<a class="code" href="event_8h.html">mware/event.h</a>&gt;</span>
<a name="l00057"></a>00057 
<a name="l00058"></a>00058 <span class="preprocessor">#include &lt;<a class="code" href="cm3_8h.html" title="Low-level Registry definition for ARM Cortex-m3 (interface).">io/cm3.h</a>&gt;</span>
<a name="l00059"></a>00059 
<a name="l00060"></a>00060 
<a name="l00061"></a>00061 <span class="comment">/* We use event to signal the end of conversion */</span>
<a name="l00062"></a>00062 <span class="keyword">static</span> Event data_ready;
<a name="l00063"></a>00063 <span class="comment">/* The last converted data */</span>
<a name="l00064"></a>00064 <span class="keyword">static</span> uint32_t data;
<a name="l00065"></a>00065 
<a name="l00077"></a><a class="code" href="adc__sam3_8c.html#a495ae03b01c71a5b4768d26923cb777e">00077</a> <span class="keyword">static</span> DECLARE_ISR(adc_conversion_end_irq)
<a name="l00078"></a>00078 {
<a name="l00079"></a>00079     data = 0;
<a name="l00080"></a>00080     <span class="keywordflow">if</span> (<a class="code" href="sam3__adc_8h.html#ac000ed7c6b1522b690b9d0af986ad110" title="Interrupt status register.">ADC_ISR</a> &amp; <a class="code" href="group__macros.html#ga663d8c125655d41622b1e6bc96e5d63d" title="Convert a bit value to a binary flag.">BV</a>(<a class="code" href="at91__adc_8h.html#a2b8d7a80685954c0ee1c8820074f7b77" title="Data ready.">ADC_DRDY</a>))
<a name="l00081"></a>00081     {
<a name="l00082"></a>00082         data = <a class="code" href="sam3__adc_8h.html#add55bec1206c258b9c78f1d088caac72" title="Last data converted register.">ADC_LDATA</a>;
<a name="l00083"></a>00083         <a class="code" href="group__event__handling.html#gae46f6285c3609bf8d6e484926dae455c" title="Trigger an event.">event_do</a>(&amp;data_ready);
<a name="l00084"></a>00084     }
<a name="l00085"></a>00085 }
<a name="l00086"></a>00086 
<a name="l00090"></a><a class="code" href="adc__sam3_8c.html#a2654afcc53d07a0fe8677c5c64c94d60">00090</a> <span class="keywordtype">void</span> <a class="code" href="adc__at91_8c.html#a2654afcc53d07a0fe8677c5c64c94d60" title="Select mux channel ch.">adc_hw_select_ch</a>(uint8_t ch)
<a name="l00091"></a>00091 {
<a name="l00092"></a>00092     <span class="comment">/* Disable all channels */</span>
<a name="l00093"></a>00093     <a class="code" href="at91__adc_8h.html#a024ae4e98b19b687a02572c529686386" title="Channel disable register address.">ADC_CHDR</a> = <a class="code" href="at91__adc_8h.html#a36013d93679dd9d296ff34dd197df763" title="Channel mask.">ADC_CH_MASK</a>;
<a name="l00094"></a>00094     <span class="comment">/* Enable select channel */</span>
<a name="l00095"></a>00095     <a class="code" href="at91__adc_8h.html#a1579c941b9446dc5a91756e21f46c9df" title="Channel enable register address.">ADC_CHER</a> = <a class="code" href="group__macros.html#ga663d8c125655d41622b1e6bc96e5d63d" title="Convert a bit value to a binary flag.">BV</a>(ch);
<a name="l00096"></a>00096 }
<a name="l00097"></a>00097 
<a name="l00101"></a><a class="code" href="adc__sam3_8c.html#af53cb85a56dda4aa7f95fc90e4d82069">00101</a> uint16_t <a class="code" href="adc__at91_8c.html#af53cb85a56dda4aa7f95fc90e4d82069" title="Start an ADC convertion.">adc_hw_read</a>(<span class="keywordtype">void</span>)
<a name="l00102"></a>00102 {
<a name="l00103"></a>00103     <a class="code" href="at91__adc_8h.html#a3d82abd19ec83649cdda24829d114cbe" title="Control register address.">ADC_CR</a> = <a class="code" href="group__macros.html#ga663d8c125655d41622b1e6bc96e5d63d" title="Convert a bit value to a binary flag.">BV</a>(<a class="code" href="at91__adc_8h.html#acc93f5a70b7081637be3d30cc04cb4dd" title="Start conversion.">ADC_START</a>);
<a name="l00104"></a>00104     <a class="code" href="group__event__handling.html#ga2dc29c321fb1c8e61ee67e64d85ad256" title="Wait the completion of event e.">event_wait</a>(&amp;data_ready);
<a name="l00105"></a>00105     <span class="keywordflow">return</span>(data);
<a name="l00106"></a>00106 }
<a name="l00107"></a>00107 
<a name="l00111"></a><a class="code" href="adc__sam3_8c.html#af9c4563e46566bd0b8352ff64f792318">00111</a> <span class="keywordtype">void</span> <a class="code" href="adc__at91_8c.html#af9c4563e46566bd0b8352ff64f792318" title="Init ADC hardware.">adc_hw_init</a>(<span class="keywordtype">void</span>)
<a name="l00112"></a>00112 {
<a name="l00113"></a>00113     <span class="comment">/* Make sure that interrupt are enabled */</span>
<a name="l00114"></a>00114     IRQ_ASSERT_ENABLED();
<a name="l00115"></a>00115 
<a name="l00116"></a>00116     <span class="comment">/* Initialize the dataready event */</span>
<a name="l00117"></a>00117     event_initGeneric(&amp;data_ready);
<a name="l00118"></a>00118 
<a name="l00119"></a>00119     <span class="comment">/* Clock ADC peripheral */</span>
<a name="l00120"></a>00120     <a class="code" href="sam3__pmc_8h.html#ab52e15eab47e357c27f86a5f8b0ba532" title="Enable a peripheral clock.">pmc_periphEnable</a>(ADC_ID);
<a name="l00121"></a>00121 
<a name="l00122"></a>00122      <span class="comment">/* Reset adc controller */</span>
<a name="l00123"></a>00123     <a class="code" href="at91__adc_8h.html#a3d82abd19ec83649cdda24829d114cbe" title="Control register address.">ADC_CR</a> = <a class="code" href="at91__adc_8h.html#a84afd9846a0c6153a1989ff70dd7fe1e" title="Software reset.">ADC_SWRST</a>;
<a name="l00124"></a>00124 
<a name="l00125"></a>00125     <span class="comment">/*</span>
<a name="l00126"></a>00126 <span class="comment">     * Set adc mode register:</span>
<a name="l00127"></a>00127 <span class="comment">     * - Disable hardware trigger and enable software trigger.</span>
<a name="l00128"></a>00128 <span class="comment">     * - Select normal mode.</span>
<a name="l00129"></a>00129 <span class="comment">     */</span>
<a name="l00130"></a>00130     <a class="code" href="at91__adc_8h.html#a875c9590c133ab1ad39e229e84a65329" title="Mode register address.">ADC_MR</a> = 0;
<a name="l00131"></a>00131 
<a name="l00132"></a>00132     <span class="comment">/* Set ADC_BITS bit convertion resolution. */</span>
<a name="l00133"></a>00133 <span class="preprocessor">    #if ADC_BITS == 12</span>
<a name="l00134"></a>00134 <span class="preprocessor"></span>        <a class="code" href="at91__adc_8h.html#a875c9590c133ab1ad39e229e84a65329" title="Mode register address.">ADC_MR</a> &amp;= ~<a class="code" href="group__macros.html#ga663d8c125655d41622b1e6bc96e5d63d" title="Convert a bit value to a binary flag.">BV</a>(<a class="code" href="at91__adc_8h.html#acf3c5c9a41616801566d07e1a3050bae" title="Resolution 0: 10-bit, 1: 8-bit.">ADC_LOWRES</a>);
<a name="l00135"></a>00135 <span class="preprocessor">    #elif ADC_BITS == 10</span>
<a name="l00136"></a>00136 <span class="preprocessor"></span>        <a class="code" href="at91__adc_8h.html#a875c9590c133ab1ad39e229e84a65329" title="Mode register address.">ADC_MR</a> |= <a class="code" href="group__macros.html#ga663d8c125655d41622b1e6bc96e5d63d" title="Convert a bit value to a binary flag.">BV</a>(<a class="code" href="at91__adc_8h.html#acf3c5c9a41616801566d07e1a3050bae" title="Resolution 0: 10-bit, 1: 8-bit.">ADC_LOWRES</a>);
<a name="l00137"></a>00137 <span class="preprocessor">    #else</span>
<a name="l00138"></a>00138 <span class="preprocessor"></span><span class="preprocessor">        #error No select bit resolution is supported to this CPU</span>
<a name="l00139"></a>00139 <span class="preprocessor"></span><span class="preprocessor">    #endif</span>
<a name="l00140"></a>00140 <span class="preprocessor"></span>
<a name="l00141"></a>00141     <span class="comment">/* Setup ADC */</span>
<a name="l00142"></a>00142     <a class="code" href="group__logging.html#gaa5595314cc54c304a127c75cfcec4017" title="Output an informative message.">LOG_INFO</a>(<span class="stringliteral">&quot;Computed ADC_CLOCK %ld\n&quot;</span>, ADC_CLOCK);
<a name="l00143"></a>00143     <a class="code" href="at91__adc_8h.html#a875c9590c133ab1ad39e229e84a65329" title="Mode register address.">ADC_MR</a> |= ((<a class="code" href="adc__sam3_8h.html#ab1d0703f6d84b37cbaa587a1a4515dd4" title="Macro for computing correct value to write into ADC register.">ADC_PRESCALER</a> &lt;&lt; <a class="code" href="at91__adc_8h.html#aaf864241f4686794dc907bc044cc3c40" title="Prescale rate selection shift.">ADC_PRESCALER_SHIFT</a>) &amp; <a class="code" href="at91__adc_8h.html#abf476b63e70a7381a2e4d0f39631dfe6" title="Prescaler rate selection.">ADC_PRESCALER_MASK</a>);
<a name="l00144"></a>00144     <a class="code" href="group__logging.html#gaa5595314cc54c304a127c75cfcec4017" title="Output an informative message.">LOG_INFO</a>(<span class="stringliteral">&quot;prescaler[%ld]\n&quot;</span>, <a class="code" href="adc__sam3_8h.html#ab1d0703f6d84b37cbaa587a1a4515dd4" title="Macro for computing correct value to write into ADC register.">ADC_PRESCALER</a>);
<a name="l00145"></a>00145     <a class="code" href="at91__adc_8h.html#a875c9590c133ab1ad39e229e84a65329" title="Mode register address.">ADC_MR</a> |= ((<a class="code" href="cfg__adc_8h.html#a7833bed0afaa11ddeb27183fd96e91e6" title="Start up timer[s] = startup value / ADCClock [Hz].">CONFIG_ADC_SUT</a> &lt;&lt; <a class="code" href="at91__adc_8h.html#adf56a5c685c1131b630ca6d5575124af" title="Start up timer shift.">ADC_STARTUP_SHIFT</a>) &amp; <a class="code" href="at91__adc_8h.html#aede4691772ec711eeb97dd0f705b31b8" title="Start up timer.">ADC_STARTUP_MASK</a>);
<a name="l00146"></a>00146     <a class="code" href="group__logging.html#gaa5595314cc54c304a127c75cfcec4017" title="Output an informative message.">LOG_INFO</a>(<span class="stringliteral">&quot;starup[%d]\n&quot;</span>, <a class="code" href="cfg__adc_8h.html#a7833bed0afaa11ddeb27183fd96e91e6" title="Start up timer[s] = startup value / ADCClock [Hz].">CONFIG_ADC_SUT</a>);
<a name="l00147"></a>00147     <a class="code" href="at91__adc_8h.html#a875c9590c133ab1ad39e229e84a65329" title="Mode register address.">ADC_MR</a> |= ((<a class="code" href="cfg__adc_8h.html#a4a5711cdc5f8dc88e4f74009d2eb971f" title="Analog Settling Time[s] = settling value / ADCClock[Hz].">CONFIG_ADC_STTLING</a> &lt;&lt; <a class="code" href="sam3__adc_8h.html#aa92a91df3ee2c912da89a1f009d39d16" title="Analog Settling Time shift.">ADC_SETTLING_SHIFT</a>) &amp; <a class="code" href="sam3__adc_8h.html#ab700de0dcb07b7ce9a51258769a050df" title="Analog Settling Time.">ADC_SETTLING_MASK</a>);
<a name="l00148"></a>00148     <a class="code" href="group__logging.html#gaa5595314cc54c304a127c75cfcec4017" title="Output an informative message.">LOG_INFO</a>(<span class="stringliteral">&quot;sttime[%d]\n&quot;</span>, <a class="code" href="cfg__adc_8h.html#a4a5711cdc5f8dc88e4f74009d2eb971f" title="Analog Settling Time[s] = settling value / ADCClock[Hz].">CONFIG_ADC_STTLING</a>);
<a name="l00149"></a>00149     <a class="code" href="at91__adc_8h.html#a875c9590c133ab1ad39e229e84a65329" title="Mode register address.">ADC_MR</a> |= ((<a class="code" href="cfg__adc_8h.html#a8c9bbf071ecea74680b79961795d7fcd" title="Tracking Time[s] = (TRACKTIM + 1) / ADCClock[Hz].">CONFIG_ADC_TRACKTIM</a> &lt;&lt; <a class="code" href="sam3__adc_8h.html#a7a194e52b50195d82c2d86e00f83436c" title="Tracking Time shift.">ADC_TRACKTIM_SHIFT</a>) &amp; <a class="code" href="sam3__adc_8h.html#a9702b714b663a46fdb1b1551feaa4931" title="Tracking Time.">ADC_TRACKTIM_MASK</a>);
<a name="l00150"></a>00150     <a class="code" href="group__logging.html#gaa5595314cc54c304a127c75cfcec4017" title="Output an informative message.">LOG_INFO</a>(<span class="stringliteral">&quot;tracking[%d]\n&quot;</span>, <a class="code" href="cfg__adc_8h.html#a8c9bbf071ecea74680b79961795d7fcd" title="Tracking Time[s] = (TRACKTIM + 1) / ADCClock[Hz].">CONFIG_ADC_TRACKTIM</a>);
<a name="l00151"></a>00151     <a class="code" href="at91__adc_8h.html#a875c9590c133ab1ad39e229e84a65329" title="Mode register address.">ADC_MR</a> |= ((<a class="code" href="cfg__adc_8h.html#a2d4dded534e1fa2902622c708a89269f" title="Transfer Period[s] = (TRANSFER * 2 + 3) ADCClock[Hz].">CONFIG_ADC_TRANSFER</a> &lt;&lt; <a class="code" href="sam3__adc_8h.html#ad98caffa1372f81b4d327e42c2851909" title="Transfer Period shift.">ADC_TRANSFER_SHIFT</a>) &amp; <a class="code" href="sam3__adc_8h.html#a5cdbf23310a88ee681739e077e72b8e7" title="Transfer Period.">ADC_TRANSFER_MASK</a>);
<a name="l00152"></a>00152     <a class="code" href="group__logging.html#gaa5595314cc54c304a127c75cfcec4017" title="Output an informative message.">LOG_INFO</a>(<span class="stringliteral">&quot;tranfer[%d]\n&quot;</span>, <a class="code" href="cfg__adc_8h.html#a2d4dded534e1fa2902622c708a89269f" title="Transfer Period[s] = (TRANSFER * 2 + 3) ADCClock[Hz].">CONFIG_ADC_TRANSFER</a>);
<a name="l00153"></a>00153 
<a name="l00154"></a>00154     <span class="comment">/* Register and enable irq for adc. */</span>
<a name="l00155"></a>00155     <a class="code" href="sysirq__at91_8c.html#ac306e48b7f835d555d57502b277961f8" title="Helper function used to set handler for system IRQ irq.">sysirq_setHandler</a>(INT_ADC, adc_conversion_end_irq);
<a name="l00156"></a>00156     <a class="code" href="at91__adc_8h.html#ae2cc5361f3fdff3bf869b9961325ec8f" title="Interrupt enable register.">ADC_IER</a> = <a class="code" href="group__macros.html#ga663d8c125655d41622b1e6bc96e5d63d" title="Convert a bit value to a binary flag.">BV</a>(<a class="code" href="at91__adc_8h.html#a2b8d7a80685954c0ee1c8820074f7b77" title="Data ready.">ADC_DRDY</a>);
<a name="l00157"></a>00157 }
</pre></div></div>
</div>


