

<!-- Generated by Doxygen 1.7.4 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="dir_9fd71c1ac00056e7d855336b2291c56c.html">bertos</a>      </li>
      <li class="navelem"><a class="el" href="dir_7a1c32e0b61e66bba4924a9a48a40b57.html">algo</a>      </li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="summary">
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle">
<div class="title">ramp.c File Reference</div>  </div>
</div>
<div class="contents">

<p>Compute, save and load ramps for stepper motors (implementation)  
<a href="#details">More...</a></p>
<div class="textblock"><code>#include &quot;<a class="el" href="ramp_8h_source.html">ramp.h</a>&quot;</code><br/>
<code>#include &lt;<a class="el" href="debug_8h_source.html">cfg/debug.h</a>&gt;</code><br/>
<code>#include &lt;string.h&gt;</code><br/>
</div>
<p><a href="ramp_8c_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr><td colspan="2"><h2><a name="func-members"></a>
Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="ramp_8c.html#ad3a92eef6fab7683cfd82a8f3812f5e4">ramp_setup</a> (struct <a class="el" href="structRamp.html">Ramp</a> *ramp, uint32_t length, uint32_t minFreq, uint32_t maxFreq)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Setup an acceleration ramp for a stepper motor.  <a href="#ad3a92eef6fab7683cfd82a8f3812f5e4"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a8aa35cc1f9521284603dcce38911197a"></a><!-- doxytag: member="ramp.c::ramp_default" ref="a8aa35cc1f9521284603dcce38911197a" args="(struct Ramp *ramp)" -->
void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="ramp_8c.html#a8aa35cc1f9521284603dcce38911197a">ramp_default</a> (struct <a class="el" href="structRamp.html">Ramp</a> *ramp)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Initialize a new ramp with default values. <br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">uint16_t FAST_FUNC&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="ramp_8c.html#abb2bb4ceeaebfaeac46cf852d7ac253a">ramp_evaluate</a> (const struct <a class="el" href="structRamp.html">Ramp</a> *ramp, uint32_t curClock)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Evaluate the ramp at the given point.  <a href="#abb2bb4ceeaebfaeac46cf852d7ac253a"></a><br/></td></tr>
</table>
<hr/><a name="details" id="details"></a><h2>Detailed Description</h2>
<div class="textblock"><p>Compute, save and load ramps for stepper motors (implementation) </p>
<dl class="author"><dt><b>Author:</b></dt><dd>Simone Zinanni &lt;<a href="mailto:s.zinanni@develer.com">s.zinanni@develer.com</a>&gt; </dd>
<dd>
Bernie Innocenti &lt;<a href="mailto:bernie@codewiz.org">bernie@codewiz.org</a>&gt; </dd>
<dd>
Giovanni Bajo &lt;<a href="mailto:rasky@develer.com">rasky@develer.com</a>&gt; </dd>
<dd>
Daniele Basile &lt;<a href="mailto:asterix@develer.com">asterix@develer.com</a>&gt;</dd></dl>
<p>The formula used by the ramp is the following:</p>
<pre>
            a * b
 f(t) = -------------
         lerp(a,b,t)
 </pre><p>Where <code>a</code> and <code>b</code> are the maximum and minimum speed respectively (minimum and maximum wavelength respectively), and <code>lerp</code> is a linear interpolation with a factor:</p>
<pre>
 lerp(a,b,t) =  a + t * (b - a)  =  (a * (1 - t)) + (b * t)
 </pre><p><code>t</code> must be in the [0,1] interval. It is easy to see that the following holds true:</p>
<pre>
 f(0) = b,   f(1) = a
 </pre><p>And that the function is monotonic. So, the function effectively interpolates between the maximum and minimum speed through its domain ([0,1] -&gt; [b,a]).</p>
<p>The curve drawn by this function is similar to 1 / (sqrt(n)), so it is slower than a linear acceleration (which would be 1/n).</p>
<p>The floating point version uses a slightly modified function which accepts the parameter in the domain [0, MT] (where MT is maxTime, the length of the ramp, which is a setup parameter for the ramp). This is done to reduce the number of operations per step. The formula looks like this:</p>
<pre>
               a * b * MT
 g(t) = ----------------------------
           (a * MT) + t * (b - a)
 </pre><p>It can be shown that this <code>g(t) = f(t * MT)</code>. The denominator is a linear interpolation in the range [b*MT, a*MT], as t moves in the interval [0, MT]. So the interpolation interval of the function is again [b, a]. The implementation caches the value of the numerator and parts of the denominator, so that the formula becomes:</p>
<pre>
 alpha = a * b * MT
 beta = a * MT
 gamma = b - a</pre><pre>                alpha
 g(t) = ----------------------
           beta + t * gamma
 </pre><p>and <code>t</code> is exactly the parameter that <a class="el" href="ramp_8c.html#abb2bb4ceeaebfaeac46cf852d7ac253a" title="Evaluate the ramp at the given point.">ramp_evaluate()</a> gets, that is the current time (in range [0, MT]). The operations performed for each step are just an addition, a multiplication and a division.</p>
<p>The fixed point version of the formula instead transforms the original function as follows:</p>
<pre>
                   a * b                         a
  f(t) =  -------------------------  =  --------------------
                 a                         a
           b * ( - * (1 - t) + t )         - * (1 - t) + t
                 b                         b
 </pre><p><code>t</code> must be computed by dividing the current time (24 bit integer) by the maximum time (24 bit integer). This is done by precomputing the reciprocal of the maximum time as a 0.32 fixed point number, and multiplying it to the current time. Multiplication is performed 8-bits a time by <a class="el" href="ramp_8h.html#ab753a6c52129601b59bf013fb07dfb67" title="Multiply a and b two integer at 32 bit and extract the high 16 bit word.">FIX_MULT32()</a>, so that we end up with a 0.16 fixed point number for <code>t</code> (and <code>1-t</code> is just its twos-complement negation). <code>a/b</code> is in the range [0,1] (because a is always less than b, being the minimum wavelength), so it is precomputed as a 0.16 fixed point. The final step is then computing the denominator and executing the division (32 cycles using the 1-step division instruction in the DSP).</p>
<p>The assembly implementation is needed for efficiency, but a C version of it can be easily written, in case it is needed in the future. </p>

<p>Definition in file <a class="el" href="ramp_8c_source.html">ramp.c</a>.</p>
</div><hr/><h2>Function Documentation</h2>
<a class="anchor" id="abb2bb4ceeaebfaeac46cf852d7ac253a"></a><!-- doxytag: member="ramp.c::ramp_evaluate" ref="abb2bb4ceeaebfaeac46cf852d7ac253a" args="(const struct Ramp *ramp, uint32_t curClock)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">uint16_t FAST_FUNC ramp_evaluate </td>
          <td>(</td>
          <td class="paramtype">const struct <a class="el" href="structRamp.html">Ramp</a> *&#160;</td>
          <td class="paramname"><em>ramp</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint32_t&#160;</td>
          <td class="paramname"><em>curClock</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Evaluate the ramp at the given point. </p>
<p>Given a <em>ramp</em>, and the current <em>clock</em> since the start of the acceleration, compute the next step, that is the interval at which send the signal to the motor.</p>
<dl class="note"><dt><b>Note:</b></dt><dd>The fixed point version does not work when curClock is zero. Anyway, the first step is always clocksMaxWL, as stored within the ramp structure. </dd></dl>

<p>Definition at line <a class="el" href="ramp_8c_source.html#l00189">189</a> of file <a class="el" href="ramp_8c_source.html">ramp.c</a>.</p>

</div>
</div>
<a class="anchor" id="ad3a92eef6fab7683cfd82a8f3812f5e4"></a><!-- doxytag: member="ramp.c::ramp_setup" ref="ad3a92eef6fab7683cfd82a8f3812f5e4" args="(struct Ramp *ramp, uint32_t length, uint32_t minFreq, uint32_t maxFreq)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void ramp_setup </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structRamp.html">Ramp</a> *&#160;</td>
          <td class="paramname"><em>ramp</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint32_t&#160;</td>
          <td class="paramname"><em>length</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint32_t&#160;</td>
          <td class="paramname"><em>minFreq</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint32_t&#160;</td>
          <td class="paramname"><em>maxFreq</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Setup an acceleration ramp for a stepper motor. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table class="params">
    <tr><td class="paramname">ramp</td><td><a class="el" href="structRamp.html" title="Ramp structure.">Ramp</a> to fill </td></tr>
    <tr><td class="paramname">length</td><td>Length of the ramp (milliseconds) </td></tr>
    <tr><td class="paramname">minFreq</td><td>Minimum operating frequency of the motor (hertz) </td></tr>
    <tr><td class="paramname">maxFreq</td><td>Maximum operating frequency of the motor (hertz) </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="ramp_8c_source.html#l00139">139</a> of file <a class="el" href="ramp_8c_source.html">ramp.c</a>.</p>

</div>
</div>
</div>


