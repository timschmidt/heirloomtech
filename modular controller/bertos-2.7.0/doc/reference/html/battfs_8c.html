

<!-- Generated by Doxygen 1.7.4 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="dir_9fd71c1ac00056e7d855336b2291c56c.html">bertos</a>      </li>
      <li class="navelem"><a class="el" href="dir_cd5151ad4b595b3b6d6807653813384b.html">fs</a>      </li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="summary">
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle">
<div class="title">battfs.c File Reference</div>  </div>
</div>
<div class="contents">

<p>BattFS: a filesystem for embedded platforms (implementation).  
<a href="#details">More...</a></p>
<div class="textblock"><code>#include &quot;<a class="el" href="battfs_8h_source.html">battfs.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="cfg__battfs_8h_source.html">cfg/cfg_battfs.h</a>&quot;</code><br/>
<code>#include &lt;<a class="el" href="debug_8h_source.html">cfg/debug.h</a>&gt;</code><br/>
<code>#include &lt;<a class="el" href="macros_8h_source.html">cfg/macros.h</a>&gt;</code><br/>
<code>#include &lt;<a class="el" href="test_8h_source.html">cfg/test.h</a>&gt;</code><br/>
<code>#include &lt;<a class="el" href="cpu_2byteorder_8h_source.html">cpu/byteorder.h</a>&gt;</code><br/>
<code>#include &lt;<a class="el" href="log_8h_source.html">cfg/log.h</a>&gt;</code><br/>
<code>#include &lt;string.h&gt;</code><br/>
</div>
<p><a href="battfs_8c_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr><td colspan="2"><h2><a name="func-members"></a>
Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="battfs_8c.html#a2ab58e79b36e2d503e0a3197ca08b65a">battfs_to_disk</a> (struct <a class="el" href="structBattFsPageHeader.html">BattFsPageHeader</a> *hdr, uint8_t *buf)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Convert from memory representation to disk structure.  <a href="#a2ab58e79b36e2d503e0a3197ca08b65a"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="battfs_8c.html#ab52ab90298977c2327a5d857fbb6517c">disk_to_battfs</a> (uint8_t *buf, struct <a class="el" href="structBattFsPageHeader.html">BattFsPageHeader</a> *hdr)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Convert from disk structure to memory representation.  <a href="#ab52ab90298977c2327a5d857fbb6517c"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="af1a47fc53b7a1972011ca0c9f8f7e927"></a><!-- doxytag: member="battfs.c::computeFcs" ref="af1a47fc53b7a1972011ca0c9f8f7e927" args="(struct BattFsPageHeader *hdr)" -->
static <a class="el" href="battfs_8h.html#aaf7617a98621b494ad58b8bbbdf9306e">fcs_t</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="battfs_8c.html#af1a47fc53b7a1972011ca0c9f8f7e927">computeFcs</a> (struct <a class="el" href="structBattFsPageHeader.html">BattFsPageHeader</a> *hdr)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Compute the fcs of the header. <br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="battfs_8c.html#a041535a629472f6a28d1608337315ebc">readHdr</a> (struct <a class="el" href="structBattFsSuper.html">BattFsSuper</a> *disk, <a class="el" href="battfs_8h.html#ab696748712d719603833f401031a7907">pgcnt_t</a> page, struct <a class="el" href="structBattFsPageHeader.html">BattFsPageHeader</a> *hdr)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Read header of <em>page</em> in <em>hdr</em>.  <a href="#a041535a629472f6a28d1608337315ebc"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a26ea14183c55be33c4e9af14fd7a6bec"></a><!-- doxytag: member="battfs.c::countPages" ref="a26ea14183c55be33c4e9af14fd7a6bec" args="(pgoff_t *filelen_table, inode_t inode)" -->
static <a class="el" href="battfs_8h.html#ab696748712d719603833f401031a7907">pgcnt_t</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="battfs_8c.html#a26ea14183c55be33c4e9af14fd7a6bec">countPages</a> (<a class="el" href="battfs_8h.html#abd9d9d290feaf2e76bce6142ae59019e">pgoff_t</a> *filelen_table, <a class="el" href="battfs_8h.html#a74713a2f9f355cad853593781defa824">inode_t</a> inode)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Count the number of pages from inode 0 to <em>inode</em> in <em>filelen_table</em>. <br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="battfs_8c.html#a79846b7cea24a012d60d2720cb2b6d6c">movePages</a> (struct <a class="el" href="structBattFsSuper.html">BattFsSuper</a> *disk, <a class="el" href="battfs_8h.html#ab696748712d719603833f401031a7907">pgcnt_t</a> src, int offset)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Move all pages in page allocation array from <em>src</em> to <em>src</em> + <em>offset</em>.  <a href="#a79846b7cea24a012d60d2720cb2b6d6c"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="battfs_8c.html#a8383bbf0bbdb27c4d669bf2b3f05abb9">countDiskFilePages</a> (struct <a class="el" href="structBattFsSuper.html">BattFsSuper</a> *disk, <a class="el" href="battfs_8h.html#abd9d9d290feaf2e76bce6142ae59019e">pgoff_t</a> *filelen_table)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Count number of pages per file on <em>disk</em>.  <a href="#a8383bbf0bbdb27c4d669bf2b3f05abb9"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="battfs_8c.html#a157e4229f50cb7fb41f0113bb06a4ab3">fillPageArray</a> (struct <a class="el" href="structBattFsSuper.html">BattFsSuper</a> *disk, <a class="el" href="battfs_8h.html#abd9d9d290feaf2e76bce6142ae59019e">pgoff_t</a> *filelen_table)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Fill page allocation array of <em>disk</em> using file lenghts in <em>filelen_table</em>.  <a href="#a157e4229f50cb7fb41f0113bb06a4ab3"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="battfs_8c.html#a5ae502d0f195b3a16836f3883f80ebac">battfs_mount</a> (struct <a class="el" href="structBattFsSuper.html">BattFsSuper</a> *disk, struct <a class="el" href="structKBlock.html">KBlock</a> *dev, <a class="el" href="battfs_8h.html#ab696748712d719603833f401031a7907">pgcnt_t</a> *page_array, size_t array_size)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Initialize and mount disk described by <em>disk</em>.  <a href="#a5ae502d0f195b3a16836f3883f80ebac"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="battfs_8c.html#abefec8a14bbb305b13d77adc7a56996b">battfs_fsck</a> (struct <a class="el" href="structBattFsSuper.html">BattFsSuper</a> *disk)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Check the filesystem.  <a href="#abefec8a14bbb305b13d77adc7a56996b"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="battfs_8c.html#a5debb24bbd73cc9be4ae0e4f3882157f">battfs_flush</a> (struct <a class="el" href="structKFile.html">KFile</a> *fd)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Flush file <em>fd</em>.  <a href="#a5debb24bbd73cc9be4ae0e4f3882157f"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="battfs_8c.html#add20fbad9f3858073feddc78d3c68e91">battfs_fileclose</a> (struct <a class="el" href="structKFile.html">KFile</a> *fd)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Close file <em>fd</em>.  <a href="#add20fbad9f3858073feddc78d3c68e91"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static size_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="battfs_8c.html#ab2bc9f316bb9eee549712ed60b2429d4">battfs_write</a> (struct <a class="el" href="structKFile.html">KFile</a> *fd, const void *_buf, size_t size)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Write to file <em>fd</em> <em>size</em> bytes from <em>buf</em>.  <a href="#ab2bc9f316bb9eee549712ed60b2429d4"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static size_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="battfs_8c.html#afd2ad685dca2d309e910aa6a0c5942b5">battfs_read</a> (struct <a class="el" href="structKFile.html">KFile</a> *fd, void *_buf, size_t size)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Read from file <em>fd</em> <em>size</em> bytes in <em>buf</em>.  <a href="#afd2ad685dca2d309e910aa6a0c5942b5"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="battfs_8c.html#a96cb0603adb42df156113679352c65d8">findFile</a> (<a class="el" href="structBattFsSuper.html">BattFsSuper</a> *disk, <a class="el" href="battfs_8h.html#a74713a2f9f355cad853593781defa824">inode_t</a> inode, <a class="el" href="battfs_8h.html#ab696748712d719603833f401031a7907">pgcnt_t</a> *last)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Search file <em>inode</em> in <em>disk</em> using a binary search.  <a href="#a96cb0603adb42df156113679352c65d8"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="battfs_8c.html#a7469859a17ef79668fdc9b3e949bba7b">battfs_fileExists</a> (<a class="el" href="structBattFsSuper.html">BattFsSuper</a> *disk, <a class="el" href="battfs_8h.html#a74713a2f9f355cad853593781defa824">inode_t</a> inode)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static <a class="el" href="battfs_8h.html#a63bb07cc5b9e2d76ea5499b397e2b4ee">file_size_t</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="battfs_8c.html#ad4ab98ab173f00db6190ff1f4c866b09">countFileSize</a> (<a class="el" href="structBattFsSuper.html">BattFsSuper</a> *disk, <a class="el" href="battfs_8h.html#ab696748712d719603833f401031a7907">pgcnt_t</a> *start, <a class="el" href="battfs_8h.html#a74713a2f9f355cad853593781defa824">inode_t</a> inode)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Count size of file <em>inode</em> on <em>disk</em>, starting at pointer <em>start</em> in disk-&gt;page_array.  <a href="#ad4ab98ab173f00db6190ff1f4c866b09"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="battfs_8c.html#a8295240f9546944d0b8e1b06a1e5579d">battfs_fileopen</a> (<a class="el" href="structBattFsSuper.html">BattFsSuper</a> *disk, <a class="el" href="structBattFs.html">BattFs</a> *fd, <a class="el" href="battfs_8h.html#a74713a2f9f355cad853593781defa824">inode_t</a> inode, <a class="el" href="battfs_8h.html#adf5532a6841c3713f99a378e3f9f7a82">filemode_t</a> mode)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Open file <em>inode</em> from <em>disk</em> in <em>mode</em>.  <a href="#a8295240f9546944d0b8e1b06a1e5579d"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a6059da32732f2272b68894610eddb99d"></a><!-- doxytag: member="battfs.c::battfs_umount" ref="a6059da32732f2272b68894610eddb99d" args="(struct BattFsSuper *disk)" -->
bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="battfs_8c.html#a6059da32732f2272b68894610eddb99d">battfs_umount</a> (struct <a class="el" href="structBattFsSuper.html">BattFsSuper</a> *disk)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Umount <em>disk</em>. <br/></td></tr>
</table>
<hr/><a name="details" id="details"></a><h2>Detailed Description</h2>
<div class="textblock"><p>BattFS: a filesystem for embedded platforms (implementation). </p>
<dl class="author"><dt><b>Author:</b></dt><dd>Francesco Sacchi &lt;<a href="mailto:batt@develer.com">batt@develer.com</a>&gt; </dd></dl>

<p>Definition in file <a class="el" href="battfs_8c_source.html">battfs.c</a>.</p>
</div><hr/><h2>Function Documentation</h2>
<a class="anchor" id="add20fbad9f3858073feddc78d3c68e91"></a><!-- doxytag: member="battfs.c::battfs_fileclose" ref="add20fbad9f3858073feddc78d3c68e91" args="(struct KFile *fd)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int battfs_fileclose </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structKFile.html">KFile</a> *&#160;</td>
          <td class="paramname"><em>fd</em></td><td>)</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Close file <em>fd</em>. </p>
<dl class="return"><dt><b>Returns:</b></dt><dd>0 if ok, EOF on errors. </dd></dl>

<p>Definition at line <a class="el" href="battfs_8c_source.html#l00500">500</a> of file <a class="el" href="battfs_8c_source.html">battfs.c</a>.</p>

</div>
</div>
<a class="anchor" id="a7469859a17ef79668fdc9b3e949bba7b"></a><!-- doxytag: member="battfs.c::battfs_fileExists" ref="a7469859a17ef79668fdc9b3e949bba7b" args="(BattFsSuper *disk, inode_t inode)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool battfs_fileExists </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structBattFsSuper.html">BattFsSuper</a> *&#160;</td>
          <td class="paramname"><em>disk</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="battfs_8h.html#a74713a2f9f355cad853593781defa824">inode_t</a>&#160;</td>
          <td class="paramname"><em>inode</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<dl class="return"><dt><b>Returns:</b></dt><dd>true if file <em>inode</em> exists on <em>disk</em>, false otherwise. </dd></dl>

<p>Definition at line <a class="el" href="battfs_8c_source.html#l00860">860</a> of file <a class="el" href="battfs_8c_source.html">battfs.c</a>.</p>

</div>
</div>
<a class="anchor" id="a8295240f9546944d0b8e1b06a1e5579d"></a><!-- doxytag: member="battfs.c::battfs_fileopen" ref="a8295240f9546944d0b8e1b06a1e5579d" args="(BattFsSuper *disk, BattFs *fd, inode_t inode, filemode_t mode)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool battfs_fileopen </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structBattFsSuper.html">BattFsSuper</a> *&#160;</td>
          <td class="paramname"><em>disk</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structBattFs.html">BattFs</a> *&#160;</td>
          <td class="paramname"><em>fd</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="battfs_8h.html#a74713a2f9f355cad853593781defa824">inode_t</a>&#160;</td>
          <td class="paramname"><em>inode</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="battfs_8h.html#adf5532a6841c3713f99a378e3f9f7a82">filemode_t</a>&#160;</td>
          <td class="paramname"><em>mode</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Open file <em>inode</em> from <em>disk</em> in <em>mode</em>. </p>
<p>File context is stored in <em>fd</em>. </p>
<dl class="return"><dt><b>Returns:</b></dt><dd>true if ok, false otherwise. </dd></dl>

<p>Definition at line <a class="el" href="battfs_8c_source.html#l00906">906</a> of file <a class="el" href="battfs_8c_source.html">battfs.c</a>.</p>

</div>
</div>
<a class="anchor" id="a5debb24bbd73cc9be4ae0e4f3882157f"></a><!-- doxytag: member="battfs.c::battfs_flush" ref="a5debb24bbd73cc9be4ae0e4f3882157f" args="(struct KFile *fd)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int battfs_flush </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structKFile.html">KFile</a> *&#160;</td>
          <td class="paramname"><em>fd</em></td><td>)</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Flush file <em>fd</em>. </p>
<dl class="return"><dt><b>Returns:</b></dt><dd>0 if ok, EOF on errors. </dd></dl>

<p>Definition at line <a class="el" href="battfs_8c_source.html#l00483">483</a> of file <a class="el" href="battfs_8c_source.html">battfs.c</a>.</p>

</div>
</div>
<a class="anchor" id="abefec8a14bbb305b13d77adc7a56996b"></a><!-- doxytag: member="battfs.c::battfs_fsck" ref="abefec8a14bbb305b13d77adc7a56996b" args="(struct BattFsSuper *disk)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool battfs_fsck </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structBattFsSuper.html">BattFsSuper</a> *&#160;</td>
          <td class="paramname"><em>disk</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Check the filesystem. </p>
<dl class="return"><dt><b>Returns:</b></dt><dd>true if ok, false on errors. </dd></dl>

<p>Definition at line <a class="el" href="battfs_8c_source.html#l00425">425</a> of file <a class="el" href="battfs_8c_source.html">battfs.c</a>.</p>

</div>
</div>
<a class="anchor" id="a5ae502d0f195b3a16836f3883f80ebac"></a><!-- doxytag: member="battfs.c::battfs_mount" ref="a5ae502d0f195b3a16836f3883f80ebac" args="(struct BattFsSuper *disk, struct KBlock *dev, pgcnt_t *page_array, size_t array_size)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool battfs_mount </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structBattFsSuper.html">BattFsSuper</a> *&#160;</td>
          <td class="paramname"><em>disk</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structKBlock.html">KBlock</a> *&#160;</td>
          <td class="paramname"><em>dev</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="battfs_8h.html#ab696748712d719603833f401031a7907">pgcnt_t</a> *&#160;</td>
          <td class="paramname"><em>page_array</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">size_t&#160;</td>
          <td class="paramname"><em>array_size</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Initialize and mount disk described by <em>disk</em>. </p>
<dl class="return"><dt><b>Returns:</b></dt><dd>false on errors, true otherwise. </dd></dl>

<p>Definition at line <a class="el" href="battfs_8c_source.html#l00364">364</a> of file <a class="el" href="battfs_8c_source.html">battfs.c</a>.</p>

</div>
</div>
<a class="anchor" id="afd2ad685dca2d309e910aa6a0c5942b5"></a><!-- doxytag: member="battfs.c::battfs_read" ref="afd2ad685dca2d309e910aa6a0c5942b5" args="(struct KFile *fd, void *_buf, size_t size)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static size_t battfs_read </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structKFile.html">KFile</a> *&#160;</td>
          <td class="paramname"><em>fd</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">void *&#160;</td>
          <td class="paramname"><em>_buf</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">size_t&#160;</td>
          <td class="paramname"><em>size</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Read from file <em>fd</em> <em>size</em> bytes in <em>buf</em>. </p>
<dl class="return"><dt><b>Returns:</b></dt><dd>The number of bytes read. </dd></dl>

<p>Definition at line <a class="el" href="battfs_8c_source.html#l00771">771</a> of file <a class="el" href="battfs_8c_source.html">battfs.c</a>.</p>

</div>
</div>
<a class="anchor" id="a2ab58e79b36e2d503e0a3197ca08b65a"></a><!-- doxytag: member="battfs.c::battfs_to_disk" ref="a2ab58e79b36e2d503e0a3197ca08b65a" args="(struct BattFsPageHeader *hdr, uint8_t *buf)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void battfs_to_disk </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structBattFsPageHeader.html">BattFsPageHeader</a> *&#160;</td>
          <td class="paramname"><em>hdr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint8_t *&#160;</td>
          <td class="paramname"><em>buf</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td><code> [inline]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Convert from memory representation to disk structure. </p>
<dl class="note"><dt><b>Note:</b></dt><dd>filesystem is in little-endian format. </dd></dl>

<p>Definition at line <a class="el" href="battfs_8c_source.html#l00071">71</a> of file <a class="el" href="battfs_8c_source.html">battfs.c</a>.</p>

</div>
</div>
<a class="anchor" id="ab2bc9f316bb9eee549712ed60b2429d4"></a><!-- doxytag: member="battfs.c::battfs_write" ref="ab2bc9f316bb9eee549712ed60b2429d4" args="(struct KFile *fd, const void *_buf, size_t size)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static size_t battfs_write </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structKFile.html">KFile</a> *&#160;</td>
          <td class="paramname"><em>fd</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const void *&#160;</td>
          <td class="paramname"><em>_buf</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">size_t&#160;</td>
          <td class="paramname"><em>size</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Write to file <em>fd</em> <em>size</em> bytes from <em>buf</em>. </p>
<dl class="return"><dt><b>Returns:</b></dt><dd>The number of bytes written. </dd></dl>

<p>Definition at line <a class="el" href="battfs_8c_source.html#l00565">565</a> of file <a class="el" href="battfs_8c_source.html">battfs.c</a>.</p>

</div>
</div>
<a class="anchor" id="a8383bbf0bbdb27c4d669bf2b3f05abb9"></a><!-- doxytag: member="battfs.c::countDiskFilePages" ref="a8383bbf0bbdb27c4d669bf2b3f05abb9" args="(struct BattFsSuper *disk, pgoff_t *filelen_table)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static bool countDiskFilePages </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structBattFsSuper.html">BattFsSuper</a> *&#160;</td>
          <td class="paramname"><em>disk</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="battfs_8h.html#abd9d9d290feaf2e76bce6142ae59019e">pgoff_t</a> *&#160;</td>
          <td class="paramname"><em>filelen_table</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Count number of pages per file on <em>disk</em>. </p>
<p>This information is registered in <em>filelen_table</em>. Array index represent file inode, while value contained is the number of pages used by that file.</p>
<dl class="return"><dt><b>Returns:</b></dt><dd>true if ok, false on disk read errors. </dd></dl>
<dl class="note"><dt><b>Note:</b></dt><dd>The whole disk is scanned once. </dd></dl>

<p>Definition at line <a class="el" href="battfs_8c_source.html#l00221">221</a> of file <a class="el" href="battfs_8c_source.html">battfs.c</a>.</p>

</div>
</div>
<a class="anchor" id="ad4ab98ab173f00db6190ff1f4c866b09"></a><!-- doxytag: member="battfs.c::countFileSize" ref="ad4ab98ab173f00db6190ff1f4c866b09" args="(BattFsSuper *disk, pgcnt_t *start, inode_t inode)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static <a class="el" href="battfs_8h.html#a63bb07cc5b9e2d76ea5499b397e2b4ee">file_size_t</a> countFileSize </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structBattFsSuper.html">BattFsSuper</a> *&#160;</td>
          <td class="paramname"><em>disk</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="battfs_8h.html#ab696748712d719603833f401031a7907">pgcnt_t</a> *&#160;</td>
          <td class="paramname"><em>start</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="battfs_8h.html#a74713a2f9f355cad853593781defa824">inode_t</a>&#160;</td>
          <td class="paramname"><em>inode</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Count size of file <em>inode</em> on <em>disk</em>, starting at pointer <em>start</em> in disk-&gt;page_array. </p>
<p>Size is written in <em>size</em>. </p>
<dl class="return"><dt><b>Returns:</b></dt><dd>true if all s ok, false on disk read errors. </dd></dl>

<p>Definition at line <a class="el" href="battfs_8c_source.html#l00871">871</a> of file <a class="el" href="battfs_8c_source.html">battfs.c</a>.</p>

</div>
</div>
<a class="anchor" id="ab52ab90298977c2327a5d857fbb6517c"></a><!-- doxytag: member="battfs.c::disk_to_battfs" ref="ab52ab90298977c2327a5d857fbb6517c" args="(uint8_t *buf, struct BattFsPageHeader *hdr)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void disk_to_battfs </td>
          <td>(</td>
          <td class="paramtype">uint8_t *&#160;</td>
          <td class="paramname"><em>buf</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structBattFsPageHeader.html">BattFsPageHeader</a> *&#160;</td>
          <td class="paramname"><em>hdr</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td><code> [inline]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Convert from disk structure to memory representation. </p>
<dl class="note"><dt><b>Note:</b></dt><dd>filesystem is in little-endian format. </dd></dl>

<p>Definition at line <a class="el" href="battfs_8c_source.html#l00105">105</a> of file <a class="el" href="battfs_8c_source.html">battfs.c</a>.</p>

</div>
</div>
<a class="anchor" id="a157e4229f50cb7fb41f0113bb06a4ab3"></a><!-- doxytag: member="battfs.c::fillPageArray" ref="a157e4229f50cb7fb41f0113bb06a4ab3" args="(struct BattFsSuper *disk, pgoff_t *filelen_table)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static bool fillPageArray </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structBattFsSuper.html">BattFsSuper</a> *&#160;</td>
          <td class="paramname"><em>disk</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="battfs_8h.html#abd9d9d290feaf2e76bce6142ae59019e">pgoff_t</a> *&#160;</td>
          <td class="paramname"><em>filelen_table</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Fill page allocation array of <em>disk</em> using file lenghts in <em>filelen_table</em>. </p>
<p>The page allocation array is an array containings all file infos. Is ordered by file, and within each file is ordered by page offset inside file. e.g. : at page array[0] you will find page address of the first page of the first file (if present). Free blocks are allocated after the last file.</p>
<dl class="return"><dt><b>Returns:</b></dt><dd>true if ok, false on disk read errors. </dd></dl>
<dl class="note"><dt><b>Note:</b></dt><dd>The whole disk is scanned at max twice. </dd></dl>

<p>Definition at line <a class="el" href="battfs_8c_source.html#l00267">267</a> of file <a class="el" href="battfs_8c_source.html">battfs.c</a>.</p>

</div>
</div>
<a class="anchor" id="a96cb0603adb42df156113679352c65d8"></a><!-- doxytag: member="battfs.c::findFile" ref="a96cb0603adb42df156113679352c65d8" args="(BattFsSuper *disk, inode_t inode, pgcnt_t *last)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static bool findFile </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structBattFsSuper.html">BattFsSuper</a> *&#160;</td>
          <td class="paramname"><em>disk</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="battfs_8h.html#a74713a2f9f355cad853593781defa824">inode_t</a>&#160;</td>
          <td class="paramname"><em>inode</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="battfs_8h.html#ab696748712d719603833f401031a7907">pgcnt_t</a> *&#160;</td>
          <td class="paramname"><em>last</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Search file <em>inode</em> in <em>disk</em> using a binary search. </p>
<p><em>last</em> is filled with array offset of file start in disk-&gt;page_array if file is found, otherwise <em>last</em> is filled with the correct insert position for creating a file with the given <em>inode</em>. </p>
<dl class="return"><dt><b>Returns:</b></dt><dd>true if file is found, false otherwisr. </dd></dl>

<p>Definition at line <a class="el" href="battfs_8c_source.html#l00827">827</a> of file <a class="el" href="battfs_8c_source.html">battfs.c</a>.</p>

</div>
</div>
<a class="anchor" id="a79846b7cea24a012d60d2720cb2b6d6c"></a><!-- doxytag: member="battfs.c::movePages" ref="a79846b7cea24a012d60d2720cb2b6d6c" args="(struct BattFsSuper *disk, pgcnt_t src, int offset)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void movePages </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structBattFsSuper.html">BattFsSuper</a> *&#160;</td>
          <td class="paramname"><em>disk</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="battfs_8h.html#ab696748712d719603833f401031a7907">pgcnt_t</a>&#160;</td>
          <td class="paramname"><em>src</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>offset</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Move all pages in page allocation array from <em>src</em> to <em>src</em> + <em>offset</em>. </p>
<p>The number of pages moved is page_count - MAX(dst, src). </p>

<p>Definition at line <a class="el" href="battfs_8c_source.html#l00198">198</a> of file <a class="el" href="battfs_8c_source.html">battfs.c</a>.</p>

</div>
</div>
<a class="anchor" id="a041535a629472f6a28d1608337315ebc"></a><!-- doxytag: member="battfs.c::readHdr" ref="a041535a629472f6a28d1608337315ebc" args="(struct BattFsSuper *disk, pgcnt_t page, struct BattFsPageHeader *hdr)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static bool readHdr </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structBattFsSuper.html">BattFsSuper</a> *&#160;</td>
          <td class="paramname"><em>disk</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="battfs_8h.html#ab696748712d719603833f401031a7907">pgcnt_t</a>&#160;</td>
          <td class="paramname"><em>page</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structBattFsPageHeader.html">BattFsPageHeader</a> *&#160;</td>
          <td class="paramname"><em>hdr</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Read header of <em>page</em> in <em>hdr</em>. </p>
<dl class="return"><dt><b>Returns:</b></dt><dd>true on success, false otherwise. </dd></dl>

<p>Definition at line <a class="el" href="battfs_8c_source.html#l00134">134</a> of file <a class="el" href="battfs_8c_source.html">battfs.c</a>.</p>

</div>
</div>
</div>


