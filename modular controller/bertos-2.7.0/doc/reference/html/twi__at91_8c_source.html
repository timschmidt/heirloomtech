

<!-- Generated by Doxygen 1.7.4 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="dir_9fd71c1ac00056e7d855336b2291c56c.html">bertos</a>      </li>
      <li class="navelem"><a class="el" href="dir_a5de7543e32a5f073daa04f8834eb5fd.html">cpu</a>      </li>
      <li class="navelem"><a class="el" href="dir_3ade2df878d06c00b7da75ebdc1e74f5.html">arm</a>      </li>
      <li class="navelem"><a class="el" href="dir_88b011769bd68bcbdcfc8a5f3d937253.html">drv</a>      </li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">twi_at91.c</div>  </div>
</div>
<div class="contents">
<a href="twi__at91_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 
<a name="l00039"></a>00039 <span class="preprocessor">#include &quot;<a class="code" href="twi__at91_8h.html" title="Driver for the AT91 ARM TWI (implementation)">twi_at91.h</a>&quot;</span>
<a name="l00040"></a>00040 
<a name="l00041"></a>00041 <span class="preprocessor">#include &quot;<a class="code" href="cfg__i2c_8h.html" title="Configuration file for I2C module.">cfg/cfg_i2c.h</a>&quot;</span>
<a name="l00042"></a>00042 <span class="preprocessor">#include &lt;<a class="code" href="compiler_8h.html" title="Additional support macros for compiler independance.">cfg/compiler.h</a>&gt;</span>
<a name="l00043"></a>00043 <span class="preprocessor">#include &lt;<a class="code" href="debug_8h.html">cfg/debug.h</a>&gt;</span>
<a name="l00044"></a>00044 <span class="preprocessor">#include &lt;<a class="code" href="macros_8h.html">cfg/macros.h</a>&gt;</span>
<a name="l00045"></a>00045 <span class="preprocessor">#include &lt;<a class="code" href="module_8h.html" title="Debug macros for inter-module dependency checking.">cfg/module.h</a>&gt;</span>
<a name="l00046"></a>00046 
<a name="l00047"></a>00047 <span class="preprocessor">#include &lt;<a class="code" href="timer_8h.html">drv/timer.h</a>&gt;</span>
<a name="l00048"></a>00048 
<a name="l00049"></a>00049 <span class="preprocessor">#include &lt;<a class="code" href="arm_8h.html">io/arm.h</a>&gt;</span>
<a name="l00050"></a>00050 
<a name="l00054"></a><a class="code" href="twi__at91_8c.html#aae1d7716ad5fb6be8b904e8a0def77c5">00054</a> <span class="preprocessor">#define TWI_TIMEOUT ms_to_ticks(50)</span>
<a name="l00055"></a>00055 <span class="preprocessor"></span>
<a name="l00066"></a><a class="code" href="twi__at91_8h.html#a965b288325beab56cb62a2427726f54e">00066</a> <span class="keywordtype">bool</span> <a class="code" href="twi__at91_8c.html#abc3d90480c32ec6727d4967936da90ad" title="Send size bytes over the twi line to slave id.">twi_write</a>(uint8_t <span class="keywordtype">id</span>, twi_iaddr_t byte1, twi_iaddr_t byte2, twi_iaddr_t byte3, <span class="keyword">const</span> <span class="keywordtype">void</span> *_buf, <span class="keywordtype">size_t</span> size)
<a name="l00067"></a>00067 {
<a name="l00068"></a>00068     uint8_t addr_size = 0;
<a name="l00069"></a>00069     <span class="keyword">const</span> uint8_t *buf = (<span class="keyword">const</span> uint8_t *)_buf;
<a name="l00070"></a>00070     <a class="code" href="compiler_8h.html#a9f2d272efa5f391ffc4b9ec4eb59fa88" title="Type for time expressed in ticks.">ticks_t</a> start;
<a name="l00071"></a>00071 
<a name="l00072"></a>00072     <span class="comment">/* At least 1 byte *must* be transmitted, thanks to crappy hw implementation */</span>
<a name="l00073"></a>00073     <a class="code" href="group__debug.html#gaca68c0d4ac8df0838e209fb5300f7be3" title="Assert a pre-condition on code.">ASSERT</a>(size &gt;= 1);
<a name="l00074"></a>00074 
<a name="l00075"></a>00075     <span class="comment">/* Check internal byte address presence */</span>
<a name="l00076"></a>00076     <span class="keywordflow">if</span> (byte1 != TWI_NO_IADDR)
<a name="l00077"></a>00077         addr_size++;
<a name="l00078"></a>00078 
<a name="l00079"></a>00079     <span class="keywordflow">if</span> (byte2 != TWI_NO_IADDR)
<a name="l00080"></a>00080     {
<a name="l00081"></a>00081         <a class="code" href="group__debug.html#gaca68c0d4ac8df0838e209fb5300f7be3" title="Assert a pre-condition on code.">ASSERT</a>(addr_size == 1);
<a name="l00082"></a>00082         addr_size++;
<a name="l00083"></a>00083     }
<a name="l00084"></a>00084 
<a name="l00085"></a>00085     <span class="keywordflow">if</span> (byte3 != TWI_NO_IADDR)
<a name="l00086"></a>00086     {
<a name="l00087"></a>00087         <a class="code" href="group__debug.html#gaca68c0d4ac8df0838e209fb5300f7be3" title="Assert a pre-condition on code.">ASSERT</a>(addr_size == 2);
<a name="l00088"></a>00088         addr_size++;
<a name="l00089"></a>00089     }
<a name="l00090"></a>00090 
<a name="l00091"></a>00091     start = <a class="code" href="group__drv__timers.html#gadc48ccae1f609e329b7bcb153622b8c4" title="Return the system tick counter (expressed in ticks)">timer_clock</a>();
<a name="l00092"></a>00092     <span class="comment">/* Wait tx buffer empty */</span>
<a name="l00093"></a>00093     <span class="keywordflow">while</span> (!(<a class="code" href="at91__twi_8h.html#ace05219303a4d04f60d0667e05cc203a" title="Status register address.">TWI_SR</a> &amp; <a class="code" href="group__macros.html#ga663d8c125655d41622b1e6bc96e5d63d" title="Convert a bit value to a binary flag.">BV</a>(<a class="code" href="at91__twi_8h.html#a0c62400ce2a0f304fb62cb13f708913b" title="Transmit holding register ready.">TWI_TXRDY</a>)))
<a name="l00094"></a>00094     {
<a name="l00095"></a>00095         <span class="keywordflow">if</span> (<a class="code" href="group__drv__timers.html#gadc48ccae1f609e329b7bcb153622b8c4" title="Return the system tick counter (expressed in ticks)">timer_clock</a>() - start &gt; <a class="code" href="twi__at91_8c.html#aae1d7716ad5fb6be8b904e8a0def77c5" title="Timeout for ACK slave waiting.">TWI_TIMEOUT</a>)
<a name="l00096"></a>00096             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00097"></a>00097     }
<a name="l00098"></a>00098 
<a name="l00099"></a>00099     <span class="comment">/* Set slave address and (optional) internal slave addresses */</span>
<a name="l00100"></a>00100     <a class="code" href="at91__twi_8h.html#ad8d84be2df06ad45ecf3542a47af9ba1" title="Master mode register address.">TWI_MMR</a> = (uint32_t)<span class="keywordtype">id</span> &lt;&lt; <a class="code" href="at91__twi_8h.html#aafd6f5c25290232d0ec92a751502c5f5" title="Device address LSB.">TWI_DADR_SHIFT</a> | (uint32_t)addr_size &lt;&lt; <a class="code" href="at91__twi_8h.html#a5ebfe3cb6f5a39e4f15491f2bda73215" title="Internal device address size shift.">TWI_IADRSZ_SHIFT</a>;
<a name="l00101"></a>00101 
<a name="l00102"></a>00102     <a class="code" href="at91__twi_8h.html#a8bead1fd15629dfaa03bcecaed7bd805" title="Internal address register address.">TWI_IADR</a> = ((uint32_t)(byte3 &amp; 0xff) &lt;&lt; 16) | ((uint32_t)(byte2 &amp; 0xff) &lt;&lt; 8) | ((uint32_t)(byte1 &amp; 0xff));
<a name="l00103"></a>00103 
<a name="l00104"></a>00104     <span class="keywordflow">while</span> (size--)
<a name="l00105"></a>00105     {
<a name="l00106"></a>00106         <span class="comment">/* Send data */</span>
<a name="l00107"></a>00107         <a class="code" href="at91__twi_8h.html#a4b03a7b68ca09ea527c41c27eb79b885" title="Transmit holding register address.">TWI_THR</a> = *buf++;
<a name="l00108"></a>00108 
<a name="l00109"></a>00109         start = <a class="code" href="group__drv__timers.html#gadc48ccae1f609e329b7bcb153622b8c4" title="Return the system tick counter (expressed in ticks)">timer_clock</a>();
<a name="l00110"></a>00110         <span class="comment">/* Wait tx buffer empty */</span>
<a name="l00111"></a>00111         <span class="keywordflow">while</span> (!(<a class="code" href="at91__twi_8h.html#ace05219303a4d04f60d0667e05cc203a" title="Status register address.">TWI_SR</a> &amp; <a class="code" href="group__macros.html#ga663d8c125655d41622b1e6bc96e5d63d" title="Convert a bit value to a binary flag.">BV</a>(<a class="code" href="at91__twi_8h.html#a0c62400ce2a0f304fb62cb13f708913b" title="Transmit holding register ready.">TWI_TXRDY</a>)))
<a name="l00112"></a>00112         {
<a name="l00113"></a>00113             <span class="keywordflow">if</span> (<a class="code" href="group__drv__timers.html#gadc48ccae1f609e329b7bcb153622b8c4" title="Return the system tick counter (expressed in ticks)">timer_clock</a>() - start &gt; <a class="code" href="twi__at91_8c.html#aae1d7716ad5fb6be8b904e8a0def77c5" title="Timeout for ACK slave waiting.">TWI_TIMEOUT</a>)
<a name="l00114"></a>00114                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00115"></a>00115         }
<a name="l00116"></a>00116     }
<a name="l00117"></a>00117 
<a name="l00118"></a>00118     <span class="comment">/* Wait transmit complete bit */</span>
<a name="l00119"></a>00119     start = <a class="code" href="group__drv__timers.html#gadc48ccae1f609e329b7bcb153622b8c4" title="Return the system tick counter (expressed in ticks)">timer_clock</a>();
<a name="l00120"></a>00120     <span class="keywordflow">while</span> (!(<a class="code" href="at91__twi_8h.html#ace05219303a4d04f60d0667e05cc203a" title="Status register address.">TWI_SR</a> &amp; <a class="code" href="group__macros.html#ga663d8c125655d41622b1e6bc96e5d63d" title="Convert a bit value to a binary flag.">BV</a>(<a class="code" href="at91__twi_8h.html#af4539af6e9b4506eb9eca59e1d40a920" title="Transmission completed.">TWI_TXCOMP</a>)))
<a name="l00121"></a>00121     {
<a name="l00122"></a>00122         <span class="keywordflow">if</span> (<a class="code" href="group__drv__timers.html#gadc48ccae1f609e329b7bcb153622b8c4" title="Return the system tick counter (expressed in ticks)">timer_clock</a>() - start &gt; <a class="code" href="twi__at91_8c.html#aae1d7716ad5fb6be8b904e8a0def77c5" title="Timeout for ACK slave waiting.">TWI_TIMEOUT</a>)
<a name="l00123"></a>00123             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00124"></a>00124     }
<a name="l00125"></a>00125 
<a name="l00126"></a>00126     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00127"></a>00127 }
<a name="l00128"></a>00128 
<a name="l00129"></a>00129 
<a name="l00140"></a><a class="code" href="twi__at91_8h.html#a13c2078bcea5cac34db1fb2e2daa3868">00140</a> <span class="keywordtype">bool</span> <a class="code" href="twi__at91_8c.html#abdb9ed5f7b003b3a88b8cc7d68b14daf" title="Read size bytes from the twi line from slave id.">twi_read</a>(uint8_t <span class="keywordtype">id</span>, twi_iaddr_t byte1, twi_iaddr_t byte2, twi_iaddr_t byte3, <span class="keywordtype">void</span> *_buf, <span class="keywordtype">size_t</span> size)
<a name="l00141"></a>00141 {
<a name="l00142"></a>00142     uint8_t addr_size = 0;
<a name="l00143"></a>00143     uint8_t *buf = (uint8_t *)_buf;
<a name="l00144"></a>00144     <span class="keywordtype">bool</span> stopped = <span class="keyword">false</span>;
<a name="l00145"></a>00145     <a class="code" href="compiler_8h.html#a9f2d272efa5f391ffc4b9ec4eb59fa88" title="Type for time expressed in ticks.">ticks_t</a> start;
<a name="l00146"></a>00146 
<a name="l00147"></a>00147     <span class="comment">/* At least 1 byte *must* be transmitted, thanks to crappy twi implementation */</span>
<a name="l00148"></a>00148     <a class="code" href="group__debug.html#gaca68c0d4ac8df0838e209fb5300f7be3" title="Assert a pre-condition on code.">ASSERT</a>(size &gt;= 1);
<a name="l00149"></a>00149 
<a name="l00150"></a>00150     <span class="comment">/* Check internal byte address presence */</span>
<a name="l00151"></a>00151     <span class="keywordflow">if</span> (byte1 != TWI_NO_IADDR)
<a name="l00152"></a>00152         addr_size++;
<a name="l00153"></a>00153 
<a name="l00154"></a>00154     <span class="keywordflow">if</span> (byte2 != TWI_NO_IADDR)
<a name="l00155"></a>00155     {
<a name="l00156"></a>00156         <a class="code" href="group__debug.html#gaca68c0d4ac8df0838e209fb5300f7be3" title="Assert a pre-condition on code.">ASSERT</a>(addr_size == 1);
<a name="l00157"></a>00157         addr_size++;
<a name="l00158"></a>00158     }
<a name="l00159"></a>00159 
<a name="l00160"></a>00160     <span class="keywordflow">if</span> (byte3 != TWI_NO_IADDR)
<a name="l00161"></a>00161     {
<a name="l00162"></a>00162         <a class="code" href="group__debug.html#gaca68c0d4ac8df0838e209fb5300f7be3" title="Assert a pre-condition on code.">ASSERT</a>(addr_size == 2);
<a name="l00163"></a>00163         addr_size++;
<a name="l00164"></a>00164     }
<a name="l00165"></a>00165 
<a name="l00166"></a>00166     <span class="comment">/* Wait tx buffer empty */</span>
<a name="l00167"></a>00167     start = <a class="code" href="group__drv__timers.html#gadc48ccae1f609e329b7bcb153622b8c4" title="Return the system tick counter (expressed in ticks)">timer_clock</a>();
<a name="l00168"></a>00168     <span class="keywordflow">while</span> (!(<a class="code" href="at91__twi_8h.html#ace05219303a4d04f60d0667e05cc203a" title="Status register address.">TWI_SR</a> &amp; <a class="code" href="group__macros.html#ga663d8c125655d41622b1e6bc96e5d63d" title="Convert a bit value to a binary flag.">BV</a>(<a class="code" href="at91__twi_8h.html#a0c62400ce2a0f304fb62cb13f708913b" title="Transmit holding register ready.">TWI_TXRDY</a>)))
<a name="l00169"></a>00169     {
<a name="l00170"></a>00170         <span class="keywordflow">if</span> (<a class="code" href="group__drv__timers.html#gadc48ccae1f609e329b7bcb153622b8c4" title="Return the system tick counter (expressed in ticks)">timer_clock</a>() - start &gt; <a class="code" href="twi__at91_8c.html#aae1d7716ad5fb6be8b904e8a0def77c5" title="Timeout for ACK slave waiting.">TWI_TIMEOUT</a>)
<a name="l00171"></a>00171             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00172"></a>00172     }
<a name="l00173"></a>00173 
<a name="l00174"></a>00174 
<a name="l00175"></a>00175     <span class="comment">/* Set slave address and (optional) internal slave addresses */</span>
<a name="l00176"></a>00176     <a class="code" href="at91__twi_8h.html#ad8d84be2df06ad45ecf3542a47af9ba1" title="Master mode register address.">TWI_MMR</a> = ((uint32_t)<span class="keywordtype">id</span> &lt;&lt; <a class="code" href="at91__twi_8h.html#aafd6f5c25290232d0ec92a751502c5f5" title="Device address LSB.">TWI_DADR_SHIFT</a>) | <a class="code" href="group__macros.html#ga663d8c125655d41622b1e6bc96e5d63d" title="Convert a bit value to a binary flag.">BV</a>(<a class="code" href="at91__twi_8h.html#ab6b865a83ebfef45a9876fe79a4133bb" title="Master read direction.">TWI_MREAD</a>) | ((uint32_t)addr_size &lt;&lt; <a class="code" href="at91__twi_8h.html#a5ebfe3cb6f5a39e4f15491f2bda73215" title="Internal device address size shift.">TWI_IADRSZ_SHIFT</a>);
<a name="l00177"></a>00177 
<a name="l00178"></a>00178     <a class="code" href="at91__twi_8h.html#a8bead1fd15629dfaa03bcecaed7bd805" title="Internal address register address.">TWI_IADR</a> = ((uint32_t)(byte3 &amp; 0xff) &lt;&lt; 16) | ((uint32_t)(byte2 &amp; 0xff) &lt;&lt; 8) | ((uint32_t)(byte1 &amp; 0xff));
<a name="l00179"></a>00179 
<a name="l00180"></a>00180     <span class="comment">/*</span>
<a name="l00181"></a>00181 <span class="comment">     * Start reception.</span>
<a name="l00182"></a>00182 <span class="comment">     * Kludge: if we want to receive only 1 byte, the stop but *must* be set here</span>
<a name="l00183"></a>00183 <span class="comment">     * (thanks to crappy twi implementation again).</span>
<a name="l00184"></a>00184 <span class="comment">     */</span>
<a name="l00185"></a>00185     <span class="keywordflow">if</span> (size == 1)
<a name="l00186"></a>00186     {
<a name="l00187"></a>00187         <a class="code" href="at91__twi_8h.html#a02b3d1b1a042abb22c9de7bb29298911" title="Control register address.">TWI_CR</a> = <a class="code" href="group__macros.html#ga663d8c125655d41622b1e6bc96e5d63d" title="Convert a bit value to a binary flag.">BV</a>(<a class="code" href="at91__twi_8h.html#a3b12a0369906d5264bd6e7ea596f6d29" title="Send start condition.">TWI_START</a>) | <a class="code" href="group__macros.html#ga663d8c125655d41622b1e6bc96e5d63d" title="Convert a bit value to a binary flag.">BV</a>(<a class="code" href="at91__twi_8h.html#abc6fae092860c77838a2a320fbfcc512" title="Send stop condition.">TWI_STOP</a>);
<a name="l00188"></a>00188         stopped = <span class="keyword">true</span>;
<a name="l00189"></a>00189     }
<a name="l00190"></a>00190     <span class="keywordflow">else</span>
<a name="l00191"></a>00191         <a class="code" href="at91__twi_8h.html#a02b3d1b1a042abb22c9de7bb29298911" title="Control register address.">TWI_CR</a> = <a class="code" href="group__macros.html#ga663d8c125655d41622b1e6bc96e5d63d" title="Convert a bit value to a binary flag.">BV</a>(<a class="code" href="at91__twi_8h.html#a3b12a0369906d5264bd6e7ea596f6d29" title="Send start condition.">TWI_START</a>);
<a name="l00192"></a>00192 
<a name="l00193"></a>00193     <span class="keywordflow">while</span> (size--)
<a name="l00194"></a>00194     {
<a name="l00195"></a>00195         <span class="comment">/* If we are at the last byte, inform the crappy hw that we</span>
<a name="l00196"></a>00196 <span class="comment">           want to stop the reception. */</span>
<a name="l00197"></a>00197         <span class="keywordflow">if</span> (!size &amp;&amp; !stopped)
<a name="l00198"></a>00198             <a class="code" href="at91__twi_8h.html#a02b3d1b1a042abb22c9de7bb29298911" title="Control register address.">TWI_CR</a> = <a class="code" href="group__macros.html#ga663d8c125655d41622b1e6bc96e5d63d" title="Convert a bit value to a binary flag.">BV</a>(<a class="code" href="at91__twi_8h.html#abc6fae092860c77838a2a320fbfcc512" title="Send stop condition.">TWI_STOP</a>);
<a name="l00199"></a>00199 
<a name="l00200"></a>00200         <span class="comment">/* Wait until a byte is received */</span>
<a name="l00201"></a>00201         start = <a class="code" href="group__drv__timers.html#gadc48ccae1f609e329b7bcb153622b8c4" title="Return the system tick counter (expressed in ticks)">timer_clock</a>();
<a name="l00202"></a>00202         <span class="keywordflow">while</span> (!(<a class="code" href="at91__twi_8h.html#ace05219303a4d04f60d0667e05cc203a" title="Status register address.">TWI_SR</a> &amp; <a class="code" href="group__macros.html#ga663d8c125655d41622b1e6bc96e5d63d" title="Convert a bit value to a binary flag.">BV</a>(<a class="code" href="at91__twi_8h.html#a32a53045ac658af41a2fdf6ca77e27e2" title="Receive holding register ready.">TWI_RXRDY</a>)))
<a name="l00203"></a>00203         {
<a name="l00204"></a>00204             <span class="keywordflow">if</span> (<a class="code" href="group__drv__timers.html#gadc48ccae1f609e329b7bcb153622b8c4" title="Return the system tick counter (expressed in ticks)">timer_clock</a>() - start &gt; <a class="code" href="twi__at91_8c.html#aae1d7716ad5fb6be8b904e8a0def77c5" title="Timeout for ACK slave waiting.">TWI_TIMEOUT</a>)
<a name="l00205"></a>00205             {
<a name="l00206"></a>00206                 <a class="code" href="at91__twi_8h.html#a02b3d1b1a042abb22c9de7bb29298911" title="Control register address.">TWI_CR</a> = <a class="code" href="group__macros.html#ga663d8c125655d41622b1e6bc96e5d63d" title="Convert a bit value to a binary flag.">BV</a>(<a class="code" href="at91__twi_8h.html#abc6fae092860c77838a2a320fbfcc512" title="Send stop condition.">TWI_STOP</a>);
<a name="l00207"></a>00207                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00208"></a>00208             }
<a name="l00209"></a>00209         }
<a name="l00210"></a>00210 
<a name="l00211"></a>00211 
<a name="l00212"></a>00212         *buf++ = <a class="code" href="at91__twi_8h.html#a10ec126222ab67b1b0d4d45a12bfce86" title="Receive holding register address.">TWI_RHR</a>;
<a name="l00213"></a>00213     }
<a name="l00214"></a>00214 
<a name="l00215"></a>00215     <span class="comment">/* Wait transmit complete bit */</span>
<a name="l00216"></a>00216     start = <a class="code" href="group__drv__timers.html#gadc48ccae1f609e329b7bcb153622b8c4" title="Return the system tick counter (expressed in ticks)">timer_clock</a>();
<a name="l00217"></a>00217     <span class="keywordflow">while</span> (!(<a class="code" href="at91__twi_8h.html#ace05219303a4d04f60d0667e05cc203a" title="Status register address.">TWI_SR</a> &amp; <a class="code" href="group__macros.html#ga663d8c125655d41622b1e6bc96e5d63d" title="Convert a bit value to a binary flag.">BV</a>(<a class="code" href="at91__twi_8h.html#af4539af6e9b4506eb9eca59e1d40a920" title="Transmission completed.">TWI_TXCOMP</a>)))
<a name="l00218"></a>00218     {
<a name="l00219"></a>00219         <span class="keywordflow">if</span> (<a class="code" href="group__drv__timers.html#gadc48ccae1f609e329b7bcb153622b8c4" title="Return the system tick counter (expressed in ticks)">timer_clock</a>() - start &gt; <a class="code" href="twi__at91_8c.html#aae1d7716ad5fb6be8b904e8a0def77c5" title="Timeout for ACK slave waiting.">TWI_TIMEOUT</a>)
<a name="l00220"></a>00220             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00221"></a>00221     }
<a name="l00222"></a>00222 
<a name="l00223"></a>00223     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00224"></a>00224 }
<a name="l00225"></a>00225 
<a name="l00226"></a>00226 <a class="code" href="module_8h.html#a8bd9b52ea25a246ad03f0c29fbe5df7a" title="Declare a global variable for module dependency check.">MOD_DEFINE</a>(twi);
<a name="l00227"></a>00227 
<a name="l00231"></a><a class="code" href="twi__at91_8h.html#a16f0e6b2fa5a26eadbf4086ab6d54467">00231</a> <span class="keywordtype">void</span> <a class="code" href="twi__at91_8c.html#a16f0e6b2fa5a26eadbf4086ab6d54467" title="Init the (broken) sam7 twi driver.">twi_init</a>(<span class="keywordtype">void</span>)
<a name="l00232"></a>00232 {
<a name="l00233"></a>00233     <span class="comment">/* Disable PIO on TWI pins */</span>
<a name="l00234"></a>00234     <a class="code" href="sam3__pio_8h.html#a5f995a869c97e633de77b4a8576c7ab4" title="PIO disable register address.">PIOA_PDR</a> = <a class="code" href="group__macros.html#ga663d8c125655d41622b1e6bc96e5d63d" title="Convert a bit value to a binary flag.">BV</a>(TWD) | <a class="code" href="group__macros.html#ga663d8c125655d41622b1e6bc96e5d63d" title="Convert a bit value to a binary flag.">BV</a>(TWCK);
<a name="l00235"></a>00235 
<a name="l00236"></a>00236     <span class="comment">/* Enable oper drain on TWI pins */</span>
<a name="l00237"></a>00237     <a class="code" href="sam3__pio_8h.html#aaf195c323918aa58914b07b9707c4574" title="Multi-driver enable register address.">PIOA_MDER</a> = <a class="code" href="group__macros.html#ga663d8c125655d41622b1e6bc96e5d63d" title="Convert a bit value to a binary flag.">BV</a>(TWD);
<a name="l00238"></a>00238 
<a name="l00239"></a>00239     <span class="comment">/* Disable all irqs */</span>
<a name="l00240"></a>00240     <a class="code" href="at91__twi_8h.html#a3b24e0af67309bddaf69254fc506d5b3" title="Interrupt disable register address.">TWI_IDR</a> = 0xFFFFFFFF;
<a name="l00241"></a>00241 
<a name="l00242"></a>00242     <a class="code" href="at91__twi_8h.html#a02b3d1b1a042abb22c9de7bb29298911" title="Control register address.">TWI_CR</a> = <a class="code" href="group__macros.html#ga663d8c125655d41622b1e6bc96e5d63d" title="Convert a bit value to a binary flag.">BV</a>(<a class="code" href="at91__twi_8h.html#a556126f8cc213b3ad4b59da0d680ec2c" title="Software reset.">TWI_SWRST</a>);
<a name="l00243"></a>00243 
<a name="l00244"></a>00244     <span class="comment">/* Enable master mode */</span>
<a name="l00245"></a>00245     <a class="code" href="at91__twi_8h.html#a02b3d1b1a042abb22c9de7bb29298911" title="Control register address.">TWI_CR</a> = <a class="code" href="group__macros.html#ga663d8c125655d41622b1e6bc96e5d63d" title="Convert a bit value to a binary flag.">BV</a>(<a class="code" href="at91__twi_8h.html#a9a73bd2a5544a605e918f26a2311dd1f" title="Enable master mode.">TWI_MSEN</a>);
<a name="l00246"></a>00246 
<a name="l00247"></a>00247     <a class="code" href="at91__pmc_8h.html#a17654b41c5f9f88c153bad07eaaf9afc" title="Peripheral clock enable register address.">PMC_PCER</a> = <a class="code" href="group__macros.html#ga663d8c125655d41622b1e6bc96e5d63d" title="Convert a bit value to a binary flag.">BV</a>(TWI_ID);
<a name="l00248"></a>00248 
<a name="l00249"></a>00249     <span class="comment">/*</span>
<a name="l00250"></a>00250 <span class="comment">     * Compute twi clock.</span>
<a name="l00251"></a>00251 <span class="comment">     * CLDIV = ((Tlow * 2^CKDIV) -3) * Tmck</span>
<a name="l00252"></a>00252 <span class="comment">     * CHDIV = ((THigh * 2^CKDIV) -3) * Tmck</span>
<a name="l00253"></a>00253 <span class="comment">     * Only CLDIV is computed since CLDIV = CHDIV (50% duty cycle)</span>
<a name="l00254"></a>00254 <span class="comment">     */</span>
<a name="l00255"></a>00255     uint16_t cldiv, ckdiv = 0;
<a name="l00256"></a>00256     <span class="keywordflow">while</span> ((cldiv = ((CPU_FREQ / (2 * <a class="code" href="cfg__i2c_8h.html#ad01428d2b930b3a32e181e9da53d976c" title="Comunication frequency.">CONFIG_I2C_FREQ</a>)) - 3) / (1 &lt;&lt; ckdiv)) &gt; 255)
<a name="l00257"></a>00257         ckdiv++;
<a name="l00258"></a>00258 
<a name="l00259"></a>00259     <span class="comment">/* Atmel errata states that ckdiv *must* be less than 5 for unknown reason */</span>
<a name="l00260"></a>00260     <a class="code" href="group__debug.html#gaca68c0d4ac8df0838e209fb5300f7be3" title="Assert a pre-condition on code.">ASSERT</a>(ckdiv &lt; 5);
<a name="l00261"></a>00261 
<a name="l00262"></a>00262     <a class="code" href="at91__twi_8h.html#ab596a5d1047574a8e0e6f28af3819bbd" title="Clock waveform generator register address.">TWI_CWGR</a> = ((uint32_t)ckdiv &lt;&lt; <a class="code" href="at91__twi_8h.html#ab6e00e71c09d6f9a12ec4143eeb7fe4b" title="Clock divider LSB.">TWI_CKDIV_SHIFT</a>) | (cldiv &lt;&lt; <a class="code" href="at91__twi_8h.html#a5aa4920447aa098faddbd7b1270b91ce" title="Clock low divider LSB.">TWI_CLDIV_SHIFT</a>) | (cldiv &lt;&lt; <a class="code" href="at91__twi_8h.html#a4ccc7013344c4f22152767834b71fbbd" title="Clock high divider LSB.">TWI_CHDIV_SHIFT</a>);
<a name="l00263"></a>00263     TRACEMSG(<span class="stringliteral">&quot;TWI_CWGR [%08lx]&quot;</span>, <a class="code" href="at91__twi_8h.html#ab596a5d1047574a8e0e6f28af3819bbd" title="Clock waveform generator register address.">TWI_CWGR</a>);
<a name="l00264"></a>00264 
<a name="l00265"></a>00265     <a class="code" href="module_8h.html#a89f1822b573749586e4afedcac425099" title="Mark module as initialized.">MOD_INIT</a>(twi);
<a name="l00266"></a>00266 }
<a name="l00267"></a>00267 
</pre></div></div>
</div>


